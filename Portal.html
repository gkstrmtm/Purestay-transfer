<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PureStay Portal</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- deploy: 2026-02-24T00:00:00Z -->
  <link rel="icon" href="brand/purestay_exact_SVG.svg" type="image/svg+xml">

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;800&family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0e0d0c;
      --bg:#ffffff;
      --muted:#6b6460;
      --border:#e7e1da;
      --card:#ffffff;
      --shadow:0 14px 38px rgba(0,0,0,.10);
      --radius: 16px;

      --maroon:#7A2E26;
      --maroon-700:#66271f;
      --gold:#C79A3B;
      --gold-700:#B78A2F;
      --ring:rgba(199,154,59,.38);

      --ok:#0f766e;
      --warn:#b45309;
      --bad:#b42318;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #f7f4f0;
      color:var(--ink);
      min-height:100vh;
    }
    a{color:var(--maroon); text-decoration:none}
    a:hover{text-decoration:underline}

    .hide{display:none !important;}

    .auth{
      min-height: 100vh;
      display:grid;
      place-items:center;
      padding: 28px 16px;
    }

    .authCard{
      width: min(880px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
    }

    .authTop{display:flex; align-items:center; gap:14px;}
    .authTop img{height:52px; width:auto; display:block;}
    .authTop h1{margin:0; font-family: Fraunces, ui-serif, Georgia, serif; font-weight:800; font-size:26px; letter-spacing:.2px;}
    .authTop .sub{color:var(--muted); font-size:13px; margin-top:2px;}

    .pill{font-family: var(--mono); font-size:12px; color:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#fff;}

    .btn{
      appearance:none;
      border: 1px solid transparent;
      background: var(--maroon);
      color: #fff;
      padding: 11px 14px;
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 18px 44px rgba(122,46,38,.18); background: var(--maroon-700);}
    .btn:focus-visible{outline:none; box-shadow: 0 0 0 3px var(--ring);}
    .btn.secondary{
      background: #fff;
      border-color: var(--border);
      color: var(--maroon);
      box-shadow: none;
    }
    .btn.secondary:hover{transform:none; box-shadow:none; background:#fff; border-color: rgba(199,154,59,.55)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .container{max-width: 1180px; margin:0 auto; padding: 18px 18px;}

    .appbar{
      position: sticky;
      top:0;
      z-index: 10;
      background: rgba(255,255,255,.88);
      backdrop-filter: saturate(180%) blur(10px);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .appbarInner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding: 10px 18px; max-width:1180px; margin:0 auto;}
    .appbrand{display:flex; align-items:center; gap:12px;}
    .appbrand img{height:46px; width:auto; display:block;}
    .appbrand .t{font-weight: 900; letter-spacing:.2px;}

    .layout{max-width:1180px; margin:0 auto; display:grid; grid-template-columns: 240px 1fr; gap: 16px; padding: 16px 18px 28px;}
    @media (max-width: 900px){ .layout{grid-template-columns: 1fr;} }

    .sidebar{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      height: fit-content;
    }

    .navTitle{font-size:12px; color:var(--muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; padding: 6px 8px 10px;}
    .navBtn{
      width: 100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      font-weight: 900;
      color: #3a2f2c;
      transition: background .15s ease, border-color .15s ease;
    }
    .navBtn:hover{background: rgba(199,154,59,.10); border-color: rgba(199,154,59,.22)}
    .navBtn.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .card .hd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .card .bd{padding:16px;}

    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      background: #fff;
      color: var(--ink);
      border:1px solid var(--border);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{box-shadow: 0 0 0 3px var(--ring); border-color: rgba(199,154,59,.55)}
    textarea{min-height: 120px; resize: vertical;}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .two{grid-template-columns:1fr;} }

    table{width:100%; border-collapse: collapse; font-size:13px;}
    th, td{padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:top;}
    th{color:var(--muted); font-weight:600; text-align:left; font-size:12px;}

    .badge{font-family: var(--mono); font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:#fff}
    .badge.ok{border-color: rgba(15,118,110,.25); color: rgba(15,118,110,1)}
    .badge.warn{border-color: rgba(180,83,9,.25); color: rgba(180,83,9,1)}

    .err{color: var(--bad); font-family: var(--mono); font-size:12px; white-space: pre-wrap;}
    .ok{color: var(--ok); font-family: var(--mono); font-size:12px; white-space: pre-wrap;}

    .spin{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.14);
      border-top-color: rgba(122,46,38,.95);
      display: inline-block;
      vertical-align: -2px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .small{font-size:12px;}
  </style>
</head>
<body>
  <div id="authView" class="auth">
    <div class="authCard">
      <div class="authTop">
        <img src="brand/purestay_exact_SVG.svg" alt="PureStay" />
        <div>
          <h1>Portal</h1>
          <div class="sub">Sign in to continue</div>
        </div>
      </div>

      <div style="height:16px"></div>
      <div class="two">
        <div>
          <label>Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="you@company.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row" style="justify-content:flex-start; gap:10px;">
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="signupBtn" class="btn secondary" type="button">Create account</button>
      </div>
      <div style="height:12px"></div>
      <div id="authMsg" class="err"></div>
      <div id="authOk" class="ok"></div>
    </div>
  </div>

  <div id="appView" class="hide">
    <div class="appbar">
      <div class="appbarInner">
        <div class="appbrand">
          <img src="brand/purestay_exact_SVG.svg" alt="PureStay" />
          <div>
            <div class="t">Portal</div>
            <div class="muted small" id="roleLine">—</div>
          </div>
        </div>
        <div class="row">
          <div id="appUser" class="pill">—</div>
          <button id="logoutBtn" class="btn secondary">Logout</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <nav class="sidebar">
        <div class="navTitle">Menu</div>
        <div id="nav"></div>
      </nav>

      <main>
        <section class="card" id="appCard">
      <div class="hd">
        <h2 id="viewTitle">Overview</h2>
        <div class="row">
          <span class="badge" id="viewBadge">ready</span>
          <button id="refreshBtn" class="btn secondary hide">Refresh</button>
        </div>
      </div>
      <div class="bd">
        <div id="viewOverview">
          <div class="muted">Sign in to view your dashboard.</div>
        </div>

        <div id="viewLeads" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px;">
            <div class="row" style="flex: 1;">
              <input id="leadQ" placeholder="Search name, property, email, phone" style="max-width:420px" />
              <select id="leadStatus" style="max-width:200px">
                <option value="">All statuses</option>
                <option value="new">new</option>
                <option value="working">working</option>
                <option value="booked">booked</option>
                <option value="won">won</option>
                <option value="lost">lost</option>
              </select>
              <button id="loadLeadsBtn" class="btn secondary">Load</button>
            </div>
            <button id="newLeadToggle" class="btn secondary">New lead</button>
          </div>

          <div id="newLeadBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div class="two">
                <div><label>First name</label><input id="nlFirst" /></div>
                <div><label>Last name</label><input id="nlLast" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>Phone</label><input id="nlPhone" /></div>
                <div><label>Email</label><input id="nlEmail" type="email" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>Property / Community</label><input id="nlProp" /></div>
                <div><label>City, State</label><input id="nlCityState" placeholder="Raleigh, NC" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="nlNotes" placeholder="What did we learn? Any context for the next touch?"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createLeadBtn" class="btn">Create lead</button>
                <div id="createLeadMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="leadsMsg" class="err"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Property</th>
                  <th>City</th>
                  <th>Status</th>
                  <th>Assigned</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="leadsTbody"></tbody>
            </table>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="leadDetailTitle" style="font-weight:900; margin-top:4px;">None</div>
                </div>
                <div class="row">
                  <button id="leadDetailRefreshBtn" class="btn secondary" type="button">Refresh timeline</button>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="leadDetailMsg" class="err"></div>

              <div class="two">
                <div>
                  <label>Status</label>
                  <select id="leadEditStatus">
                    <option value="">(unchanged)</option>
                    <option>new</option>
                    <option>working</option>
                    <option>booked</option>
                    <option>won</option>
                    <option>lost</option>
                  </select>
                </div>
                <div>
                  <label>Priority</label>
                  <select id="leadEditPriority">
                    <option value="">(unchanged)</option>
                    <option value="5">5</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                    <option value="1">1</option>
                    <option value="0">0</option>
                    <option value="-1">-1</option>
                    <option value="-2">-2</option>
                    <option value="-3">-3</option>
                    <option value="-4">-4</option>
                    <option value="-5">-5</option>
                  </select>
                </div>
              </div>

              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Assigned role</label>
                  <select id="leadEditAssignedRole">
                    <option value="">(unchanged)</option>
                    <option>dialer</option>
                    <option>in_person_setter</option>
                    <option>remote_setter</option>
                    <option>closer</option>
                    <option>account_manager</option>
                    <option>event_coordinator</option>
                    <option>event_host</option>
                    <option>media_team</option>
                  </select>
                </div>
                <div>
                  <label>Assigned user id (manager only)</label>
                  <input id="leadEditAssignedUser" placeholder="uuid" />
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Next follow up (ISO or free text)</label>
                <input id="leadEditFollowup" placeholder="2026-02-25 14:30 ET" />
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="leadSaveBtn" class="btn secondary" type="button">Save updates</button>
                <div id="leadSaveMsg" class="err"></div>
              </div>

              <div style="height:14px"></div>

              <div class="card" style="background:#fff; border-color: rgba(231,225,218,.9);">
                <div class="bd">
                  <div style="font-weight:900;">Timeline</div>
                  <div class="muted small" style="margin-top:4px;">Calls, closes, notes, and follow ups</div>
                  <div style="height:10px"></div>
                  <div id="timelineMsg" class="err"></div>
                  <div id="timelineList"></div>

                  <div style="height:12px"></div>
                  <div>
                    <label>Add note</label>
                    <textarea id="timelineNote" placeholder="Add factual notes and next step."></textarea>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button id="timelineAddBtn" class="btn" type="button">Add note</button>
                    <div id="timelineAddMsg" class="err"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewCalls" class="hide">
          <div class="card" style="background:#fff; margin-bottom:14px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">My queue</div>
                  <div class="muted small">Leads assigned to you or your role</div>
                </div>
                <div class="row">
                  <button id="loadQueueBtn" class="btn secondary" type="button">Load</button>
                </div>
              </div>
              <div style="height:10px"></div>
              <div id="queueMsg" class="err"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Property</th>
                      <th>Status</th>
                      <th>Priority</th>
                      <th>Follow up</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="queueTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card" style="background: #fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="selectedLeadLine" style="font-weight:700; margin-top:4px;">None</div>
                </div>
                <button id="pickFromLeads" class="btn secondary">Pick from Leads</button>
              </div>
              <div style="height:10px"></div>
              <div class="two">
                <div>
                  <label>Outcome</label>
                  <select id="callOutcome">
                    <option value="">Select…</option>
                    <option>no_answer</option>
                    <option>left_voicemail</option>
                    <option>not_interested</option>
                    <option>call_back</option>
                    <option>booked_meeting</option>
                    <option>qualified_handoff</option>
                  </select>
                </div>
                <div>
                  <label>Next status (optional)</label>
                  <select id="callLeadStatus">
                    <option value="">No change</option>
                    <option>working</option>
                    <option>booked</option>
                    <option>won</option>
                    <option>lost</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px;">
                <label>Next follow up</label>
                <input id="callFollowup" placeholder="2026-02-25 14:30 ET" />
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="callNotes" placeholder="Short, factual notes."></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="logCallBtn" class="btn">Log call</button>
                <button id="aiFollowupBtn" class="btn secondary">AI follow-up</button>
                <div id="callMsg" class="err"></div>
              </div>
              <div id="followupBox" class="card hide" style="margin-top:12px; background: #fff;">
                <div class="bd">
                  <div class="muted small">Generated follow-up</div>
                  <div style="height:8px"></div>
                  <div><label>Email subject</label><input id="fuSubject" /></div>
                  <div style="margin-top:10px;"><label>Email body</label><textarea id="fuEmail"></textarea></div>
                  <div style="margin-top:10px;"><label>SMS</label><textarea id="fuSms"></textarea></div>
                  <div style="margin-top:10px;"><label>Next step</label><input id="fuNext" /></div>
                </div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Recent activity</div>
                  <div class="muted small">Calls and notes for the selected lead</div>
                </div>
                <button id="loadDialerTimelineBtn" class="btn secondary" type="button">Refresh</button>
              </div>
              <div style="height:10px"></div>
              <div id="dialerTimelineMsg" class="err"></div>
              <div id="dialerTimelineList"></div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Dispatch tasks</div>
                  <div class="muted small">Open and assigned tasks for your role</div>
                </div>
                <div class="row">
                  <select id="dialerTasksScope" style="max-width:220px">
                    <option value="role">Role inbox</option>
                    <option value="mine">My tasks</option>
                  </select>
                  <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="dialerTasksOverdue" type="checkbox" style="width:auto;" />
                    Overdue only
                  </label>
                  <button id="loadDialerTasksBtn" class="btn secondary" type="button">Load</button>
                </div>
              </div>
              <div style="height:10px"></div>
              <div id="dialerTasksMsg" class="err"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Due</th>
                      <th>Title</th>
                      <th>Lead</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="dialerTasksTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="viewCloser" class="hide">
          <div class="card" style="background:#fff; margin-bottom:14px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Closer pipeline</div>
                  <div class="muted small">Working and booked leads for closing</div>
                </div>
                <button id="loadCloserQueueBtn" class="btn secondary" type="button">Load</button>
              </div>
              <div style="height:10px"></div>
              <div id="closerQueueMsg" class="err"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Property</th>
                      <th>Status</th>
                      <th>Priority</th>
                      <th>Follow up</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="closerQueueTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card" style="background: #fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="closerSelectedLead" style="font-weight:700; margin-top:4px;">None</div>
                </div>
                <button id="closerPickLead" class="btn secondary">Pick from Leads</button>
              </div>

              <div style="height:12px"></div>

              <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                    <div>
                      <div style="font-weight:900;">AI Research</div>
                      <div class="muted small">Call prep from lead details</div>
                    </div>
                    <button id="aiResearchBtn" class="btn secondary">Generate</button>
                  </div>
                  <div style="height:10px"></div>
                  <div><label>Optional question</label><input id="researchQ" placeholder="What should I ask on discovery?" /></div>
                  <div style="height:10px"></div>
                  <div id="researchMsg" class="err"></div>
                  <div id="researchBox" class="card hide" style="margin-top:12px; background:#fff;">
                    <div class="bd">
                      <div><label>Summary</label><textarea id="researchSummary"></textarea></div>
                      <div style="margin-top:10px;"><label>Talking points</label><textarea id="researchTalking"></textarea></div>
                      <div style="margin-top:10px;"><label>Likely objections</label><textarea id="researchObjections"></textarea></div>
                      <div style="margin-top:10px;"><label>Next steps</label><textarea id="researchNext"></textarea></div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="height:14px"></div>

              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div style="font-weight:900;">Close or Disposition</div>
                  <div style="height:10px"></div>

                  <div class="two">
                    <div>
                      <label>Disposition</label>
                      <select id="closeDisposition">
                        <option value="follow_up">follow_up</option>
                        <option value="won">won</option>
                        <option value="lost">lost</option>
                      </select>
                    </div>
                    <div>
                      <label>Closed on (if won)</label>
                      <input id="closeDate" type="date" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Package tier</label>
                      <select id="closePackage">
                        <option value="">Select…</option>
                        <option value="tier_1">tier_1 ($1000)</option>
                        <option value="tier_2">tier_2 ($2000)</option>
                        <option value="tier_3">tier_3 ($3000)</option>
                        <option value="custom">custom</option>
                      </select>
                    </div>
                    <div>
                      <label>Package price (USD)</label>
                      <input id="closePackagePrice" type="number" min="0" step="0.01" placeholder="1000" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Initial payment (USD)</label>
                      <input id="closeInitial" type="number" min="0" step="0.01" placeholder="0" />
                    </div>
                    <div>
                      <label>Term length (months)</label>
                      <input id="closeTerm" type="number" min="1" step="1" placeholder="6" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Monthly pricing (USD)</label>
                      <input id="closeMonthly" type="number" min="0" step="0.01" placeholder="0" />
                    </div>
                    <div>
                      <label>Contract send date (optional)</label>
                      <input id="closeContractSend" type="date" />
                    </div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Notes / next steps</label>
                    <textarea id="closeNotes" placeholder="Next steps, follow-up date, key details."></textarea>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <button id="closeSubmitBtn" class="btn">Submit</button>
                    <button id="closeQuoteBtn" class="btn secondary" type="button">Fill tier price</button>
                    <div id="closeMsg" class="err"></div>
                  </div>
                </div>
              </div>

              <div style="height:14px"></div>

              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                    <div>
                      <div style="font-weight:900;">Appointments</div>
                      <div class="muted small">Schedule and track closer appointments</div>
                    </div>
                    <button id="loadApptsBtn" class="btn secondary" type="button">Load</button>
                  </div>

                  <div style="height:10px"></div>
                  <div id="apptsMsg" class="err"></div>

                  <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                    <table>
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Time</th>
                          <th>Lead</th>
                          <th>Status</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="apptsTbody"></tbody>
                    </table>
                  </div>

                  <div style="height:12px"></div>
                  <div class="two">
                    <div>
                      <label>Date</label>
                      <input id="apptDate" type="date" />
                    </div>
                    <div>
                      <label>Start time</label>
                      <input id="apptStart" type="time" />
                    </div>
                  </div>
                  <div style="margin-top:10px;">
                    <label>Notes</label>
                    <textarea id="apptNotes" placeholder="Agenda and next steps."></textarea>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button id="scheduleApptBtn" class="btn" type="button">Schedule for selected lead</button>
                    <div id="scheduleApptMsg" class="err"></div>
                  </div>
                </div>
              </div>

              <div style="height:14px"></div>

              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div style="font-weight:900;">Availability</div>
                  <div class="muted small" style="margin-top:4px;">Saved server-side for dispatch and scheduling</div>
                  <div style="height:10px"></div>
                  <div><label>Availability notes</label><textarea id="availNotes" placeholder="Example: Mon to Fri 10am to 4pm ET. No calls after 6pm."></textarea></div>
                  <div class="row" style="margin-top:10px;">
                    <button id="saveAvailBtn" class="btn secondary" type="button">Save availability</button>
                    <div id="availMsg" class="err"></div>
                  </div>
                </div>
              </div>

              <div style="height:14px"></div>

              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                    <div>
                      <div style="font-weight:900;">Dispatch tasks</div>
                      <div class="muted small">Open and assigned tasks for your role</div>
                    </div>
                    <div class="row">
                      <select id="closerTasksScope" style="max-width:220px">
                        <option value="role">Role inbox</option>
                        <option value="mine">My tasks</option>
                      </select>
                      <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                        <input id="closerTasksOverdue" type="checkbox" style="width:auto;" />
                        Overdue only
                      </label>
                      <button id="loadCloserTasksBtn" class="btn secondary" type="button">Load</button>
                    </div>
                  </div>
                  <div style="height:10px"></div>
                  <div id="closerTasksMsg" class="err"></div>
                  <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                    <table>
                      <thead>
                        <tr>
                          <th>Due</th>
                          <th>Title</th>
                          <th>Lead</th>
                          <th>Status</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="closerTasksTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div id="viewEvents" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px;">
            <div class="row">
              <select id="eventStatus" style="max-width:220px">
                <option value="">All statuses</option>
                <option value="open">open</option>
                <option value="assigned">assigned</option>
                <option value="completed">completed</option>
                <option value="canceled">canceled</option>
              </select>
              <button id="loadEventsBtn" class="btn secondary">Load</button>
            </div>
            <button id="newEventToggle" class="btn secondary hide">New event</button>
          </div>

          <div id="newEventBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div class="two">
                <div><label>Title</label><input id="neTitle" placeholder="Property event" /></div>
                <div><label>Date</label><input id="neDate" type="date" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>City</label><input id="neCity" /></div>
                <div><label>State</label><input id="neState" placeholder="NC" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="neNotes"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createEventBtn" class="btn">Create event</button>
                <div id="createEventMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="eventsMsg" class="err"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th>Title</th>
                  <th>City</th>
                  <th>Status</th>
                  <th>Assigned</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="eventsTbody"></tbody>
            </table>
          </div>

          <div id="eventRecapWrap" class="card hide" style="margin-top:14px; background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected event</div>
                  <div id="selectedEventLine" style="font-weight:900; margin-top:4px;">None</div>
                </div>
                <button id="closeRecapBtn" class="btn secondary" type="button">Close</button>
              </div>

              <div style="height:12px"></div>

              <div class="two">
                <div>
                  <label>Attendance estimate</label>
                  <input id="recapAttendance" type="number" min="0" step="1" placeholder="0" />
                </div>
                <div>
                  <label>How it went</label>
                  <select id="recapRating">
                    <option value="">Select…</option>
                    <option>excellent</option>
                    <option>good</option>
                    <option>ok</option>
                    <option>poor</option>
                  </select>
                </div>
              </div>

              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Issues reported</label>
                  <select id="recapIssues">
                    <option value="">Select…</option>
                    <option value="no">no</option>
                    <option value="yes">yes</option>
                  </select>
                </div>
                <div>
                  <label>Photos uploaded</label>
                  <select id="recapPhotos">
                    <option value="">Select…</option>
                    <option value="yes">yes</option>
                    <option value="no">no</option>
                    <option value="pending">pending</option>
                  </select>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Issues details (if any)</label>
                <textarea id="recapIssuesDetails"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Host notes</label>
                <textarea id="recapNotes"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Media links (one per line)</label>
                <textarea id="recapMedia" placeholder="https://...\nhttps://..."></textarea>
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="submitRecapBtn" class="btn">Submit recap</button>
                <div id="recapMsg" class="err"></div>
              </div>

              <div style="height:14px"></div>
              <div class="muted small" style="font-weight:900;">Recent recaps</div>
              <div style="height:8px"></div>
              <div id="recapsList"></div>
            </div>
          </div>
        </div>

        <div id="viewPayments" class="hide">
          <div class="row" style="justify-content:space-between;">
            <button id="loadPayoutsBtn" class="btn secondary">Load</button>
          </div>
          <div style="height:14px"></div>
          <div id="payoutsMsg" class="err"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="payoutsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewManager" class="hide">
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Manager view</div>
                  <div style="font-weight:900; margin-top:4px;">Stats</div>
                </div>
                <button id="loadStatsBtn" class="btn secondary" type="button">Load stats</button>
              </div>
              <div style="height:10px"></div>
              <div id="statsMsg" class="err"></div>
              <div id="statsBox" class="row" style="gap:10px; flex-wrap:wrap;"></div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Dispatch</div>
                  <div class="muted small">Create and manage operational tasks</div>
                </div>
                <div class="row">
                  <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="dispatchOverdueOnly" type="checkbox" style="width:auto;" />
                    Overdue only
                  </label>
                  <button id="scanDispatchBtn" class="btn secondary" type="button">Scan overdue</button>
                  <button id="loadDispatchBtn" class="btn secondary" type="button">Load tasks</button>
                </div>
              </div>

              <div style="height:12px"></div>
              <div class="two">
                <div>
                  <label>Status filter</label>
                  <select id="dispatchStatus">
                    <option value="">Open and assigned</option>
                    <option value="open">open</option>
                    <option value="assigned">assigned</option>
                    <option value="completed">completed</option>
                    <option value="cancelled">cancelled</option>
                  </select>
                </div>
                <div>
                  <label>Assigned role filter</label>
                  <select id="dispatchRole">
                    <option value="">All roles</option>
                    <option>dialer</option>
                    <option>in_person_setter</option>
                    <option>remote_setter</option>
                    <option>closer</option>
                    <option>account_manager</option>
                    <option>event_coordinator</option>
                    <option>event_host</option>
                    <option>media_team</option>
                  </select>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="dispatchMsg" class="err"></div>

              <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div style="font-weight:900;">Create task</div>
                  <div style="height:10px"></div>
                  <div class="two">
                    <div>
                      <label>Lead ID (optional)</label>
                      <input id="dispatchLeadId" placeholder="123" />
                    </div>
                    <div>
                      <label>Assigned role</label>
                      <select id="dispatchAssignedRole">
                        <option value="">Select…</option>
                        <option>dialer</option>
                        <option>in_person_setter</option>
                        <option>remote_setter</option>
                        <option>closer</option>
                        <option>account_manager</option>
                        <option>event_coordinator</option>
                        <option>event_host</option>
                        <option>media_team</option>
                      </select>
                    </div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Title</label>
                    <input id="dispatchTitle" placeholder="Example: Pull comps and prep talking points" />
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Due date</label>
                      <input id="dispatchDueDate" type="date" />
                    </div>
                    <div>
                      <label>Due time</label>
                      <input id="dispatchDueTime" type="time" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Assigned user id (optional)</label>
                      <input id="dispatchAssignedUserId" placeholder="uuid" />
                    </div>
                    <div>
                      <label>Priority</label>
                      <select id="dispatchPriority">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="-1">-1</option>
                        <option value="-2">-2</option>
                        <option value="-3">-3</option>
                        <option value="-4">-4</option>
                        <option value="-5">-5</option>
                      </select>
                    </div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Notes</label>
                    <textarea id="dispatchNotes" placeholder="Context and expected output."></textarea>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <button id="dispatchCreateBtn" class="btn" type="button">Create</button>
                    <div id="dispatchCreateMsg" class="err"></div>
                  </div>
                </div>
              </div>

              <div style="height:12px"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Due</th>
                      <th>Title</th>
                      <th>Role</th>
                      <th>Assigned</th>
                      <th>Lead</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="dispatchTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div style="font-weight:900;">Lead assignment</div>
              <div class="muted small" style="margin-top:4px;">Assign a lead to a role or a specific user</div>
              <div style="height:10px"></div>
              <div class="two">
                <div>
                  <label>Lead ID</label>
                  <input id="mgrLeadId" placeholder="123" />
                </div>
                <div>
                  <label>Assigned role</label>
                  <select id="mgrAssignedRole">
                    <option value="">(no change)</option>
                    <option>dialer</option>
                    <option>in_person_setter</option>
                    <option>remote_setter</option>
                    <option>closer</option>
                    <option>account_manager</option>
                    <option>event_coordinator</option>
                    <option>event_host</option>
                    <option>media_team</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px;">
                <label>Assigned user id</label>
                <input id="mgrAssignedUserId" placeholder="uuid" />
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="mgrAssignBtn" class="btn secondary" type="button">Apply</button>
                <div id="mgrAssignMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Users</div>
                  <div class="muted small">Edit roles and view availability</div>
                </div>
                <button id="loadUsersBtn" class="btn secondary" type="button">Load users</button>
              </div>
              <div style="height:14px"></div>
              <div id="usersMsg" class="err"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>User ID</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="usersTbody"></tbody>
                </table>
              </div>

              <div style="height:12px"></div>
              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div style="font-weight:900;">Team availability</div>
                  <div class="muted small" style="margin-top:4px;">Loads from saved availability notes</div>
                  <div style="height:10px"></div>
                  <button id="loadTeamAvailBtn" class="btn secondary" type="button">Load availability</button>
                  <div style="height:10px"></div>
                  <div id="teamAvailMsg" class="err"></div>
                  <div id="teamAvailList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    (function stripCloudflareChallengeParams(){
      try{
        const u = new URL(window.location.href);
        let changed = false;
        for (const k of Array.from(u.searchParams.keys())){
          if (k.startsWith('__cf_chl_') || k.startsWith('cf_chl_')) {
            u.searchParams.delete(k);
            changed = true;
          }
        }
        if (changed) {
          const qs = u.searchParams.toString();
          const next = u.pathname + (qs ? ('?' + qs) : '') + (u.hash || '');
          window.history.replaceState({}, '', next);
        }
      } catch(_e) {}
    })();

    const $ = (id) => document.getElementById(id);

    function setAuthLoading(loading, label){
      const loginBtn = $('loginBtn');
      const signupBtn = $('signupBtn');
      if (loginBtn) {
        loginBtn.disabled = !!loading;
        loginBtn.textContent = loading ? (label || 'Signing in…') : 'Sign in';
      }
      if (signupBtn) {
        signupBtn.disabled = !!loading;
        signupBtn.textContent = loading ? 'Working…' : 'Create account';
      }
      const ok = $('authOk');
      if (ok) ok.innerHTML = loading ? `<span class="spin"></span> ${escapeHtml(label || 'Signing in…')}` : '';
    }

    function withTimeout(promise, ms, label){
      let t;
      const timeout = new Promise((_, rej) => {
        t = setTimeout(() => rej(new Error(label || 'request_timeout')), ms);
      });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    }

    // If something breaks in JS, surface it instead of silently doing nothing.
    window.addEventListener('error', (ev) => {
      const msg = String(ev?.message || 'script_error');
      const el = $('authMsg');
      if (el) el.textContent = msg;
    });
    window.addEventListener('unhandledrejection', (ev) => {
      const msg = String(ev?.reason?.message || ev?.reason || 'promise_rejection');
      const el = $('authMsg');
      if (el) el.textContent = msg;
    });

    const state = {
      token: '',
      me: null,
      activeTab: 'overview',
      leads: [],
      selectedLead: null,
      events: [],
      selectedEvent: null,
      appointments: [],
      dispatch: [],
      pickLeadReturnTab: 'calls',
      usersCache: [],
    };

    function setBadge(kind, text){
      const b = $('viewBadge');
      b.textContent = text;
      b.className = 'badge ' + (kind || '');
    }

    function setTab(tab){
      state.activeTab = tab;
      const title = {
        overview: 'Overview',
        leads: 'Leads',
        calls: 'Dialer',
        closer: 'Closer',
        events: 'Events',
        payments: 'Payments',
        manager: 'Manager'
      }[tab] || 'Overview';
      const viewKey = {
        overview: 'Overview',
        leads: 'Leads',
        calls: 'Calls',
        closer: 'Closer',
        events: 'Events',
        payments: 'Payments',
        manager: 'Manager'
      }[tab] || 'Overview';

      $('viewTitle').textContent = title;

      const views = ['Overview','Leads','Calls','Closer','Events','Payments','Manager'];
      for (const v of views) $('view'+v).classList.add('hide');
      const viewEl = $('view' + viewKey);
      if (viewEl) viewEl.classList.remove('hide');

      for (const el of document.querySelectorAll('.navBtn')) {
        el.classList.toggle('active', el.dataset.tab === tab);
      }

      if (tab === 'leads') loadLeads().catch(()=>{});
      if (tab === 'events') loadEvents().catch(()=>{});
      if (tab === 'closer') {
        loadAppointments().catch(()=>{});
        loadAvailability().catch(()=>{});
        loadCloserQueue().catch(()=>{});
        loadDispatchInto('closerTasksTbody', 'closerTasksMsg', { overdueOnly: !!$('closerTasksOverdue')?.checked, scope: String($('closerTasksScope')?.value || 'role') }).catch(()=>{});
      }
      if (tab === 'calls') {
        loadQueue().catch(()=>{});
        if (state.selectedLead && state.selectedLead.id) {
          loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
        }
        loadDispatchInto('dialerTasksTbody', 'dialerTasksMsg', { overdueOnly: !!$('dialerTasksOverdue')?.checked, scope: String($('dialerTasksScope')?.value || 'role') }).catch(()=>{});
      }
      if (tab === 'manager') {
        loadDispatchManager().catch(()=>{});
      }
    }

    function showAuthView(message){
      $('authView').classList.remove('hide');
      $('appView').classList.add('hide');
      $('authMsg').textContent = message || '';
      const ok = $('authOk');
      if (ok) ok.textContent = '';
    }

    function showAppView(){
      $('authView').classList.add('hide');
      $('appView').classList.remove('hide');
    }

    async function api(path, { method='GET', body=null } = {}){
      const token = String(state.token || '').trim();
      if (!token) throw new Error('not_signed_in');

      const r = await fetch(path, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token,
        },
        body: body ? JSON.stringify(body) : undefined,
      });
      const j = await r.json().catch(() => null);
      if (!j || !j.ok) throw new Error(j?.error || ('http_' + r.status));
      return j;
    }

    async function refreshMe(){
      const token = String(state.token || '').trim();
      if (!token){
        state.me = null;
        showAuthView('');
        setTab('overview');
        return;
      }

      let me = null;
      try {
        me = await api('/api/portal/me');
        state.me = me;
      } catch (e) {
        // Token likely expired or invalid
        state.token = '';
        localStorage.removeItem('portal_access_token');
        state.me = null;
        showAuthView('Session expired. Please sign in again.');
        return;
      }

      showAppView();

  me = state.me;
      $('roleLine').textContent = me.profile.role;
      $('appUser').textContent = me.user.email;

      const navItems = [
        { id:'overview', label:'Overview' },
        { id:'leads', label:'Leads' },
      ];

      const role = String(me.profile.role || '');
      const isManager = role === 'manager';

      // Dialers/setters need call logging.
      if (['dialer','in_person_setter','remote_setter','closer','account_manager','event_coordinator'].includes(role) || isManager) {
        navItems.push({ id:'calls', label:'Dialer' });
      }

      // Closer/account manager workflows.
      if (['closer','account_manager'].includes(role) || isManager) {
        navItems.push({ id:'closer', label:'Closer' });
      }

      // Events workflows.
      if (['event_host','media_team','event_coordinator'].includes(role) || isManager) {
        navItems.push({ id:'events', label:'Events' });
      }

      navItems.push({ id:'payments', label:'Payments' });
      if (isManager) navItems.push({ id:'manager', label:'Manager' });

      $('nav').innerHTML = navItems
        .map((t) => `<button class="navBtn" type="button" data-tab="${t.id}">${t.label}</button>`)
        .join('');

      for (const el of document.querySelectorAll('.navBtn')){
        el.addEventListener('click', () => setTab(el.dataset.tab));
      }

      // Manager-only controls
      $('newEventToggle').classList.toggle('hide', !(me.profile.role === 'manager' || me.profile.role === 'event_coordinator'));

      // Overview
      $('viewOverview').innerHTML = `
        <div class="row" style="justify-content:space-between; gap:16px;">
          <div>
            <div class="muted small">Signed in</div>
            <div style="font-weight:900; margin-top:4px;">${me.user.email}</div>
          </div>
          <div>
            <div class="muted small">Role</div>
            <div style="margin-top:4px;"><span class="badge ok">${me.profile.role}</span></div>
          </div>
        </div>
      `;

      setTab(state.activeTab || 'overview');
    }

    function requireSelectedLead(where){
      if (!state.selectedLead || !state.selectedLead.id) {
        const msg = where ? (where + ': select a lead first') : 'select a lead first';
        throw new Error(msg);
      }
      return state.selectedLead;
    }

    function setSelectedLeadLine(){
      const l = state.selectedLead;
      const line = l
        ? `#${l.id} • ${[l.first_name, l.last_name].filter(Boolean).join(' ').trim()} • ${l.property_name || l.company || ''}`.trim()
        : 'None';
      if ($('selectedLeadLine')) $('selectedLeadLine').textContent = line;
      if ($('closerSelectedLead')) $('closerSelectedLead').textContent = line;
      if ($('leadDetailTitle')) $('leadDetailTitle').textContent = line;

      // Populate lead edit defaults for convenience
      if (l) {
        if ($('leadEditStatus')) $('leadEditStatus').value = '';
        if ($('leadEditPriority')) $('leadEditPriority').value = '';
        if ($('leadEditAssignedRole')) $('leadEditAssignedRole').value = '';
        if ($('leadEditAssignedUser')) $('leadEditAssignedUser').value = '';
        const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
        if ($('leadEditFollowup')) $('leadEditFollowup').value = fu;
      }
    }

    function leadDisplayName(l){
      if (!l) return '';
      const name = [l.first_name, l.last_name].filter(Boolean).join(' ').trim();
      const prop = l.property_name || l.company || '';
      return [name || '(no name)', prop].filter(Boolean).join(' • ');
    }

    function activityLabel(a){
      const t = String(a.activity_type || '');
      if (t === 'call') return 'Call';
      if (t === 'close') return 'Close';
      if (t === 'note') return 'Note';
      return t || 'Activity';
    }

    function renderTimeline(listElId, msgElId, items){
      const msgEl = msgElId ? $(msgElId) : null;
      const listEl = $(listElId);
      if (!listEl) return;
      if (msgEl) msgEl.textContent = '';

      const arr = Array.isArray(items) ? items : [];
      if (!arr.length) {
        listEl.innerHTML = '<div class="muted small">No activity yet.</div>';
        return;
      }

      listEl.innerHTML = arr.map((a) => {
        const when = String(a.created_at || '').replace('T', ' ').slice(0, 19);
        const label = activityLabel(a);
        const outcome = a.outcome ? `<span class="badge">${escapeHtml(a.outcome)}</span>` : '';
        const notes = a.notes ? `<div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(a.notes)}</div>` : '';
        const payload = a.payload && typeof a.payload === 'object' ? a.payload : {};
        const fu = payload.followup || '';
        const fuLine = fu ? `<div class="muted small" style="margin-top:6px;">Follow up: ${escapeHtml(String(fu))}</div>` : '';
        return `
          <div class="card" style="background:#fff; margin-bottom:10px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; gap:10px; align-items:flex-start;">
                <div>
                  <div class="muted small">${escapeHtml(when)}</div>
                  <div style="font-weight:900; margin-top:4px;">${escapeHtml(label)}</div>
                </div>
                <div class="row">${outcome}</div>
              </div>
              ${notes}
              ${fuLine}
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadTimelineInto(listElId, msgElId){
      const msgEl = msgElId ? $(msgElId) : null;
      if (msgEl) msgEl.textContent = '';
      try{
        const lead = requireSelectedLead('Timeline');
        const j = await api('/api/portal/activities?leadId=' + encodeURIComponent(String(lead.id)) + '&limit=80');
        renderTimeline(listElId, msgElId, j.activities || []);
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
      }
    }

    async function addTimelineNote(noteElId, msgElId, listElId){
      const msgEl = msgElId ? $(msgElId) : null;
      if (msgEl) msgEl.textContent = '';
      try{
        const lead = requireSelectedLead('Add note');
        const notes = String($(noteElId)?.value || '').trim();
        if (!notes) throw new Error('Write a note');
        const fu = String($('leadEditFollowup')?.value || '').trim();

        await api('/api/portal/activities', {
          method: 'POST',
          body: {
            leadId: lead.id,
            activityType: 'note',
            notes,
            payload: fu ? { followup: fu } : {},
          }
        });

        const nEl = $(noteElId);
        if (nEl) nEl.value = '';
        await loadTimelineInto(listElId, msgElId);
        setBadge('ok', 'saved');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
      }
    }

    async function saveLeadEdits(){
      $('leadSaveMsg').textContent = '';
      try{
        const lead = requireSelectedLead('Lead update');
        const patch = { id: lead.id };

        const st = $('leadEditStatus').value;
        const pr = $('leadEditPriority').value;
        const ar = $('leadEditAssignedRole').value;
        const au = $('leadEditAssignedUser').value.trim();
        const fu = $('leadEditFollowup').value.trim();

        if (st) patch.status = st;
        if (pr !== '') patch.priority = Number(pr);
        if (ar) patch.assignedRole = ar;
        if (au) patch.assignedUserId = au;

        // Merge meta followup
        const nextMeta = Object.assign({}, (lead.meta && typeof lead.meta === 'object') ? lead.meta : {});
        if (fu) nextMeta.followup = fu;
        if (!fu && 'followup' in nextMeta) delete nextMeta.followup;
        patch.meta = nextMeta;

        await api('/api/portal/leads', { method:'PATCH', body: patch });
        await loadLeads();
        // Preserve selected lead instance from refreshed list
        state.selectedLead = state.leads.find((x) => Number(x.id) === Number(lead.id)) || state.selectedLead;
        setSelectedLeadLine();
        await loadTimelineInto('timelineList', 'timelineMsg');
        setBadge('ok', 'updated');
      } catch(e){
        $('leadSaveMsg').textContent = String(e.message || e);
      }
    }

    async function loadQueue(){
      $('queueMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/queue?kind=dialer&limit=50');
        const leads = j.leads || [];
        const tb = $('queueTbody');
        if (!tb) return;

        if (!leads.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No queue items.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = leads.map((l) => {
          const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
          const prop = l.property_name || l.company || '';
          const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
          const canClaim = !l.assigned_user_id;
          const claimBtn = canClaim ? `<button class="btn small" data-queue-claim="${l.id}">Claim</button>` : '';
          return `
            <tr>
              <td><span class="badge">${l.id}</span></td>
              <td>${escapeHtml(name)}</td>
              <td class="muted">${escapeHtml(prop)}</td>
              <td><span class="badge">${escapeHtml(l.status || '')}</span></td>
              <td class="muted">${escapeHtml(String(l.priority ?? 0))}</td>
              <td class="muted">${escapeHtml(fu)}</td>
              <td><button class="btn secondary small" data-queue-pick="${l.id}">Select</button> ${claimBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-queue-pick]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.queuePick);
            const l = leads.find((x) => Number(x.id) === id) || null;
            state.selectedLead = l;
            setSelectedLeadLine();
            loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
          });
        }

        for (const btn of tb.querySelectorAll('button[data-queue-claim]')){
          btn.addEventListener('click', async () => {
            $('queueMsg').textContent = '';
            try{
              const id = Number(btn.dataset.queueClaim);
              await api('/api/portal/leads', { method:'PATCH', body: { id, assignedUserId: state.me.user.id, status: 'working' } });
              await loadQueue();
              setBadge('ok', 'claimed');
            } catch(e){
              $('queueMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('queueMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadStats(){
      $('statsMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/stats?scope=all');
        const c = j.leadCounts || {};
        const box = $('statsBox');
        if (box) {
          box.innerHTML = [
            `<span class="badge ok">new ${Number(c.new ?? 0)}</span>`,
            `<span class="badge">working ${Number(c.working ?? 0)}</span>`,
            `<span class="badge">booked ${Number(c.booked ?? 0)}</span>`,
            `<span class="badge ok">won ${Number(c.won ?? 0)}</span>`,
            `<span class="badge warn">lost ${Number(c.lost ?? 0)}</span>`,
            `<span class="badge">calls24h ${Number(j.callsLast24h ?? 0)}</span>`,
            `<span class="badge">upcoming appts ${Number(j.upcomingAppointments ?? 0)}</span>`,
            `<span class="badge">dispatch open ${Number(j.dispatchOpen ?? 0)}</span>`,
            `<span class="badge warn">dispatch overdue ${Number(j.dispatchOverdue ?? 0)}</span>`,
          ].join(' ');
        }
        setBadge('ok', 'loaded');
      } catch(e){
        $('statsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function managerAssignLead(){
      $('mgrAssignMsg').textContent = '';
      try{
        const id = Number($('mgrLeadId').value || 0);
        if (!id) throw new Error('Enter a lead id');
        const body = { id };

        const role = $('mgrAssignedRole').value;
        const userId = $('mgrAssignedUserId').value.trim();
        if (role) body.assignedRole = role;
        if (userId) body.assignedUserId = userId;

        await api('/api/portal/leads', { method:'PATCH', body });
        setBadge('ok', 'assigned');
      } catch(e){
        $('mgrAssignMsg').textContent = String(e.message || e);
      }
    }

    async function loadTeamAvailability(){
      $('teamAvailMsg').textContent = '';
      const box = $('teamAvailList');
      if (box) box.innerHTML = '';
      try{
        if (!state.usersCache || !Array.isArray(state.usersCache) || !state.usersCache.length) {
          throw new Error('Load users first');
        }
        const users = state.usersCache.slice(0, 60);
        const rows = [];
        for (const u of users) {
          // eslint-disable-next-line no-await-in-loop
          const j = await api('/api/portal/availability?userId=' + encodeURIComponent(String(u.userId)));
          const notes = String(j.availability?.notes || '').trim();
          if (!notes) continue;
          rows.push({ u, notes, updatedAt: j.availability?.updatedAt || '' });
        }
        if (!rows.length) {
          if (box) box.innerHTML = '<div class="muted small">No availability saved.</div>';
          return;
        }
        if (box) {
          box.innerHTML = rows.map((r) => `
            <div class="card" style="background:#fff; margin-bottom:10px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; gap:10px;">
                  <div>
                    <div style="font-weight:900;">${escapeHtml(r.u.email || r.u.userId)}</div>
                    <div class="muted small" style="margin-top:4px;">${escapeHtml(r.u.role || '')}</div>
                  </div>
                  <div class="muted small">${escapeHtml(String(r.updatedAt || '').slice(0,19).replace('T',' '))}</div>
                </div>
                <div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(r.notes)}</div>
              </div>
            </div>
          `).join('');
        }
      } catch(e){
        $('teamAvailMsg').textContent = String(e.message || e);
      }
    }

    function dispatchDue(task){
      const d = String(task?.event_date || '');
      const t = String(task?.start_time || '');
      return [d, t].filter(Boolean).join(' ');
    }

    function isOverdue(task){
      const st = String(task?.status || '');
      if (['completed', 'cancelled'].includes(st)) return false;
      const d = String(task?.event_date || '');
      if (!d) return false;
      const now = new Date();
      const yyyy = now.getUTCFullYear();
      const mm = String(now.getUTCMonth() + 1).padStart(2, '0');
      const dd = String(now.getUTCDate()).padStart(2, '0');
      const today = `${yyyy}-${mm}-${dd}`;
      return d < today;
    }

    async function loadDispatchInto(tbodyId, msgId, { overdueOnly = false, scope = '' } = {}){
      const tb = $(tbodyId);
      const msgEl = $(msgId);
      if (!tb) return;
      if (msgEl) msgEl.textContent = '';
      setBadge('warn', 'loading');
      try{
        const qs = [];
        qs.push('limit=80');
        if (overdueOnly) qs.push('overdue=1');
        if (scope) qs.push('scope=' + encodeURIComponent(scope));
        const j = await api('/api/portal/dispatch?' + qs.join('&'));
        const tasks = (j.tasks || []).filter((t) => !['completed','cancelled'].includes(String(t.status || '')));
        state.dispatch = tasks;
        if (!tasks.length) {
          tb.innerHTML = '<tr><td colspan="5" class="muted">No tasks.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        const meId = state.me?.user?.id;
        const role = String(state.me?.profile?.role || '');

        tb.innerHTML = tasks.map((t) => {
          const meta = t.meta && typeof t.meta === 'object' ? t.meta : {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = String(t.status || '');
          const due = dispatchDue(t);
          const overdue = isOverdue(t) ? '<span class="badge warn">overdue</span>' : '';
          const escalated = meta.escalatedAt ? '<span class="badge warn">escalated</span>' : '';
          const canClaim = !t.assigned_user_id && st === 'open' && role && t.assigned_role === role;
          const canComplete = (t.assigned_user_id && meId && t.assigned_user_id === meId) || String(state.me?.profile?.role || '') === 'manager';
          const claimBtn = canClaim ? `<button class="btn small" data-task-claim="${t.id}">Claim</button>` : '';
          const doneBtn = canComplete ? `<button class="btn secondary small" data-task-done="${t.id}">Done</button>` : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(due)}</td>
              <td>${escapeHtml(String(t.title || ''))} ${overdue} ${escalated}</td>
              <td class="muted">${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>${claimBtn} ${doneBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-task-claim]')){
          btn.addEventListener('click', async () => {
            if (msgEl) msgEl.textContent = '';
            try{
              const id = Number(btn.dataset.taskClaim);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, assignedUserId: state.me.user.id, status: 'assigned' } });
              await loadDispatchInto(tbodyId, msgId);
              setBadge('ok', 'claimed');
            } catch(e){
              if (msgEl) msgEl.textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-task-done]')){
          btn.addEventListener('click', async () => {
            if (msgEl) msgEl.textContent = '';
            try{
              const id = Number(btn.dataset.taskDone);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'completed' } });
              await loadDispatchInto(tbodyId, msgId);
              setBadge('ok', 'done');
            } catch(e){
              if (msgEl) msgEl.textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadDispatchManager(){
      const tb = $('dispatchTbody');
      $('dispatchMsg').textContent = '';
      if (!tb) return;
      setBadge('warn', 'loading');
      try{
        const statusFilter = String($('dispatchStatus')?.value || '').trim();
        const roleFilter = String($('dispatchRole')?.value || '').trim();
        const overdueOnly = !!$('dispatchOverdueOnly')?.checked;

        const qs = [];
        qs.push('limit=180');
        if (statusFilter) qs.push('status=' + encodeURIComponent(statusFilter));
        if (roleFilter) qs.push('assignedRole=' + encodeURIComponent(roleFilter));
        if (overdueOnly) qs.push('overdue=1');

        const j = await api('/api/portal/dispatch?' + qs.join('&'));
        let tasks = (j.tasks || []);
        if (!statusFilter) {
          // Default view: show open/assigned only.
          tasks = tasks.filter((t) => ['open', 'assigned'].includes(String(t.status || '')));
        }
        state.dispatch = tasks;
        if (!tasks.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No tasks.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = tasks.map((t) => {
          const meta = t.meta && typeof t.meta === 'object' ? t.meta : {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = String(t.status || '');
          const due = dispatchDue(t);
          const overdue = isOverdue(t) ? '<span class="badge warn">overdue</span>' : '';
          const escalated = meta.escalatedAt ? '<span class="badge warn">escalated</span>' : '';
          const assigned = t.assigned_user_id ? String(t.assigned_user_id).slice(0, 8) : '';
          const canEscalate = isOverdue(t) && !meta.escalatedAt && !['completed','cancelled'].includes(st);
          const escBtn = canEscalate ? `<button class="btn secondary small" data-mgr-escalate="${t.id}">Escalate</button>` : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(due)}</td>
              <td>${escapeHtml(String(t.title || ''))} ${overdue} ${escalated}</td>
              <td><span class="badge">${escapeHtml(String(t.assigned_role || ''))}</span></td>
              <td class="muted" style="font-family:var(--mono); font-size:12px;">${escapeHtml(assigned)}</td>
              <td class="muted">${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>
                <button class="btn secondary small" data-mgr-assign="${t.id}">Assign</button>
                <button class="btn secondary small" data-mgr-done="${t.id}">Done</button>
                <button class="btn secondary small" data-mgr-cancel="${t.id}">Cancel</button>
                ${escBtn}
              </td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-mgr-assign]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrAssign);
              const userId = prompt('Assign user id (uuid) or blank to clear:', '');
              if (userId == null) return;
              const nextAssigned = String(userId).trim() || null;
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, assignedUserId: nextAssigned, status: nextAssigned ? 'assigned' : 'open' } });
              await loadDispatchManager();
              setBadge('ok', 'assigned');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-mgr-done]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrDone);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'completed' } });
              await loadDispatchManager();
              setBadge('ok', 'done');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-mgr-cancel]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrCancel);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'cancelled' } });
              await loadDispatchManager();
              setBadge('ok', 'cancelled');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-mgr-escalate]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrEscalate);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, action: 'escalate' } });
              await loadDispatchManager();
              setBadge('ok', 'escalated');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('dispatchMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createDispatchTask(){
      $('dispatchCreateMsg').textContent = '';
      try{
        const assignedRole = String($('dispatchAssignedRole').value || '').trim();
        if (!assignedRole) throw new Error('Select an assigned role');
        const title = String($('dispatchTitle').value || '').trim();
        if (!title) throw new Error('Enter a title');

        const leadIdRaw = String($('dispatchLeadId').value || '').trim();
        const leadId = leadIdRaw ? Number(leadIdRaw) : null;
        const body = {
          leadId: leadId || null,
          title,
          assignedRole,
          assignedUserId: String($('dispatchAssignedUserId').value || '').trim() || null,
          dueDate: $('dispatchDueDate').value || null,
          dueTime: $('dispatchDueTime').value || '',
          priority: Number($('dispatchPriority').value || 0),
          notes: String($('dispatchNotes').value || ''),
        };

        await api('/api/portal/dispatch', { method:'POST', body });
        $('dispatchTitle').value = '';
        $('dispatchNotes').value = '';
        $('dispatchAssignedUserId').value = '';
        await loadDispatchManager();
        setBadge('ok', 'created');
      } catch(e){
        $('dispatchCreateMsg').textContent = String(e.message || e);
      }
    }

    async function scanDispatchOverdue(){
      $('dispatchMsg').textContent = '';
      try{
        const j = await api('/api/portal/dispatch_scan', { method:'POST', body: {} });
        $('dispatchMsg').textContent = `Scanned ${Number(j.scanned || 0)}; escalated ${Number(j.escalated || 0)}`;
        await loadDispatchManager();
        setBadge('ok', 'scanned');
      } catch(e){
        $('dispatchMsg').textContent = String(e.message || e);
      }
    }

    async function aiResearch(){
      $('researchMsg').textContent = '';
      $('researchBox').classList.add('hide');
      try{
        const lead = requireSelectedLead('AI research');
        const question = $('researchQ').value.trim();
        const j = await api('/api/portal/ai/research', {
          method: 'POST',
          body: { leadId: lead.id, question },
        });
        const r = j.research || {};
        $('researchSummary').value = String(r.summary || '');
        $('researchTalking').value = Array.isArray(r.talkingPoints) ? r.talkingPoints.join('\n') : '';
        $('researchObjections').value = Array.isArray(r.likelyObjections) ? r.likelyObjections.join('\n') : '';
        $('researchNext').value = Array.isArray(r.nextSteps) ? r.nextSteps.join('\n') : '';
        $('researchBox').classList.remove('hide');
      } catch(e){
        $('researchMsg').textContent = String(e.message || e);
      }
    }

    function fillTierPrice(){
      const tier = String($('closePackage').value || '');
      const map = { tier_1: 1000, tier_2: 2000, tier_3: 3000 };
      const v = map[tier];
      if (v) $('closePackagePrice').value = String(v);
    }

    async function submitClose(){
      $('closeMsg').textContent = '';
      try{
        const lead = requireSelectedLead('Close');

        const disposition = String($('closeDisposition').value || 'follow_up');
        const payload = {
          disposition,
          closedOn: $('closeDate').value || null,
          packageTier: $('closePackage').value || null,
          packagePrice: Number($('closePackagePrice').value || 0),
          initialPayment: Number($('closeInitial').value || 0),
          termMonths: Number($('closeTerm').value || 0),
          monthlyPricing: Number($('closeMonthly').value || 0),
          contractSendDate: $('closeContractSend').value || null,
          notes: $('closeNotes').value || '',
        };

        const nextStatus = disposition === 'won' ? 'won' : (disposition === 'lost' ? 'lost' : 'working');

        await api('/api/portal/close', {
          method: 'POST',
          body: { leadId: lead.id, status: nextStatus, payload },
        });

        $('closeMsg').textContent = '';
        setBadge('ok', 'submitted');
      } catch(e){
        $('closeMsg').textContent = String(e.message || e);
      }
    }

    function fmtDate(d){
      const s = String(d || '');
      if (!s) return '';
      return s.slice(0,10);
    }

    function fmtTime(t){
      const s = String(t || '');
      if (!s) return '';
      return s;
    }

    async function loadAppointments(){
      if (!$('apptsTbody')) return;
      setBadge('warn', 'loading');
      $('apptsMsg').textContent = '';
      try{
        const j = await api('/api/portal/appointments?limit=80');
        const appts = j.appointments || [];
        state.appointments = appts;

        const tb = $('apptsTbody');
        if (!appts.length){
          tb.innerHTML = '<tr><td colspan="5" class="muted">No appointments yet.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = appts.map((a) => {
          const meta = a.meta || {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = a.status || '';
          const doneBtn = st !== 'completed'
            ? `<button class="btn secondary small" data-appt-done="${a.id}">Mark completed</button>`
            : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(fmtDate(a.event_date))}</td>
              <td class="muted">${escapeHtml(fmtTime(a.start_time))}</td>
              <td>${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>${doneBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-appt-done]')){
          btn.addEventListener('click', async () => {
            $('apptsMsg').textContent = '';
            try{
              const id = Number(btn.dataset.apptDone);
              await api('/api/portal/appointments', { method:'PATCH', body: { id, status:'completed' } });
              await loadAppointments();
            } catch(e){
              $('apptsMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('apptsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadCloserQueue(){
      if (!$('closerQueueTbody')) return;
      $('closerQueueMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/queue?kind=closer&limit=60');
        const leads = j.leads || [];
        const tb = $('closerQueueTbody');
        if (!leads.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No pipeline items.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = leads.map((l) => {
          const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
          const prop = l.property_name || l.company || '';
          const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
          return `
            <tr>
              <td><span class="badge">${l.id}</span></td>
              <td>${escapeHtml(name)}</td>
              <td class="muted">${escapeHtml(prop)}</td>
              <td><span class="badge">${escapeHtml(l.status || '')}</span></td>
              <td class="muted">${escapeHtml(String(l.priority ?? 0))}</td>
              <td class="muted">${escapeHtml(fu)}</td>
              <td><button class="btn secondary small" data-closer-pick="${l.id}">Select</button></td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-closer-pick]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.closerPick);
            const l = leads.find((x) => Number(x.id) === id) || null;
            state.selectedLead = l;
            setSelectedLeadLine();
            loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('closerQueueMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function scheduleAppointment(){
      $('scheduleApptMsg').textContent = '';
      try{
        const lead = requireSelectedLead('Appointment');
        const eventDate = $('apptDate').value;
        const startTime = $('apptStart').value;
        if (!eventDate) throw new Error('Pick a date');
        if (!startTime) throw new Error('Pick a start time');

        await api('/api/portal/appointments', {
          method:'POST',
          body: {
            leadId: lead.id,
            eventDate,
            startTime,
            notes: $('apptNotes').value || '',
          }
        });

        $('apptNotes').value = '';
        $('scheduleApptMsg').textContent = '';
        await loadAppointments();
        setBadge('ok', 'scheduled');
      } catch(e){
        $('scheduleApptMsg').textContent = String(e.message || e);
      }
    }

    async function loadAvailability(){
      if (!$('availNotes')) return;
      $('availMsg').textContent = '';
      try{
        const j = await api('/api/portal/availability');
        const notes = String(j.availability?.notes || '');
        $('availNotes').value = notes;
      } catch(e){
        $('availMsg').textContent = String(e.message || e);
      }
    }

    async function saveAvailability(){
      $('availMsg').textContent = '';
      try{
        await api('/api/portal/availability', {
          method: 'PUT',
          body: { notes: $('availNotes').value || '' }
        });
        setBadge('ok', 'saved');
      } catch(e){
        $('availMsg').textContent = String(e.message || e);
      }
    }

    function setSelectedEvent(eventObj){
      state.selectedEvent = eventObj || null;
      const e = state.selectedEvent;
      $('selectedEventLine').textContent = e ? `#${e.id} • ${e.title || ''} • ${(e.event_date || '')}`.trim() : 'None';
      $('eventRecapWrap').classList.toggle('hide', !e);
      if (e) loadRecaps(e.id).catch(()=>{});
    }

    async function loadRecaps(eventId){
      $('recapMsg').textContent = '';
      $('recapsList').textContent = '';
      try{
        const j = await api('/api/portal/event_recaps?eventId=' + encodeURIComponent(String(eventId)));
        const recaps = j.recaps || [];
        if (!recaps.length) {
          $('recapsList').innerHTML = '<div class="muted small">No recaps yet.</div>';
          return;
        }
        $('recapsList').innerHTML = recaps.map((r) => {
          const p = r.payload || {};
          const media = Array.isArray(r.media_urls) ? r.media_urls : [];
          const meta = [
            p.attendanceEstimate != null ? ('attendance ' + p.attendanceEstimate) : '',
            p.rating ? ('rating ' + p.rating) : '',
            p.photosUploaded ? ('photos ' + p.photosUploaded) : '',
          ].filter(Boolean).join(' • ');
          const mediaHtml = media.length ? (`<div class="small" style="margin-top:8px;">${media.map((u) => `<div><a href="${escapeHtml(u)}" target="_blank" rel="noopener">${escapeHtml(u)}</a></div>`).join('')}</div>`) : '';
          return `
            <div class="card" style="background:#fff; margin-bottom:10px;">
              <div class="bd">
                <div class="muted small">${escapeHtml(r.created_at || '')}</div>
                ${meta ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(meta)}</div>` : ''}
                ${r.recap ? `<div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(r.recap)}</div>` : ''}
                ${mediaHtml}
              </div>
            </div>
          `;
        }).join('');
      } catch(e){
        $('recapMsg').textContent = String(e.message || e);
      }
    }

    async function submitRecap(){
      $('recapMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');

        const mediaUrls = String($('recapMedia').value || '')
          .split('\n')
          .map((x) => x.trim())
          .filter(Boolean)
          .slice(0, 30);

        const payload = {
          attendanceEstimate: $('recapAttendance').value ? Number($('recapAttendance').value) : null,
          rating: $('recapRating').value || null,
          issuesReported: $('recapIssues').value || null,
          issuesDetails: $('recapIssuesDetails').value || '',
          photosUploaded: $('recapPhotos').value || null,
          hostNotes: $('recapNotes').value || '',
        };

        await api('/api/portal/event_recaps', {
          method: 'POST',
          body: {
            eventId: e.id,
            recap: payload.hostNotes || payload.issuesDetails || '',
            mediaUrls,
            payload,
          },
        });

        $('recapMsg').textContent = '';
        await loadRecaps(e.id);
      } catch(e){
        $('recapMsg').textContent = String(e.message || e);
      }
    }

    function fmtMoney(cents){
      const n = Number(cents || 0) / 100;
      return n.toLocaleString(undefined, { style:'currency', currency:'USD' });
    }

    async function loadLeads(){
      setBadge('warn', 'loading');
      $('leadsMsg').textContent = '';

      const q = $('leadQ').value.trim();
      const status = $('leadStatus').value;
      const qs = new URLSearchParams();
      if (q) qs.set('q', q);
      if (status) qs.set('status', status);
      qs.set('limit', '120');

      try{
        const j = await api('/api/portal/leads?' + qs.toString());
        state.leads = j.leads || [];

        const tb = $('leadsTbody');
        tb.innerHTML = state.leads.map((l) => {
          const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
          const prop = l.property_name || l.company || '';
          const city = [l.city, l.state].filter(Boolean).join(', ');
          const asg = l.assigned_role || '';
          return `
            <tr>
              <td><span class="badge">${l.id}</span></td>
              <td>${name}</td>
              <td>${prop}</td>
              <td class="muted">${city}</td>
              <td><span class="badge">${l.status}</span></td>
              <td class="muted">${asg}</td>
              <td><button class="btn secondary small" data-pick="${l.id}">Select</button></td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-pick]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.pick);
            state.selectedLead = state.leads.find((x) => Number(x.id) === id) || null;
            setSelectedLeadLine();
            loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
            loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
            setTab(state.pickLeadReturnTab || 'calls');
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('leadsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createLead(){
      $('createLeadMsg').textContent = '';
      const cityState = $('nlCityState').value.trim();
      let city = cityState, st = '';
      if (cityState.includes(',')){
        const parts = cityState.split(',');
        city = (parts[0] || '').trim();
        st = (parts[1] || '').trim();
      }

      try{
        await api('/api/portal/leads', {
          method: 'POST',
          body: {
            firstName: $('nlFirst').value,
            lastName: $('nlLast').value,
            phone: $('nlPhone').value,
            email: $('nlEmail').value,
            propertyName: $('nlProp').value,
            city,
            state: st,
            notes: $('nlNotes').value,
            status: 'new',
          }
        });
        $('newLeadBox').hidden = true;
        await loadLeads();
      } catch(e){
        $('createLeadMsg').textContent = String(e.message || e);
      }
    }

    async function logCall(){
      $('callMsg').textContent = '';
      if (!state.selectedLead) return $('callMsg').textContent = 'Select a lead first (from Leads tab).';

      const outcome = $('callOutcome').value;
      if (!outcome) return $('callMsg').textContent = 'Pick an outcome.';

      try{
        const followup = String($('callFollowup').value || '').trim();
        await api('/api/portal/calls', {
          method: 'POST',
          body: {
            leadId: state.selectedLead.id,
            outcome,
            notes: $('callNotes').value,
            payload: followup ? { followup } : {},
          }
        });

        const nextStatus = $('callLeadStatus').value;
        if (nextStatus){
          await api('/api/portal/leads', { method:'PATCH', body: { id: state.selectedLead.id, status: nextStatus } });
        }

        if (followup) {
          const nextMeta = Object.assign({}, (state.selectedLead.meta && typeof state.selectedLead.meta === 'object') ? state.selectedLead.meta : {});
          nextMeta.followup = followup;
          await api('/api/portal/leads', { method:'PATCH', body: { id: state.selectedLead.id, meta: nextMeta } });
        }

        $('callMsg').textContent = '';
        setBadge('ok', 'saved');
        loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
      } catch(e){
        $('callMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function aiFollowup(){
      $('callMsg').textContent = '';
      $('followupBox').classList.add('hide');

      if (!state.selectedLead) return $('callMsg').textContent = 'Select a lead first (from Leads tab).';
      const outcome = $('callOutcome').value;

      setBadge('warn', 'thinking');
      try{
        const j = await api('/api/portal/ai/followup', {
          method: 'POST',
          body: {
            leadId: state.selectedLead.id,
            outcome,
            notes: $('callNotes').value,
          }
        });

        const fu = j.followup || {};
        $('fuSubject').value = fu.emailSubject || '';
        $('fuEmail').value = fu.emailBody || '';
        $('fuSms').value = fu.sms || '';
        $('fuNext').value = fu.nextStep || '';
        $('followupBox').classList.remove('hide');

        setBadge('ok', 'ready');
      } catch(e){
        $('callMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadEvents(){
      setBadge('warn', 'loading');
      $('eventsMsg').textContent = '';

      // Reset selection when reloading the list.
      setSelectedEvent(null);

      const status = $('eventStatus').value;
      const qs = new URLSearchParams();
      if (status) qs.set('status', status);
      qs.set('limit', '120');

      try{
        const j = await api('/api/portal/events?' + qs.toString());
        state.events = j.events || [];

        const tb = $('eventsTbody');
        tb.innerHTML = state.events.map((ev) => {
          const date = ev.event_date || '';
          const city = [ev.city, ev.state].filter(Boolean).join(', ');
          const asg = ev.assigned_role || '';
          const selectBtn = `<button class="btn secondary small" data-pick-event="${ev.id}">Select</button>`;

          const myRole = String(state.me?.profile?.role || '');
          const canAccept = !ev.assigned_user_id && asg && (myRole === 'manager' || myRole === asg) && String(ev.status || 'open') === 'open';
          const acceptBtn = canAccept ? `<button class="btn small" data-accept-event="${ev.id}">Accept</button>` : '';

          return `
            <tr>
              <td><span class="badge">${ev.id}</span></td>
              <td class="muted">${date}</td>
              <td>${escapeHtml(ev.title || '')}</td>
              <td class="muted">${escapeHtml(city)}</td>
              <td><span class="badge">${escapeHtml(ev.status || '')}</span></td>
              <td class="muted">${asg}</td>
              <td>${selectBtn} ${acceptBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-pick-event]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.pickEvent);
            const ev = state.events.find((x) => Number(x.id) === id) || null;
            setSelectedEvent(ev);
          });
        }

        for (const btn of tb.querySelectorAll('button[data-accept-event]')){
          btn.addEventListener('click', async () => {
            $('eventsMsg').textContent = '';
            try{
              const id = Number(btn.dataset.acceptEvent);
              await api('/api/portal/events', {
                method: 'PATCH',
                body: { id, assignedUserId: state.me.user.id, status: 'assigned' },
              });
              await loadEvents();
            } catch(e){
              $('eventsMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('eventsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createEvent(){
      $('createEventMsg').textContent = '';
      try{
        await api('/api/portal/events', {
          method: 'POST',
          body: {
            title: $('neTitle').value,
            eventDate: $('neDate').value,
            city: $('neCity').value,
            state: $('neState').value,
            notes: $('neNotes').value,
            status: 'open',
            assignedRole: 'event_host',
          }
        });
        $('newEventBox').hidden = true;
        await loadEvents();
      } catch(e){
        $('createEventMsg').textContent = String(e.message || e);
      }
    }

    async function loadPayouts(){
      setBadge('warn', 'loading');
      $('payoutsMsg').textContent = '';
      try{
        const j = await api('/api/portal/payouts?limit=120');
        const payouts = j.payouts || [];
        $('payoutsTbody').innerHTML = payouts.map((p) => `
          <tr>
            <td class="muted">${(p.created_at || '').slice(0,10)}</td>
            <td>${fmtMoney(p.amount_cents)}</td>
            <td><span class="badge">${p.status}</span></td>
            <td class="muted">${p.description || ''}</td>
          </tr>
        `).join('');
        setBadge('ok', 'loaded');
      } catch(e){
        $('payoutsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadDocs(){
      setBadge('warn', 'loading');
      $('docsMsg').textContent = '';
      try{
        const j = await api('/api/portal/docs?limit=80');
        const docs = j.docs || [];
        $('docsList').innerHTML = docs.map((d) => {
          const role = d.audience_role ? `<span class="badge">${d.audience_role}</span>` : `<span class="badge ok">all</span>`;
          const content = (d.content || '').slice(0, 2000);
          return `
            <div class="card" style="background: #fff; margin-bottom:12px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between;">
                  <div style="font-weight:800;">${d.title}</div>
                  ${role}
                </div>
                <div style="height:10px"></div>
                <pre style="white-space:pre-wrap; margin:0; font-family: var(--mono); font-size:12px; color: var(--text);">${escapeHtml(content)}</pre>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted">No docs yet.</div>';
        setBadge('ok', 'loaded');
      } catch(e){
        $('docsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createDoc(){
      $('createDocMsg').textContent = '';
      try{
        await api('/api/portal/docs', {
          method: 'POST',
          body: {
            title: $('docTitle').value,
            audienceRole: $('docAudience').value,
            content: $('docContent').value,
            source: 'manual_paste',
            meta: { format: 'csv_or_text' }
          }
        });
        $('docTitle').value = '';
        $('docAudience').value = '';
        $('docContent').value = '';
        await loadDocs();
      } catch(e){
        $('createDocMsg').textContent = String(e.message || e);
      }
    }

    async function loadUsers(){
      $('usersMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/users');
        const users = (j.users || []);
        state.usersCache = users;
        $('usersTbody').innerHTML = users.map((u) => `
          <tr>
            <td>${u.fullName || ''}</td>
            <td class="muted">${u.email || ''}</td>
            <td><span class="badge">${u.role}</span></td>
            <td class="muted" style="font-family:var(--mono); font-size:12px;">${u.userId}</td>
            <td><button class="btn secondary small" data-edit-user="${u.userId}">Edit</button></td>
          </tr>
        `).join('');

        for (const btn of $('usersTbody').querySelectorAll('button[data-edit-user]')){
          btn.addEventListener('click', async () => {
            $('usersMsg').textContent = '';
            try{
              const userId = String(btn.dataset.editUser || '').trim();
              const current = users.find((x) => String(x.userId) === userId);
              const nextRole = prompt('Role for user:', current?.role || '');
              if (nextRole == null) return;
              const nextName = prompt('Full name:', current?.fullName || '');
              if (nextName == null) return;
              await api('/api/portal/users', { method:'PATCH', body: { userId, role: nextRole, fullName: nextName } });
              await loadUsers();
              setBadge('ok', 'updated');
            } catch(e){
              $('usersMsg').textContent = String(e.message || e);
            }
          });
        }
        setBadge('ok', 'loaded');
      } catch(e){
        $('usersMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    function escapeHtml(s){
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function on(id, eventName, handler){
      const el = $(id);
      if (el) el.addEventListener(eventName, handler);
    }

    async function boot(){
      $('authMsg').textContent = '';
      $('authOk').textContent = '';

      // Restore prior session token if present.
      state.token = localStorage.getItem('portal_access_token') || '';
      await refreshMe();
    }

    on('loginBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      setAuthLoading(true, 'Signing in…');
      try{
        const email = $('email').value.trim();
        const password = $('password').value;

        const r = await withTimeout(fetch('/api/portal/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        }), 15000, 'login_timeout');

        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          throw new Error(det ? (msg + ': ' + det) : msg);
        }

        const token = String(j?.session?.access_token || '').trim();
        if (!token) throw new Error('login_failed');

        state.token = token;
        localStorage.setItem('portal_access_token', token);

        setAuthLoading(false);
        $('authOk').textContent = 'Signed in.';
        await refreshMe();
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      } finally {
        setAuthLoading(false);
      }
    });

    on('signupBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      setAuthLoading(true, 'Creating account…');
      try{
        const email = $('email').value.trim();
        const password = $('password').value;

        const r = await withTimeout(fetch('/api/portal/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        }), 15000, 'signup_timeout');

        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          throw new Error(det ? (msg + ': ' + det) : msg);
        }

        const token = String(j?.session?.access_token || '').trim();
        if (!token) throw new Error('signup_failed');

        state.token = token;
        localStorage.setItem('portal_access_token', token);

        setAuthLoading(false);
        $('authOk').textContent = 'Account created.';
        await refreshMe();
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      } finally {
        setAuthLoading(false);
      }
    });


    on('logoutBtn', 'click', async () => {
      state.token = '';
      localStorage.removeItem('portal_access_token');
      await refreshMe();
    });

    on('refreshBtn', 'click', () => refreshMe().catch(() => {}));

    on('loadLeadsBtn', 'click', () => loadLeads().catch(() => {}));
    on('newLeadToggle', 'click', () => { $('newLeadBox').hidden = !$('newLeadBox').hidden; });
    on('createLeadBtn', 'click', () => createLead().catch(() => {}));

    on('closerPickLead', 'click', () => { state.pickLeadReturnTab = 'closer'; setTab('leads'); });
    on('pickFromLeads', 'click', () => { state.pickLeadReturnTab = 'calls'; setTab('leads'); });
    on('logCallBtn', 'click', () => logCall().catch(() => {}));
    on('aiFollowupBtn', 'click', () => aiFollowup().catch(() => {}));

    on('loadQueueBtn', 'click', () => loadQueue().catch(() => {}));
    on('loadDialerTimelineBtn', 'click', () => loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(() => {}));

    on('loadEventsBtn', 'click', () => loadEvents().catch(() => {}));
    on('newEventToggle', 'click', () => { $('newEventBox').hidden = !$('newEventBox').hidden; });
    on('createEventBtn', 'click', () => createEvent().catch(() => {}));

    on('closeSubmitBtn', 'click', () => submitClose().catch(() => {}));
    on('closeQuoteBtn', 'click', () => fillTierPrice());

    on('loadApptsBtn', 'click', () => loadAppointments().catch(() => {}));
    on('scheduleApptBtn', 'click', () => scheduleAppointment().catch(() => {}));
    on('saveAvailBtn', 'click', () => saveAvailability().catch(() => {}));

    on('loadCloserQueueBtn', 'click', () => loadCloserQueue().catch(() => {}));

    on('submitRecapBtn', 'click', () => submitRecap().catch(() => {}));
    on('closeRecapBtn', 'click', () => setSelectedEvent(null));

    on('loadPayoutsBtn', 'click', () => loadPayouts().catch(() => {}));

    on('loadUsersBtn', 'click', () => loadUsers().catch(() => {}));

    on('leadDetailRefreshBtn', 'click', () => loadTimelineInto('timelineList', 'timelineMsg').catch(() => {}));
    on('leadSaveBtn', 'click', () => saveLeadEdits().catch(() => {}));
    on('timelineAddBtn', 'click', () => addTimelineNote('timelineNote', 'timelineAddMsg', 'timelineList').catch(() => {}));

    on('loadStatsBtn', 'click', () => loadStats().catch(() => {}));
    on('mgrAssignBtn', 'click', () => managerAssignLead().catch(() => {}));
    on('loadTeamAvailBtn', 'click', () => loadTeamAvailability().catch(() => {}));

    on('loadDispatchBtn', 'click', () => loadDispatchManager().catch(() => {}));
    on('scanDispatchBtn', 'click', () => scanDispatchOverdue().catch(() => {}));
    on('dispatchCreateBtn', 'click', () => createDispatchTask().catch(() => {}));

    on('loadDialerTasksBtn', 'click', () => loadDispatchInto('dialerTasksTbody', 'dialerTasksMsg', { overdueOnly: !!$('dialerTasksOverdue')?.checked, scope: String($('dialerTasksScope')?.value || 'role') }).catch(() => {}));
    on('loadCloserTasksBtn', 'click', () => loadDispatchInto('closerTasksTbody', 'closerTasksMsg', { overdueOnly: !!$('closerTasksOverdue')?.checked, scope: String($('closerTasksScope')?.value || 'role') }).catch(() => {}));

    boot().catch((e) => {
      $('authMsg').textContent = String(e.message || e);
    });
  </script>
</body>
</html>
