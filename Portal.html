<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PureStay Portal</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- deploy: 2026-02-24T00:00:00Z -->
  <link rel="icon" href="brand/purestay_exact_SVG.svg" type="image/svg+xml">

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;800&family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0e0d0c;
      --bg:#ffffff;
      --muted:#6b6460;
      --border:#e7e1da;
      --card:#ffffff;
      --shadow:0 14px 38px rgba(0,0,0,.10);
      --radius: 16px;

      --maroon:#7A2E26;
      --maroon-700:#66271f;
      --gold:#C79A3B;
      --gold-700:#B78A2F;
      --ring:rgba(199,154,59,.38);

      --ok:#0f766e;
      --warn:#b45309;
      --bad:#b42318;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #f7f4f0;
      color:var(--ink);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:var(--maroon); text-decoration:none}
    a:hover{text-decoration:underline}

    .hide{display:none !important;}

    .auth{
      min-height: 100vh;
      display:grid;
      place-items:center;
      padding: 28px 16px;
    }

    .authCard{
      width: min(880px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
    }

    .authTop{display:flex; align-items:center; gap:14px;}
    .authTop img{height:52px; width:auto; display:block;}
    .authTop h1{margin:0; font-family: Fraunces, ui-serif, Georgia, serif; font-weight:800; font-size:26px; letter-spacing:.2px;}
    .authTop .sub{color:var(--muted); font-size:13px; margin-top:2px;}

    .pill{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:12px; font-weight:700; color:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#fff;}

    .btn{
      appearance:none;
      border: 1px solid transparent;
      background: var(--maroon);
      color: #fff;
      padding: 11px 14px;
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 18px 44px rgba(122,46,38,.18); background: var(--maroon-700);}
    .btn:focus-visible{outline:none; box-shadow: 0 0 0 3px var(--ring);}
    .btn.secondary{
      background: #fff;
      border-color: var(--border);
      color: var(--maroon);
      box-shadow: none;
    }
    .btn.secondary:hover{transform:none; box-shadow:none; background:#fff; border-color: rgba(199,154,59,.55)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .container{max-width: 1180px; margin:0 auto; padding: 18px 18px;}

    .appbar{
      position: sticky;
      top:0;
      z-index: 10;
      background: rgba(255,255,255,.88);
      backdrop-filter: saturate(180%) blur(10px);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .appbarInner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding: 10px 18px; max-width:1180px; margin:0 auto;}
    .appbrand{display:flex; align-items:center; gap:12px;}
    .appbrand img{height:46px; width:auto; display:block;}
    .appbrand .t{font-weight: 900; letter-spacing:.2px;}

    .layout{max-width:1180px; margin:0 auto; display:grid; grid-template-columns: var(--sbw, 240px) 1fr; gap: 16px; padding: 16px 18px 28px;}
    @media (max-width: 900px){ .layout{grid-template-columns: 1fr;} }

    body.sbCollapsed .layout{--sbw:72px;}

    main{min-width:0;}

    .sidebar{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      position: sticky;
      top: 78px;
      max-height: calc(100vh - 98px);
      overflow:auto;
      min-width:0;
    }

    @media (max-width: 900px){
      .sidebar{position:relative; top:auto; max-height:none;}
    }

    .navTitle{font-size:12px; color:var(--muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; padding: 6px 8px 10px;}
    .navBtn{
      width: 100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      font-weight: 900;
      color: #3a2f2c;
      transition: background .15s ease, border-color .15s ease;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .navBtn:hover{background: rgba(199,154,59,.10); border-color: rgba(199,154,59,.22)}
    .navBtn.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}

    .navIco{width:22px; height:22px; border:1px solid var(--border); border-radius:8px; display:grid; place-items:center; font-size:12px; color:var(--muted); flex:0 0 auto; background:#fff;}
    .navLbl{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    body.sbCollapsed .navTitle{display:none;}
    body.sbCollapsed .navLbl{display:none;}
    body.sbCollapsed .sidebar{padding:10px;}
    body.sbCollapsed .ddBtn{padding:10px 10px; justify-content:center;}
    body.sbCollapsed .ddBtn span:first-child{display:none;}
    body.sbCollapsed .ddBtn span:last-child{margin:0;}

    .iconBtn{appearance:none; border:1px solid var(--border); background:#fff; color: var(--maroon); border-radius: 12px; padding: 10px 12px; cursor:pointer; font-weight:900;}
    .iconBtn:hover{border-color: rgba(199,154,59,.55)}

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .card .hd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .card .bd{padding:16px;}

    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      background: #fff;
      color: var(--ink);
      border:1px solid var(--border);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{box-shadow: 0 0 0 3px var(--ring); border-color: rgba(199,154,59,.55)}
    textarea{min-height: 120px; resize: vertical;}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .two{grid-template-columns:1fr;} }

    table{width:100%; border-collapse: collapse; font-size:13px;}
    th, td{padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:top;}
    th{color:var(--muted); font-weight:600; text-align:left; font-size:12px;}

    .badge{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:12px; font-weight:800; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:#fff}
    .badge.dot{padding:0; width:12px; height:12px; border-radius:999px; display:inline-block; border-width:2px; background:#fff;}
    .badge.ok{border-color: rgba(15,118,110,.25); color: rgba(15,118,110,1)}
    .badge.warn{border-color: rgba(180,83,9,.25); color: rgba(180,83,9,1)}

    .err{color: var(--bad); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:12px; white-space: pre-wrap;}
    .ok{color: var(--ok); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:12px; white-space: pre-wrap;}

    .segTabs{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .segBtn{appearance:none; border:1px solid var(--border); background:#fff; padding:9px 12px; border-radius:999px; font-weight:900; color:#3a2f2c; cursor:pointer;}
    .segBtn.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}

    .dd{position:relative;}
    .ddBtn{width:100%; appearance:none; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:12px; font-weight:900; color:#3a2f2c; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .ddBtn:focus-visible{outline:none; box-shadow: 0 0 0 3px var(--ring); border-color: rgba(199,154,59,.55)}
    .ddMenu{position:absolute; left:0; right:0; top: calc(100% + 8px); background:#fff; border:1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); padding: 6px; z-index: 40; max-height: 320px; overflow:auto;}
    .ddItem{width:100%; text-align:left; appearance:none; border:1px solid transparent; background:transparent; padding:10px 10px; border-radius:12px; cursor:pointer; font-weight:900; color:#3a2f2c;}
    .ddItem:hover{background: rgba(199,154,59,.10); border-color: rgba(199,154,59,.22)}
    .ddItem.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}

    .slotGrid{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .slotBtn{appearance:none; border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:999px; font-weight:900; color:#3a2f2c; cursor:pointer; font-size:12px;}
    .slotBtn.active{background: rgba(15,118,110,.08); border-color: rgba(15,118,110,.22); color: rgba(15,118,110,1)}
    .calGrid{display:grid; grid-template-columns: repeat(7, 1fr); gap: 8px;}
    .calCell{border:1px solid var(--border); background:#fff; border-radius: 12px; padding: 10px 10px; cursor:pointer; min-height: 42px;}
    .calCell:hover{border-color: rgba(199,154,59,.55)}
    .calCell.muted{opacity:.55;}
    .calCell.active{background: rgba(122,46,38,.06); border-color: rgba(122,46,38,.22)}

    .availGridWrap{overflow:auto; border:1px solid var(--border); border-radius: 14px; background:#fff;}
    .availWeekGrid{display:grid; grid-template-columns: 96px repeat(7, minmax(130px, 1fr)); min-width: 960px;}
    .availHeadCell{position: sticky; top: 0; z-index: 2; background:#fff; border-bottom:1px solid var(--border); padding:10px 10px; font-size:12px; color:var(--muted); font-weight:900;}
    .availHeadCell:first-child{left:0; z-index: 3; position: sticky;}
    .availTimeCell{position: sticky; left: 0; z-index: 1; background:#fff; border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:10px 10px; font-family: var(--mono); font-size:12px; color:var(--muted);}
    .availSlotCell{border-bottom:1px solid var(--border); border-right:1px solid var(--border); padding:6px; background:#fff;}
    .availSlotBtn{width:100%; height:34px; appearance:none; border:1px solid rgba(0,0,0,.06); background: rgba(15,118,110,.04); border-radius: 10px; cursor:pointer;}
    .availSlotBtn:hover{border-color: rgba(199,154,59,.35)}
    .availSlotBtn.active{background: rgba(15,118,110,.18); border-color: rgba(15,118,110,.28)}
    .availSlotBtn[disabled]{cursor:not-allowed; opacity:.6}

    .stageBar{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .stageBtn{appearance:none; border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:900; color:#3a2f2c; display:flex; align-items:center; gap:8px;}
    .stageBtn:hover{border-color: rgba(199,154,59,.55)}
    .stageBtn.active{background: rgba(15,118,110,.08); border-color: rgba(15,118,110,.22); color: rgba(15,118,110,1)}
    .stageCount{font-family: var(--mono); font-size:12px; color: var(--muted); font-weight:900;}

    .pipe{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .pipeStage{display:flex; align-items:center; gap:10px;}
    .pipeNode{appearance:none; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius: 14px; cursor:pointer; box-shadow: none; display:flex; align-items:center; gap:10px; font-weight:900; color:#3a2f2c;}
    .pipeNode:hover{border-color: rgba(199,154,59,.55)}
    .pipeCount{font-family: var(--mono); font-size:12px; color: var(--muted); font-weight:900;}
    .pipeLine{height:2px; width:28px; background: rgba(0,0,0,.10); border-radius:999px;}

    .modalBackdrop{position:fixed; inset:0; background: rgba(0,0,0,.38); z-index: 80; display:none; padding: 20px;}
    .modalBackdrop.show{display:block;}
    .modal{max-width: 1040px; margin: 30px auto; background:#fff; border:1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow); overflow:hidden;}
    .modalHd{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; border-bottom:1px solid var(--border);}
    .modalHd .t{font-weight:900;}
    .modalBd{padding:16px;}
    .modalTwo{display:grid; grid-template-columns: 1fr 1fr; gap:12px; min-width:0;}
    @media (max-width: 860px){ .modalTwo{grid-template-columns: 1fr;} }
    .modalList{border:1px solid var(--border); border-radius: 14px; overflow:auto; max-height: 420px;}
    .modalList button{width:100%; text-align:left; background:#fff; border:0; border-bottom:1px solid var(--border); padding:10px 12px; cursor:pointer;}
    .modalList button:hover{background: rgba(199,154,59,.10)}
    .modalList button.active{background: rgba(15,118,110,.08)}
    .modalDetail{border:1px solid var(--border); border-radius: 14px; padding:12px; min-width:0;}
    .modalDetail .kv{display:grid; grid-template-columns: 120px 1fr; gap:8px 10px; font-size:13px;}
    .modalDetail .kv div:nth-child(odd){color:var(--muted); font-weight:800;}
    .modalDetail .kv div:nth-child(even){word-break:break-word;}

    .spin{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.14);
      border-top-color: rgba(122,46,38,.95);
      display: inline-block;
      vertical-align: -2px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .small{font-size:12px;}
  </style>
</head>
<body>
  <div id="authView" class="auth">
    <div class="authCard">
      <div class="authTop">
        <img src="brand/purestay_exact_SVG.svg" alt="PureStay" />
        <div>
          <h1>Portal</h1>
          <div class="sub">Sign in to continue</div>
        </div>
      </div>

      <div style="height:16px"></div>
      <div class="two">
        <div>
          <label>Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="you@company.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row" style="justify-content:flex-start; gap:10px;">
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="signupBtn" class="btn secondary" type="button">Create account</button>
      </div>
      <div style="height:12px"></div>
      <div id="authMsg" class="err"></div>
      <div id="authOk" class="ok"></div>
    </div>
  </div>

  <div id="appView" class="hide">
    <div class="appbar">
      <div class="appbarInner">
        <div class="appbrand">
          <button id="sidebarToggle" class="iconBtn" type="button" aria-label="Toggle sidebar">☰</button>
          <img src="brand/purestay_exact_SVG.svg" alt="PureStay" />
          <div>
            <div class="t">Portal</div>
            <div class="muted small" id="roleLine">—</div>
          </div>
        </div>
        <div class="row">
          <div id="appUser" class="pill">—</div>
          <button id="logoutBtn" class="btn secondary">Logout</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <nav class="sidebar">
        <div id="nav"></div>
      </nav>

      <main>
        <section class="card" id="appCard">
      <div class="hd">
        <h2 id="viewTitle">Overview</h2>
        <div class="row">
          <span class="badge dot" id="viewBadge" aria-label="status"></span>
          <button id="refreshBtn" class="btn secondary hide">Refresh</button>
        </div>
      </div>
      <div class="bd">
        <div id="viewOverview">
          <div class="muted">Sign in to view your dashboard.</div>
        </div>

        <div id="viewAccounts" class="hide">
          <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
            <div>
              <div style="font-weight:900;">Accounts</div>
              <div class="muted small">Zero-friction account management</div>
            </div>
            <div class="row" style="gap:8px;">
              <button id="accountsRefreshBtn" class="btn secondary" type="button">Refresh</button>
              <button id="accountsNewToggle" class="btn secondary" type="button">+ New</button>
            </div>
          </div>

          <div id="accountsNewBox" class="card" style="margin-top:14px; background:#fff;" hidden>
            <div class="bd">
              <div style="font-weight:900;">Create account</div>
              <div class="muted small" style="margin-top:4px;">Normally created automatically when a closer marks a deal as won.</div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Property name</label>
                  <input id="acctName" placeholder="Property / Community" />
                </div>
                <div>
                  <label>Property address</label>
                  <input id="acctAddress" placeholder="123 Main St, Raleigh, NC 27601" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Primary contact name</label>
                  <input id="acctContactName" placeholder="Jane Doe" />
                </div>
                <div>
                  <label>Primary contact email</label>
                  <input id="acctContactEmail" type="email" placeholder="jane@property.com" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Primary contact phone</label>
                  <input id="acctContactPhone" placeholder="(555) 555-5555" />
                </div>
                <div>
                  <label>Contract tier</label>
                  <select id="acctTier">
                    <option value="">Select…</option>
                    <option value="core">core</option>
                    <option value="tier_1">tier_1</option>
                    <option value="tier_2">tier_2</option>
                    <option value="tier_3">tier_3</option>
                    <option value="custom">custom</option>
                  </select>
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Term (months)</label>
                  <input id="acctTermMonths" type="number" min="0" step="1" placeholder="6" />
                </div>
                <div>
                  <label>Renewal reminder (days before end)</label>
                  <input id="acctReminderDays" type="number" min="0" step="1" placeholder="30" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Contract start date</label>
                  <input id="acctStart" type="date" />
                </div>
                <div>
                  <label>Contract end date</label>
                  <input id="acctEnd" type="date" />
                </div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes (internal)</label>
                <textarea id="acctNotes" placeholder="Onboarding context, expectations, issues..."></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="accountsCreateBtn" class="btn" type="button">Create</button>
                <div id="accountsCreateMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="accountsMsg" class="err"></div>

          <div class="two" style="grid-template-columns: 1fr 1.2fr;">
            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div class="muted small">Search</div>
                    <input id="accountsQ" placeholder="Search property, address, contact" />
                  </div>
                  <div>
                    <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                      <input id="accountsExpiring" type="checkbox" style="width:auto;" />
                      Expiring soon
                    </label>
                  </div>
                </div>
                <div style="height:10px"></div>
                <div id="accountsList" style="display:flex; flex-direction:column; gap:10px;"></div>
              </div>
            </div>

            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="muted small">Selected account</div>
                <div id="acctSelected" style="font-weight:900; margin-top:4px;">None</div>
                <div style="height:10px"></div>

                <div class="two">
                  <div>
                    <label>Property name</label>
                    <input id="acctEditName" placeholder="Property / Community" />
                  </div>
                  <div>
                    <label>Contract tier</label>
                    <input id="acctEditTier" placeholder="core / tier_1 / ..." />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <label>Property address</label>
                  <input id="acctEditAddress" placeholder="123 Main St, Raleigh, NC 27601" />
                </div>
                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Primary contact name</label>
                    <input id="acctEditContactName" placeholder="Jane Doe" />
                  </div>
                  <div>
                    <label>Primary contact email</label>
                    <input id="acctEditEmail" type="email" placeholder="jane@property.com" />
                  </div>
                </div>
                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Primary contact phone</label>
                    <input id="acctEditPhone" placeholder="(555) 555-5555" />
                  </div>
                  <div>
                    <label>Term (months)</label>
                    <input id="acctEditTermMonths" type="number" min="0" step="1" placeholder="6" />
                  </div>
                </div>
                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Contract start</label>
                    <input id="acctEditStart" type="date" />
                  </div>
                  <div>
                    <label>Contract end</label>
                    <input id="acctEditEnd" type="date" />
                  </div>
                </div>
                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Renewal reminder (days before end)</label>
                    <input id="acctEditReminderDays" type="number" min="0" step="1" placeholder="30" />
                  </div>
                  <div>
                    <label>Renewal reminder date</label>
                    <input id="acctEditReminderDate" type="date" />
                  </div>
                </div>
                <div class="muted small" id="acctRenewalHint" style="margin-top:10px;"></div>
                <div style="margin-top:10px;">
                  <label>Notes</label>
                  <textarea id="acctEditNotes" placeholder="Internal notes"></textarea>
                </div>

                <div class="row" style="margin-top:10px;">
                  <button id="acctSaveBtn" class="btn" type="button">Save</button>
                  <button id="acctDeleteBtn" class="btn secondary" type="button">Delete</button>
                  <div id="acctSaveMsg" class="err"></div>
                </div>

                <div style="height:14px"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                  <div class="bd">
                    <div style="font-weight:900;">Sentiment log</div>
                    <div class="muted small" style="margin-top:4px;">Track relationship health over time</div>
                    <div style="height:10px"></div>
                    <div class="two">
                      <div>
                        <label>Sentiment</label>
                        <select id="sentimentKind">
                          <option value="green">green</option>
                          <option value="yellow">yellow</option>
                          <option value="red">red</option>
                        </select>
                      </div>
                      <div>
                        <label>Tags (optional)</label>
                        <input id="sentimentTags" placeholder="pricing, communication, recap quality" />
                      </div>
                    </div>
                    <div style="margin-top:10px;">
                      <label>Note</label>
                      <textarea id="sentimentNote" placeholder="What happened? What should we do next?"></textarea>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <button id="sentimentAddBtn" class="btn secondary" type="button">Add entry</button>
                      <div id="sentimentMsg" class="err"></div>
                    </div>
                    <div style="height:10px"></div>
                    <div id="sentimentList"></div>
                  </div>
                </div>

                <div style="height:14px"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                  <div class="bd">
                    <div style="font-weight:900;">Issues</div>
                    <div class="muted small" style="margin-top:4px;">Internal issue tracking and escalations</div>
                    <div style="height:10px"></div>
                    <div class="two">
                      <div>
                        <label>Severity</label>
                        <select id="issueSeverity">
                          <option value="low">low</option>
                          <option value="med">med</option>
                          <option value="high">high</option>
                        </select>
                      </div>
                      <div>
                        <label>Status</label>
                        <select id="issueStatus">
                          <option value="open">open</option>
                          <option value="resolved">resolved</option>
                        </select>
                      </div>
                    </div>
                    <div style="margin-top:10px;">
                      <label>Issue</label>
                      <textarea id="issueNote" placeholder="What is the issue? Who owns it? Any next steps?"></textarea>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <button id="issueAddBtn" class="btn secondary" type="button">Add issue</button>
                      <div id="issueMsg" class="err"></div>
                    </div>
                    <div style="height:10px"></div>
                    <div id="issueList"></div>
                  </div>
                </div>

                <div style="height:14px"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                  <div class="bd">
                    <div style="font-weight:900;">Templates</div>
                    <div class="muted small" style="margin-top:4px;">Email / SMS templates</div>
                    <div style="height:10px"></div>
                    <div class="two">
                      <div>
                        <label>Template type</label>
                        <select id="tplType">
                          <option value="email">email</option>
                          <option value="sms">sms</option>
                        </select>
                      </div>
                      <div>
                        <label>Name</label>
                        <input id="tplName" placeholder="Quarterly check-in" />
                      </div>
                    </div>
                    <div style="margin-top:10px;">
                      <label>Body</label>
                      <textarea id="tplBody" placeholder="Hi {{name}}, ..."></textarea>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <button id="tplSaveBtn" class="btn secondary" type="button">Save template</button>
                      <div id="tplMsg" class="err"></div>
                    </div>
                    <div style="height:10px"></div>
                    <div id="tplList"></div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <div id="viewLeads" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px;">
            <div class="row" style="flex: 1;">
              <input id="leadQ" placeholder="Search name, property, email, phone" style="max-width:420px" />
              <select id="leadStatus" style="max-width:200px">
                <option value="">All statuses</option>
                <option value="new">new</option>
                <option value="working">working</option>
                <option value="booked">booked</option>
                <option value="won">won</option>
                <option value="lost">lost</option>
              </select>
              <button id="loadLeadsBtn" class="btn secondary">Load</button>
            </div>
            <div class="row" style="gap:8px;">
              <button id="pullLeadsToggle" class="btn secondary hide" type="button">Pull leads</button>
              <button id="newLeadToggle" class="btn secondary" type="button">+ New lead</button>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="pipe" id="leadsPipeline"></div>

          <div id="pullLeadsBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div style="font-weight:900;">Pull leads (Google Maps)</div>
              <div class="muted small" style="margin-top:4px;">Apartment / multi-family offices. Phone + website included when available.</div>
              <div style="height:10px"></div>
              <div class="two">
                <div>
                  <label>City, State</label>
                  <input id="plCityState" placeholder="Raleigh, NC" />
                </div>
                <div>
                  <label>Keyword</label>
                  <input id="plKeyword" placeholder="apartment leasing office" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Max leads</label>
                  <input id="plLimit" type="number" min="1" max="25" step="1" value="10" />
                </div>
                <div>
                  <label>Notes (optional)</label>
                  <input id="plNotes" placeholder="Any context to store on the leads" />
                </div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="pullLeadsBtn" class="btn" type="button">Pull now</button>
                <div id="pullLeadsMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div id="newLeadBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div class="two">
                <div><label>First name</label><input id="nlFirst" /></div>
                <div><label>Last name</label><input id="nlLast" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>Phone</label><input id="nlPhone" /></div>
                <div><label>Email</label><input id="nlEmail" type="email" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>Property / Community</label><input id="nlProp" /></div>
                <div><label>City, State</label><input id="nlCityState" placeholder="Raleigh, NC" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="nlNotes" placeholder="What did we learn? Any context for the next touch?"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createLeadBtn" class="btn">Create lead</button>
                <div id="createLeadMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="leadsMsg" class="err"></div>
          <div id="leadsEmpty" class="muted small" style="margin-top:6px;"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Property</th>
                  <th>City</th>
                  <th>Status</th>
                  <th>Assigned</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="leadsTbody"></tbody>
            </table>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="leadDetailTitle" style="font-weight:900; margin-top:4px;">None</div>
                </div>
                <div class="row">
                  <button id="leadDetailRefreshBtn" class="btn secondary" type="button">Refresh timeline</button>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="leadDetailMsg" class="err"></div>

              <div class="two">
                <div>
                  <label>Status</label>
                  <select id="leadEditStatus">
                    <option value="">(unchanged)</option>
                    <option value="new">new</option>
                    <option value="working">working</option>
                    <option value="booked">booked</option>
                    <option value="won">won</option>
                    <option value="lost">lost</option>
                  </select>
                </div>
                <div>
                  <label>Priority</label>
                  <select id="leadEditPriority">
                    <option value="">(unchanged)</option>
                    <option value="5">5</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                    <option value="1">1</option>
                    <option value="0">0</option>
                    <option value="-1">-1</option>
                    <option value="-2">-2</option>
                    <option value="-3">-3</option>
                    <option value="-4">-4</option>
                    <option value="-5">-5</option>
                  </select>
                </div>
              </div>

              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Assigned workspace</label>
                  <select id="leadEditAssignedRole">
                    <option value="">(unchanged)</option>
                    <option value="dialer">Calls</option>
                    <option value="in_person_setter">Booked</option>
                    <option value="closer">Sales</option>
                    <option value="event_host">Events</option>
                    <option value="event_coordinator">Operations</option>
                    <option value="media_team">Content</option>
                  </select>
                </div>
                <div>
                  <label>Assigned user id (manager only)</label>
                  <input id="leadEditAssignedUser" placeholder="uuid" />
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Next follow up (ISO or free text)</label>
                <input id="leadEditFollowup" placeholder="2026-02-25 14:30 ET" />
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="leadSaveBtn" class="btn secondary" type="button">Save updates</button>
                <div id="leadSaveMsg" class="err"></div>
              </div>

              <div style="height:14px"></div>

              <div class="card" style="background:#fff; border-color: rgba(231,225,218,.9);">
                <div class="bd">
                  <div style="font-weight:900;">Timeline</div>
                  <div class="muted small" style="margin-top:4px;">Calls, closes, notes, and follow ups</div>
                  <div style="height:10px"></div>
                  <div id="timelineMsg" class="err"></div>
                  <div id="timelineList"></div>

                  <div style="height:12px"></div>
                  <div>
                    <label>Add note</label>
                    <textarea id="timelineNote" placeholder="Add factual notes and next step."></textarea>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button id="timelineAddBtn" class="btn" type="button">Add note</button>
                    <div id="timelineAddMsg" class="err"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewCalls" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px; margin-bottom:12px;">
            <div class="segTabs" style="gap:8px;">
              <button id="dialerSegCall" class="segBtn" type="button">Queue & Call</button>
              <button id="dialerSegActivity" class="segBtn" type="button">Activity</button>
              <button id="dialerSegBooked" class="segBtn" type="button">Booked</button>
              <button id="dialerSegTasks" class="segBtn" type="button">Dispatch</button>
            </div>
          </div>

          <div id="dialerPaneCall">
          <div class="card" style="background:#fff; margin-bottom:14px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">My queue</div>
                  <div class="muted small">Leads assigned to you or unassigned</div>
                </div>
                <div class="row">
                  <button id="loadQueueBtn" class="btn secondary" type="button">Load</button>
                </div>
              </div>
              <div style="height:10px"></div>
              <div id="queueMsg" class="err"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Property</th>
                      <th>Status</th>
                      <th>Priority</th>
                      <th>Follow up</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="queueTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card" style="background: #fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="selectedLeadLine" style="font-weight:700; margin-top:4px;">None</div>
                </div>
                <button id="pickFromLeads" class="btn secondary">Pick from Leads</button>
              </div>
              <div style="height:10px"></div>
              <div id="dialerCallForm">
                <div class="two">
                  <div>
                    <label>Outcome</label>
                    <select id="callOutcome">
                      <option value="">Select…</option>
                      <option>no_answer</option>
                      <option>left_voicemail</option>
                      <option>not_interested</option>
                      <option>call_back</option>
                      <option>booked_meeting</option>
                      <option>qualified_handoff</option>
                    </select>
                  </div>
                  <div>
                    <label>Next status (optional)</label>
                    <select id="callLeadStatus">
                      <option value="">No change</option>
                      <option>working</option>
                      <option>booked</option>
                      <option>won</option>
                      <option>lost</option>
                    </select>
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <label>Next follow up</label>
                  <input id="callFollowup" placeholder="2026-02-25 14:30 ET" />
                </div>
                <div style="margin-top:10px;">
                  <label>Notes</label>
                  <textarea id="callNotes" placeholder="Short, factual notes."></textarea>
                </div>
                <div class="row" style="margin-top:10px;">
                  <button id="logCallBtn" class="btn">Log call</button>
                  <button id="aiFollowupBtn" class="btn secondary">AI follow-up</button>
                  <div id="callMsg" class="err"></div>
                </div>
                <div id="followupBox" class="card hide" style="margin-top:12px; background: #fff;">
                  <div class="bd">
                    <div class="muted small">Generated follow-up</div>
                    <div style="height:8px"></div>
                    <div><label>Email subject</label><input id="fuSubject" /></div>
                    <div style="margin-top:10px;"><label>Email body</label><textarea id="fuEmail"></textarea></div>
                    <div style="margin-top:10px;"><label>SMS</label><textarea id="fuSms"></textarea></div>
                    <div style="margin-top:10px;"><label>Next step</label><input id="fuNext" /></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          </div>

          <div id="dialerPaneActivity" class="hide">
            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div style="font-weight:900;">Lead activity</div>
                    <div class="muted small">Calls, notes, appointments, and closes for the selected lead</div>
                  </div>
                  <button id="loadDialerTimelineBtn" class="btn secondary" type="button">Refresh</button>
                </div>
                <div style="height:10px"></div>
                <div id="dialerTimelineMsg" class="err"></div>
                <div id="dialerTimelineList"></div>
              </div>
            </div>
          </div>

          <div id="dialerPaneBooked" class="hide">
            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div style="font-weight:900;">Booked meetings</div>
                    <div class="muted small">Meetings you scheduled (track outcomes in Activity)</div>
                  </div>
                  <div class="row">
                    <button id="dialerBookedRefreshBtn" class="btn secondary" type="button">Refresh</button>
                  </div>
                </div>

                <div style="height:10px"></div>
                <div id="dialerBookedMsg" class="err"></div>

                <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Lead</th>
                        <th>Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="dialerBookedTbody"></tbody>
                  </table>
                </div>

                <div style="height:12px"></div>
                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                  <div class="bd">
                    <div style="font-weight:900;">Schedule for selected lead</div>
                    <div class="muted small" style="margin-top:4px;">Creates an appointment. Track outcomes in Activity.</div>

                    <div style="height:10px"></div>
                    <div class="two">
                      <div>
                        <label>Date</label>
                        <input id="dialerBookedDate" type="date" />
                      </div>
                      <div>
                        <label>Start time</label>
                        <input id="dialerBookedStart" type="time" />
                      </div>
                    </div>
                    <div style="margin-top:10px;">
                      <label>Notes (optional)</label>
                      <textarea id="dialerBookedNotes" placeholder="Any context for the meeting."></textarea>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <button id="dialerBookedScheduleBtn" class="btn" type="button">Schedule</button>
                      <div id="dialerBookedScheduleMsg" class="err"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="dialerPaneTasks" class="hide">
            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div style="font-weight:900;">Dispatch tasks</div>
                    <div class="muted small">Open tasks assigned to you or unassigned</div>
                  </div>
                  <div class="row">
                    <select id="dialerTasksScope" style="max-width:220px">
                      <option value="role">Role</option>
                      <option value="mine">My tasks</option>
                    </select>
                    <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                      <input id="dialerTasksOverdue" type="checkbox" style="width:auto;" />
                      Overdue only
                    </label>
                    <button id="loadDialerTasksBtn" class="btn secondary" type="button">Load</button>
                  </div>
                </div>
                <div style="height:10px"></div>
                <div id="dialerTasksMsg" class="err"></div>
                <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Due</th>
                        <th>Title</th>
                        <th>Lead</th>
                        <th>Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="dialerTasksTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewMeetings" class="hide">
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="segTabs" style="gap:8px; margin-bottom:12px;">
                <button id="meetingsSegList" class="segBtn" type="button">Meetings</button>
                <button id="meetingsSegAvailability" class="segBtn" type="button">Availability</button>
              </div>

              <div id="meetingsPaneList" class="hide">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">My meetings</div>
                  <div class="muted small">Upcoming and recent appointments</div>
                </div>
                <div class="row">
                  <button id="meetingsRefreshBtn" class="btn secondary" type="button">Refresh</button>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="meetingsMsg" class="err"></div>

              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Lead</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="meetingsTbody"></tbody>
                </table>
              </div>

              <div style="height:12px"></div>
              <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div style="font-weight:900;">Schedule</div>
                  <div class="muted small" style="margin-top:4px;">Schedules for the currently selected lead</div>

                  <div style="height:10px"></div>
                  <div class="two">
                    <div>
                      <label>Date</label>
                      <input id="meetingDate" type="date" />
                    </div>
                    <div>
                      <label>Start time</label>
                      <input id="meetingStart" type="time" />
                    </div>
                  </div>
                  <div style="margin-top:10px;">
                    <label>Notes</label>
                    <textarea id="meetingNotes" placeholder="Agenda and next steps."></textarea>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button id="meetingScheduleBtn" class="btn" type="button">Schedule for selected lead</button>
                    <div id="meetingScheduleMsg" class="err"></div>
                  </div>
                </div>
              </div>

              </div>

              <div id="meetingsPaneAvailability" class="hide">
              <div id="meetingsAvailabilityCard" class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                    <div>
                      <div style="font-weight:900;">Availability</div>
                      <div class="muted small" style="margin-top:4px;">Select times you can take meetings. Times are shown in your local timezone (<span id="availTzLabel"></span>).</div>
                      <div id="availReadOnlyNote" class="muted small" style="margin-top:6px; display:none;">View-as is read-only.</div>
                    </div>
                    <div class="row" style="gap:8px;">
                      <button id="availPrevWeek" class="btn secondary" type="button">Prev week</button>
                      <button id="availToday" class="btn secondary" type="button">This week</button>
                      <button id="availNextWeek" class="btn secondary" type="button">Next week</button>
                      <button id="availClearWeek" class="btn secondary" type="button">Clear week</button>
                      <button id="availSaveBtn" class="btn" type="button">Save</button>
                    </div>
                  </div>

                  <div style="height:10px"></div>
                  <div class="row" style="justify-content:space-between; gap:10px;">
                    <div class="muted small" id="availWeekLabel">—</div>
                  </div>
                  <div style="height:10px"></div>
                  <div id="availMsg" class="err"></div>

                  <div class="availGridWrap" style="margin-top:10px;">
                    <div class="availWeekGrid" id="availWeekGrid"></div>
                  </div>
                </div>
              </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewCloser" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px; margin-bottom:12px;">
            <div class="segTabs" style="gap:8px;">
              <button id="closerSegDisposition" class="segBtn" type="button">Disposition</button>
              <button id="closerSegPipeline" class="segBtn" type="button">Pipeline</button>
            </div>
          </div>

          <div id="closerPaneDisposition" class="hide">
          <div class="card" style="background: #fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="closerSelectedLead" style="font-weight:700; margin-top:4px;">None</div>
                </div>
                <button id="closerPickLead" class="btn secondary">Pick from Leads</button>
              </div>

              <div style="height:12px"></div>

              <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                    <div>
                      <div style="font-weight:900;">AI Research</div>
                      <div class="muted small">Call prep from lead details</div>
                    </div>
                    <button id="aiResearchBtn" class="btn secondary">Generate</button>
                  </div>
                  <div style="height:10px"></div>
                  <div><label>Optional question</label><input id="researchQ" placeholder="What should I ask on discovery?" /></div>
                  <div style="height:10px"></div>
                  <div id="researchMsg" class="err"></div>
                  <div id="researchBox" class="card hide" style="margin-top:12px; background:#fff;">
                    <div class="bd">
                      <div><label>Summary</label><textarea id="researchSummary"></textarea></div>
                      <div style="margin-top:10px;"><label>Talking points</label><textarea id="researchTalking"></textarea></div>
                      <div style="margin-top:10px;"><label>Likely objections</label><textarea id="researchObjections"></textarea></div>
                      <div style="margin-top:10px;"><label>Next steps</label><textarea id="researchNext"></textarea></div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="height:14px"></div>

              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div style="font-weight:900;">Close or Disposition</div>
                  <div style="height:10px"></div>

                  <div class="two">
                    <div>
                      <label>Disposition</label>
                      <select id="closeDisposition">
                        <option value="follow_up">follow_up</option>
                        <option value="won">won</option>
                        <option value="lost">lost</option>
                      </select>
                    </div>
                    <div>
                      <label>Closed on (if won)</label>
                      <input id="closeDate" type="date" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Package tier</label>
                      <select id="closePackage">
                        <option value="">Select…</option>
                        <option value="tier_1">tier_1 ($1000)</option>
                        <option value="tier_2">tier_2 ($2000)</option>
                        <option value="tier_3">tier_3 ($3000)</option>
                        <option value="custom">custom</option>
                      </select>
                    </div>
                    <div>
                      <label>Package price (USD)</label>
                      <input id="closePackagePrice" type="number" min="0" step="0.01" placeholder="1000" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Initial payment (USD)</label>
                      <input id="closeInitial" type="number" min="0" step="0.01" placeholder="0" />
                    </div>
                    <div>
                      <label>Term length (months)</label>
                      <input id="closeTerm" type="number" min="1" step="1" placeholder="6" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Monthly pricing (USD)</label>
                      <input id="closeMonthly" type="number" min="0" step="0.01" placeholder="0" />
                    </div>
                    <div>
                      <label>Contract send date (optional)</label>
                      <input id="closeContractSend" type="date" />
                    </div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Next steps (optional)</label>
                    <textarea id="closeNotes" placeholder="Short context for follow-up."></textarea>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <button id="closeSubmitBtn" class="btn">Submit</button>
                    <button id="closeQuoteBtn" class="btn secondary" type="button">Fill tier price</button>
                    <div id="closeMsg" class="err"></div>
                  </div>
                </div>
              </div>

          </div>
          <div id="closerPanePipeline" class="hide">
            <div class="card" id="closerPipelineCard" style="background:#fff; margin-bottom:14px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div style="font-weight:900;">Pipeline</div>
                    <div class="muted small">Working and booked leads for closing</div>
                  </div>
                  <button id="loadCloserQueueBtn" class="btn secondary" type="button">Load</button>
                </div>
                <div style="height:10px"></div>
                <div class="pipe" id="closerPipeline"></div>
                <div style="height:10px"></div>
                <div id="closerQueueMsg" class="err"></div>
                <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                  <table>
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Property</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Follow up</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="closerQueueTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

            </div>
          </div>
        </div>

        <div id="viewEvents" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px;">
            <div class="row">
              <select id="eventStatus" style="max-width:220px">
                <option value="">All statuses</option>
                <option value="open">open</option>
                <option value="assigned">assigned</option>
                <option value="completed">completed</option>
                <option value="canceled">canceled</option>
              </select>
              <button id="loadEventsBtn" class="btn secondary">Load</button>
            </div>
            <button id="newEventToggle" class="btn secondary hide">New event</button>
          </div>

          <div id="newEventBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div class="two">
                <div><label>Property name</label><input id="nePropertyName" placeholder="Property name" /></div>
                <div><label>Date</label><input id="neDate" type="date" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Property address</label>
                <input id="neAddress" placeholder="123 Main St" />
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>City</label><input id="neCity" /></div>
                <div><label>State</label><input id="neState" placeholder="NC" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Title (optional override)</label>
                <input id="neTitle" placeholder="Property event" />
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="neNotes"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createEventBtn" class="btn">Create event</button>
                <div id="createEventMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="eventsMsg" class="err"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th>Title</th>
                  <th>City</th>
                  <th>Status</th>
                  <th>Assigned</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="eventsTbody"></tbody>
            </table>
          </div>

          <div id="eventRecapWrap" class="card hide" style="margin-top:14px; background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected event</div>
                  <div id="selectedEventLine" style="font-weight:900; margin-top:4px;">None</div>
                </div>
                <button id="closeRecapBtn" class="btn secondary" type="button">Close</button>
              </div>

              <div style="height:12px"></div>

              <div class="two">
                <div>
                  <label>Attendance estimate</label>
                  <input id="recapAttendance" type="number" min="0" step="1" placeholder="0" />
                </div>
                <div>
                  <label>How it went</label>
                  <select id="recapRating">
                    <option value="">Select…</option>
                    <option>excellent</option>
                    <option>good</option>
                    <option>ok</option>
                    <option>poor</option>
                  </select>
                </div>
              </div>

              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Issues reported</label>
                  <select id="recapIssues">
                    <option value="">Select…</option>
                    <option value="no">no</option>
                    <option value="yes">yes</option>
                  </select>
                </div>
                <div>
                  <label>Photos uploaded</label>
                  <select id="recapPhotos">
                    <option value="">Select…</option>
                    <option value="yes">yes</option>
                    <option value="no">no</option>
                    <option value="pending">pending</option>
                  </select>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Issues details (if any)</label>
                <textarea id="recapIssuesDetails"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Host notes</label>
                <textarea id="recapNotes"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Standout moments / wins</label>
                <textarea id="recapStandouts"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Giveaway winners (if any)</label>
                <textarea id="recapGiveawayWinners" placeholder="Name / unit (or notes)"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Resident feedback highlights</label>
                <textarea id="recapFeedbackHighlights"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Event flow doc link (optional)</label>
                <input id="recapEventFlowDoc" placeholder="https://..." />
              </div>

              <div style="margin-top:10px;">
                <label>Media links (one per line)</label>
                <textarea id="recapMedia" placeholder="https://...\nhttps://..."></textarea>
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="submitRecapBtn" class="btn">Submit recap</button>
                <div id="recapMsg" class="err"></div>
              </div>

              <div style="height:14px"></div>
              <div class="muted small" style="font-weight:900;">Recent recaps</div>
              <div style="height:8px"></div>
              <div id="recapsList"></div>
            </div>
          </div>

          <div id="eventOpsWrap" class="card hide" style="margin-top:14px; background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Coordinator / Ops</div>
                  <div style="font-weight:900; margin-top:4px;">Event checklist & staffing</div>
                </div>
                <button id="createFollowupsBtn" class="btn secondary" type="button">Create 24h follow-ups</button>
              </div>

              <div style="height:10px"></div>
              <div id="eventOpsMsg" class="err"></div>

              <div class="two">
                <div>
                  <div style="font-weight:900;">Staffing</div>
                  <div class="muted small">Assign host/media and track acceptance</div>
                  <div style="height:10px"></div>

                  <div class="row" style="gap:8px; flex-wrap:wrap;">
                    <select id="assignHostUser" style="min-width:260px;">
                      <option value="">Assign host…</option>
                    </select>
                    <button id="addHostBtn" class="btn secondary" type="button">Add host</button>
                  </div>
                  <div style="height:8px"></div>

                  <div class="card" style="background:#fff; border-color: rgba(199,154,59,.25);">
                    <div class="bd">
                      <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                        <div>
                          <div class="muted small">Resident feedback</div>
                          <div style="font-weight:900; margin-top:4px;">Feedback form & submissions</div>
                          <div class="muted small" style="margin-top:4px;">Generate a share link (or QR), then review submissions here.</div>
                        </div>
                        <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                          <button id="feedbackEnableBtn" class="btn secondary" type="button">Enable / Regenerate link</button>
                          <button id="feedbackLoadSummaryBtn" class="btn secondary" type="button">Load submissions</button>
                        </div>
                      </div>

                      <div style="height:10px"></div>
                      <div id="feedbackFormMsg" class="err"></div>

                      <label>Shareable link</label>
                      <div class="row" style="gap:8px; flex-wrap:wrap;">
                        <input id="feedbackLink" readonly placeholder="Enable feedback to generate a link" style="min-width:320px; flex:1;" />
                        <button id="feedbackCopyBtn" class="btn secondary" type="button">Copy</button>
                        <button id="feedbackOpenBtn" class="btn secondary" type="button">Open</button>
                      </div>

                      <div class="two" style="margin-top:10px;">
                        <div>
                          <label>Subtitle (optional)</label>
                          <input id="feedbackSubtitle" placeholder="Thanks for joining us..." />
                        </div>
                        <div>
                          <label>Thank-you message (optional)</label>
                          <input id="feedbackThanks" placeholder="Your feedback was received." />
                        </div>
                      </div>

                      <div style="margin-top:10px;">
                        <div style="font-weight:900;">Questions</div>
                        <div class="muted small" style="margin-top:4px;">Overall rating is always included.</div>
                        <div style="height:8px"></div>
                        <div id="feedbackQuestionsList"></div>
                        <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
                          <button id="feedbackAddQBtn" class="btn secondary" type="button">Add question</button>
                          <button id="feedbackSaveBtn" class="btn secondary" type="button">Save feedback form</button>
                        </div>
                      </div>

                      <div style="height:12px"></div>
                      <div id="feedbackSummaryLine" class="muted small"></div>
                      <div id="feedbackCommentsList" style="margin-top:10px;"></div>
                    </div>
                  </div>
                  <div class="row" style="gap:8px; flex-wrap:wrap;">
                    <select id="assignMediaUser" style="min-width:260px;">
                      <option value="">Assign media…</option>
                    </select>
                    <button id="addMediaBtn" class="btn secondary" type="button">Add media</button>
                  </div>

                  <div style="height:10px"></div>
                  <div id="assignmentsList"></div>

                  <div id="myAssignmentActions" class="hide" style="margin-top:10px;"></div>
                </div>

                <div>
                  <div style="font-weight:900;">Checklist</div>
                  <div class="muted small">Track deliverables for AM/management</div>
                  <div style="height:10px"></div>

                  <div class="row" style="gap:12px; flex-wrap:wrap;">
                    <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                      <input id="chkRecapReceived" type="checkbox" style="width:auto;" />
                      Recap received
                    </label>
                    <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                      <input id="chkMediaReceived" type="checkbox" style="width:auto;" />
                      Media received
                    </label>
                    <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                      <input id="chkFeedbackReceived" type="checkbox" style="width:auto;" />
                      Feedback received
                    </label>
                    <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                      <input id="chkReportSent" type="checkbox" style="width:auto;" />
                      Report sent
                    </label>
                  </div>

                  <div style="height:10px"></div>
                  <button id="saveChecklistBtn" class="btn secondary" type="button">Save checklist</button>
                </div>
              </div>

              <div style="height:14px"></div>

              <div class="two">
                <div>
                  <div style="font-weight:900;">Plan</div>
                  <div style="height:10px"></div>
                  <div class="two">
                    <div>
                      <label>Strategy</label>
                      <select id="planStrategy">
                        <option value="">Select…</option>
                        <option value="anchor">Anchor</option>
                        <option value="momentum">Momentum</option>
                      </select>
                    </div>
                    <div>
                      <label>Event type</label>
                      <select id="planEventType">
                        <option value="">Select…</option>
                      </select>
                    </div>
                  </div>
                  <div style="margin-top:10px;">
                    <label>Justification</label>
                    <textarea id="planJustification" placeholder="Why this strategy/type for this property?"></textarea>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <button id="savePlanBtn" class="btn secondary" type="button">Save plan</button>
                  </div>
                </div>

                <div>
                  <div style="font-weight:900;">Budget</div>
                  <div class="muted small">Constraint: host pay ≥ 75% of media pay (when media included)</div>
                  <div style="height:10px"></div>

                  <div class="two">
                    <div><label>Host pay ($)</label><input id="budHost" type="number" min="0" step="0.01" /></div>
                    <div><label>Media pay ($)</label><input id="budMedia" type="number" min="0" step="0.01" /></div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div><label>Food/catering ($)</label><input id="budFood" type="number" min="0" step="0.01" /></div>
                    <div><label>Decor ($)</label><input id="budDecor" type="number" min="0" step="0.01" /></div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div><label>Supplies ($)</label><input id="budSupplies" type="number" min="0" step="0.01" /></div>
                    <div><label>Contingency ($)</label><input id="budContingency" type="number" min="0" step="0.01" /></div>
                  </div>

                  <div style="margin-top:10px;" class="row">
                    <button id="saveBudgetBtn" class="btn secondary" type="button">Save budget</button>
                    <div id="budgetMsg" class="err"></div>
                  </div>
                </div>
              </div>

              <div style="height:14px"></div>
              <div class="card" style="background:#fff; border-color: rgba(199,154,59,.25);">
                <div class="bd">
                  <div style="font-weight:900;">Vendor & Event Type CSV</div>
                  <div class="muted small">Paste CSVs here once; they will be stored for browsing</div>
                  <div style="height:10px"></div>

                  <div class="two">
                    <div>
                      <label>Vendors CSV</label>
                      <textarea id="vendorsCsv" placeholder="paste vendors CSV..."></textarea>
                      <div class="row" style="margin-top:8px;">
                        <button id="importVendorsBtn" class="btn secondary" type="button">Import vendors</button>
                        <div id="importVendorsMsg" class="err"></div>
                      </div>
                    </div>
                    <div>
                      <label>Event types CSV</label>
                      <textarea id="eventTypesCsv" placeholder="paste event types CSV..."></textarea>
                      <div class="row" style="margin-top:8px;">
                        <button id="importEventTypesBtn" class="btn secondary" type="button">Import event types</button>
                        <div id="importEventTypesMsg" class="err"></div>
                      </div>
                    </div>
                  </div>

                  <div style="height:10px"></div>
                  <div class="two">
                    <div>
                      <label>Browse vendors</label>
                      <input id="vendorQ" placeholder="search vendors (name, city, state, etc.)" />
                      <div class="row" style="margin-top:8px;">
                        <button id="loadVendorsBtn" class="btn secondary" type="button">Search</button>
                        <button id="suggestVendorsBtn" class="btn secondary" type="button">Suggest nearby</button>
                        <div id="vendorsMsg" class="err"></div>
                      </div>
                      <div id="vendorsList" style="margin-top:10px;"></div>
                    </div>
                    <div>
                      <label>Browse event types</label>
                      <input id="eventTypeQ" placeholder="search event types" />
                      <div class="row" style="margin-top:8px;">
                        <button id="loadEventTypesBtn" class="btn secondary" type="button">Search</button>
                        <div id="eventTypesMsg" class="err"></div>
                      </div>
                      <div id="eventTypesList" style="margin-top:10px;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewTalent" class="hide">
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Talent profile</div>
                  <div style="font-weight:900; margin-top:4px;">Bio, location, specialties</div>
                  <div id="talentEditingLine" class="muted small" style="margin-top:4px;"></div>
                </div>
                <div class="row">
                  <button id="talentRefreshBtn" class="btn secondary" type="button">Refresh</button>
                  <button id="talentStopEditingBtn" class="btn secondary hide" type="button">Stop editing</button>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="talentMsg" class="err"></div>

              <div class="two">
                <div>
                  <label>Display name</label>
                  <input id="talDisplayName" placeholder="Preferred name" />
                </div>
                <div>
                  <label>Role</label>
                  <select id="talRole">
                    <option value="">Select…</option>
                    <option value="event_host">event_host</option>
                    <option value="media_team">media_team</option>
                  </select>
                </div>
              </div>

              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Home base city</label>
                  <input id="talCity" placeholder="Charlotte" />
                </div>
                <div>
                  <label>Home base state</label>
                  <input id="talState" placeholder="NC" />
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Specialties (comma separated)</label>
                <input id="talSpecialties" placeholder="ex: games, luxury, families" />
              </div>

              <div style="margin-top:10px;">
                <label>Tone / style</label>
                <input id="talTone" placeholder="high-energy, warm, professional" />
              </div>

              <div style="margin-top:10px;">
                <label>Gear / capabilities</label>
                <input id="talGear" placeholder="camera, gimbal, lighting, drone (if licensed)" />
              </div>

              <div style="margin-top:10px;">
                <label>Bio</label>
                <textarea id="talBio" placeholder="Short bio used for matching and reporting"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Preferred pairings (user IDs comma separated)</label>
                <input id="talPairings" placeholder="uuid1, uuid2" />
              </div>

              <div style="margin-top:10px;">
                <label>Notes (internal)</label>
                <textarea id="talNotes"></textarea>
              </div>

              <div id="talReliabilityBox" class="hide" style="margin-top:10px;">
                <div class="two">
                  <div>
                    <label>Reliability score (0-100)</label>
                    <input id="talReliabilityScore" type="number" min="0" max="100" step="1" />
                  </div>
                  <div>
                    <label>Reliability flags (comma separated)</label>
                    <input id="talReliabilityFlags" placeholder="late, no_show, great" />
                  </div>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="talentSaveBtn" class="btn" type="button">Save profile</button>
              </div>
            </div>
          </div>

          <div id="talentDirectoryWrap" class="card hide" style="margin-top:14px; background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Coordinator tools</div>
                  <div style="font-weight:900; margin-top:4px;">Talent directory</div>
                </div>
                <div style="max-width:360px; width:100%;">
                  <input id="talentQ" placeholder="search by name, city/state, specialty" />
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="talentDirMsg" class="err"></div>
              <div id="talentDirList"></div>
            </div>
          </div>
        </div>

        <div id="viewPayments" class="hide">
          <div class="row" style="justify-content:space-between;">
            <button id="loadPayoutsBtn" class="btn secondary">Load</button>
          </div>
          <div style="height:14px"></div>
          <div id="payoutsMsg" class="err"></div>
          <div id="payoutsEmpty" class="muted small" style="margin-top:6px;"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="payoutsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewManager" class="hide">
          <div id="mgrStatsCard" class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Operations</div>
                  <div style="font-weight:900; margin-top:4px;">Stats</div>
                </div>
                <button id="loadStatsBtn" class="btn secondary" type="button">Load stats</button>
              </div>
              <div style="height:10px"></div>
              <div id="statsMsg" class="err"></div>
              <div id="statsBox" class="row" style="gap:10px; flex-wrap:wrap;"></div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Dispatch</div>
                  <div class="muted small">Create and manage operational tasks</div>
                </div>
                <div class="row">
                  <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="dispatchOverdueOnly" type="checkbox" style="width:auto;" />
                    Overdue only
                  </label>
                  <button id="scanDispatchBtn" class="btn secondary" type="button">Scan overdue</button>
                  <button id="loadDispatchBtn" class="btn secondary" type="button">Load tasks</button>
                </div>
              </div>

              <div style="height:12px"></div>
              <div class="two">
                <div>
                  <label>Status filter</label>
                  <select id="dispatchStatus">
                    <option value="">Open and assigned</option>
                    <option value="open">open</option>
                    <option value="assigned">assigned</option>
                    <option value="completed">completed</option>
                    <option value="cancelled">cancelled</option>
                  </select>
                </div>
                <div>
                  <label>Assigned workspace filter</label>
                  <select id="dispatchRole">
                    <option value="">All workspaces</option>
                    <option value="dialer">Calls</option>
                    <option value="in_person_setter">Booked</option>
                    <option value="closer">Sales</option>
                    <option value="event_host">Events</option>
                    <option value="event_coordinator">Operations</option>
                    <option value="media_team">Content</option>
                  </select>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="dispatchMsg" class="err"></div>

              <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div style="font-weight:900;">Create task</div>
                  <div style="height:10px"></div>
                  <div class="two">
                    <div>
                      <label>Lead ID (optional)</label>
                      <input id="dispatchLeadId" placeholder="123" />
                    </div>
                    <div>
                      <label>Assigned workspace</label>
                      <select id="dispatchAssignedRole">
                        <option value="">Select…</option>
                        <option value="dialer">Calls</option>
                        <option value="in_person_setter">Booked</option>
                        <option value="closer">Sales</option>
                        <option value="event_host">Events</option>
                        <option value="event_coordinator">Operations</option>
                        <option value="media_team">Content</option>
                      </select>
                    </div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Title</label>
                    <input id="dispatchTitle" placeholder="Example: Pull comps and prep talking points" />
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Due date</label>
                      <input id="dispatchDueDate" type="date" />
                    </div>
                    <div>
                      <label>Due time</label>
                      <input id="dispatchDueTime" type="time" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Assigned user id (optional)</label>
                      <input id="dispatchAssignedUserId" placeholder="uuid" />
                    </div>
                    <div>
                      <label>Priority</label>
                      <select id="dispatchPriority">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="-1">-1</option>
                        <option value="-2">-2</option>
                        <option value="-3">-3</option>
                        <option value="-4">-4</option>
                        <option value="-5">-5</option>
                      </select>
                    </div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Notes</label>
                    <textarea id="dispatchNotes" placeholder="Context and expected output."></textarea>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <button id="dispatchCreateBtn" class="btn" type="button">Create</button>
                    <div id="dispatchCreateMsg" class="err"></div>
                  </div>
                </div>
              </div>

              <div style="height:12px"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Due</th>
                      <th>Title</th>
                      <th>Workspace</th>
                      <th>Assigned</th>
                      <th>Lead</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="dispatchTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div style="font-weight:900;">Lead assignment</div>
              <div class="muted small" style="margin-top:4px;">Assign a lead to a workspace or a specific person</div>
              <div style="height:10px"></div>
              <div class="two">
                <div>
                  <label>Lead ID</label>
                  <input id="mgrLeadId" placeholder="123" />
                </div>
                <div>
                  <label>Assigned workspace</label>
                  <select id="mgrAssignedRole">
                    <option value="">(no change)</option>
                    <option value="dialer">Calls</option>
                    <option value="in_person_setter">Booked</option>
                    <option value="closer">Sales</option>
                    <option value="event_host">Events</option>
                    <option value="event_coordinator">Operations</option>
                    <option value="media_team">Content</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px;">
                <label>Assigned user id</label>
                <input id="mgrAssignedUserId" placeholder="uuid" />
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="mgrAssignBtn" class="btn secondary" type="button">Apply</button>
                <div id="mgrAssignMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Users</div>
                  <div class="muted small">Edit team assignments and view availability</div>
                </div>
                <button id="loadUsersBtn" class="btn secondary" type="button">Load users</button>
              </div>
              <div style="height:14px"></div>
              <div id="usersMsg" class="err"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Workspace</th>
                      <th>User ID</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="usersTbody"></tbody>
                </table>
              </div>

              <div style="height:12px"></div>
              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div style="font-weight:900;">Team availability</div>
                  <div class="muted small" style="margin-top:4px;">Loads from saved availability notes</div>
                  <div style="height:10px"></div>
                  <button id="loadTeamAvailBtn" class="btn secondary" type="button">Load availability</button>
                  <div style="height:10px"></div>
                  <div id="teamAvailMsg" class="err"></div>
                  <div id="teamAvailList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
        </section>

    <div id="pipelineModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-label="Pipeline stage">
      <div class="modal">
        <div class="modalHd">
          <div>
            <div class="t" id="pipelineModalTitle">Pipeline</div>
            <div class="muted small" id="pipelineModalSub">—</div>
          </div>
          <div class="row" style="gap:8px;">
            <button id="pipelinePrev" class="btn secondary" type="button">Prev</button>
            <button id="pipelineNext" class="btn secondary" type="button">Next</button>
            <button id="pipelineClose" class="btn secondary" type="button">Close</button>
          </div>
        </div>
        <div class="modalBd">
          <div class="modalTwo">
            <div>
              <div class="muted small" style="font-weight:900;">Leads</div>
              <div style="height:8px"></div>
              <div id="pipelineModalList" class="modalList"></div>
            </div>
            <div>
              <div class="muted small" style="font-weight:900;">Lead</div>
              <div style="height:8px"></div>
              <div id="pipelineModalDetail" class="modalDetail"></div>
              <div class="row" style="margin-top:10px;">
                <button id="pipelineOpenLead" class="btn" type="button">Open lead</button>
              </div>
              <div class="muted small" style="margin-top:8px;">Tip: click a lead, then Prev/Next to browse.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
      </main>
    </div>
  </div>

  <script>
    (function stripCloudflareChallengeParams(){
      try{
        const u = new URL(window.location.href);
        let changed = false;
        for (const k of Array.from(u.searchParams.keys())){
          if (k.startsWith('__cf_chl_') || k.startsWith('cf_chl_')) {
            u.searchParams.delete(k);
            changed = true;
          }
        }
        if (changed) {
          const qs = u.searchParams.toString();
          const next = u.pathname + (qs ? ('?' + qs) : '') + (u.hash || '');
          window.history.replaceState({}, '', next);
        }
      } catch(_e) {}
    })();

    const $ = (id) => document.getElementById(id);

    function setAuthLoading(loading, label){
      const loginBtn = $('loginBtn');
      const signupBtn = $('signupBtn');
      if (loginBtn) {
        loginBtn.disabled = !!loading;
        loginBtn.textContent = loading ? (label || 'Signing in…') : 'Sign in';
      }
      if (signupBtn) {
        signupBtn.disabled = !!loading;
        signupBtn.textContent = loading ? 'Working…' : 'Create account';
      }
      const ok = $('authOk');
      if (ok) ok.innerHTML = loading ? `<span class="spin"></span> ${escapeHtml(label || 'Signing in…')}` : '';
    }

    function withTimeout(promise, ms, label){
      let t;
      const timeout = new Promise((_, rej) => {
        t = setTimeout(() => rej(new Error(label || 'request_timeout')), ms);
      });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    }

    // If something breaks in JS, surface it instead of silently doing nothing.
    window.addEventListener('error', (ev) => {
      const msg = String(ev?.message || 'script_error');
      const el = $('authMsg');
      if (el) el.textContent = msg;
    });
    window.addEventListener('unhandledrejection', (ev) => {
      const msg = String(ev?.reason?.message || ev?.reason || 'promise_rejection');
      const el = $('authMsg');
      if (el) el.textContent = msg;
    });

    const state = {
      token: '',
      me: null,
      activeTab: 'overview',
      meetingsSubtab: 'list',
      viewAsRole: '',
      viewAsUserId: '',
      dialerSubtab: 'call',
      closerSubtab: 'disposition',
      leads: [],
      selectedLead: null,
      events: [],
      selectedEvent: null,
      appointments: [],
      dispatch: [],
      pickLeadReturnTab: 'calls',
      usersCache: [],
      talent: {
        my: null,
        profiles: [],
        editUserId: '',
        q: '',
      },
      closerQueue: [],
      ui: { sidebarCollapsed: false },
      availability: { weekOffset: 0, byDate: {}, tz: '', drag: { active: false, mode: '' } },
    };

    function setSidebarCollapsed(next){
      const v = !!next;
      state.ui.sidebarCollapsed = v;
      document.body.classList.toggle('sbCollapsed', v);
      try { localStorage.setItem('portal_sidebar_collapsed', v ? '1' : '0'); } catch(_e) {}
    }

    function restoreUiPrefs(){
      try {
        const v = localStorage.getItem('portal_sidebar_collapsed');
        setSidebarCollapsed(v === '1');
      } catch(_e) {}
    }

    function setMeetingsSubtab(next){
      state.meetingsSubtab = String(next || 'list');
      renderMeetingsSubtab();
      // Load data for the active pane.
      if (state.activeTab === 'meetings') {
        if (state.meetingsSubtab === 'availability') loadAvailability().catch(()=>{});
        else loadAppointmentsInto('meetingsTbody', 'meetingsMsg').catch(()=>{});
      }
    }

    function renderMeetingsSubtab(){
      const t = String(state.meetingsSubtab || 'list');
      const map = {
        list: { btn: 'meetingsSegList', pane: 'meetingsPaneList' },
        availability: { btn: 'meetingsSegAvailability', pane: 'meetingsPaneAvailability' },
      };
      const keys = Object.keys(map);
      for (const k of keys) {
        const btn = $(map[k].btn);
        const pane = $(map[k].pane);
        if (btn) btn.classList.toggle('active', k === t);
        if (pane) pane.classList.toggle('hide', k !== t);
      }
    }

    function setBadge(kind, text){
      const b = $('viewBadge');
      if (!b) return;
      b.textContent = '';
      b.className = 'badge dot' + (kind ? (' ' + kind) : '');
    }

    const ROLE_ORDER = [
      'dialer',
      'remote_setter',
      'in_person_setter',
      'closer',
      'account_manager',
      'event_host',
      'event_coordinator',
      'media_team',
      'manager',
    ];

    const MANAGER_VIEW_OPTIONS = [
      { role: 'manager', label: 'Manager' },
      { role: 'remote_setter', label: 'Remote setter' },
      { role: 'in_person_setter', label: 'In-person setter' },
      { role: 'closer', label: 'Closer' },
      { role: 'account_manager', label: 'Account manager' },
      { role: 'event_host', label: 'Event host' },
      { role: 'event_coordinator', label: 'Event coordinator' },
    ];

    function roleViewLabel(role){
      const r = String(role || '').trim();
      const map = {
        dialer: 'Dialer',
        remote_setter: 'Remote setter',
        in_person_setter: 'In-person setter',
        closer: 'Closer',
        account_manager: 'Account manager',
        event_host: 'Event host',
        event_coordinator: 'Event coordinator',
        media_team: 'Content',
        manager: 'Manager',
      };
      return map[r] || (r ? r.replaceAll('_', ' ') : '—');
    }

    function viewingLabel(role){
      const r = String(role || '').trim();
      if (['dialer','remote_setter'].includes(r)) return 'Calls';
      if (r === 'in_person_setter') return 'Booked';
      if (['closer','account_manager'].includes(r)) return 'Sales';
      if (r === 'event_host') return 'Events';
      if (r === 'event_coordinator') return 'Operations';
      if (r === 'media_team') return 'Content';
      if (r === 'manager') return 'Operations';
      return roleLabel(r);
    }

    function roleLabel(role){
      const r = String(role || '').trim();
      const map = {
        dialer: 'Calls',
        remote_setter: 'Calls',
        in_person_setter: 'Booked',
        closer: 'Sales',
        account_manager: 'Sales',
        event_host: 'Events',
        event_coordinator: 'Operations',
        media_team: 'Content',
        manager: 'Operations',
      };
      return map[r] || (r ? r.replaceAll('_', ' ') : '—');
    }

    function myRole(){
      return String(state.me?.profile?.role || '').trim();
    }

    function isManagerUser(){
      return myRole() === 'manager';
    }

    function effectiveRole(){
      if (!isManagerUser()) return myRole();
      const v = String(state.viewAsRole || '').trim();
      return v || 'manager';
    }

    function canLoadUserDirectory(){
      const r = effectiveRole();
      return isManagerUser() || r === 'event_coordinator';
    }

    function viewAsUserLabel(userId){
      const id = String(userId || '').trim();
      if (!id) return '';
      const u = (state.usersCache || []).find((x) => String(x.userId) === id);
      if (!u) return '';
      return String(u.fullName || u.email || '').trim();
    }

    function roleKeysForPeople(role){
      const r = String(role || '').trim();
      if (!r) return [];
      return [r];
    }

    function usersForViewAsRole(role){
      const keys = roleKeysForPeople(role);
      const all = Array.isArray(state.usersCache) ? state.usersCache : [];
      const users = all.filter((u) => keys.includes(String(u.role || '').trim()));
      users.sort((a, b) => {
        const an = String(a.fullName || a.email || a.userId || '');
        const bn = String(b.fullName || b.email || b.userId || '');
        return an.localeCompare(bn);
      });
      return users;
    }

    async function ensureUsersCache(){
      if (!canLoadUserDirectory()) return;
      if (Array.isArray(state.usersCache) && state.usersCache.length) return;
      try {
        const j = await api('/api/portal/users');
        state.usersCache = j.users || [];
      } catch(_e) {}
    }

    function setViewAsRole(nextRole){
      const raw = String(nextRole || '').trim();
      state.viewAsRole = raw === 'manager' ? '' : raw;
      state.viewAsUserId = '';

      const er = effectiveRole();
      if (['dialer','in_person_setter','remote_setter'].includes(er)) {
        state.activeTab = 'calls';
        if (er === 'in_person_setter') state.dialerSubtab = 'booked';
      }
      else if (['closer','account_manager'].includes(er)) state.activeTab = 'closer';
      else if (er === 'event_coordinator') state.activeTab = 'manager';
      else if (['event_host','media_team'].includes(er)) state.activeTab = 'events';
      else state.activeTab = 'overview';

      refreshMe().catch(() => {});
    }

    function setViewAsUserId(nextUserId){
      const v = String(nextUserId || '').trim();
      state.viewAsUserId = v;
      if (v) {
        const u = (Array.isArray(state.usersCache) ? state.usersCache : []).find((x) => String(x.userId) === v);
        const theirRole = String(u?.role || '').trim();
        if (theirRole) state.viewAsRole = theirRole;
      }
      refreshMe().catch(() => {});
    }

    function setDialerSubtab(next){
      state.dialerSubtab = String(next || 'call');
      renderDialerSubtab();
      queueAutoRefreshSoon();
    }

    function renderDialerSubtab(){
      const t = String(state.dialerSubtab || 'call');
      const map = {
        call: { btn: 'dialerSegCall', pane: 'dialerPaneCall' },
        activity: { btn: 'dialerSegActivity', pane: 'dialerPaneActivity' },
        booked: { btn: 'dialerSegBooked', pane: 'dialerPaneBooked' },
        tasks: { btn: 'dialerSegTasks', pane: 'dialerPaneTasks' },
      };
      const keys = Object.keys(map);
      for (const k of keys) {
        const btn = $(map[k].btn);
        const pane = $(map[k].pane);
        if (btn) btn.classList.toggle('active', k === t);
        if (pane) pane.classList.toggle('hide', k !== t);
      }
    }

    function setCloserSubtab(next){
      state.closerSubtab = String(next || 'disposition');
      renderCloserSubtab();
      queueAutoRefreshSoon();
    }

    function renderCloserSubtab(){
      const t = String(state.closerSubtab || 'disposition');
      const map = {
        disposition: { btn: 'closerSegDisposition', pane: 'closerPaneDisposition' },
        pipeline: { btn: 'closerSegPipeline', pane: 'closerPanePipeline' },
      };
      const keys = Object.keys(map);
      for (const k of keys) {
        const btn = $(map[k].btn);
        const pane = $(map[k].pane);
        if (btn) btn.classList.toggle('active', k === t);
        if (pane) pane.classList.toggle('hide', k !== t);
      }
    }

    function hideManualLoadButtons(){
      const ids = [
        'loadLeadsBtn','loadQueueBtn','loadCloserQueueBtn','loadEventsBtn','loadPayoutsBtn',
        'loadStatsBtn','loadDispatchBtn','loadDialerTasksBtn','loadCloserTasksBtn','loadApptsBtn',
        'refreshBtn','loadDialerTimelineBtn','meetingsRefreshBtn','dialerBookedRefreshBtn',
      ];
      for (const id of ids) {
        const el = $(id);
        if (el) el.classList.add('hide');
      }
    }

    let autoRefreshTimer = null;
    let autoRefreshQueued = false;

    function queueAutoRefreshSoon(){
      if (autoRefreshQueued) return;
      autoRefreshQueued = true;
      setTimeout(async () => {
        autoRefreshQueued = false;
        await autoRefreshActiveView().catch(()=>{});
      }, 350);
    }

    function startAutoRefresh(){
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      autoRefreshTimer = setInterval(() => {
        autoRefreshActiveView().catch(()=>{});
      }, 15000);
    }

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) queueAutoRefreshSoon();
    });

    function setTab(tab){
      state.activeTab = tab;
      const er = effectiveRole();
      const callsTitle = er === 'in_person_setter' ? 'Booked' : 'Calls';
      const title = {
        overview: 'Overview',
        leads: 'Leads',
        calls: callsTitle,
        meetings: 'My meetings',
        accounts: 'Accounts',
        closer: 'Sales',
        events: 'Events',
        talent: 'Talent',
        payments: 'Payments',
        manager: 'Operations'
      }[tab] || 'Overview';
      const viewKey = {
        overview: 'Overview',
        leads: 'Leads',
        calls: 'Calls',
        meetings: 'Meetings',
        accounts: 'Accounts',
        closer: 'Closer',
        events: 'Events',
        talent: 'Talent',
        payments: 'Payments',
        manager: 'Manager'
      }[tab] || 'Overview';

      $('viewTitle').textContent = title;

      const views = ['Overview','Leads','Calls','Meetings','Accounts','Closer','Events','Talent','Payments','Manager'];
      for (const v of views) $('view'+v).classList.add('hide');
      const viewEl = $('view' + viewKey);
      if (viewEl) viewEl.classList.remove('hide');

      for (const el of document.querySelectorAll('.navBtn')) {
        el.classList.toggle('active', el.dataset.tab === tab);
      }

      if (tab === 'overview') loadOverview().catch(()=>{});
      if (tab === 'leads') loadLeads().catch(()=>{});
      if (tab === 'events') loadEvents().catch(()=>{});
      if (tab === 'talent') loadTalentTab().catch(()=>{});
      if (tab === 'meetings') {
        renderMeetingsSubtab();
        if (state.meetingsSubtab === 'availability') loadAvailability().catch(()=>{});
        else loadAppointmentsInto('meetingsTbody', 'meetingsMsg').catch(()=>{});
      }
      if (tab === 'accounts') {
        loadAccounts().catch(()=>{});
      }
      if (tab === 'closer') {
        renderCloserSubtab();
        if (state.closerSubtab === 'pipeline') loadCloserQueue().catch(()=>{});
        // Closer Dispatch removed from Sales.
      }
      if (tab === 'calls') {
        renderDialerSubtab();
        if (state.dialerSubtab === 'call') loadQueue().catch(()=>{});
        if (state.dialerSubtab === 'activity') {
          if (state.selectedLead && state.selectedLead.id) loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
        }
        if (state.dialerSubtab === 'tasks') {
          loadDispatchInto('dialerTasksTbody', 'dialerTasksMsg', { overdueOnly: !!$('dialerTasksOverdue')?.checked, scope: String($('dialerTasksScope')?.value || 'role') }).catch(()=>{});
        }
        if (state.dialerSubtab === 'booked') {
          loadDialerBooked().catch(()=>{});
        }
      }
      if (tab === 'manager') {
        loadDispatchManager().catch(()=>{});
      }

      queueAutoRefreshSoon();
    }

    async function autoRefreshActiveView(){
      const tab = String(state.activeTab || 'overview');
      if (!state.token) return;
      if (tab === 'overview') {
        await loadOverview().catch(()=>{});
      }
      if (tab === 'leads') {
        await loadLeads().catch(()=>{});
        if (state.selectedLead?.id) await loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
      }
      if (tab === 'calls') {
        renderDialerSubtab();
        if (state.dialerSubtab === 'call') await loadQueue().catch(()=>{});
        if (state.dialerSubtab === 'activity') {
          if (state.selectedLead?.id) await loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
        }
        if (state.dialerSubtab === 'tasks') {
          await loadDispatchInto('dialerTasksTbody', 'dialerTasksMsg', { overdueOnly: !!$('dialerTasksOverdue')?.checked, scope: String($('dialerTasksScope')?.value || 'role') }).catch(()=>{});
        }
        if (state.dialerSubtab === 'booked') {
          await loadDialerBooked().catch(()=>{});
        }
      }
      if (tab === 'closer') {
        renderCloserSubtab();
        if (state.closerSubtab === 'pipeline') await loadCloserQueue().catch(()=>{});
        // Closer Dispatch removed from Sales.
      }
      if (tab === 'meetings') {
        await loadAppointmentsInto('meetingsTbody', 'meetingsMsg').catch(()=>{});
      }
      if (tab === 'accounts') {
        await loadAccounts().catch(()=>{});
      }
      if (tab === 'events') {
        await loadEvents().catch(()=>{});
        if (state.selectedEvent?.id) await loadRecaps(state.selectedEvent.id).catch(()=>{});
      }
      if (tab === 'talent') {
        await loadTalentTab().catch(()=>{});
      }
      if (tab === 'payments') {
        await loadPayouts().catch(()=>{});
      }
      if (tab === 'manager') {
        if (myRole() === 'manager') await loadStats().catch(()=>{});
        await loadDispatchManager().catch(()=>{});
      }
    }

    function showAuthView(message){
      $('authView').classList.remove('hide');
      $('appView').classList.add('hide');
      $('authMsg').textContent = message || '';
      const ok = $('authOk');
      if (ok) ok.textContent = '';
    }

    function showAppView(){
      $('authView').classList.add('hide');
      $('appView').classList.remove('hide');
    }

    async function api(path, { method='GET', body=null } = {}){
      const token = String(state.token || '').trim();
      if (!token) throw new Error('not_signed_in');

      const headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token,
      };

      // Manager-only: pass effective view-as role to the server so it can
      // enforce scoping (and read-only) server-side.
      const viewAs = isManagerUser() ? String(state.viewAsRole || '').trim() : '';
      const viewAsUserId = isManagerUser() ? String(state.viewAsUserId || '').trim() : '';
      const p = String(path || '');
      const exclude = [
        '/api/portal/me',
        '/api/portal/users',
        '/api/portal/stats',
        '/api/portal/dispatch_scan',
        '/api/portal/seed',
      ];
      const excluded = exclude.some((x) => p.startsWith(x));
      if (viewAs && p.startsWith('/api/portal/') && !excluded) {
        headers['X-Portal-View-As'] = viewAs;
        if (viewAsUserId) headers['X-Portal-View-As-User'] = viewAsUserId;
      }

      const r = await fetch(path, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined,
      });
      const j = await r.json().catch(() => null);
      if (!j || !j.ok) {
        const err = String(j?.error || ('http_' + r.status));
        if (err === 'view_as_read_only') {
          throw new Error('View-as is read-only');
        }
        throw new Error(err);
      }
      if (String(method || 'GET').toUpperCase() !== 'GET') {
        queueAutoRefreshSoon();
      }
      return j;
    }

    async function refreshMe(){
      const token = String(state.token || '').trim();
      if (!token){
        state.me = null;
        showAuthView('');
        setTab('overview');
        return;
      }

      let me = null;
      try {
        me = await api('/api/portal/me');
        state.me = me;
      } catch (e) {
        // Token likely expired or invalid
        state.token = '';
        localStorage.removeItem('portal_access_token');
        state.me = null;
        showAuthView('Session expired. Please sign in again.');
        return;
      }

      showAppView();

      me = state.me;
      const realRole = String(me.profile.role || '').trim();
      const er = effectiveRole();

      // Manager view-as needs the user roster to offer a person picker.
      if (isManagerUser()) await ensureUsersCache();

      const inViewAs = isManagerUser() && (!!String(state.viewAsRole || '').trim() || !!String(state.viewAsUserId || '').trim());
      $('roleLine').textContent = inViewAs
        ? `Viewing ${roleViewLabel(er)}${(state.viewAsUserId ? (' — ' + (viewAsUserLabel(state.viewAsUserId) || '')) : '')}`.trim()
        : roleViewLabel(realRole);
      $('appUser').textContent = me.user.email;

      const navItems = [];
      navItems.push({ id:'overview', label:'Overview' });
      navItems.push({ id:'leads', label:'Leads' });
      if (['dialer','remote_setter','in_person_setter'].includes(er)) {
        navItems.push({ id:'calls', label: er === 'in_person_setter' ? 'Booked' : 'Calls' });
        navItems.push({ id:'meetings', label:'Meetings' });
      }
      if (['closer','account_manager'].includes(er)) {
        navItems.push({ id:'closer', label:'Sales' });
        navItems.push({ id:'meetings', label:'Meetings' });
      }
      if (er === 'account_manager' || er === 'manager') {
        navItems.push({ id:'accounts', label:'Accounts' });
      }
      if (['event_host','media_team','event_coordinator'].includes(er)) {
        navItems.push({ id:'events', label: er === 'media_team' ? 'Content' : 'Events' });
        navItems.push({ id:'talent', label:'Talent' });
      }
      if (er === 'event_coordinator' || er === 'manager') {
        navItems.push({ id:'manager', label:'Operations' });
      }
      navItems.push({ id:'payments', label:'Payments' });

      const viewAsHtml = isManagerUser() ? (() => {
        const inViewAs = !!String(state.viewAsRole || '').trim() || !!String(state.viewAsUserId || '').trim();
        const currentRole = String(state.viewAsRole || '').trim() || 'manager';

        const activeOpt = MANAGER_VIEW_OPTIONS.find((o) => String(o.role) === String(currentRole)) || MANAGER_VIEW_OPTIONS[0];
        const viewSelect = `
          <div class="navTitle">Views</div>
          <div class="dd" id="viewRoleDd" style="margin-top:6px;">
            <button id="viewRoleBtn" class="ddBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
              <span>${escapeHtml(activeOpt?.label || 'Manager')}</span>
              <span class="muted small">▼</span>
            </button>
            <div id="viewRoleMenu" class="ddMenu hide" role="listbox" aria-label="Views">
              ${MANAGER_VIEW_OPTIONS.map((o) => {
                const active = String(o.role) === String(currentRole);
                return `<button class="ddItem ${active ? 'active' : ''}" type="button" data-view-role="${escapeHtml(o.role)}">${escapeHtml(o.label)}</button>`;
              }).join('')}
            </div>
          </div>
        `;

        const selectedRole = String(state.viewAsRole || '').trim();
        const people = selectedRole ? usersForViewAsRole(selectedRole) : [];
        const peopleBtns = selectedRole ? `
          <div class="navTitle" style="margin-top:8px;">Person</div>
          <div style="max-height:240px; overflow:auto; padding-right:4px;">
            ${people.map((u) => {
              const label = String(u.fullName || u.email || u.userId || '').trim() || u.userId;
              const active = String(u.userId) === String(state.viewAsUserId || '');
              return `<button class="navBtn ${active ? 'active' : ''}" type="button" data-viewas-user="${escapeHtml(u.userId)}">${escapeHtml(label)}</button>`;
            }).join('')}
          </div>
        ` : '';

        return `${viewSelect}${peopleBtns}<div style="height:10px"></div><div class="navTitle">Menu</div>`;
      })() : '<div class="navTitle">Menu</div>';

      const ico = {
        overview: 'O',
        leads: 'L',
        calls: 'C',
        meetings: 'M',
        accounts: 'A',
        closer: 'S',
        events: 'E',
        talent: 'T',
        payments: '$',
        manager: '⚙',
      };

      $('nav').innerHTML = viewAsHtml + navItems
        .map((t) => `<button class="navBtn" type="button" data-tab="${t.id}"><span class="navIco">${escapeHtml(ico[t.id] || '•')}</span><span class="navLbl">${escapeHtml(t.label)}</span></button>`)
        .join('');

      // Role-specific UI tweaks
      try {
        const setterMode = (er === 'in_person_setter');
        const seg = $('dialerSegCall');
        if (seg) seg.textContent = setterMode ? 'Queue' : 'Queue & Call';
        const form = $('dialerCallForm');
        if (form) form.classList.toggle('hide', setterMode);
        if (setterMode && state.dialerSubtab === 'call') state.dialerSubtab = 'booked';
      } catch(_e) {}

      const mgrStats = $('mgrStatsCard');
      if (mgrStats) mgrStats.classList.toggle('hide', effectiveRole() !== 'manager');

      // Setter-only: show Pull Leads button.
      try {
        const canPull = !isManagerUser() && ['remote_setter','in_person_setter'].includes(er);
        const pl = $('pullLeadsToggle');
        if (pl) pl.classList.toggle('hide', !canPull);
      } catch(_e) {}

      for (const el of document.querySelectorAll('.navBtn[data-tab]')){
        el.addEventListener('click', () => setTab(el.dataset.tab));
      }

      // Custom Views dropdown (manager)
      try {
        const ddBtn = $('viewRoleBtn');
        const ddMenu = $('viewRoleMenu');
        if (ddBtn && ddMenu) {
          const close = () => {
            ddMenu.classList.add('hide');
            ddBtn.setAttribute('aria-expanded', 'false');
          };
          const toggle = () => {
            const open = !ddMenu.classList.contains('hide');
            if (open) close();
            else {
              ddMenu.classList.remove('hide');
              ddBtn.setAttribute('aria-expanded', 'true');
            }
          };

          ddBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggle();
          });
          for (const item of ddMenu.querySelectorAll('button[data-view-role]')) {
            item.addEventListener('click', () => {
              const role = String(item.dataset.viewRole || '').trim();
              close();
              setViewAsRole(role);
            });
          }

          if (window.__portalViewDdCloser) document.removeEventListener('click', window.__portalViewDdCloser, true);
          window.__portalViewDdCloser = (ev) => {
            const dd = $('viewRoleDd');
            if (!dd) return;
            if (dd.contains(ev.target)) return;
            close();
          };
          document.addEventListener('click', window.__portalViewDdCloser, true);
        }
      } catch(_e) {}

      for (const item of document.querySelectorAll('button[data-viewas-user]')) {
        item.addEventListener('click', () => {
          const uid = String(item.dataset.viewasUser || '').trim();
          setViewAsUserId(uid);
        });
      }

      // No explicit exit button: managers can switch back to Manager in the Views dropdown.

      // Manager-only controls
      $('newEventToggle').classList.toggle('hide', !(me.profile.role === 'manager' || me.profile.role === 'event_coordinator'));

      // Overview
      $('viewOverview').innerHTML = `
        <div class="row" style="justify-content:space-between; gap:16px;">
          <div>
            <div class="muted small">Signed in</div>
            <div style="font-weight:900; margin-top:4px;">${me.user.email}</div>
          </div>
          <div>
            <div class="muted small">Workspace</div>
            <div style="margin-top:4px;"><span class="badge ok">${escapeHtml(inViewAs ? roleViewLabel(er) : roleViewLabel(realRole))}</span></div>
            ${inViewAs && state.viewAsUserId ? `<div class="muted small" style="margin-top:6px;">${escapeHtml(viewAsUserLabel(state.viewAsUserId) || '')}</div>` : ''}
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="muted small">At-a-glance only (no mixed workflows).</div>
        <div style="height:10px"></div>
        <div id="overviewMsg" class="err"></div>
        <div id="overviewCards" class="two"></div>
      `;

      hideManualLoadButtons();
      startAutoRefresh();

      setTab(state.activeTab || 'overview');
    }

    async function loadOverview(){
      const box = $('overviewCards');
      const msg = $('overviewMsg');
      if (!box) return;
      if (msg) msg.textContent = '';

      const er = effectiveRole();
      setBadge('warn', 'loading');

      const cards = [];
      const fmtNum = (n) => Number(n || 0).toLocaleString();
      const sumMoney = (rows) => (Array.isArray(rows) ? rows : []).reduce((a, r) => a + Number(r.amount || 0), 0);

      try{
        if (['dialer','in_person_setter','remote_setter'].includes(er)) {
          const [qR, aR, dR, pR] = await Promise.allSettled([
            api('/api/portal/queue?kind=dialer&limit=200'),
            api('/api/portal/appointments?limit=200'),
            api('/api/portal/dispatch?limit=200&scope=role'),
            api('/api/portal/payouts?limit=30'),
          ]);

          const queue = qR.status === 'fulfilled' ? (qR.value.leads || []) : [];
          const appts = aR.status === 'fulfilled' ? (aR.value.appointments || []) : [];
          const tasks = dR.status === 'fulfilled' ? (dR.value.tasks || []) : [];
          const payouts = pR.status === 'fulfilled' ? (pR.value.payouts || []) : [];

          const openTasks = tasks.filter((t) => ['open','assigned'].includes(String(t.status || '')));
          const overdueTasks = openTasks.filter((t) => isOverdue(t));

          cards.push({
            title: 'Queue',
            sub: 'Leads in your call queue',
            value: fmtNum(queue.length),
            hint: 'Open Calls → Queue & Call',
          });

          cards.push({
            title: 'Booked',
            sub: 'Meetings you scheduled',
            value: fmtNum(appts.length),
            hint: 'Open Calls → Booked',
          });

          cards.push({
            title: 'Dispatch',
            sub: 'Open tasks',
            value: `${fmtNum(openTasks.length)}${overdueTasks.length ? (` • overdue ${fmtNum(overdueTasks.length)}`) : ''}`,
            hint: 'Open Calls → Dispatch',
          });

          cards.push({
            title: 'Commissions',
            sub: 'Recent payouts',
            value: `$${sumMoney(payouts).toFixed(2)}`,
            hint: 'Open Payments',
          });
        } else if (['closer','account_manager'].includes(er)) {
          const [aR, dR, vR, pR] = await Promise.allSettled([
            api('/api/portal/appointments?limit=200'),
            api('/api/portal/dispatch?limit=200&scope=role'),
            api('/api/portal/availability'),
            api('/api/portal/payouts?limit=30'),
          ]);

          const appts = aR.status === 'fulfilled' ? (aR.value.appointments || []) : [];
          const tasks = dR.status === 'fulfilled' ? (dR.value.tasks || []) : [];
          const payouts = pR.status === 'fulfilled' ? (pR.value.payouts || []) : [];
          const slots = vR.status === 'fulfilled' ? (vR.value.availability?.slots || null) : null;
          const byDate = slots && typeof slots === 'object' && slots.byDate && typeof slots.byDate === 'object' ? slots.byDate : null;
          const days = byDate ? Object.keys(byDate).length : 0;

          const upcoming = appts.filter((a) => String(a.status || '') === 'scheduled');
          const openTasks = tasks.filter((t) => ['open','assigned'].includes(String(t.status || '')));
          const overdueTasks = openTasks.filter((t) => isOverdue(t));

          cards.push({ title: 'Meetings', sub: 'Scheduled appointments', value: fmtNum(upcoming.length), hint: 'Open Sales → Meetings' });
          cards.push({ title: 'Availability', sub: 'Days with slots saved', value: fmtNum(days), hint: 'Open Sales → Availability' });
          cards.push({ title: 'Dispatch', sub: 'Open tasks', value: `${fmtNum(openTasks.length)}${overdueTasks.length ? (` • overdue ${fmtNum(overdueTasks.length)}`) : ''}`, hint: 'Open Sales → Dispatch' });
          cards.push({ title: 'Commissions', sub: 'Recent payouts', value: `$${sumMoney(payouts).toFixed(2)}`, hint: 'Open Payments' });
        } else if (er === 'manager') {
          cards.push({ title: 'Manager', sub: 'Use Manager tab for ops/stats', value: '—', hint: 'Open Manager' });
        } else {
          cards.push({ title: 'Workspace', sub: 'Use the menu to open your workspace', value: '—', hint: '' });
        }

        box.innerHTML = cards.map((c) => `
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="muted small">${escapeHtml(c.sub || '')}</div>
              <div style="font-weight:900; font-size:18px; margin-top:6px;">${escapeHtml(c.value || '')}</div>
              <div style="height:6px"></div>
              <div class="muted small" style="font-weight:900; letter-spacing:.1px;">${escapeHtml(c.title || '')}</div>
              ${c.hint ? `<div class="muted small" style="margin-top:6px;">${escapeHtml(c.hint)}</div>` : ''}
            </div>
          </div>
        `).join('');
        setBadge('ok', 'ready');
      } catch(e){
        if (msg) msg.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    function requireSelectedLead(where){
      if (!state.selectedLead || !state.selectedLead.id) {
        const msg = where ? (where + ': select a lead first') : 'select a lead first';
        throw new Error(msg);
      }
      return state.selectedLead;
    }

    function setSelectedLeadLine(){
      const l = state.selectedLead;
      const line = l
        ? `#${l.id} • ${[l.first_name, l.last_name].filter(Boolean).join(' ').trim()} • ${l.property_name || l.company || ''}`.trim()
        : 'None';
      if ($('selectedLeadLine')) $('selectedLeadLine').textContent = line;
      if ($('closerSelectedLead')) $('closerSelectedLead').textContent = line;
      if ($('leadDetailTitle')) $('leadDetailTitle').textContent = line;

      // Populate lead edit defaults for convenience
      if (l) {
        if ($('leadEditStatus')) $('leadEditStatus').value = '';
        if ($('leadEditPriority')) $('leadEditPriority').value = '';
        if ($('leadEditAssignedRole')) $('leadEditAssignedRole').value = '';
        if ($('leadEditAssignedUser')) $('leadEditAssignedUser').value = '';
        const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
        if ($('leadEditFollowup')) $('leadEditFollowup').value = fu;
      }
    }

    function leadDisplayName(l){
      if (!l) return '';
      const name = [l.first_name, l.last_name].filter(Boolean).join(' ').trim();
      const prop = l.property_name || l.company || '';
      return [name || '(no name)', prop].filter(Boolean).join(' • ');
    }

    function activityLabel(a){
      const t = String(a.activity_type || '');
      if (t === 'call') return 'Call';
      if (t === 'close') return 'Close';
      if (t === 'note') return 'Note';
      return t || 'Activity';
    }

    function renderTimeline(listElId, msgElId, items){
      const msgEl = msgElId ? $(msgElId) : null;
      const listEl = $(listElId);
      if (!listEl) return;
      if (msgEl) msgEl.textContent = '';

      const arr = Array.isArray(items) ? items : [];
      if (!arr.length) {
        listEl.innerHTML = '<div class="muted small">No activity yet.</div>';
        return;
      }

      listEl.innerHTML = arr.map((a) => {
        const when = String(a.created_at || '').replace('T', ' ').slice(0, 19);
        const label = activityLabel(a);
        const outcome = a.outcome ? `<span class="badge">${escapeHtml(a.outcome)}</span>` : '';
        const notes = a.notes ? `<div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(a.notes)}</div>` : '';
        const payload = a.payload && typeof a.payload === 'object' ? a.payload : {};
        const fu = payload.followup || '';
        const fuLine = fu ? `<div class="muted small" style="margin-top:6px;">Follow up: ${escapeHtml(String(fu))}</div>` : '';
        return `
          <div class="card" style="background:#fff; margin-bottom:10px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; gap:10px; align-items:flex-start;">
                <div>
                  <div class="muted small">${escapeHtml(when)}</div>
                  <div style="font-weight:900; margin-top:4px;">${escapeHtml(label)}</div>
                </div>
                <div class="row">${outcome}</div>
              </div>
              ${notes}
              ${fuLine}
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadTimelineInto(listElId, msgElId){
      const msgEl = msgElId ? $(msgElId) : null;
      if (msgEl) msgEl.textContent = '';
      try{
        const lead = requireSelectedLead('Timeline');
        const j = await api('/api/portal/activities?leadId=' + encodeURIComponent(String(lead.id)) + '&limit=80');
        renderTimeline(listElId, msgElId, j.activities || []);
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
      }
    }

    async function addTimelineNote(noteElId, msgElId, listElId){
      const msgEl = msgElId ? $(msgElId) : null;
      if (msgEl) msgEl.textContent = '';
      try{
        const lead = requireSelectedLead('Add note');
        const notes = String($(noteElId)?.value || '').trim();
        if (!notes) throw new Error('Write a note');
        const fu = String($('leadEditFollowup')?.value || '').trim();

        await api('/api/portal/activities', {
          method: 'POST',
          body: {
            leadId: lead.id,
            activityType: 'note',
            notes,
            payload: fu ? { followup: fu } : {},
          }
        });

        const nEl = $(noteElId);
        if (nEl) nEl.value = '';
        await loadTimelineInto(listElId, msgElId);
        setBadge('ok', 'saved');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
      }
    }

    async function saveLeadEdits(){
      $('leadSaveMsg').textContent = '';
      try{
        const lead = requireSelectedLead('Lead update');
        const patch = { id: lead.id };

        const st = $('leadEditStatus').value;
        const pr = $('leadEditPriority').value;
        const ar = $('leadEditAssignedRole').value;
        const au = $('leadEditAssignedUser').value.trim();
        const fu = $('leadEditFollowup').value.trim();

        if (st) patch.status = st;
        if (pr !== '') patch.priority = Number(pr);
        if (ar) patch.assignedRole = ar;
        if (au) patch.assignedUserId = au;

        // Merge meta followup
        const nextMeta = Object.assign({}, (lead.meta && typeof lead.meta === 'object') ? lead.meta : {});
        if (fu) nextMeta.followup = fu;
        if (!fu && 'followup' in nextMeta) delete nextMeta.followup;
        patch.meta = nextMeta;

        await api('/api/portal/leads', { method:'PATCH', body: patch });
        await loadLeads();
        // Preserve selected lead instance from refreshed list
        state.selectedLead = state.leads.find((x) => Number(x.id) === Number(lead.id)) || state.selectedLead;
        setSelectedLeadLine();
        await loadTimelineInto('timelineList', 'timelineMsg');
        setBadge('ok', 'updated');
      } catch(e){
        $('leadSaveMsg').textContent = String(e.message || e);
      }
    }

    async function loadQueue(){
      $('queueMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/queue?kind=dialer&limit=50');
        const leads = j.leads || [];
        const tb = $('queueTbody');
        if (!tb) return;

        if (!leads.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No queue items.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = leads.map((l) => {
          const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
          const prop = l.property_name || l.company || '';
          const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
          const canClaim = !l.assigned_user_id;
          const claimBtn = canClaim ? `<button class="btn small" data-queue-claim="${l.id}">Claim</button>` : '';
          return `
            <tr>
              <td><span class="badge">${l.id}</span></td>
              <td>${escapeHtml(name)}</td>
              <td class="muted">${escapeHtml(prop)}</td>
              <td><span class="badge">${escapeHtml(l.status || '')}</span></td>
              <td class="muted">${escapeHtml(String(l.priority ?? 0))}</td>
              <td class="muted">${escapeHtml(fu)}</td>
              <td><button class="btn secondary small" data-queue-pick="${l.id}">Select</button> ${claimBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-queue-pick]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.queuePick);
            const l = leads.find((x) => Number(x.id) === id) || null;
            state.selectedLead = l;
            setSelectedLeadLine();
          });
        }

        for (const btn of tb.querySelectorAll('button[data-queue-claim]')){
          btn.addEventListener('click', async () => {
            $('queueMsg').textContent = '';
            try{
              const id = Number(btn.dataset.queueClaim);
              await api('/api/portal/leads', { method:'PATCH', body: { id, assignedUserId: state.me.user.id, status: 'working' } });
              await loadQueue();
              setBadge('ok', 'claimed');
            } catch(e){
              $('queueMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('queueMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadStats(){
      $('statsMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/stats?scope=all');
        const c = j.leadCounts || {};
        const box = $('statsBox');
        if (box) {
          box.innerHTML = [
            `<span class="badge ok">new ${Number(c.new ?? 0)}</span>`,
            `<span class="badge">working ${Number(c.working ?? 0)}</span>`,
            `<span class="badge">booked ${Number(c.booked ?? 0)}</span>`,
            `<span class="badge ok">won ${Number(c.won ?? 0)}</span>`,
            `<span class="badge warn">lost ${Number(c.lost ?? 0)}</span>`,
            `<span class="badge">calls24h ${Number(j.callsLast24h ?? 0)}</span>`,
            `<span class="badge">upcoming appts ${Number(j.upcomingAppointments ?? 0)}</span>`,
            `<span class="badge">dispatch open ${Number(j.dispatchOpen ?? 0)}</span>`,
            `<span class="badge warn">dispatch overdue ${Number(j.dispatchOverdue ?? 0)}</span>`,
          ].join(' ');
        }
        setBadge('ok', 'loaded');
      } catch(e){
        $('statsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function managerAssignLead(){
      $('mgrAssignMsg').textContent = '';
      try{
        const id = Number($('mgrLeadId').value || 0);
        if (!id) throw new Error('Enter a lead id');
        const body = { id };

        const role = $('mgrAssignedRole').value;
        const userId = $('mgrAssignedUserId').value.trim();
        if (role) body.assignedRole = role;
        if (userId) body.assignedUserId = userId;

        await api('/api/portal/leads', { method:'PATCH', body });
        setBadge('ok', 'assigned');
      } catch(e){
        $('mgrAssignMsg').textContent = String(e.message || e);
      }
    }

    async function loadTeamAvailability(){
      $('teamAvailMsg').textContent = '';
      const box = $('teamAvailList');
      if (box) box.innerHTML = '';
      try{
        if (!state.usersCache || !Array.isArray(state.usersCache) || !state.usersCache.length) {
          throw new Error('Load users first');
        }
        const users = state.usersCache.slice(0, 60);
        const rows = [];
        for (const u of users) {
          // eslint-disable-next-line no-await-in-loop
          const j = await api('/api/portal/availability?userId=' + encodeURIComponent(String(u.userId)));
          const notes = String(j.availability?.notes || '').trim();
          const slots = (j.availability?.slots && typeof j.availability.slots === 'object') ? j.availability.slots : null;
          const byDate = (slots && slots.byDate && typeof slots.byDate === 'object') ? slots.byDate : null;

          let text = notes;
          if (!text && byDate) {
            const days = Object.keys(byDate);
            let total = 0;
            for (const d of days) {
              const arr = Array.isArray(byDate[d]) ? byDate[d] : [];
              total += arr.length;
            }
            if (days.length && total) {
              text = `Slots: ${total} across ${days.length} days`;
            }
          }

          if (!text) continue;
          rows.push({ u, notes: text, updatedAt: j.availability?.updatedAt || '' });
        }
        if (!rows.length) {
          if (box) box.innerHTML = '<div class="muted small">No availability saved.</div>';
          return;
        }
        if (box) {
          box.innerHTML = rows.map((r) => `
            <div class="card" style="background:#fff; margin-bottom:10px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; gap:10px;">
                  <div>
                    <div style="font-weight:900;">${escapeHtml(r.u.email || r.u.userId)}</div>
                    <div class="muted small" style="margin-top:4px;">${escapeHtml(viewingLabel(r.u.role || ''))}</div>
                  </div>
                  <div class="muted small">${escapeHtml(String(r.updatedAt || '').slice(0,19).replace('T',' '))}</div>
                </div>
                <div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(r.notes)}</div>
              </div>
            </div>
          `).join('');
        }
      } catch(e){
        $('teamAvailMsg').textContent = String(e.message || e);
      }
    }

    function dispatchDue(task){
      const d = String(task?.event_date || '');
      const t = String(task?.start_time || '');
      return [d, t].filter(Boolean).join(' ');
    }

    function isOverdue(task){
      const st = String(task?.status || '');
      if (['completed', 'cancelled'].includes(st)) return false;
      const d = String(task?.event_date || '');
      if (!d) return false;
      const now = new Date();
      const yyyy = now.getUTCFullYear();
      const mm = String(now.getUTCMonth() + 1).padStart(2, '0');
      const dd = String(now.getUTCDate()).padStart(2, '0');
      const today = `${yyyy}-${mm}-${dd}`;
      return d < today;
    }

    async function loadDispatchInto(tbodyId, msgId, { overdueOnly = false, scope = '' } = {}){
      const tb = $(tbodyId);
      const msgEl = $(msgId);
      if (!tb) return;
      if (msgEl) msgEl.textContent = '';
      setBadge('warn', 'loading');
      try{
        const qs = [];
        qs.push('limit=80');
        if (overdueOnly) qs.push('overdue=1');
        if (scope) qs.push('scope=' + encodeURIComponent(scope));
        const j = await api('/api/portal/dispatch?' + qs.join('&'));
        const tasks = (j.tasks || []).filter((t) => !['completed','cancelled'].includes(String(t.status || '')));
        state.dispatch = tasks;
        if (!tasks.length) {
          tb.innerHTML = '<tr><td colspan="5" class="muted">No tasks.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        const meId = state.me?.user?.id;
        const role = String(state.me?.profile?.role || '');

        tb.innerHTML = tasks.map((t) => {
          const meta = t.meta && typeof t.meta === 'object' ? t.meta : {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = String(t.status || '');
          const due = dispatchDue(t);
          const overdue = isOverdue(t) ? '<span class="badge warn">overdue</span>' : '';
          const escalated = meta.escalatedAt ? '<span class="badge warn">escalated</span>' : '';
          const canClaim = !t.assigned_user_id && st === 'open' && role && t.assigned_role === role;
          const canComplete = (t.assigned_user_id && meId && t.assigned_user_id === meId) || String(state.me?.profile?.role || '') === 'manager';
          const claimBtn = canClaim ? `<button class="btn small" data-task-claim="${t.id}">Claim</button>` : '';
          const doneBtn = canComplete ? `<button class="btn secondary small" data-task-done="${t.id}">Done</button>` : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(due)}</td>
              <td>${escapeHtml(String(t.title || ''))} ${overdue} ${escalated}</td>
              <td class="muted">${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>${claimBtn} ${doneBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-task-claim]')){
          btn.addEventListener('click', async () => {
            if (msgEl) msgEl.textContent = '';
            try{
              const id = Number(btn.dataset.taskClaim);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, assignedUserId: state.me.user.id, status: 'assigned' } });
              await loadDispatchInto(tbodyId, msgId);
              setBadge('ok', 'claimed');
            } catch(e){
              if (msgEl) msgEl.textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-task-done]')){
          btn.addEventListener('click', async () => {
            if (msgEl) msgEl.textContent = '';
            try{
              const id = Number(btn.dataset.taskDone);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'completed' } });
              await loadDispatchInto(tbodyId, msgId);
              setBadge('ok', 'done');
            } catch(e){
              if (msgEl) msgEl.textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadDispatchManager(){
      const tb = $('dispatchTbody');
      $('dispatchMsg').textContent = '';
      if (!tb) return;
      setBadge('warn', 'loading');
      try{
        const statusFilter = String($('dispatchStatus')?.value || '').trim();
        const roleFilter = String($('dispatchRole')?.value || '').trim();
        const overdueOnly = !!$('dispatchOverdueOnly')?.checked;

        const qs = [];
        qs.push('limit=180');
        if (statusFilter) qs.push('status=' + encodeURIComponent(statusFilter));
        if (roleFilter) qs.push('assignedRole=' + encodeURIComponent(roleFilter));
        if (overdueOnly) qs.push('overdue=1');

        const j = await api('/api/portal/dispatch?' + qs.join('&'));
        let tasks = (j.tasks || []);
        if (!statusFilter) {
          // Default view: show open/assigned only.
          tasks = tasks.filter((t) => ['open', 'assigned'].includes(String(t.status || '')));
        }
        state.dispatch = tasks;
        if (!tasks.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No tasks.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = tasks.map((t) => {
          const meta = t.meta && typeof t.meta === 'object' ? t.meta : {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = String(t.status || '');
          const due = dispatchDue(t);
          const overdue = isOverdue(t) ? '<span class="badge warn">overdue</span>' : '';
          const escalated = meta.escalatedAt ? '<span class="badge warn">escalated</span>' : '';
          const assigned = t.assigned_user_id ? String(t.assigned_user_id).slice(0, 8) : '';
          const canEscalate = isOverdue(t) && !meta.escalatedAt && !['completed','cancelled'].includes(st);
          const escBtn = canEscalate ? `<button class="btn secondary small" data-mgr-escalate="${t.id}">Escalate</button>` : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(due)}</td>
              <td>${escapeHtml(String(t.title || ''))} ${overdue} ${escalated}</td>
              <td><span class="badge">${escapeHtml(viewingLabel(String(t.assigned_role || '')))}</span></td>
              <td class="muted" style="font-family:var(--mono); font-size:12px;">${escapeHtml(assigned)}</td>
              <td class="muted">${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>
                <button class="btn secondary small" data-mgr-assign="${t.id}">Assign</button>
                <button class="btn secondary small" data-mgr-done="${t.id}">Done</button>
                <button class="btn secondary small" data-mgr-cancel="${t.id}">Cancel</button>
                ${escBtn}
              </td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-mgr-assign]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrAssign);
              const userId = prompt('Assign user id (uuid) or blank to clear:', '');
              if (userId == null) return;
              const nextAssigned = String(userId).trim() || null;
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, assignedUserId: nextAssigned, status: nextAssigned ? 'assigned' : 'open' } });
              await loadDispatchManager();
              setBadge('ok', 'assigned');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-mgr-done]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrDone);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'completed' } });
              await loadDispatchManager();
              setBadge('ok', 'done');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-mgr-cancel]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrCancel);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'cancelled' } });
              await loadDispatchManager();
              setBadge('ok', 'cancelled');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-mgr-escalate]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrEscalate);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, action: 'escalate' } });
              await loadDispatchManager();
              setBadge('ok', 'escalated');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('dispatchMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createDispatchTask(){
      $('dispatchCreateMsg').textContent = '';
      try{
        const assignedRole = String($('dispatchAssignedRole').value || '').trim();
        if (!assignedRole) throw new Error('Select an assigned workspace');
        const title = String($('dispatchTitle').value || '').trim();
        if (!title) throw new Error('Enter a title');

        const leadIdRaw = String($('dispatchLeadId').value || '').trim();
        const leadId = leadIdRaw ? Number(leadIdRaw) : null;
        const body = {
          leadId: leadId || null,
          title,
          assignedRole,
          assignedUserId: String($('dispatchAssignedUserId').value || '').trim() || null,
          dueDate: $('dispatchDueDate').value || null,
          dueTime: $('dispatchDueTime').value || '',
          priority: Number($('dispatchPriority').value || 0),
          notes: String($('dispatchNotes').value || ''),
        };

        await api('/api/portal/dispatch', { method:'POST', body });
        $('dispatchTitle').value = '';
        $('dispatchNotes').value = '';
        $('dispatchAssignedUserId').value = '';
        await loadDispatchManager();
        setBadge('ok', 'created');
      } catch(e){
        $('dispatchCreateMsg').textContent = String(e.message || e);
      }
    }

    async function scanDispatchOverdue(){
      $('dispatchMsg').textContent = '';
      try{
        const j = await api('/api/portal/dispatch_scan', { method:'POST', body: {} });
        $('dispatchMsg').textContent = `Scanned ${Number(j.scanned || 0)}; escalated ${Number(j.escalated || 0)}`;
        await loadDispatchManager();
        setBadge('ok', 'scanned');
      } catch(e){
        $('dispatchMsg').textContent = String(e.message || e);
      }
    }

    async function aiResearch(){
      $('researchMsg').textContent = '';
      $('researchBox').classList.add('hide');
      try{
        const lead = requireSelectedLead('AI research');
        const question = $('researchQ').value.trim();
        const j = await api('/api/portal/ai/research', {
          method: 'POST',
          body: { leadId: lead.id, question },
        });
        const r = j.research || {};
        $('researchSummary').value = String(r.summary || '');
        $('researchTalking').value = Array.isArray(r.talkingPoints) ? r.talkingPoints.join('\n') : '';
        $('researchObjections').value = Array.isArray(r.likelyObjections) ? r.likelyObjections.join('\n') : '';
        $('researchNext').value = Array.isArray(r.nextSteps) ? r.nextSteps.join('\n') : '';
        $('researchBox').classList.remove('hide');
      } catch(e){
        $('researchMsg').textContent = String(e.message || e);
      }
    }

    function fillTierPrice(){
      const tier = String($('closePackage').value || '');
      const map = { tier_1: 1000, tier_2: 2000, tier_3: 3000 };
      const v = map[tier];
      if (v) $('closePackagePrice').value = String(v);
    }

    async function submitClose(){
      $('closeMsg').textContent = '';
      try{
        const lead = requireSelectedLead('Close');

        const disposition = String($('closeDisposition').value || 'follow_up');
        const payload = {
          disposition,
          closedOn: $('closeDate').value || null,
          packageTier: $('closePackage').value || null,
          packagePrice: Number($('closePackagePrice').value || 0),
          initialPayment: Number($('closeInitial').value || 0),
          termMonths: Number($('closeTerm').value || 0),
          monthlyPricing: Number($('closeMonthly').value || 0),
          contractSendDate: $('closeContractSend').value || null,
          notes: $('closeNotes').value || '',
        };

        const nextStatus = disposition === 'won' ? 'won' : (disposition === 'lost' ? 'lost' : 'working');

        await api('/api/portal/close', {
          method: 'POST',
          body: { leadId: lead.id, status: nextStatus, payload },
        });

        $('closeMsg').textContent = '';
        setBadge('ok', 'submitted');
      } catch(e){
        $('closeMsg').textContent = String(e.message || e);
      }
    }

    function fmtDate(d){
      const s = String(d || '');
      if (!s) return '';
      return s.slice(0,10);
    }

    function fmtTime(t){
      const s = String(t || '');
      if (!s) return '';
      return s;
    }

    async function loadAppointmentsInto(tbodyId, msgId){
      // Back-compat signature; opts is supported below.
      return loadAppointmentsIntoWithOpts(tbodyId, msgId, {});
    }

    async function openLeadById(leadId, { goTab = 'calls', goDialerSubtab = 'activity' } = {}){
      const id = Number(leadId || 0);
      if (!id) throw new Error('missing_lead_id');
      const j = await api('/api/portal/activities?leadId=' + encodeURIComponent(String(id)) + '&limit=80');
      state.selectedLead = j.lead || { id };
      setSelectedLeadLine();
      setTab(goTab);
      if (goTab === 'calls') setDialerSubtab(goDialerSubtab);
      await loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
    }

    async function loadAppointmentsIntoWithOpts(tbodyId, msgId, { allowComplete = true, allowOpenLead = false } = {}){
      const tb = $(tbodyId);
      const msgEl = $(msgId);
      if (!tb) return;
      if (msgEl) msgEl.textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/appointments?limit=80');
        const appts = j.appointments || [];
        state.appointments = appts;

        if (!appts.length){
          tb.innerHTML = '<tr><td colspan="5" class="muted">No appointments yet.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        const canMarkComplete = !!allowComplete && (isManagerUser() || ['closer','account_manager'].includes(effectiveRole()));

        tb.innerHTML = appts.map((a) => {
          const meta = a.meta || {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = a.status || '';
          const doneBtn = (canMarkComplete && st !== 'completed')
            ? `<button class="btn secondary small" data-appt-done="${a.id}" data-appt-msg="${escapeHtml(msgId)}">Mark completed</button>`
            : '';

          const openBtn = (allowOpenLead && meta.leadId)
            ? `<button class="btn secondary small" data-appt-open="${Number(meta.leadId)}">Open</button>`
            : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(fmtDate(a.event_date))}</td>
              <td class="muted">${escapeHtml(fmtTime(a.start_time))}</td>
              <td>${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>${openBtn} ${doneBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-appt-done]')){
          btn.addEventListener('click', async () => {
            const m = $(msgId);
            if (m) m.textContent = '';
            try{
              const id = Number(btn.dataset.apptDone);
              await api('/api/portal/appointments', { method:'PATCH', body: { id, status:'completed' } });
              await loadAppointmentsIntoWithOpts(tbodyId, msgId, { allowComplete, allowOpenLead });
            } catch(e){
              if (m) m.textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-appt-open]')){
          btn.addEventListener('click', async () => {
            const m = $(msgId);
            if (m) m.textContent = '';
            try{
              const id = Number(btn.dataset.apptOpen);
              await openLeadById(id, { goTab: 'calls', goDialerSubtab: 'activity' });
            } catch(e){
              if (m) m.textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadAppointments(){
      if (!$('apptsTbody')) return;
      return loadAppointmentsIntoWithOpts('apptsTbody', 'apptsMsg', { allowComplete: true, allowOpenLead: false });
    }

    async function loadDialerBooked(){
      if (!$('dialerBookedTbody')) return;
      return loadAppointmentsIntoWithOpts('dialerBookedTbody', 'dialerBookedMsg', { allowComplete: false, allowOpenLead: true });
    }

    async function scheduleDialerBooked(){
      return scheduleAppointmentFrom({
        dateId: 'dialerBookedDate',
        timeId: 'dialerBookedStart',
        notesId: 'dialerBookedNotes',
        msgId: 'dialerBookedScheduleMsg',
        after: () => loadDialerBooked(),
      });
    }

    async function loadCloserQueue(){
      if (!$('closerQueueTbody')) return;
      $('closerQueueMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/queue?kind=closer&limit=60');
        const leads = j.leads || [];
        state.closerQueue = leads;
        const tb = $('closerQueueTbody');
        renderPipelineTimeline('closerPipeline', leads, { context: 'closer' });

        if (!leads.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No pipeline items.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = leads.map((l) => {
          const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
          const prop = l.property_name || l.company || '';
          const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
          return `
            <tr>
              <td><span class="badge">${l.id}</span></td>
              <td>${escapeHtml(name)}</td>
              <td class="muted">${escapeHtml(prop)}</td>
              <td><span class="badge">${escapeHtml(l.status || '')}</span></td>
              <td class="muted">${escapeHtml(String(l.priority ?? 0))}</td>
              <td class="muted">${escapeHtml(fu)}</td>
              <td><button class="btn secondary small" data-closer-pick="${l.id}">Select</button></td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-closer-pick]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.closerPick);
            const l = leads.find((x) => Number(x.id) === id) || null;
            state.selectedLead = l;
            setSelectedLeadLine();
            loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('closerQueueMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function scheduleAppointmentFrom({ dateId, timeId, notesId, msgId, after } = {}){
      const msgEl = $(msgId);
      if (msgEl) msgEl.textContent = '';
      try{
        const lead = requireSelectedLead('Meeting');
        const eventDate = String($(dateId)?.value || '');
        const startTime = String($(timeId)?.value || '');
        if (!eventDate) throw new Error('Pick a date');
        if (!startTime) throw new Error('Pick a start time');

        await api('/api/portal/appointments', {
          method:'POST',
          body: {
            leadId: lead.id,
            eventDate,
            startTime,
            notes: String($(notesId)?.value || ''),
          }
        });

        const notesEl = $(notesId);
        if (notesEl) notesEl.value = '';
        if (after) await after();
        setBadge('ok', 'scheduled');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
      }
    }

    async function scheduleAppointment(){
      return scheduleAppointmentFrom({
        dateId: 'apptDate',
        timeId: 'apptStart',
        notesId: 'apptNotes',
        msgId: 'scheduleApptMsg',
        after: () => loadAppointments(),
      });
    }

    async function scheduleMeeting(){
      return scheduleAppointmentFrom({
        dateId: 'meetingDate',
        timeId: 'meetingStart',
        notesId: 'meetingNotes',
        msgId: 'meetingScheduleMsg',
        after: () => loadAppointmentsInto('meetingsTbody', 'meetingsMsg'),
      });
    }

    function localTz(){
      try { return Intl.DateTimeFormat().resolvedOptions().timeZone || ''; } catch { return ''; }
    }

    function isoToday(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function addMonths(date, offset){
      const d = new Date(date.getTime());
      d.setMonth(d.getMonth() + Number(offset || 0));
      return d;
    }

    function ymd(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function monthLabel(d){
      const m = d.toLocaleString(undefined, { month: 'long' });
      return `${m} ${d.getFullYear()}`;
    }

    function ensureAvailInit(){
      // Treat slots as floating local times; always show in viewer's local timezone.
      state.availability.tz = localTz() || '';
      if (typeof state.availability.weekOffset !== 'number') state.availability.weekOffset = Number(state.availability.weekOffset || 0);
      if (!state.availability.byDate || typeof state.availability.byDate !== 'object') state.availability.byDate = {};
      if (!state.availability.drag || typeof state.availability.drag !== 'object') state.availability.drag = { active: false, mode: '' };
    }

    function addDays(date, n){
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + Number(n || 0));
      return d;
    }

    function startOfWeekMonday(date){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const dow = d.getDay();
      const diff = (dow + 6) % 7; // Monday -> 0
      d.setDate(d.getDate() - diff);
      return d;
    }

    function dayHeadLabel(date){
      try{
        return date.toLocaleDateString(undefined, { weekday:'short', month:'numeric', day:'numeric' });
      } catch {
        return ymd(date);
      }
    }

    function timeLabel(hhmm){
      const s = String(hhmm || '');
      const parts = s.split(':');
      const h = Number(parts[0] || 0);
      const m = Number(parts[1] || 0);
      const d = new Date();
      d.setHours(h, m, 0, 0);
      try{
        return d.toLocaleTimeString(undefined, { hour:'numeric', minute:'2-digit' });
      } catch {
        return s;
      }
    }

    function availabilityEditable(){
      const er = effectiveRole();
      if (!['closer','account_manager'].includes(er)) return false;
      // Manager view-as must remain read-only (server enforced too).
      if (isManagerUser() && String(state.viewAsRole || '').trim()) return false;
      return true;
    }

    function weekDates(){
      ensureAvailInit();
      const off = Number(state.availability.weekOffset || 0);
      const base = addDays(new Date(), off * 7);
      const start = startOfWeekMonday(base);
      return Array.from({ length: 7 }, (_, i) => addDays(start, i));
    }

    function setAvailSlot(dateYmd, hhmm, on){
      ensureAvailInit();
      const d = String(dateYmd || '');
      const t = String(hhmm || '');
      if (!d || !t) return;
      const arr = Array.isArray(state.availability.byDate[d]) ? state.availability.byDate[d].slice() : [];
      const set = new Set(arr.map(String));
      if (on) set.add(t);
      else set.delete(t);
      const next = Array.from(set).sort();
      if (next.length) state.availability.byDate[d] = next;
      else delete state.availability.byDate[d];
    }

    function hasAvailSlot(dateYmd, hhmm){
      const d = String(dateYmd || '');
      const t = String(hhmm || '');
      const arr = Array.isArray(state.availability.byDate?.[d]) ? state.availability.byDate[d] : [];
      return arr.includes(t);
    }

    function timeSlots(){
      const out = [];
      for (let h = 8; h <= 20; h++) {
        for (const m of [0, 30]) {
          if (h === 20 && m > 0) continue;
          out.push(String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0'));
        }
      }
      return out;
    }

    function renderAvailWeekGrid(){
      ensureAvailInit();
      const grid = $('availWeekGrid');
      if (!grid) return;

      const tz = localTz() || '';
      const tzLabel = $('availTzLabel');
      if (tzLabel) tzLabel.textContent = tz || 'local';

      const week = weekDates();
      const weekLabel = $('availWeekLabel');
      if (weekLabel) weekLabel.textContent = `${ymd(week[0])} – ${ymd(week[6])}`;

      const editable = availabilityEditable();
      const ro = $('availReadOnlyNote');
      if (ro) ro.style.display = (!editable && isManagerUser() && String(state.viewAsRole || '').trim()) ? 'block' : 'none';
      const saveBtn = $('availSaveBtn');
      if (saveBtn) saveBtn.disabled = !editable;
      const clearBtn = $('availClearWeek');
      if (clearBtn) clearBtn.disabled = !editable;

      const head = [];
      head.push(`<div class="availHeadCell"></div>`);
      for (const d of week) {
        head.push(`<div class="availHeadCell">${escapeHtml(dayHeadLabel(d))}<div class="muted" style="margin-top:2px; font-weight:700;">${escapeHtml(ymd(d))}</div></div>`);
      }

      const rows = [];
      const times = timeSlots();
      for (const t of times) {
        rows.push(`<div class="availTimeCell">${escapeHtml(timeLabel(t))}</div>`);
        for (const d of week) {
          const dateKey = ymd(d);
          const active = hasAvailSlot(dateKey, t);
          rows.push(
            `<div class="availSlotCell"><button ${editable ? '' : 'disabled'} type="button" class="availSlotBtn ${active ? 'active' : ''}" data-avail-date="${escapeHtml(dateKey)}" data-avail-time="${escapeHtml(t)}" aria-pressed="${active ? 'true' : 'false'}"></button></div>`
          );
        }
      }

      grid.innerHTML = head.join('') + rows.join('');

      // Drag multi-select (Excel-ish).
      const drag = state.availability.drag;
      drag.active = false;
      drag.mode = '';

      const applyCell = (btn) => {
        const dateKey = String(btn.dataset.availDate || '');
        const t = String(btn.dataset.availTime || '');
        if (!dateKey || !t) return;
        if (!availabilityEditable()) return;
        const wantOn = drag.mode === 'add';
        setAvailSlot(dateKey, t, wantOn);
        const on = hasAvailSlot(dateKey, t);
        btn.classList.toggle('active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      };

      grid.onpointerdown = (ev) => {
        const btn = ev.target && ev.target.closest ? ev.target.closest('button.availSlotBtn') : null;
        if (!btn) return;
        if (btn.disabled) return;
        ev.preventDefault();
        const dateKey = String(btn.dataset.availDate || '');
        const t = String(btn.dataset.availTime || '');
        const currentlyOn = hasAvailSlot(dateKey, t);
        drag.active = true;
        drag.mode = currentlyOn ? 'remove' : 'add';
        applyCell(btn);
        try { btn.setPointerCapture(ev.pointerId); } catch(_e) {}
      };

      grid.onpointerover = (ev) => {
        if (!drag.active) return;
        const btn = ev.target && ev.target.closest ? ev.target.closest('button.availSlotBtn') : null;
        if (!btn) return;
        if (btn.disabled) return;
        applyCell(btn);
      };

      const endDrag = () => {
        drag.active = false;
        drag.mode = '';
      };
      grid.onpointerup = endDrag;
      grid.onpointercancel = endDrag;
      document.addEventListener('pointerup', endDrag, { once: true });
    }

    async function loadAvailability(){
      if (!$('availWeekGrid')) return;
      const card = $('meetingsAvailabilityCard');
      const show = ['closer','account_manager'].includes(effectiveRole());
      if (card) card.classList.toggle('hide', !show);
      if (!show) return;
      $('availMsg').textContent = '';
      ensureAvailInit();
      try{
        const j = await api('/api/portal/availability');
        const slots = j.availability?.slots && typeof j.availability.slots === 'object' ? j.availability.slots : {};
        const byDate = slots.byDate && typeof slots.byDate === 'object' ? slots.byDate : {};
        state.availability.byDate = byDate;
        state.availability.tz = localTz() || '';
        renderAvailWeekGrid();
        setBadge('ok', 'ready');
      } catch(e){
        $('availMsg').textContent = String(e.message || e);
      }
    }

    async function saveAvailability(){
      $('availMsg').textContent = '';
      ensureAvailInit();
      try{
        await api('/api/portal/availability', {
          method: 'PUT',
          body: {
            slots: {
              tz: localTz() || '',
              byDate: state.availability.byDate || {},
            }
          }
        });
        setBadge('ok', 'saved');
      } catch(e){
        $('availMsg').textContent = String(e.message || e);
      }
    }

    // Accounts (Account Manager)

    function ensureAccountsInit(){
      state.accounts = state.accounts || {
        list: [],
        selectedId: '',
        selected: null,
        sentiment: [],
        issues: [],
        templates: [],
        qTimer: null,
      };
    }

    function accountsEditable(){
      const er = effectiveRole();
      if (!['account_manager','manager'].includes(er)) return false;
      // Manager view-as must remain read-only (server enforced too).
      if (isManagerUser() && String(state.viewAsRole || '').trim()) return false;
      return true;
    }

    function cleanYmd(s){
      const v = String(s || '').trim();
      if (!v) return '';
      if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return '';
      return v;
    }

    function addDaysYmd(ymd, days){
      const s = cleanYmd(ymd);
      if (!s) return '';
      const d = new Date(s + 'T00:00:00');
      if (Number.isNaN(d.getTime())) return '';
      d.setDate(d.getDate() + Number(days || 0));
      const yyyy = String(d.getFullYear()).padStart(4,'0');
      const mm = String(d.getMonth() + 1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function daysInMonth(y, m0){
      return new Date(y, m0 + 1, 0).getDate();
    }

    function addMonthsYmd(ymd, months){
      const s = cleanYmd(ymd);
      if (!s) return '';
      const m = Math.trunc(Number(months || 0));
      if (!Number.isFinite(m) || !m) return s;
      const [yyyy, mm, dd] = s.split('-').map((x)=>Number(x));
      if (!yyyy || !mm || !dd) return '';
      const fromM0 = mm - 1;
      const base = new Date(yyyy, fromM0, 1);
      base.setMonth(base.getMonth() + m);
      const ty = base.getFullYear();
      const tm0 = base.getMonth();
      const day = Math.min(dd, daysInMonth(ty, tm0));
      const out = new Date(ty, tm0, day);
      const outY = String(out.getFullYear()).padStart(4,'0');
      const outM = String(out.getMonth() + 1).padStart(2,'0');
      const outD = String(out.getDate()).padStart(2,'0');
      return `${outY}-${outM}-${outD}`;
    }

    function computeContractEnd({ contractStart, termMonths, contractEnd }){
      const end = cleanYmd(contractEnd);
      if (end) return end;
      const start = cleanYmd(contractStart);
      const tm = Math.trunc(Number(termMonths || 0));
      if (!start || !Number.isFinite(tm) || tm <= 0) return '';
      return addMonthsYmd(start, tm);
    }

    function computeRenewalReminderDate({ contractEnd, reminderDays }){
      const end = cleanYmd(contractEnd);
      if (!end) return '';
      const days = Math.trunc(Number(reminderDays || 30));
      const safe = Number.isFinite(days) ? Math.max(0, Math.min(3650, days)) : 30;
      return addDaysYmd(end, -safe);
    }

    function renderRenewalHint({ elId, contractStart, termMonths, contractEnd, reminderDays }){
      const el = $(elId);
      if (!el) return;
      const end = computeContractEnd({ contractStart, termMonths, contractEnd });
      const rr = computeRenewalReminderDate({ contractEnd: end, reminderDays });
      if (!end && !rr) { el.textContent = ''; return; }
      const bits = [];
      if (end) bits.push('Contract end: ' + end);
      if (rr) bits.push('Renewal reminder: ' + rr);
      el.textContent = bits.join(' • ');
    }

    function syncNewAccountDerived(){
      const start = cleanYmd($('acctStart')?.value);
      const termMonths = Math.trunc(Number($('acctTermMonths')?.value || 0));
      const end = computeContractEnd({ contractStart: start, termMonths, contractEnd: $('acctEnd')?.value });
      if ($('acctEnd') && !$('acctEnd').value && end) $('acctEnd').value = end;
    }

    function syncEditAccountDerived(){
      const start = cleanYmd($('acctEditStart')?.value);
      const termMonths = Math.trunc(Number($('acctEditTermMonths')?.value || 0));
      const reminderDays = Math.trunc(Number($('acctEditReminderDays')?.value || 30));
      const end = computeContractEnd({ contractStart: start, termMonths, contractEnd: $('acctEditEnd')?.value });
      if ($('acctEditEnd') && !$('acctEditEnd').value && end) $('acctEditEnd').value = end;
      const rr = computeRenewalReminderDate({ contractEnd: end, reminderDays });
      if ($('acctEditReminderDate')) $('acctEditReminderDate').value = rr || '';
      renderRenewalHint({ elId: 'acctRenewalHint', contractStart: start, termMonths, contractEnd: end, reminderDays });
    }

    function accountMatchesQ(a, q){
      const qq = String(q || '').trim().toLowerCase();
      if (!qq) return true;
      const hay = [
        a?.name,
        a?.propertyName,
        a?.address,
        a?.city,
        a?.state,
        a?.postalCode,
        a?.primaryContactName,
        a?.primaryContactEmail,
        a?.primaryContactPhone,
        a?.contractTier,
        a?.tier,
        a?.contractStart,
        a?.contractEnd,
        a?.renewalReminderDate,
        a?.email,
        a?.phone,
        a?.notes,
      ]
        .map((x) => String(x || '').toLowerCase())
        .join(' ');
      return hay.includes(qq);
    }

    function renderAccounts(){
      ensureAccountsInit();
      const list = $('accountsList');
      if (!list) return;
      const q = String($('accountsQ')?.value || '').trim();
      const expiring = !!$('accountsExpiring')?.checked;

      const items = (Array.isArray(state.accounts.list) ? state.accounts.list : [])
        .filter((a) => accountMatchesQ(a, q));

      const soonDays = 45;
      const now = new Date();
      const soon = new Date(now.getTime() + soonDays * 86400 * 1000);
      const filtered = expiring ? items.filter((a) => {
        const end = String(a?.contractEnd || '').trim();
        if (!end) return false;
        const d = new Date(end + 'T00:00:00');
        if (Number.isNaN(d.getTime())) return false;
        return d <= soon;
      }) : items;

      if (!filtered.length) {
        list.innerHTML = '<div class="muted small">No accounts yet.</div>';
        return;
      }

      const sel = String(state.accounts.selectedId || '');
      list.innerHTML = filtered.map((a) => {
        const id = String(a?.id || '');
        const active = id && id === sel;
        const name = String(a?.propertyName || a?.name || '').trim() || '(no property)';
        const tier = String(a?.contractTier || a?.tier || '').trim();
        const end = String(a?.contractEnd || '').trim();
        const rr = String(a?.renewalReminderDate || '').trim();
        const contact = String(a?.primaryContactName || '').trim();
        const meta = [
          contact ? contact : '',
          tier ? ('tier ' + tier) : '',
          rr ? ('remind ' + rr) : (end ? ('ends ' + end) : ''),
        ].filter(Boolean).join(' • ');
        return `
          <button type="button" class="card" data-acct-pick="${escapeHtml(id)}" style="text-align:left; background:#fff; border-color:${active ? 'rgba(199,154,59,.55)' : 'rgba(199,154,59,.25)'}">
            <div class="bd">
              <div style="font-weight:900;">${escapeHtml(name)}</div>
              ${meta ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(meta)}</div>` : ''}
            </div>
          </button>
        `;
      }).join('');

      for (const btn of list.querySelectorAll('[data-acct-pick]')) {
        btn.addEventListener('click', () => {
          selectAccount(String(btn.dataset.acctPick || '')).catch(()=>{});
        });
      }
    }

    function renderSelectedAccount(){
      ensureAccountsInit();
      const a = state.accounts.selected;
      $('acctSelected').textContent = a ? (String(a.propertyName || a.name || '').trim() || '(no property)') : 'None';

      const editable = accountsEditable();
      const disable = !editable || !a;
      const ids = [
        'acctEditName','acctEditAddress','acctEditContactName','acctEditEmail','acctEditPhone',
        'acctEditTier','acctEditTermMonths','acctEditStart','acctEditEnd','acctEditReminderDays','acctEditReminderDate',
        'acctEditNotes','acctSaveBtn','acctDeleteBtn',
        'sentimentKind','sentimentTags','sentimentNote','sentimentAddBtn',
        'issueSeverity','issueStatus','issueNote','issueAddBtn',
        'tplType','tplName','tplBody','tplSaveBtn'
      ];
      for (const id of ids) {
        const el = $(id);
        if (!el) continue;
        if (id === 'tplType' || id === 'tplName' || id === 'tplBody' || id === 'tplSaveBtn') {
          // Templates are global; allow even without selecting an account (if editable).
          el.disabled = !editable;
        } else {
          el.disabled = disable;
        }
      }

      // Derived field should not be edited directly.
      if ($('acctEditReminderDate')) $('acctEditReminderDate').disabled = true;

      // New toggle should be disabled in view-as.
      if ($('accountsNewToggle')) $('accountsNewToggle').disabled = !editable;

      // New-account form
      const newIds = ['acctName','acctAddress','acctContactName','acctContactEmail','acctContactPhone','acctTier','acctTermMonths','acctReminderDays','acctStart','acctEnd','acctNotes','accountsCreateBtn'];
      for (const id of newIds) {
        const el = $(id);
        if (el) el.disabled = !editable;
      }

      if (!a) {
        if ($('acctEditName')) $('acctEditName').value = '';
        if ($('acctEditAddress')) $('acctEditAddress').value = '';
        if ($('acctEditContactName')) $('acctEditContactName').value = '';
        if ($('acctEditTier')) $('acctEditTier').value = '';
        if ($('acctEditTermMonths')) $('acctEditTermMonths').value = '';
        if ($('acctEditStart')) $('acctEditStart').value = '';
        if ($('acctEditEnd')) $('acctEditEnd').value = '';
        if ($('acctEditReminderDays')) $('acctEditReminderDays').value = '';
        if ($('acctEditReminderDate')) $('acctEditReminderDate').value = '';
        if ($('acctEditEmail')) $('acctEditEmail').value = '';
        if ($('acctEditPhone')) $('acctEditPhone').value = '';
        if ($('acctEditNotes')) $('acctEditNotes').value = '';
        if ($('acctRenewalHint')) $('acctRenewalHint').textContent = '';
        $('sentimentList').innerHTML = '<div class="muted small">Select an account.</div>';
        $('issueList').innerHTML = '<div class="muted small">Select an account.</div>';
        return;
      }

      const contractStart = String(a.contractStart || '');
      const termMonths = Number(a.termMonths || 0);
      const contractEnd = computeContractEnd({ contractStart, termMonths, contractEnd: a.contractEnd });
      const reminderDays = Number(a.renewalReminderDays != null ? a.renewalReminderDays : 30);
      const reminderDate = cleanYmd(a.renewalReminderDate) || computeRenewalReminderDate({ contractEnd, reminderDays });

      if ($('acctEditName')) $('acctEditName').value = String(a.propertyName || a.name || '');
      if ($('acctEditAddress')) $('acctEditAddress').value = String(a.address || '');
      if ($('acctEditContactName')) $('acctEditContactName').value = String(a.primaryContactName || '');
      if ($('acctEditTier')) $('acctEditTier').value = String(a.contractTier || a.tier || '');
      if ($('acctEditTermMonths')) $('acctEditTermMonths').value = String(a.termMonths != null ? a.termMonths : '');
      if ($('acctEditStart')) $('acctEditStart').value = cleanYmd(a.contractStart) || '';
      if ($('acctEditEnd')) $('acctEditEnd').value = contractEnd || '';
      if ($('acctEditReminderDays')) $('acctEditReminderDays').value = String(a.renewalReminderDays != null ? a.renewalReminderDays : 30);
      if ($('acctEditReminderDate')) $('acctEditReminderDate').value = reminderDate || '';
      if ($('acctEditEmail')) $('acctEditEmail').value = String(a.primaryContactEmail || a.email || '');
      if ($('acctEditPhone')) $('acctEditPhone').value = String(a.primaryContactPhone || a.phone || '');
      if ($('acctEditNotes')) $('acctEditNotes').value = String(a.notes || '');

      renderRenewalHint({
        elId: 'acctRenewalHint',
        contractStart: cleanYmd(a.contractStart),
        termMonths: a.termMonths,
        contractEnd,
        reminderDays: a.renewalReminderDays,
      });
    }

    function renderSentiment(){
      ensureAccountsInit();
      const el = $('sentimentList');
      if (!el) return;
      const items = Array.isArray(state.accounts.sentiment) ? state.accounts.sentiment : [];
      if (!items.length) {
        el.innerHTML = '<div class="muted small">No sentiment entries yet.</div>';
        return;
      }
      el.innerHTML = items.slice().reverse().map((x) => {
        const when = String(x?.createdAt || '');
        const kind = String(x?.kind || '');
        const tags = Array.isArray(x?.tags) ? x.tags.join(', ') : String(x?.tags || '');
        const note = String(x?.note || '');
        const meta = [kind ? kind.toUpperCase() : '', tags ? ('tags: ' + tags) : ''].filter(Boolean).join(' • ');
        return `
          <div class="card" style="background:#fff; margin-top:10px;">
            <div class="bd">
              <div class="muted small">${escapeHtml(when)}</div>
              ${meta ? `<div class="small" style="margin-top:4px; font-weight:900;">${escapeHtml(meta)}</div>` : ''}
              ${note ? `<div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(note)}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderIssues(){
      ensureAccountsInit();
      const el = $('issueList');
      if (!el) return;
      const items = Array.isArray(state.accounts.issues) ? state.accounts.issues : [];
      if (!items.length) {
        el.innerHTML = '<div class="muted small">No issues yet.</div>';
        return;
      }
      el.innerHTML = items.slice().reverse().map((x) => {
        const when = String(x?.createdAt || '');
        const sev = String(x?.severity || '');
        const st = String(x?.status || '');
        const note = String(x?.note || '');
        const meta = [sev ? ('sev ' + sev) : '', st ? st : ''].filter(Boolean).join(' • ');
        return `
          <div class="card" style="background:#fff; margin-top:10px;">
            <div class="bd">
              <div class="muted small">${escapeHtml(when)}</div>
              ${meta ? `<div class="small" style="margin-top:4px; font-weight:900;">${escapeHtml(meta)}</div>` : ''}
              ${note ? `<div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(note)}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTemplates(){
      ensureAccountsInit();
      const el = $('tplList');
      if (!el) return;
      const items = Array.isArray(state.accounts.templates) ? state.accounts.templates : [];
      if (!items.length) {
        el.innerHTML = '<div class="muted small">No templates yet.</div>';
        return;
      }
      el.innerHTML = items.slice().reverse().map((t) => {
        const name = String(t?.name || '').trim() || '(no name)';
        const type = String(t?.type || '').trim();
        const body = String(t?.body || '').trim();
        return `
          <div class="card" style="background:#fff; margin-top:10px;">
            <div class="bd">
              <div style="font-weight:900;">${escapeHtml(name)}</div>
              ${type ? `<div class="muted small" style="margin-top:2px;">${escapeHtml(type)}</div>` : ''}
              ${body ? `<div class="small" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(body)}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadAccounts(){
      ensureAccountsInit();
      if (!$('viewAccounts')) return;
      $('accountsMsg').textContent = '';
      $('acctSaveMsg').textContent = '';
      const show = (effectiveRole() === 'account_manager' || effectiveRole() === 'manager');
      $('viewAccounts').classList.toggle('hide', !show);
      if (!show) return;

      try {
        const expiring = !!$('accountsExpiring')?.checked;
        const q = String($('accountsQ')?.value || '').trim();
        const url = '/api/portal/accounts'
          + (q || expiring ? ('?' + new URLSearchParams({
            q: q || '',
            expiringSoon: expiring ? '1' : '0'
          }).toString()) : '');
        const j = await api(url);
        state.accounts.list = Array.isArray(j.accounts) ? j.accounts : [];

        // Keep selection if possible
        const sel = String(state.accounts.selectedId || '');
        const found = sel ? state.accounts.list.find((x) => String(x?.id || '') === sel) : null;
        if (found) {
          state.accounts.selected = found;
        } else {
          state.accounts.selectedId = '';
          state.accounts.selected = null;
        }

        renderAccounts();
        renderSelectedAccount();

        if (!state.accounts.templates.length) {
          await loadTemplates().catch(()=>{});
        }
      } catch (e) {
        $('accountsMsg').textContent = String(e.message || e);
      }
    }

    async function selectAccount(accountId){
      ensureAccountsInit();
      $('acctSaveMsg').textContent = '';
      const id = String(accountId || '').trim();
      state.accounts.selectedId = id;
      state.accounts.selected = (Array.isArray(state.accounts.list) ? state.accounts.list : []).find((x) => String(x?.id || '') === id) || null;
      renderAccounts();
      renderSelectedAccount();
      await loadSentiment().catch(()=>{});
      await loadIssues().catch(()=>{});
    }

    async function createAccount(){
      ensureAccountsInit();
      $('accountsCreateMsg').textContent = '';
      try {
        const name = String($('acctName').value || '').trim();
        const addr = String($('acctAddress').value || '').trim();
        const contactName = String($('acctContactName').value || '').trim();
        if (!name) throw new Error('property_name_required');
        if (!addr) throw new Error('property_address_required');
        if (!contactName) throw new Error('primary_contact_name_required');

        const termMonths = Math.trunc(Number($('acctTermMonths').value || 0));
        const reminderDays = Math.trunc(Number($('acctReminderDays').value || 30));
        const contractStart = cleanYmd($('acctStart').value) || '';
        const contractEnd = computeContractEnd({ contractStart, termMonths, contractEnd: $('acctEnd').value });
        const body = {
          name,
          propertyName: name,
          address: addr,
          primaryContactName: contactName,
          primaryContactEmail: String($('acctContactEmail').value || '').trim(),
          primaryContactPhone: String($('acctContactPhone').value || '').trim(),
          contractTier: String($('acctTier').value || '').trim(),
          tier: String($('acctTier').value || '').trim(),
          termMonths: Number.isFinite(termMonths) ? termMonths : 0,
          renewalReminderDays: Number.isFinite(reminderDays) ? reminderDays : 30,
          contractStart,
          contractEnd,
          email: String($('acctContactEmail').value || '').trim(),
          phone: String($('acctContactPhone').value || '').trim(),
          notes: String($('acctNotes').value || '').trim(),
        };
        const j = await api('/api/portal/accounts', { method:'POST', body });
        $('accountsNewBox').hidden = true;
        $('acctName').value = '';
        $('acctAddress').value = '';
        $('acctContactName').value = '';
        $('acctContactEmail').value = '';
        $('acctContactPhone').value = '';
        $('acctTier').value = '';
        $('acctTermMonths').value = '';
        $('acctReminderDays').value = '';
        $('acctStart').value = '';
        $('acctEnd').value = '';
        $('acctNotes').value = '';

        await loadAccounts();
        const id = String(j?.account?.id || '').trim();
        if (id) await selectAccount(id);
      } catch (e) {
        $('accountsCreateMsg').textContent = String(e.message || e);
      }
    }

    async function saveAccount(){
      ensureAccountsInit();
      $('acctSaveMsg').textContent = '';
      try {
        const a = state.accounts.selected;
        if (!a || !a.id) throw new Error('select_account');

        const name = String($('acctEditName').value || '').trim();
        if (!name) throw new Error('property_name_required');

        const termMonths = Math.trunc(Number($('acctEditTermMonths').value || 0));
        const reminderDays = Math.trunc(Number($('acctEditReminderDays').value || 30));
        const contractStart = cleanYmd($('acctEditStart').value) || '';
        const contractEnd = computeContractEnd({ contractStart, termMonths, contractEnd: $('acctEditEnd').value });
        const reminderDate = computeRenewalReminderDate({ contractEnd, reminderDays });

        const patch = {
          name,
          propertyName: name,
          address: String($('acctEditAddress').value || '').trim(),
          primaryContactName: String($('acctEditContactName').value || '').trim(),
          primaryContactEmail: String($('acctEditEmail').value || '').trim(),
          primaryContactPhone: String($('acctEditPhone').value || '').trim(),
          contractTier: String($('acctEditTier').value || '').trim(),
          tier: String($('acctEditTier').value || '').trim(),
          termMonths: Number.isFinite(termMonths) ? termMonths : 0,
          renewalReminderDays: Number.isFinite(reminderDays) ? reminderDays : 30,
          contractStart,
          contractEnd,
          renewalReminderDate: reminderDate,
          email: String($('acctEditEmail').value || '').trim(),
          phone: String($('acctEditPhone').value || '').trim(),
          notes: String($('acctEditNotes').value || '').trim(),
        };
        const j = await api('/api/portal/accounts', { method:'PUT', body: { id: a.id, patch } });
        const updated = j?.account || null;
        if (updated && updated.id) {
          // update local list
          state.accounts.list = (Array.isArray(state.accounts.list) ? state.accounts.list : []).map((x) => String(x?.id || '') === String(updated.id) ? updated : x);
          state.accounts.selected = updated;
        }
        renderAccounts();
        renderSelectedAccount();
        $('acctSaveMsg').textContent = '';
        setBadge('ok', 'saved');
      } catch (e) {
        $('acctSaveMsg').textContent = String(e.message || e);
      }
    }

    async function deleteAccount(){
      ensureAccountsInit();
      $('acctSaveMsg').textContent = '';
      try {
        const a = state.accounts.selected;
        if (!a || !a.id) throw new Error('select_account');
        const ok = confirm('Delete this account?');
        if (!ok) return;
        await api('/api/portal/accounts', { method:'DELETE', body: { id: a.id } });
        state.accounts.selectedId = '';
        state.accounts.selected = null;
        state.accounts.sentiment = [];
        state.accounts.issues = [];
        await loadAccounts();
        renderSelectedAccount();
        renderSentiment();
        renderIssues();
      } catch (e) {
        $('acctSaveMsg').textContent = String(e.message || e);
      }
    }

    async function loadSentiment(){
      ensureAccountsInit();
      $('sentimentMsg').textContent = '';
      const a = state.accounts.selected;
      if (!a || !a.id) { state.accounts.sentiment = []; renderSentiment(); return; }
      try {
        const j = await api('/api/portal/account_sentiment?accountId=' + encodeURIComponent(String(a.id)));
        state.accounts.sentiment = Array.isArray(j.entries) ? j.entries : [];
        renderSentiment();
      } catch (e) {
        $('sentimentMsg').textContent = String(e.message || e);
      }
    }

    async function addSentiment(){
      ensureAccountsInit();
      $('sentimentMsg').textContent = '';
      const a = state.accounts.selected;
      if (!a || !a.id) { $('sentimentMsg').textContent = 'select an account'; return; }
      try {
        const tags = String($('sentimentTags').value || '').split(',').map((x)=>x.trim()).filter(Boolean).slice(0, 10);
        await api('/api/portal/account_sentiment', {
          method:'POST',
          body: {
            accountId: a.id,
            kind: String($('sentimentKind').value || 'green'),
            tags,
            note: String($('sentimentNote').value || '').trim(),
          }
        });
        $('sentimentTags').value = '';
        $('sentimentNote').value = '';
        await loadSentiment();
      } catch (e) {
        $('sentimentMsg').textContent = String(e.message || e);
      }
    }

    async function loadIssues(){
      ensureAccountsInit();
      $('issueMsg').textContent = '';
      const a = state.accounts.selected;
      if (!a || !a.id) { state.accounts.issues = []; renderIssues(); return; }
      try {
        const j = await api('/api/portal/account_issues?accountId=' + encodeURIComponent(String(a.id)));
        state.accounts.issues = Array.isArray(j.issues) ? j.issues : [];
        renderIssues();
      } catch (e) {
        $('issueMsg').textContent = String(e.message || e);
      }
    }

    async function addIssue(){
      ensureAccountsInit();
      $('issueMsg').textContent = '';
      const a = state.accounts.selected;
      if (!a || !a.id) { $('issueMsg').textContent = 'select an account'; return; }
      try {
        await api('/api/portal/account_issues', {
          method:'POST',
          body: {
            accountId: a.id,
            severity: String($('issueSeverity').value || 'low'),
            status: String($('issueStatus').value || 'open'),
            note: String($('issueNote').value || '').trim(),
          }
        });
        $('issueNote').value = '';
        await loadIssues();
      } catch (e) {
        $('issueMsg').textContent = String(e.message || e);
      }
    }

    async function loadTemplates(){
      ensureAccountsInit();
      $('tplMsg').textContent = '';
      try {
        const j = await api('/api/portal/account_templates');
        state.accounts.templates = Array.isArray(j.templates) ? j.templates : [];
        renderTemplates();
      } catch (e) {
        $('tplMsg').textContent = String(e.message || e);
      }
    }

    async function saveTemplate(){
      ensureAccountsInit();
      $('tplMsg').textContent = '';
      try {
        const type = String($('tplType').value || 'email');
        const name = String($('tplName').value || '').trim();
        const body = String($('tplBody').value || '').trim();
        if (!name) throw new Error('name_required');
        if (!body) throw new Error('body_required');
        await api('/api/portal/account_templates', { method:'POST', body: { type, name, body } });
        $('tplName').value = '';
        $('tplBody').value = '';
        await loadTemplates();
      } catch (e) {
        $('tplMsg').textContent = String(e.message || e);
      }
    }

    function setSelectedEvent(eventObj){
      state.selectedEvent = eventObj || null;
      const e = state.selectedEvent;
      $('selectedEventLine').textContent = e ? `#${e.id} • ${e.title || ''} • ${(e.event_date || '')}`.trim() : 'None';
      $('eventRecapWrap').classList.toggle('hide', !e);
      if ($('eventOpsWrap')) $('eventOpsWrap').classList.toggle('hide', !e);
      if (e) loadRecaps(e.id).catch(()=>{});
      if (e) initEventOps().catch(()=>{});
    }

    function splitCsvList(text, { max = 30, maxLen = 60 } = {}){
      return String(text || '')
        .split(',')
        .map((x) => x.trim())
        .filter(Boolean)
        .map((x) => x.slice(0, maxLen))
        .slice(0, max);
    }

    function joinCsvList(arr){
      return (Array.isArray(arr) ? arr : []).filter(Boolean).join(', ');
    }

    function talentIsCoordinator(){
      return isCoordinatorRole();
    }

    function setTalentEditingLine(){
      const line = $('talentEditingLine');
      if (!line) return;
      const editing = String(state.talent?.editUserId || '').trim();
      if (!editing) {
        line.textContent = '';
        return;
      }
      const u = (Array.isArray(state.usersCache) ? state.usersCache : []).find((x) => String(x.userId) === editing);
      const label = u ? String(u.fullName || u.email || u.userId || '').trim() : editing;
      line.textContent = `Editing: ${label}`;
    }

    function readTalentForm(){
      const specialties = splitCsvList($('talSpecialties')?.value || '', { max: 20, maxLen: 60 });
      const preferredPairings = splitCsvList($('talPairings')?.value || '', { max: 20, maxLen: 80 });
      const reliabilityFlags = splitCsvList($('talReliabilityFlags')?.value || '', { max: 20, maxLen: 60 });

      const out = {
        displayName: String($('talDisplayName')?.value || '').trim(),
        role: String($('talRole')?.value || '').trim(),
        homeBaseCity: String($('talCity')?.value || '').trim(),
        homeBaseState: String($('talState')?.value || '').trim(),
        specialties,
        tone: String($('talTone')?.value || '').trim(),
        gear: String($('talGear')?.value || '').trim(),
        bio: String($('talBio')?.value || '').trim(),
        preferredPairings,
        notes: String($('talNotes')?.value || '').trim(),
      };

      if (talentIsCoordinator() && !$('talReliabilityBox')?.classList.contains('hide')) {
        const score = $('talReliabilityScore')?.value ? Number($('talReliabilityScore').value) : null;
        out.reliability = {
          score: Number.isFinite(score) ? Math.max(0, Math.min(100, Math.trunc(score))) : null,
          flags: reliabilityFlags,
        };
      }

      return out;
    }

    function writeTalentForm(profile){
      const p = (profile && typeof profile === 'object') ? profile : {};
      if ($('talDisplayName')) $('talDisplayName').value = String(p.displayName || '');
      if ($('talRole')) $('talRole').value = String(p.role || '') || String(myPortalRole() || '');
      if ($('talCity')) $('talCity').value = String(p.homeBaseCity || '');
      if ($('talState')) $('talState').value = String(p.homeBaseState || '');
      if ($('talSpecialties')) $('talSpecialties').value = joinCsvList(p.specialties);
      if ($('talTone')) $('talTone').value = String(p.tone || '');
      if ($('talGear')) $('talGear').value = String(p.gear || '');
      if ($('talBio')) $('talBio').value = String(p.bio || '');
      if ($('talPairings')) $('talPairings').value = joinCsvList(p.preferredPairings);
      if ($('talNotes')) $('talNotes').value = String(p.notes || '');

      const relBox = $('talReliabilityBox');
      if (relBox) relBox.classList.toggle('hide', !talentIsCoordinator());
      if (talentIsCoordinator()) {
        const rel = p.reliability && typeof p.reliability === 'object' ? p.reliability : {};
        if ($('talReliabilityScore')) $('talReliabilityScore').value = (rel.score == null ? '' : String(rel.score));
        if ($('talReliabilityFlags')) $('talReliabilityFlags').value = joinCsvList(rel.flags);
      }
    }

    async function loadTalentProfilesCache({ force = false } = {}){
      if (!talentIsCoordinator()) return new Map();

      const now = Date.now();
      const loadedAt = Number(state._talentProfilesLoadedAt || 0);
      const ttlMs = 5 * 60 * 1000;
      if (!force && state._talentProfilesById instanceof Map && (now - loadedAt) < ttlMs) {
        return state._talentProfilesById;
      }

      try {
        const j = await api('/api/portal/talent_profiles');
        const profiles = Array.isArray(j.profiles) ? j.profiles : [];
        state.talent.profiles = profiles;
        const byId = new Map(profiles.map((p) => [String(p?.userId || ''), p]));
        state._talentProfilesById = byId;
        state._talentProfilesLoadedAt = now;
        return byId;
      } catch {
        state.talent.profiles = [];
        const byId = new Map();
        state._talentProfilesById = byId;
        state._talentProfilesLoadedAt = now;
        return byId;
      }
    }

    async function rerenderTalentDirectoryFromCache(){
      if (!talentIsCoordinator()) return;
      await ensureUsersCache();
      const profilesById = (state._talentProfilesById instanceof Map)
        ? state._talentProfilesById
        : new Map((Array.isArray(state.talent?.profiles) ? state.talent.profiles : []).map((p) => [String(p?.userId || ''), p]));
      renderTalentDirectory(profilesById);
    }

    async function loadTalentTab(){
      $('talentMsg').textContent = '';
      $('talentDirMsg').textContent = '';

      // Clear edit mode automatically for non-coordinators.
      if (!talentIsCoordinator()) {
        state.talent.editUserId = '';
      }

      if (talentIsCoordinator()) {
        await ensureUsersCache();
        $('talentDirectoryWrap')?.classList.remove('hide');
        $('talentStopEditingBtn')?.classList.toggle('hide', !String(state.talent.editUserId || '').trim());
      } else {
        $('talentDirectoryWrap')?.classList.add('hide');
        $('talentStopEditingBtn')?.classList.add('hide');
      }

      setTalentEditingLine();

      const profilesById = await loadTalentProfilesCache();

      // Load the active form target.
      const targetUserId = (talentIsCoordinator() && String(state.talent.editUserId || '').trim())
        ? String(state.talent.editUserId || '').trim()
        : String(state.me?.user?.id || '').trim();

      let profile = profilesById.get(targetUserId) || null;
      if (!profile) {
        try {
          const j = await api('/api/portal/talent_profiles?userId=' + encodeURIComponent(targetUserId));
          profile = j.profile || null;
        } catch {
          profile = null;
        }
      }
      state.talent.my = profile;
      writeTalentForm(profile || { role: myPortalRole() });

      if (talentIsCoordinator()) {
        renderTalentDirectory(profilesById);
      }
    }

    function talentDirectoryRows(profilesById){
      const users = Array.isArray(state.usersCache) ? state.usersCache : [];
      const pool = users.filter((u) => ['event_host','media_team'].includes(String(u?.role || '').trim()));
      const q = String($('talentQ')?.value || state.talent.q || '').trim().toLowerCase();
      state.talent.q = q;

      const rows = pool.map((u) => {
        const uid = String(u.userId);
        const p = profilesById.get(uid) || null;
        const display = (p && p.displayName) ? String(p.displayName) : String(u.fullName || u.email || uid);
        const loc = p ? [p.homeBaseCity, p.homeBaseState].filter(Boolean).join(', ') : '';
        const specs = p && Array.isArray(p.specialties) ? p.specialties.join(', ') : '';
        const rel = p && p.reliability && typeof p.reliability === 'object' ? p.reliability : {};
        const relScore = (rel.score == null) ? '' : String(rel.score);

        const hay = [display, String(u.email || ''), String(u.role || ''), loc, specs].join(' ').toLowerCase();
        if (q && !hay.includes(q)) return null;

        return {
          userId: uid,
          role: String(u.role || ''),
          display,
          email: String(u.email || ''),
          loc,
          specs,
          relScore,
          hasProfile: !!p,
        };
      }).filter(Boolean);

      rows.sort((a, b) => a.display.localeCompare(b.display));
      return rows;
    }

    function renderTalentDirectory(profilesById){
      const list = $('talentDirList');
      if (!list) return;
      const rows = talentDirectoryRows(profilesById);
      if (!rows.length) {
        list.innerHTML = '<div class="muted small">No matching talent.</div>';
        return;
      }

      list.innerHTML = rows.slice(0, 120).map((r) => {
        const badge = r.hasProfile ? '<span class="badge ok">profile</span>' : '<span class="badge">missing</span>';
        const rel = r.relScore ? `<span class="badge">rel ${escapeHtml(r.relScore)}</span>` : '';
        return `
          <div class="card" style="background:#fff; margin-bottom:10px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; gap:12px;">
                <div>
                  <div style="font-weight:900;">${escapeHtml(r.display)} <span class="muted">(${escapeHtml(r.role)})</span></div>
                  <div class="muted small" style="margin-top:2px;">${escapeHtml([r.loc, r.specs].filter(Boolean).join(' • '))}</div>
                  <div class="muted small" style="margin-top:2px; font-family:var(--mono);">${escapeHtml(r.userId)}</div>
                </div>
                <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                  ${badge} ${rel}
                  <button class="btn secondary small" type="button" data-edit-talent="${escapeHtml(r.userId)}">Edit</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      for (const btn of list.querySelectorAll('button[data-edit-talent]')){
        btn.addEventListener('click', () => {
          state.talent.editUserId = String(btn.dataset.editTalent || '').trim();
          $('talentStopEditingBtn')?.classList.remove('hide');
          loadTalentTab().catch(()=>{});
        });
      }
    }

    async function saveTalentProfile(){
      $('talentMsg').textContent = '';
      try{
        const profile = readTalentForm();
        const body = { profile };
        if (talentIsCoordinator() && String(state.talent.editUserId || '').trim()) {
          body.userId = String(state.talent.editUserId || '').trim();
        }
        const j = await api('/api/portal/talent_profiles', { method: 'POST', body });
        state.talent.my = j.profile || null;
        $('talentMsg').textContent = 'Saved.';

        // Refresh caches + directory and staffing dropdown labels.
        if (talentIsCoordinator()) {
          await loadTalentProfilesCache({ force: true });
          await initEventOps().catch(()=>{});
          await rerenderTalentDirectoryFromCache().catch(()=>{});
        }
      } catch(e){
        $('talentMsg').textContent = String(e.message || e);
      }
    }

    function stopTalentEditing(){
      state.talent.editUserId = '';
      $('talentStopEditingBtn')?.classList.add('hide');
      setTalentEditingLine();
      loadTalentTab().catch(()=>{});
    }

    async function loadRecaps(eventId){
      $('recapMsg').textContent = '';
      $('recapsList').textContent = '';
      try{
        const j = await api('/api/portal/event_recaps?eventId=' + encodeURIComponent(String(eventId)));
        const recaps = j.recaps || [];
        if (!recaps.length) {
          $('recapsList').innerHTML = '<div class="muted small">No recaps yet.</div>';
          return;
        }
        $('recapsList').innerHTML = recaps.map((r) => {
          const p = r.payload || {};
          const media = Array.isArray(r.media_urls) ? r.media_urls : [];
          const meta = [
            p.attendanceEstimate != null ? ('attendance ' + p.attendanceEstimate) : '',
            p.rating ? ('rating ' + p.rating) : '',
            p.photosUploaded ? ('photos ' + p.photosUploaded) : '',
          ].filter(Boolean).join(' • ');
          const mediaHtml = media.length ? (`<div class="small" style="margin-top:8px;">${media.map((u) => `<div><a href="${escapeHtml(u)}" target="_blank" rel="noopener">${escapeHtml(u)}</a></div>`).join('')}</div>`) : '';
          return `
            <div class="card" style="background:#fff; margin-bottom:10px;">
              <div class="bd">
                <div class="muted small">${escapeHtml(r.created_at || '')}</div>
                ${meta ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(meta)}</div>` : ''}
                ${r.recap ? `<div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(r.recap)}</div>` : ''}
                ${mediaHtml}
              </div>
            </div>
          `;
        }).join('');
      } catch(e){
        $('recapMsg').textContent = String(e.message || e);
      }
    }

    async function submitRecap(){
      $('recapMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');

        const mediaUrls = String($('recapMedia').value || '')
          .split('\n')
          .map((x) => x.trim())
          .filter(Boolean)
          .slice(0, 30);

        const payload = {
          attendanceEstimate: $('recapAttendance').value ? Number($('recapAttendance').value) : null,
          rating: $('recapRating').value || null,
          issuesReported: $('recapIssues').value || null,
          issuesDetails: $('recapIssuesDetails').value || '',
          photosUploaded: $('recapPhotos').value || null,
          hostNotes: $('recapNotes').value || '',
          standouts: $('recapStandouts') ? ($('recapStandouts').value || '') : '',
          giveawayWinners: $('recapGiveawayWinners') ? ($('recapGiveawayWinners').value || '') : '',
          feedbackHighlights: $('recapFeedbackHighlights') ? ($('recapFeedbackHighlights').value || '') : '',
          eventFlowDocUrl: $('recapEventFlowDoc') ? ($('recapEventFlowDoc').value || '') : '',
        };

        await api('/api/portal/event_recaps', {
          method: 'POST',
          body: {
            eventId: e.id,
            recap: payload.hostNotes || payload.issuesDetails || '',
            mediaUrls,
            payload,
          },
        });

        $('recapMsg').textContent = '';
        await loadRecaps(e.id);
      } catch(e){
        $('recapMsg').textContent = String(e.message || e);
      }
    }

    function myPortalRole(){
      return String(state.me?.profile?.role || '');
    }

    function isCoordinatorRole(){
      const r = myPortalRole();
      return r === 'event_coordinator' || r === 'manager';
    }

    function isManagerViewAsActive(){
      const vRole = String(state.viewAsRole || '').trim();
      const vUser = String(state.viewAsUserId || '').trim();
      return isManagerUser() && (!!vRole || !!vUser);
    }

    function coordinatorOpsEditable(){
      // Manager view-as must remain read-only (server enforced too).
      return isCoordinatorRole() && !isManagerViewAsActive();
    }

    function dollarsToCents(v){
      const n = Number(String(v || '').trim());
      if (!Number.isFinite(n) || n < 0) return 0;
      return Math.round(n * 100);
    }

    function centsToDollars(c){
      const n = Number(c || 0);
      if (!Number.isFinite(n)) return '';
      return (n / 100).toFixed(2);
    }

    function mergeMeta(base, patch){
      const a = (base && typeof base === 'object') ? base : {};
      const b = (patch && typeof patch === 'object') ? patch : {};
      return Object.assign({}, a, b);
    }

    function feedbackDefaultForm(){
      return {
        enabled: 'no',
        token: '',
        subtitle: 'Thanks for joining us. Your feedback helps us improve future events.',
        thanksMessage: 'Your feedback was received.',
        questions: [
          { type: 'long_text', label: 'What was your favorite part?' },
          { type: 'long_text', label: 'What should we do differently next time?' },
        ],
      };
    }

    function cleanFeedbackQuestion(q){
      const obj = (q && typeof q === 'object') ? q : {};
      const type = String(obj.type || 'long_text').trim();
      const label = String(obj.label || '').trim();
      const allowed = new Set(['short_text','long_text','yes_no']);
      return {
        type: allowed.has(type) ? type : 'long_text',
        label: label.slice(0, 140) || 'Question',
      };
    }

    function feedbackFormFromMeta(meta){
      const m = (meta && typeof meta === 'object') ? meta : {};
      const base = feedbackDefaultForm();
      const f = (m.feedbackForm && typeof m.feedbackForm === 'object') ? m.feedbackForm : {};
      const out = Object.assign({}, base, f);
      out.enabled = String(out.enabled || '') === 'yes' ? 'yes' : 'no';
      out.token = String(out.token || '').trim().slice(0, 220);
      out.subtitle = String(out.subtitle || base.subtitle).trim().slice(0, 200);
      out.thanksMessage = String(out.thanksMessage || base.thanksMessage).trim().slice(0, 200);
      out.questions = (Array.isArray(out.questions) ? out.questions : base.questions).slice(0, 10).map(cleanFeedbackQuestion);
      return out;
    }

    function feedbackLinkFor(eventId, token){
      const id = String(eventId || '').trim();
      const t = String(token || '').trim();
      if (!id || !t) return '';
      try {
        return `${location.origin}/feedback?eventId=${encodeURIComponent(id)}&t=${encodeURIComponent(t)}`;
      } catch {
        return `/feedback?eventId=${encodeURIComponent(id)}&t=${encodeURIComponent(t)}`;
      }
    }

    function genFeedbackToken(){
      try {
        if (crypto?.randomUUID) return crypto.randomUUID().replace(/-/g, '');
      } catch {
        // ignore
      }
      return 'fb_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function renderFeedbackEditor(meta){
      const e = state.selectedEvent;
      const msg = $('feedbackFormMsg');
      if (msg) msg.textContent = '';

      const editable = coordinatorOpsEditable();
      $('feedbackEnableBtn')?.toggleAttribute('disabled', !editable);
      $('feedbackAddQBtn')?.toggleAttribute('disabled', !editable);
      $('feedbackSaveBtn')?.toggleAttribute('disabled', !editable);

      const f = feedbackFormFromMeta(meta);
      const link = (f.enabled === 'yes' && f.token) ? feedbackLinkFor(e?.id, f.token) : '';
      if ($('feedbackLink')) $('feedbackLink').value = link;
      if ($('feedbackSubtitle')) $('feedbackSubtitle').value = String(f.subtitle || '');
      if ($('feedbackThanks')) $('feedbackThanks').value = String(f.thanksMessage || '');

      const list = $('feedbackQuestionsList');
      if (list) {
        list.innerHTML = '';
        if (!f.questions.length) {
          list.innerHTML = '<div class="muted small">No questions yet.</div>';
        } else {
          for (const q of f.questions) addFeedbackQuestionRow(list, q, { editable });
        }
      }

      // Clear summary display if event changed.
      const sum = state._feedbackSummaryByEventId && e?.id ? state._feedbackSummaryByEventId[String(e.id)] : null;
      renderFeedbackSummary(sum);
    }

    function addFeedbackQuestionRow(listEl, q, { editable } = {}){
      const list = listEl || $('feedbackQuestionsList');
      if (!list) return;

      const question = cleanFeedbackQuestion(q);
      // Remove the empty placeholder.
      if (list.children.length === 1 && list.children[0].classList?.contains('muted')) list.innerHTML = '';

      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.fbqRow = '1';
      row.style.gap = '8px';
      row.style.flexWrap = 'wrap';
      row.style.marginBottom = '8px';

      row.innerHTML = `
        <select data-fbq-type="1" ${editable ? '' : 'disabled'}>
          <option value="long_text" ${question.type === 'long_text' ? 'selected' : ''}>Long text</option>
          <option value="short_text" ${question.type === 'short_text' ? 'selected' : ''}>Short text</option>
          <option value="yes_no" ${question.type === 'yes_no' ? 'selected' : ''}>Yes / No</option>
        </select>
        <input data-fbq-label="1" value="${escapeHtml(question.label)}" placeholder="Question label" style="min-width:280px; flex:1;" ${editable ? '' : 'disabled'} />
        <button class="btn secondary small" type="button" data-fbq-remove="1" ${editable ? '' : 'disabled'}>Remove</button>
      `;

      const rm = row.querySelector('button[data-fbq-remove]');
      if (rm) {
        rm.addEventListener('click', () => {
          if (!editable) return;
          row.remove();
          if (!list.children.length) list.innerHTML = '<div class="muted small">No questions yet.</div>';
        });
      }

      list.appendChild(row);
    }

    function readFeedbackEditor(){
      const subtitle = String($('feedbackSubtitle')?.value || '').trim().slice(0, 200);
      const thanksMessage = String($('feedbackThanks')?.value || '').trim().slice(0, 200);
      const list = $('feedbackQuestionsList');
      const rows = list ? Array.from(list.querySelectorAll('[data-fbq-row]')) : [];
      const questions = rows.map((row) => {
        const type = String(row.querySelector('[data-fbq-type]')?.value || 'long_text').trim();
        const label = String(row.querySelector('[data-fbq-label]')?.value || '').trim();
        return cleanFeedbackQuestion({ type, label });
      }).filter(Boolean).slice(0, 10);
      return { subtitle, thanksMessage, questions };
    }

    async function enableOrRegenerateFeedbackLink(){
      $('feedbackFormMsg').textContent = '';
      try {
        if (!coordinatorOpsEditable()) throw new Error('read_only');
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const current = feedbackFormFromMeta(meta);
        const ed = readFeedbackEditor();
        const next = Object.assign({}, current, ed, {
          enabled: 'yes',
          token: genFeedbackToken(),
          updatedAt: new Date().toISOString(),
        });
        await patchSelectedEventMeta({ feedbackForm: next });
        const updated = state.selectedEvent;
        renderFeedbackEditor(updated?.meta);
        $('feedbackFormMsg').textContent = 'Link generated.';
      } catch(e){
        $('feedbackFormMsg').textContent = String(e.message || e);
      }
    }

    async function saveFeedbackForm(){
      $('feedbackFormMsg').textContent = '';
      try {
        if (!coordinatorOpsEditable()) throw new Error('read_only');
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const current = feedbackFormFromMeta(meta);
        const ed = readFeedbackEditor();
        const next = Object.assign({}, current, ed, {
          updatedAt: new Date().toISOString(),
        });
        await patchSelectedEventMeta({ feedbackForm: next });
        const updated = state.selectedEvent;
        renderFeedbackEditor(updated?.meta);
        $('feedbackFormMsg').textContent = 'Saved.';
      } catch(e){
        $('feedbackFormMsg').textContent = String(e.message || e);
      }
    }

    async function copyFeedbackLink(){
      const v = String($('feedbackLink')?.value || '').trim();
      if (!v) return;
      try {
        await navigator.clipboard.writeText(v);
        $('feedbackFormMsg').textContent = 'Copied.';
      } catch {
        // Fallback
        const el = $('feedbackLink');
        if (el) {
          el.focus();
          el.select();
          document.execCommand('copy');
          $('feedbackFormMsg').textContent = 'Copied.';
        }
      }
    }

    function openFeedbackLink(){
      const v = String($('feedbackLink')?.value || '').trim();
      if (!v) return;
      try { window.open(v, '_blank', 'noopener'); } catch { /* ignore */ }
    }

    function renderFeedbackSummary(summary){
      const line = $('feedbackSummaryLine');
      const list = $('feedbackCommentsList');
      if (!line || !list) return;

      if (!summary) {
        line.textContent = '';
        list.innerHTML = '';
        return;
      }

      const c = Number(summary.count || 0);
      const avg = summary.avgRating == null ? '' : String(summary.avgRating);
      line.textContent = c ? `Submissions: ${c}${avg ? (' • Avg rating: ' + avg) : ''}` : 'No submissions yet.';

      const comments = Array.isArray(summary.comments) ? summary.comments : [];
      if (!comments.length) {
        list.innerHTML = '';
        return;
      }

      list.innerHTML = comments.slice(0, 25).map((x) => {
        const meta = [x.ts ? String(x.ts).slice(0, 19).replace('T', ' ') : '', x.rating ? ('★' + x.rating) : '', x.name || ''].filter(Boolean).join(' • ');
        return `
          <div class="card" style="background:#fff; margin-bottom:10px;">
            <div class="bd">
              <div class="muted small">${escapeHtml(meta)}</div>
              <div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(x.comment || '')}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadFeedbackSummary(){
      $('feedbackFormMsg').textContent = '';
      try {
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const j = await api('/api/portal/event_feedback?eventId=' + encodeURIComponent(String(e.id)));
        const summary = j?.summary || null;
        if (!state._feedbackSummaryByEventId) state._feedbackSummaryByEventId = {};
        state._feedbackSummaryByEventId[String(e.id)] = summary;
        renderFeedbackSummary(summary);
      } catch(e){
        $('feedbackFormMsg').textContent = String(e.message || e);
      }
    }

    function updateEventInState(updated){
      if (!updated || !updated.id) return;
      const id = Number(updated.id);
      state.events = Array.isArray(state.events) ? state.events : [];
      const idx = state.events.findIndex((x) => Number(x?.id) === id);
      if (idx >= 0) state.events[idx] = updated;
      if (state.selectedEvent && Number(state.selectedEvent.id) === id) state.selectedEvent = updated;
    }

    function renderAssignments(assignments, usersById){
      const box = $('assignmentsList');
      if (!box) return;
      const arr = Array.isArray(assignments) ? assignments : [];
      if (!arr.length) {
        box.innerHTML = '<div class="muted small">No assignments yet.</div>';
        return;
      }

      const canManage = isCoordinatorRole();

      box.innerHTML = arr.map((a) => {
        const uid = String(a?.userId || '');
        const role = String(a?.role || '');
        const status = String(a?.status || 'pending');
        const u = usersById && usersById.get ? usersById.get(uid) : null;
        const name = String(u?.fullName || u?.email || uid).trim();
        const badge = `<span class="badge ${status === 'accepted' ? 'ok' : ''}">${escapeHtml(status)}</span>`;
        const removeBtn = canManage
          ? `<button class="btn secondary small" data-remove-asg="1" data-asg-role="${escapeHtml(role)}" data-asg-user="${escapeHtml(uid)}">Remove</button>`
          : '';
        return `
          <div class="card" style="background:#fff; margin-top:8px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; gap:12px;">
                <div>
                  <div style="font-weight:900;">${escapeHtml(role)} — ${escapeHtml(name)}</div>
                  <div class="muted small" style="margin-top:2px;">${escapeHtml(uid)}</div>
                </div>
                <div class="row" style="gap:8px;">${badge} ${removeBtn}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      for (const btn of box.querySelectorAll('button[data-remove-asg]')){
        btn.addEventListener('click', () => {
          const uid = String(btn.dataset.asgUser || '');
          const role = String(btn.dataset.asgRole || '');
          removeAssignment(uid, role).catch(()=>{});
        });
      }
    }

    function renderMyAssignmentActions(assignments){
      const el = $('myAssignmentActions');
      if (!el) return;
      const arr = Array.isArray(assignments) ? assignments : [];
      const uid = String(state.me?.user?.id || '');
      const mine = arr.filter((a) => String(a?.userId || '') === uid && String(a?.status || '') === 'pending');
      if (!mine.length) {
        el.classList.add('hide');
        el.innerHTML = '';
        return;
      }

      el.classList.remove('hide');
      el.innerHTML = `
        <div style="font-weight:900;">Your assignment</div>
        <div class="muted small" style="margin-top:4px;">Accept/decline so Ops can reassign quickly.</div>
        <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap;">
          ${mine.map((a) => {
            const role = String(a?.role || '');
            return `
              <button class="btn" type="button" data-asg-accept="1" data-asg-role="${escapeHtml(role)}">Accept ${escapeHtml(role)}</button>
              <button class="btn secondary" type="button" data-asg-decline="1" data-asg-role="${escapeHtml(role)}">Decline</button>
            `;
          }).join('')}
        </div>
      `;

      for (const btn of el.querySelectorAll('button[data-asg-accept]')) {
        btn.addEventListener('click', () => respondAssignment(String(btn.dataset.asgRole || ''), 'accepted').catch(()=>{}));
      }
      for (const btn of el.querySelectorAll('button[data-asg-decline]')) {
        btn.addEventListener('click', () => respondAssignment(String(btn.dataset.asgRole || ''), 'declined').catch(()=>{}));
      }
    }

    async function loadAssignableUsers(){
      if (!isCoordinatorRole()) return [];
      if (Array.isArray(state._eventOpsUsers) && state._eventOpsUsers.length) return state._eventOpsUsers;
      const j = await api('/api/portal/users');
      const users = Array.isArray(j.users) ? j.users : [];
      state._eventOpsUsers = users;
      return users;
    }

    function fillAssignSelects(users, profilesById){
      const hostSel = $('assignHostUser');
      const mediaSel = $('assignMediaUser');
      if (!hostSel || !mediaSel) return;
      const arr = Array.isArray(users) ? users : [];

      const byId = (profilesById instanceof Map)
        ? profilesById
        : new Map((Array.isArray(state.talent?.profiles) ? state.talent.profiles : []).map((p) => [String(p?.userId || ''), p]));

      function bestName(u, p){
        return String((p && p.displayName) || u.fullName || u.email || u.userId || '').trim();
      }

      function talentMetaBits(p){
        if (!p || typeof p !== 'object') return [];
        const loc = [p.homeBaseCity, p.homeBaseState].filter(Boolean).join(', ');
        const specs = Array.isArray(p.specialties) ? p.specialties.filter(Boolean).slice(0, 3).join(', ') : '';
        const rel = (p.reliability && typeof p.reliability === 'object' && p.reliability.score != null) ? ('rel ' + String(p.reliability.score)) : '';
        return [loc, specs, rel].filter(Boolean);
      }

      function option(u){
        const p = byId.get(String(u.userId)) || null;
        const meta = talentMetaBits(p);
        const label = [bestName(u, p), u.email || '', meta.length ? meta.join(' • ') : ''].filter(Boolean).join(' • ') || u.userId;
        return `<option value="${escapeHtml(u.userId)}">${escapeHtml(label)}</option>`;
      }

      const hosts = arr.filter((u) => String(u.role || '') === 'event_host').slice().sort((a, b) => {
        const pa = byId.get(String(a.userId)) || null;
        const pb = byId.get(String(b.userId)) || null;
        return bestName(a, pa).localeCompare(bestName(b, pb));
      });
      const medias = arr.filter((u) => String(u.role || '') === 'media_team').slice().sort((a, b) => {
        const pa = byId.get(String(a.userId)) || null;
        const pb = byId.get(String(b.userId)) || null;
        return bestName(a, pa).localeCompare(bestName(b, pb));
      });

      hostSel.innerHTML = '<option value="">Assign host…</option>' + hosts.map(option).join('');
      mediaSel.innerHTML = '<option value="">Assign media…</option>' + medias.map(option).join('');
    }

    async function loadAssignmentsForSelected(){
      const e = state.selectedEvent;
      if (!e || !e.id) return { assignments: [], usersById: new Map() };

      const j = await api('/api/portal/event_assignments?eventId=' + encodeURIComponent(String(e.id)));
      const assignments = Array.isArray(j.assignments) ? j.assignments : [];

      let users = [];
      try {
        users = await loadAssignableUsers();
      } catch {
        users = [];
      }
      const byId = new Map((Array.isArray(users) ? users : []).map((u) => [String(u.userId), u]));
      return { assignments, usersById: byId };
    }

    function renderEventOpsFromSelected(meta, assignments, usersById){
      const wrap = $('eventOpsWrap');
      if (!wrap) return;

      const e = state.selectedEvent;
      wrap.classList.toggle('hide', !e);
      if (!e) return;

      const canManage = coordinatorOpsEditable();
      $('assignHostUser')?.toggleAttribute('disabled', !canManage);
      $('assignMediaUser')?.toggleAttribute('disabled', !canManage);
      $('addHostBtn')?.toggleAttribute('disabled', !canManage);
      $('addMediaBtn')?.toggleAttribute('disabled', !canManage);

      const checklist = meta?.checklist && typeof meta.checklist === 'object' ? meta.checklist : {};
      if ($('chkRecapReceived')) $('chkRecapReceived').checked = String(checklist.recapReceived || '') === 'yes';
      if ($('chkMediaReceived')) $('chkMediaReceived').checked = String(checklist.mediaReceived || '') === 'yes';
      if ($('chkFeedbackReceived')) $('chkFeedbackReceived').checked = String(checklist.feedbackReceived || '') === 'yes';
      if ($('chkReportSent')) $('chkReportSent').checked = String(checklist.reportSent || '') === 'yes';

      const plan = meta?.plan && typeof meta.plan === 'object' ? meta.plan : {};
      if ($('planStrategy')) $('planStrategy').value = String(plan.strategy || '');
      if ($('planEventType')) $('planEventType').value = String(plan.eventType || '');
      if ($('planJustification')) $('planJustification').value = String(plan.justification || '');

      const budget = meta?.budget && typeof meta.budget === 'object' ? meta.budget : {};
      if ($('budHost')) $('budHost').value = centsToDollars(budget.hostPayCents || 0);
      if ($('budMedia')) $('budMedia').value = centsToDollars(budget.mediaPayCents || 0);
      if ($('budFood')) $('budFood').value = centsToDollars(budget.foodCents || 0);
      if ($('budDecor')) $('budDecor').value = centsToDollars(budget.decorCents || 0);
      if ($('budSupplies')) $('budSupplies').value = centsToDollars(budget.suppliesCents || 0);
      if ($('budContingency')) $('budContingency').value = centsToDollars(budget.contingencyCents || 0);

      renderAssignments(assignments, usersById);
      renderMyAssignmentActions(assignments);

      renderFeedbackEditor(meta);
    }

    async function initEventOps(){
      const e = state.selectedEvent;
      if (!e || !e.id) {
        if ($('eventOpsWrap')) $('eventOpsWrap').classList.add('hide');
        return;
      }

      $('eventOpsMsg').textContent = '';
      $('budgetMsg').textContent = '';

      // Load event types for select.
      try{
        const j = await api('/api/portal/event_types');
        const types = Array.isArray(j.types) ? j.types : [];
        state._eventOpsTypes = types;
        const sel = $('planEventType');
        if (sel) {
          const opts = types.map((t) => {
            const label = String(t['Event Type'] || t['event_type'] || t['type'] || t['name'] || '').trim() || JSON.stringify(t).slice(0, 80);
            return `<option value="${escapeHtml(label)}">${escapeHtml(label)}</option>`;
          });
          sel.innerHTML = '<option value="">Select…</option>' + opts.join('');
        }
      } catch {
        // ignore
      }

      if (isCoordinatorRole()) {
        try{
          const profilesById = await loadTalentProfilesCache();
          const users = await loadAssignableUsers();
          fillAssignSelects(users, profilesById);
        } catch {
          // ignore
        }
      }

      const { assignments, usersById } = await loadAssignmentsForSelected();
      const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
      renderEventOpsFromSelected(meta, assignments, usersById);
    }

    async function addAssignment(role){
      $('eventOpsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const userId = role === 'event_host' ? String($('assignHostUser')?.value || '') : String($('assignMediaUser')?.value || '');
        if (!userId) throw new Error('select a user');
        const j = await api('/api/portal/event_assignments', { method: 'PATCH', body: { action: 'add', eventId: e.id, role, userId } });
        const next = Array.isArray(j.assignments) ? j.assignments : [];
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const nextMeta = Object.assign({}, meta, { assignments: next });
        const updated = Object.assign({}, e, { meta: nextMeta });
        updateEventInState(updated);
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function removeAssignment(userId, role){
      $('eventOpsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const j = await api('/api/portal/event_assignments', { method: 'PATCH', body: { action: 'remove', eventId: e.id, role, userId } });
        const next = Array.isArray(j.assignments) ? j.assignments : [];
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const nextMeta = Object.assign({}, meta, { assignments: next });
        const updated = Object.assign({}, e, { meta: nextMeta });
        updateEventInState(updated);
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function respondAssignment(role, decision){
      $('eventOpsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const j = await api('/api/portal/event_assignments', { method: 'PATCH', body: { action: 'respond', eventId: e.id, role, decision } });
        const next = Array.isArray(j.assignments) ? j.assignments : [];
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const nextMeta = Object.assign({}, meta, { assignments: next });
        const updated = Object.assign({}, e, { meta: nextMeta, status: j.status || e.status });
        updateEventInState(updated);
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function patchSelectedEventMeta(partial){
      const e = state.selectedEvent;
      if (!e || !e.id) throw new Error('select an event');
      const baseMeta = (e.meta && typeof e.meta === 'object') ? e.meta : {};
      const nextMeta = mergeMeta(baseMeta, partial);
      const j = await api('/api/portal/events', { method: 'PATCH', body: { id: e.id, meta: nextMeta } });
      if (j && j.event) updateEventInState(j.event);
      else updateEventInState(Object.assign({}, e, { meta: nextMeta }));
    }

    async function saveChecklist(){
      $('eventOpsMsg').textContent = '';
      try{
        const checklist = {
          recapReceived: $('chkRecapReceived')?.checked ? 'yes' : 'no',
          mediaReceived: $('chkMediaReceived')?.checked ? 'yes' : 'no',
          feedbackReceived: $('chkFeedbackReceived')?.checked ? 'yes' : 'no',
          reportSent: $('chkReportSent')?.checked ? 'yes' : 'no',
          updatedAt: new Date().toISOString(),
        };
        await patchSelectedEventMeta({ checklist });
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function savePlan(){
      $('eventOpsMsg').textContent = '';
      try{
        const strategy = String($('planStrategy')?.value || '');
        const eventType = String($('planEventType')?.value || '');
        const justification = String($('planJustification')?.value || '').trim();
        if (strategy && !justification) throw new Error('justification_required');
        const plan = { strategy, eventType, justification, updatedAt: new Date().toISOString() };
        await patchSelectedEventMeta({ plan });
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function saveBudget(){
      $('budgetMsg').textContent = '';
      try{
        const hostPayCents = dollarsToCents($('budHost')?.value);
        const mediaPayCents = dollarsToCents($('budMedia')?.value);
        if (mediaPayCents > 0) {
          const minHost = Math.ceil(mediaPayCents * 0.75);
          if (hostPayCents < minHost) throw new Error(`host_pay_must_be_at_least_${(minHost/100).toFixed(2)}`);
        }
        const budget = {
          hostPayCents,
          mediaPayCents,
          foodCents: dollarsToCents($('budFood')?.value),
          decorCents: dollarsToCents($('budDecor')?.value),
          suppliesCents: dollarsToCents($('budSupplies')?.value),
          contingencyCents: dollarsToCents($('budContingency')?.value),
          updatedAt: new Date().toISOString(),
        };
        await patchSelectedEventMeta({ budget });
        await initEventOps();
      } catch (err) {
        $('budgetMsg').textContent = String(err.message || err);
      }
    }

    async function createFollowups(){
      $('eventOpsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const j = await api('/api/portal/event_followups', { method: 'POST', body: { eventId: e.id } });
        const created = Array.isArray(j.created) ? j.created.length : 0;
        const skipped = Array.isArray(j.skipped) ? j.skipped.length : 0;
        $('eventOpsMsg').textContent = `Follow-ups: ${created} created, ${skipped} already existed.`;
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function importVendors(){
      $('importVendorsMsg').textContent = '';
      try{
        const csvText = String($('vendorsCsv')?.value || '').trim();
        if (!csvText) throw new Error('paste_csv');
        const j = await api('/api/portal/vendors', { method: 'POST', body: { csvText } });
        $('importVendorsMsg').textContent = `Imported ${Number(j.count || 0)} vendors.`;
      } catch (err) {
        $('importVendorsMsg').textContent = String(err.message || err);
      }
    }

    async function importEventTypes(){
      $('importEventTypesMsg').textContent = '';
      try{
        const csvText = String($('eventTypesCsv')?.value || '').trim();
        if (!csvText) throw new Error('paste_csv');
        const j = await api('/api/portal/event_types', { method: 'POST', body: { csvText } });
        $('importEventTypesMsg').textContent = `Imported ${Number(j.count || 0)} event types.`;
        await initEventOps();
      } catch (err) {
        $('importEventTypesMsg').textContent = String(err.message || err);
      }
    }

    function vendorLabel(v){
      const name = String(v?.Vendor || v?.vendor || v?.Name || v?.name || '').trim();
      const city = String(v?.City || v?.city || '').trim();
      const st = String(v?.State || v?.state || '').trim();
      const extra = [city, st].filter(Boolean).join(', ');
      return [name, extra].filter(Boolean).join(' • ') || JSON.stringify(v).slice(0, 80);
    }

    async function loadVendors(){
      $('vendorsMsg').textContent = '';
      try{
        const q = String($('vendorQ')?.value || '').trim();
        const j = await api('/api/portal/vendors?q=' + encodeURIComponent(q));
        let vendors = Array.isArray(j.vendors) ? j.vendors : [];

        const e = state.selectedEvent;
        const evCity = String(e?.city || '').trim().toLowerCase();
        const evState = String(e?.state || '').trim().toLowerCase();
        function scoreVendor(v){
          const city = String(v?.City || v?.city || '').trim().toLowerCase();
          const st = String(v?.State || v?.state || '').trim().toLowerCase();
          let s = 0;
          if (evState && st && evState === st) s += 1;
          if (evCity && city && evCity === city) s += 2;
          return s;
        }

        if (evCity || evState) {
          vendors = vendors.slice().sort((a, b) => {
            const sa = scoreVendor(a);
            const sb = scoreVendor(b);
            if (sb !== sa) return sb - sa;
            return vendorLabel(a).localeCompare(vendorLabel(b));
          });
        }

        $('vendorsList').innerHTML = vendors.slice(0, 30).map((v, i) => {
          const s = (evCity || evState) ? scoreVendor(v) : 0;
          const match = s >= 3 ? '<span class="badge ok">local</span>' : (s >= 1 ? '<span class="badge">state</span>' : '');
          return `
            <div class="card" style="background:#fff; margin-bottom:8px;">
              <div class="bd">
                <div style="font-weight:900;">${escapeHtml(vendorLabel(v))} ${match}</div>
                <div class="row" style="margin-top:8px;">
                  <button class="btn secondary small" type="button" data-add-vendor="${i}">Add to event</button>
                </div>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted small">No vendors found.</div>';

        for (const btn of $('vendorsList').querySelectorAll('button[data-add-vendor]')){
          btn.addEventListener('click', () => {
            const idx = Number(btn.dataset.addVendor || 0);
            addVendorToEvent(vendors[idx]).catch(()=>{});
          });
        }
      } catch (err) {
        $('vendorsMsg').textContent = String(err.message || err);
      }
    }

    function suggestVendorsForSelected(){
      const e = state.selectedEvent;
      const city = String(e?.city || '').trim();
      const st = String(e?.state || '').trim();
      const q = [city, st].filter(Boolean).join(' ');
      if ($('vendorQ')) $('vendorQ').value = q;
      loadVendors().catch(()=>{});
    }

    async function addVendorToEvent(vendor){
      $('vendorsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const baseMeta = (e.meta && typeof e.meta === 'object') ? e.meta : {};
        const chosen = Array.isArray(baseMeta.vendorsChosen) ? baseMeta.vendorsChosen : [];
        const next = chosen.concat([vendor]).slice(0, 20);
        await patchSelectedEventMeta({ vendorsChosen: next });
        $('vendorsMsg').textContent = 'Added.';
      } catch (err) {
        $('vendorsMsg').textContent = String(err.message || err);
      }
    }

    function eventTypeLabel(t){
      return String(t?.['Event Type'] || t?.event_type || t?.type || t?.name || '').trim() || JSON.stringify(t).slice(0, 80);
    }

    async function loadEventTypes(){
      $('eventTypesMsg').textContent = '';
      try{
        const q = String($('eventTypeQ')?.value || '').trim();
        const j = await api('/api/portal/event_types?q=' + encodeURIComponent(q));
        const types = Array.isArray(j.types) ? j.types : [];
        $('eventTypesList').innerHTML = types.slice(0, 30).map((t, i) => {
          const label = eventTypeLabel(t);
          return `
            <div class="card" style="background:#fff; margin-bottom:8px;">
              <div class="bd">
                <div style="font-weight:900;">${escapeHtml(label)}</div>
                <div class="row" style="margin-top:8px;">
                  <button class="btn secondary small" type="button" data-use-type="${i}">Use as event type</button>
                </div>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted small">No event types found.</div>';

        for (const btn of $('eventTypesList').querySelectorAll('button[data-use-type]')){
          btn.addEventListener('click', () => {
            const idx = Number(btn.dataset.useType || 0);
            const label = eventTypeLabel(types[idx]);
            if ($('planEventType')) $('planEventType').value = label;
          });
        }
      } catch (err) {
        $('eventTypesMsg').textContent = String(err.message || err);
      }
    }

    function fmtMoney(cents){
      const n = Number(cents || 0) / 100;
      return n.toLocaleString(undefined, { style:'currency', currency:'USD' });
    }

    function pipelineStages(){
      // Order matters: this is the visual timeline.
      return [
        { key: 'new', label: 'New' },
        { key: 'working', label: 'Working' },
        { key: 'booked', label: 'Booked' },
        { key: 'won', label: 'Won' },
        { key: 'lost', label: 'Lost' },
      ];
    }

    function countByStatus(leads){
      const out = {};
      const arr = Array.isArray(leads) ? leads : [];
      for (const l of arr) {
        const st = String(l?.status || '').trim();
        if (!st) continue;
        out[st] = Number(out[st] || 0) + 1;
      }
      return out;
    }

    function leadsForStage(leads, stageKey){
      const st = String(stageKey || '').trim();
      return (Array.isArray(leads) ? leads : []).filter((l) => String(l?.status || '').trim() === st);
    }

    function leadLabelLine(l){
      const name = [l?.first_name, l?.last_name].filter(Boolean).join(' ').trim() || '(no name)';
      const prop = String(l?.property_name || l?.company || '').trim();
      return [name, prop].filter(Boolean).join(' • ');
    }

    function renderPipelineTimeline(containerId, leads, { context = 'leads' } = {}){
      const el = $(containerId);
      if (!el) return;
      const defs = pipelineStages();
      const counts = countByStatus(leads);
      el.innerHTML = defs.map((d, idx) => {
        const c = Number(counts[d.key] || 0);
        const line = (idx < defs.length - 1) ? `<span class="pipeLine" aria-hidden="true"></span>` : '';
        return `
          <div class="pipeStage">
            <button type="button" class="pipeNode" data-pipe-stage="${escapeHtml(d.key)}" data-pipe-context="${escapeHtml(context)}">
              <span>${escapeHtml(d.label)}</span>
              <span class="pipeCount">${c}</span>
            </button>
            ${line}
          </div>
        `;
      }).join('');

      for (const btn of el.querySelectorAll('button[data-pipe-stage]')){
        btn.addEventListener('click', () => {
          const stage = String(btn.dataset.pipeStage || '');
          const ctx = String(btn.dataset.pipeContext || 'leads');
          openPipelineModal({ stage, context: ctx });
        });
      }
    }

    const pipelineModalState = {
      stage: '',
      context: 'leads',
      leads: [],
      idx: 0,
    };

    function openPipelineModal({ stage, context } = {}){
      const modal = $('pipelineModal');
      if (!modal) return;

      const st = String(stage || '').trim();
      if (!st) return;
      const ctx = String(context || 'leads');

      const pool = (ctx === 'closer') ? (state.closerQueue || []) : (state.leads || []);
      const items = leadsForStage(pool, st);
      items.sort((a, b) => {
        const an = leadLabelLine(a);
        const bn = leadLabelLine(b);
        return an.localeCompare(bn);
      });

      pipelineModalState.stage = st;
      pipelineModalState.context = ctx;
      pipelineModalState.leads = items;
      pipelineModalState.idx = 0;

      const title = $('pipelineModalTitle');
      const sub = $('pipelineModalSub');
      if (title) title.textContent = (ctx === 'closer' ? 'Sales pipeline' : 'Pipeline') + ` — ${st}`;
      if (sub) sub.textContent = `${items.length} lead${items.length === 1 ? '' : 's'}`;

      renderPipelineModal();
      modal.classList.add('show');
    }

    function closePipelineModal(){
      const modal = $('pipelineModal');
      if (!modal) return;
      modal.classList.remove('show');
    }

    function selectPipelineIdx(nextIdx){
      const n = pipelineModalState.leads.length;
      if (!n) { pipelineModalState.idx = 0; return; }
      let i = Number(nextIdx || 0);
      if (i < 0) i = 0;
      if (i >= n) i = n - 1;
      pipelineModalState.idx = i;
      renderPipelineModal();
    }

    function renderPipelineModal(){
      const list = $('pipelineModalList');
      const detail = $('pipelineModalDetail');
      if (!list || !detail) return;

      const items = pipelineModalState.leads || [];
      if (!items.length) {
        list.innerHTML = '<div class="muted small" style="padding:12px;">No leads in this stage.</div>';
        detail.innerHTML = '<div class="muted small">—</div>';
        return;
      }

      const idx = Number(pipelineModalState.idx || 0);
      const safeIdx = Math.max(0, Math.min(idx, items.length - 1));
      pipelineModalState.idx = safeIdx;

      list.innerHTML = items.map((l, i) => {
        const active = i === safeIdx ? 'active' : '';
        const line = leadLabelLine(l);
        const phone = String(l?.phone || '').trim();
        const followup = (l?.meta && typeof l.meta === 'object') ? String(l.meta.followup || '').trim() : '';
        const extra = [phone ? ('☎ ' + phone) : '', followup ? ('FU ' + followup) : ''].filter(Boolean).join(' • ');
        return `<button type="button" class="${active}" data-pm-pick="${i}">
          <div style="font-weight:900;">${escapeHtml(line)}</div>
          ${extra ? `<div class="muted small" style="margin-top:2px;">${escapeHtml(extra)}</div>` : ''}
        </button>`;
      }).join('');

      for (const btn of list.querySelectorAll('button[data-pm-pick]')){
        btn.addEventListener('click', () => selectPipelineIdx(Number(btn.dataset.pmPick || 0)));
      }

      const l = items[safeIdx];
      const meta = (l?.meta && typeof l.meta === 'object') ? l.meta : {};
      const website = String(meta?.website || '').trim();
      const mapsUrl = String(meta?.maps_url || '').trim();

      detail.innerHTML = `
        <div class="kv">
          <div>ID</div><div>${escapeHtml(String(l?.id || ''))}</div>
          <div>Name</div><div>${escapeHtml([l?.first_name, l?.last_name].filter(Boolean).join(' ') || '')}</div>
          <div>Property</div><div>${escapeHtml(String(l?.property_name || l?.company || ''))}</div>
          <div>Phone</div><div>${escapeHtml(String(l?.phone || ''))}</div>
          <div>Email</div><div>${escapeHtml(String(l?.email || ''))}</div>
          <div>City</div><div>${escapeHtml([l?.city, l?.state].filter(Boolean).join(', '))}</div>
          <div>Status</div><div><span class="badge">${escapeHtml(String(l?.status || ''))}</span></div>
          <div>Follow up</div><div>${escapeHtml(String(meta?.followup || ''))}</div>
          <div>Website</div><div>${website ? `<a href="${escapeHtml(website)}" target="_blank" rel="noopener">${escapeHtml(website)}</a>` : '<span class="muted">—</span>'}</div>
          <div>Maps</div><div>${mapsUrl ? `<a href="${escapeHtml(mapsUrl)}" target="_blank" rel="noopener">Open</a>` : '<span class="muted">—</span>'}</div>
        </div>
      `;
    }

    function renderLeadsTable(){
      const tb = $('leadsTbody');
      if (!tb) return;
      const status = String($('leadStatus')?.value || '').trim();
      const items = (Array.isArray(state.leads) ? state.leads : []).filter((l) => !status || String(l?.status || '') === status);

      renderPipelineTimeline('leadsPipeline', state.leads || [], { context: 'leads' });

      if ($('leadsEmpty')) $('leadsEmpty').textContent = items.length ? '' : 'No leads yet.';
      if (!items.length) {
        tb.innerHTML = '<tr><td colspan="7" class="muted">No leads yet.</td></tr>';
        return;
      }

      tb.innerHTML = items.map((l) => {
        const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
        const prop = l.property_name || l.company || '';
        const city = [l.city, l.state].filter(Boolean).join(', ');
        const asg = l.assigned_role || '';
        return `
          <tr>
            <td><span class="badge">${l.id}</span></td>
            <td>${name}</td>
            <td>${prop}</td>
            <td class="muted">${city}</td>
            <td><span class="badge">${l.status}</span></td>
            <td class="muted">${asg}</td>
            <td><button class="btn secondary small" data-pick="${l.id}">Select</button></td>
          </tr>
        `;
      }).join('');

      for (const btn of tb.querySelectorAll('button[data-pick]')){
        btn.addEventListener('click', () => {
          const id = Number(btn.dataset.pick);
          state.selectedLead = (state.leads || []).find((x) => Number(x.id) === id) || null;
          setSelectedLeadLine();
          loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
          loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
          setTab(state.pickLeadReturnTab || 'calls');
        });
      }
    }

    async function loadLeads(){
      setBadge('warn', 'loading');
      $('leadsMsg').textContent = '';
      if ($('leadsEmpty')) $('leadsEmpty').textContent = '';

      const q = $('leadQ').value.trim();
      const qs = new URLSearchParams();
      if (q) qs.set('q', q);
      // Always fetch without status so the stage bar can show counts.
        renderPipelineTimeline('closerPipeline', leads, { context: 'closer' });

        if (!leads.length) {
      }
    }

    async function pullLeads(){
      const msg = $('pullLeadsMsg');
        tb.innerHTML = leads.map((l) => {

      const cityState = String($('plCityState')?.value || '').trim();
      if (!cityState) {
        if (msg) msg.textContent = 'Enter City, State.';
        return;
      }
      const keyword = String($('plKeyword')?.value || '').trim() || 'apartment leasing office';
      const limit = Number($('plLimit')?.value || 10) || 10;
      const notes = String($('plNotes')?.value || '').trim();

      setBadge('warn', 'loading');
      try {
        const j = await api('/api/portal/pull_leads', {
          method: 'POST',
          body: { cityState, keyword, limit, notes },
        });
        const inserted = Number(j.inserted || 0);
        const skipped = Number(j.skipped || 0);
        if (msg) msg.textContent = inserted
          ? `Pulled ${inserted} leads. ${skipped ? (skipped + ' skipped (missing phone).') : ''}`.trim()
          : `No leads pulled. ${skipped ? (skipped + ' skipped (missing phone).') : ''}`.trim();
        $('pullLeadsBox').hidden = true;
        await loadLeads();
        setBadge('ok', 'loaded');
      } catch (e) {
        if (msg) msg.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createLead(){
      $('createLeadMsg').textContent = '';
      const cityState = $('nlCityState').value.trim();
      let city = cityState, st = '';
      if (cityState.includes(',')){
        const parts = cityState.split(',');
        city = (parts[0] || '').trim();
        st = (parts[1] || '').trim();
      }

      try{
        await api('/api/portal/leads', {
          method: 'POST',
          body: {
            firstName: $('nlFirst').value,
            lastName: $('nlLast').value,
            phone: $('nlPhone').value,
            email: $('nlEmail').value,
            propertyName: $('nlProp').value,
            city,
            state: st,
            notes: $('nlNotes').value,
            status: 'new',
          }
        });
        $('newLeadBox').hidden = true;
        await loadLeads();
      } catch(e){
        $('createLeadMsg').textContent = String(e.message || e);
      }
    }

    async function logCall(){
      $('callMsg').textContent = '';
      if (!state.selectedLead) return $('callMsg').textContent = 'Select a lead first (from Leads tab).';

      const outcome = $('callOutcome').value;
      if (!outcome) return $('callMsg').textContent = 'Pick an outcome.';

      try{
        const followup = String($('callFollowup').value || '').trim();
        await api('/api/portal/calls', {
          method: 'POST',
          body: {
            leadId: state.selectedLead.id,
            outcome,
            notes: $('callNotes').value,
            payload: followup ? { followup } : {},
          }
        });

        const nextStatus = $('callLeadStatus').value;
        if (nextStatus){
          await api('/api/portal/leads', { method:'PATCH', body: { id: state.selectedLead.id, status: nextStatus } });
        }

        if (followup) {
          const nextMeta = Object.assign({}, (state.selectedLead.meta && typeof state.selectedLead.meta === 'object') ? state.selectedLead.meta : {});
          nextMeta.followup = followup;
          await api('/api/portal/leads', { method:'PATCH', body: { id: state.selectedLead.id, meta: nextMeta } });
        }

        $('callMsg').textContent = '';
        setBadge('ok', 'saved');
        loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
      } catch(e){
        $('callMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function aiFollowup(){
      $('callMsg').textContent = '';
      $('followupBox').classList.add('hide');

      if (!state.selectedLead) return $('callMsg').textContent = 'Select a lead first (from Leads tab).';
      const outcome = $('callOutcome').value;

      setBadge('warn', 'thinking');
      try{
        const j = await api('/api/portal/ai/followup', {
          method: 'POST',
          body: {
            leadId: state.selectedLead.id,
            outcome,
            notes: $('callNotes').value,
          }
        });

        const fu = j.followup || {};
        $('fuSubject').value = fu.emailSubject || '';
        $('fuEmail').value = fu.emailBody || '';
        $('fuSms').value = fu.sms || '';
        $('fuNext').value = fu.nextStep || '';
        $('followupBox').classList.remove('hide');

        setBadge('ok', 'ready');
      } catch(e){
        $('callMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadEvents(){
      setBadge('warn', 'loading');
      $('eventsMsg').textContent = '';

      // Reset selection when reloading the list.
      setSelectedEvent(null);

      const status = $('eventStatus').value;
      const qs = new URLSearchParams();
      if (status) qs.set('status', status);
      qs.set('limit', '120');

      try{
        const j = await api('/api/portal/events?' + qs.toString());
        state.events = j.events || [];

        const tb = $('eventsTbody');
        if (!state.events.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No events yet.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = state.events.map((ev) => {
          const date = ev.event_date || '';
          const city = [ev.city, ev.state].filter(Boolean).join(', ');
          const asg = ev.assigned_role || '';
          const selectBtn = `<button class="btn secondary small" data-pick-event="${ev.id}">Select</button>`;

          const myRole = String(state.me?.profile?.role || '');
          const hasAssignments = !!(ev.meta && typeof ev.meta === 'object' && Array.isArray(ev.meta.assignments) && ev.meta.assignments.length);
          const canAccept = !hasAssignments && !ev.assigned_user_id && asg && (myRole === 'manager' || myRole === asg) && String(ev.status || 'open') === 'open';
          const acceptBtn = canAccept ? `<button class="btn small" data-accept-event="${ev.id}">Accept</button>` : '';

          return `
            <tr>
              <td><span class="badge">${ev.id}</span></td>
              <td class="muted">${date}</td>
              <td>${escapeHtml(ev.title || '')}</td>
              <td class="muted">${escapeHtml(city)}</td>
              <td><span class="badge">${escapeHtml(ev.status || '')}</span></td>
              <td class="muted">${asg}</td>
              <td>${selectBtn} ${acceptBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-pick-event]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.pickEvent);
            const ev = state.events.find((x) => Number(x.id) === id) || null;
            setSelectedEvent(ev);
          });
        }

        for (const btn of tb.querySelectorAll('button[data-accept-event]')){
          btn.addEventListener('click', async () => {
            $('eventsMsg').textContent = '';
            try{
              const id = Number(btn.dataset.acceptEvent);
              await api('/api/portal/events', {
                method: 'PATCH',
                body: { id, assignedUserId: state.me.user.id, status: 'assigned' },
              });
              await loadEvents();
            } catch(e){
              $('eventsMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('eventsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createEvent(){
      $('createEventMsg').textContent = '';
      try{
        const propertyName = String($('nePropertyName')?.value || '').trim();
        if (!propertyName) throw new Error('property_name_required');
        const address = String($('neAddress')?.value || '').trim();
        const title = String($('neTitle')?.value || '').trim() || propertyName;
        await api('/api/portal/events', {
          method: 'POST',
          body: {
            title,
            eventDate: $('neDate').value,
            address,
            city: $('neCity').value,
            state: $('neState').value,
            notes: $('neNotes').value,
            status: 'open',
            assignedRole: 'event_host',
            meta: {
              propertyName,
              propertyAddress: address,
              createdFrom: 'portal_new_event',
            }
          }
        });
        $('newEventBox').hidden = true;
        if ($('nePropertyName')) $('nePropertyName').value = '';
        if ($('neAddress')) $('neAddress').value = '';
        if ($('neTitle')) $('neTitle').value = '';
        if ($('neDate')) $('neDate').value = '';
        if ($('neCity')) $('neCity').value = '';
        if ($('neState')) $('neState').value = '';
        if ($('neNotes')) $('neNotes').value = '';
        await loadEvents();
      } catch(e){
        $('createEventMsg').textContent = String(e.message || e);
      }
    }

    async function loadPayouts(){
      setBadge('warn', 'loading');
      $('payoutsMsg').textContent = '';
      if ($('payoutsEmpty')) $('payoutsEmpty').textContent = '';
      try{
        const j = await api('/api/portal/payouts?limit=120');
        const payouts = j.payouts || [];
        if ($('payoutsEmpty')) $('payoutsEmpty').textContent = payouts.length ? '' : 'No payments yet.';
        if (!payouts.length) {
          $('payoutsTbody').innerHTML = '<tr><td colspan="4" class="muted">No payments yet.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }
        $('payoutsTbody').innerHTML = payouts.map((p) => `
          <tr>
            <td class="muted">${(p.created_at || '').slice(0,10)}</td>
            <td>${fmtMoney(p.amount_cents)}</td>
            <td><span class="badge">${p.status}</span></td>
            <td class="muted">${p.description || ''}</td>
          </tr>
        `).join('');
        setBadge('ok', 'loaded');
      } catch(e){
        $('payoutsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadDocs(){
      setBadge('warn', 'loading');
      $('docsMsg').textContent = '';
      try{
        const j = await api('/api/portal/docs?limit=80');
        const docs = j.docs || [];
        $('docsList').innerHTML = docs.map((d) => {
          const role = d.audience_role
            ? `<span class="badge">${escapeHtml(viewingLabel(d.audience_role))}</span>`
            : `<span class="badge ok">all</span>`;
          const content = (d.content || '').slice(0, 2000);
          return `
            <div class="card" style="background: #fff; margin-bottom:12px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between;">
                  <div style="font-weight:800;">${d.title}</div>
                  ${role}
                </div>
                <div style="height:10px"></div>
                <pre style="white-space:pre-wrap; margin:0; font-family: var(--mono); font-size:12px; color: var(--text);">${escapeHtml(content)}</pre>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted">No docs yet.</div>';
        setBadge('ok', 'loaded');
      } catch(e){
        $('docsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createDoc(){
      $('createDocMsg').textContent = '';
      try{
        await api('/api/portal/docs', {
          method: 'POST',
          body: {
            title: $('docTitle').value,
            audienceRole: $('docAudience').value,
            content: $('docContent').value,
            source: 'manual_paste',
            meta: { format: 'csv_or_text' }
          }
        });
        $('docTitle').value = '';
        $('docAudience').value = '';
        $('docContent').value = '';
        await loadDocs();
      } catch(e){
        $('createDocMsg').textContent = String(e.message || e);
      }
    }

    async function loadUsers(){
      $('usersMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/users');
        const users = (j.users || []);
        state.usersCache = users;
        $('usersTbody').innerHTML = users.map((u) => `
          <tr>
            <td>${u.fullName || ''}</td>
            <td class="muted">${u.email || ''}</td>
            <td><span class="badge">${escapeHtml(viewingLabel(u.role))}</span></td>
            <td class="muted" style="font-family:var(--mono); font-size:12px;">${u.userId}</td>
            <td><button class="btn secondary small" data-edit-user="${u.userId}">Edit</button></td>
          </tr>
        `).join('');

        for (const btn of $('usersTbody').querySelectorAll('button[data-edit-user]')){
          btn.addEventListener('click', async () => {
            $('usersMsg').textContent = '';
            try{
              const userId = String(btn.dataset.editUser || '').trim();
              const current = users.find((x) => String(x.userId) === userId);
              const nextRole = prompt('Workspace for person:', current?.role || '');
              if (nextRole == null) return;
              const nextName = prompt('Full name:', current?.fullName || '');
              if (nextName == null) return;
              await api('/api/portal/users', { method:'PATCH', body: { userId, role: nextRole, fullName: nextName } });
              await loadUsers();
              setBadge('ok', 'updated');
            } catch(e){
              $('usersMsg').textContent = String(e.message || e);
            }
          });
        }
        setBadge('ok', 'loaded');
      } catch(e){
        $('usersMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    function escapeHtml(s){
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function on(id, eventName, handler){
      const el = $(id);
      if (el) el.addEventListener(eventName, handler);
    }

    async function boot(){
      $('authMsg').textContent = '';
      $('authOk').textContent = '';

      restoreUiPrefs();

      // Restore prior session token if present.
      state.token = localStorage.getItem('portal_access_token') || '';
      await refreshMe();
      renderDialerSubtab();
      renderCloserSubtab();
      renderMeetingsSubtab();
    }

    on('loginBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      setAuthLoading(true, 'Signing in…');
      try{
        const email = $('email').value.trim();
        const password = $('password').value;

        const r = await withTimeout(fetch('/api/portal/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        }), 15000, 'login_timeout');

        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          throw new Error(det ? (msg + ': ' + det) : msg);
        }

        const token = String(j?.session?.access_token || '').trim();
        if (!token) throw new Error('login_failed');

        state.token = token;
        localStorage.setItem('portal_access_token', token);

        setAuthLoading(false);
        $('authOk').textContent = 'Signed in.';
        await refreshMe();
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      } finally {
        setAuthLoading(false);
      }
    });

    on('signupBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      setAuthLoading(true, 'Creating account…');
      try{
        const email = $('email').value.trim();
        const password = $('password').value;

        const r = await withTimeout(fetch('/api/portal/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        }), 15000, 'signup_timeout');

        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          throw new Error(det ? (msg + ': ' + det) : msg);
        }

        const token = String(j?.session?.access_token || '').trim();
        if (!token) throw new Error('signup_failed');

        state.token = token;
        localStorage.setItem('portal_access_token', token);

        setAuthLoading(false);
        $('authOk').textContent = 'Account created.';
        await refreshMe();
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      } finally {
        setAuthLoading(false);
      }
    });


    on('logoutBtn', 'click', async () => {
      state.token = '';
      localStorage.removeItem('portal_access_token');
      await refreshMe();
    });

    on('refreshBtn', 'click', () => refreshMe().catch(() => {}));

    on('loadLeadsBtn', 'click', () => loadLeads().catch(() => {}));
    on('leadStatus', 'change', () => renderLeadsTable());
    on('newLeadToggle', 'click', () => { $('newLeadBox').hidden = !$('newLeadBox').hidden; });
    on('createLeadBtn', 'click', () => createLead().catch(() => {}));
    on('pullLeadsToggle', 'click', () => { $('pullLeadsBox').hidden = !$('pullLeadsBox').hidden; });
    on('pullLeadsBtn', 'click', () => pullLeads().catch(() => {}));

    on('closerPickLead', 'click', () => { state.pickLeadReturnTab = 'closer'; setTab('leads'); });
    on('pickFromLeads', 'click', () => { state.pickLeadReturnTab = 'calls'; setTab('leads'); });
    on('logCallBtn', 'click', () => logCall().catch(() => {}));
    on('aiFollowupBtn', 'click', () => aiFollowup().catch(() => {}));

    on('loadQueueBtn', 'click', () => loadQueue().catch(() => {}));
    on('loadDialerTimelineBtn', 'click', () => loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(() => {}));

    on('dialerSegCall', 'click', () => setDialerSubtab('call'));
    on('dialerSegActivity', 'click', () => setDialerSubtab('activity'));
    on('dialerSegBooked', 'click', () => setDialerSubtab('booked'));
    on('dialerSegTasks', 'click', () => setDialerSubtab('tasks'));
    on('dialerBookedRefreshBtn', 'click', () => loadDialerBooked().catch(() => {}));
    on('dialerBookedScheduleBtn', 'click', () => scheduleDialerBooked().catch(() => {}));

    on('loadEventsBtn', 'click', () => loadEvents().catch(() => {}));
    on('newEventToggle', 'click', () => { $('newEventBox').hidden = !$('newEventBox').hidden; });
    on('createEventBtn', 'click', () => createEvent().catch(() => {}));
    on('createFollowupsBtn', 'click', () => createFollowups().catch(() => {}));
    on('addHostBtn', 'click', () => addAssignment('event_host').catch(() => {}));
    on('addMediaBtn', 'click', () => addAssignment('media_team').catch(() => {}));
    on('saveChecklistBtn', 'click', () => saveChecklist().catch(() => {}));
    on('savePlanBtn', 'click', () => savePlan().catch(() => {}));
    on('saveBudgetBtn', 'click', () => saveBudget().catch(() => {}));
    on('importVendorsBtn', 'click', () => importVendors().catch(() => {}));
    on('importEventTypesBtn', 'click', () => importEventTypes().catch(() => {}));
    on('loadVendorsBtn', 'click', () => loadVendors().catch(() => {}));
    on('suggestVendorsBtn', 'click', () => suggestVendorsForSelected());
    on('loadEventTypesBtn', 'click', () => loadEventTypes().catch(() => {}));

    on('feedbackEnableBtn', 'click', () => enableOrRegenerateFeedbackLink().catch(() => {}));
    on('feedbackCopyBtn', 'click', () => copyFeedbackLink().catch(() => {}));
    on('feedbackOpenBtn', 'click', () => openFeedbackLink());
    on('feedbackAddQBtn', 'click', () => {
      if (!coordinatorOpsEditable()) return;
      addFeedbackQuestionRow(null, { type: 'long_text', label: '' }, { editable: true });
    });
    on('feedbackSaveBtn', 'click', () => saveFeedbackForm().catch(() => {}));
    on('feedbackLoadSummaryBtn', 'click', () => loadFeedbackSummary().catch(() => {}));

    on('talentSaveBtn', 'click', () => saveTalentProfile().catch(() => {}));
    on('talentRefreshBtn', 'click', async () => {
      await loadTalentProfilesCache({ force: true }).catch(() => {});
      await loadTalentTab().catch(() => {});
    });
    on('talentStopEditingBtn', 'click', () => stopTalentEditing());
    on('talentQ', 'input', () => {
      if (!talentIsCoordinator()) return;
      if (state.talent.qTimer) clearTimeout(state.talent.qTimer);
      state.talent.qTimer = setTimeout(() => {
        rerenderTalentDirectoryFromCache().catch(() => {});
      }, 120);
    });

    on('closeSubmitBtn', 'click', () => submitClose().catch(() => {}));
    on('closeQuoteBtn', 'click', () => fillTierPrice());

    on('loadApptsBtn', 'click', () => loadAppointments().catch(() => {}));
    on('scheduleApptBtn', 'click', () => scheduleAppointment().catch(() => {}));
    on('meetingsRefreshBtn', 'click', () => loadAppointmentsInto('meetingsTbody', 'meetingsMsg').catch(() => {}));
    on('meetingScheduleBtn', 'click', () => scheduleMeeting().catch(() => {}));

    on('meetingsSegList', 'click', () => setMeetingsSubtab('list'));
    on('meetingsSegAvailability', 'click', () => setMeetingsSubtab('availability'));

    on('availSaveBtn', 'click', () => saveAvailability().catch(() => {}));
    on('availPrevWeek', 'click', () => { ensureAvailInit(); state.availability.weekOffset -= 1; renderAvailWeekGrid(); });
    on('availNextWeek', 'click', () => { ensureAvailInit(); state.availability.weekOffset += 1; renderAvailWeekGrid(); });
    on('availToday', 'click', () => { ensureAvailInit(); state.availability.weekOffset = 0; renderAvailWeekGrid(); });
    on('availClearWeek', 'click', () => {
      if (!availabilityEditable()) return;
      ensureAvailInit();
      const week = weekDates().map(ymd);
      for (const d of week) {
        if (state.availability.byDate && typeof state.availability.byDate === 'object') delete state.availability.byDate[d];
      }
      renderAvailWeekGrid();
    });

    on('accountsRefreshBtn', 'click', () => loadAccounts().catch(() => {}));
    on('accountsNewToggle', 'click', () => { const b = $('accountsNewBox'); if (b) b.hidden = !b.hidden; });
    on('accountsCreateBtn', 'click', () => createAccount().catch(() => {}));
    on('acctSaveBtn', 'click', () => saveAccount().catch(() => {}));
    on('acctDeleteBtn', 'click', () => deleteAccount().catch(() => {}));
    on('sentimentAddBtn', 'click', () => addSentiment().catch(() => {}));
    on('issueAddBtn', 'click', () => addIssue().catch(() => {}));
    on('tplSaveBtn', 'click', () => saveTemplate().catch(() => {}));
    on('accountsExpiring', 'change', () => loadAccounts().catch(() => {}));
    on('accountsQ', 'input', () => {
      ensureAccountsInit();
      if (state.accounts.qTimer) clearTimeout(state.accounts.qTimer);
      state.accounts.qTimer = setTimeout(() => {
        // Filter locally and refresh server list occasionally.
        renderAccounts();
      }, 120);
    });

    on('acctStart', 'change', () => syncNewAccountDerived());
    on('acctTermMonths', 'input', () => syncNewAccountDerived());
    on('acctEnd', 'change', () => syncNewAccountDerived());

    on('acctEditStart', 'change', () => syncEditAccountDerived());
    on('acctEditTermMonths', 'input', () => syncEditAccountDerived());
    on('acctEditEnd', 'change', () => syncEditAccountDerived());
    on('acctEditReminderDays', 'input', () => syncEditAccountDerived());

    on('closerSegDisposition', 'click', () => setCloserSubtab('disposition'));
    on('closerSegPipeline', 'click', () => setCloserSubtab('pipeline'));

    on('sidebarToggle', 'click', () => setSidebarCollapsed(!state.ui.sidebarCollapsed));

    on('loadCloserQueueBtn', 'click', () => loadCloserQueue().catch(() => {}));

    on('submitRecapBtn', 'click', () => submitRecap().catch(() => {}));
    on('closeRecapBtn', 'click', () => setSelectedEvent(null));

    on('pipelineClose', 'click', () => closePipelineModal());
    on('pipelinePrev', 'click', () => selectPipelineIdx(Number(pipelineModalState.idx || 0) - 1));
    on('pipelineNext', 'click', () => selectPipelineIdx(Number(pipelineModalState.idx || 0) + 1));
    on('pipelineOpenLead', 'click', async () => {
      const items = pipelineModalState.leads || [];
      const idx = Number(pipelineModalState.idx || 0);
      const l = items[idx];
      if (!l || !l.id) return;
      state.selectedLead = l;
      setSelectedLeadLine();
      closePipelineModal();
      if (pipelineModalState.context === 'closer') {
        setTab('closer');
        setCloserSubtab('disposition');
      } else {
        setTab('leads');
      }
      await loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
      await loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
    });

    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape') {
        const m = $('pipelineModal');
        if (m && m.classList.contains('show')) closePipelineModal();
      }
    });

    on('pipelineModal', 'click', (ev) => {
      const m = $('pipelineModal');
      if (!m) return;
      if (ev.target === m) closePipelineModal();
    });

    on('loadPayoutsBtn', 'click', () => loadPayouts().catch(() => {}));

    on('loadUsersBtn', 'click', () => loadUsers().catch(() => {}));

    on('leadDetailRefreshBtn', 'click', () => loadTimelineInto('timelineList', 'timelineMsg').catch(() => {}));
    on('leadSaveBtn', 'click', () => saveLeadEdits().catch(() => {}));
    on('timelineAddBtn', 'click', () => addTimelineNote('timelineNote', 'timelineAddMsg', 'timelineList').catch(() => {}));

    on('loadStatsBtn', 'click', () => loadStats().catch(() => {}));
    on('mgrAssignBtn', 'click', () => managerAssignLead().catch(() => {}));
    on('loadTeamAvailBtn', 'click', () => loadTeamAvailability().catch(() => {}));

    on('loadDispatchBtn', 'click', () => loadDispatchManager().catch(() => {}));
    on('scanDispatchBtn', 'click', () => scanDispatchOverdue().catch(() => {}));
    on('dispatchCreateBtn', 'click', () => createDispatchTask().catch(() => {}));

    on('loadDialerTasksBtn', 'click', () => loadDispatchInto('dialerTasksTbody', 'dialerTasksMsg', { overdueOnly: !!$('dialerTasksOverdue')?.checked, scope: String($('dialerTasksScope')?.value || 'role') }).catch(() => {}));
    // Closer Dispatch removed from Sales.

    boot().catch((e) => {
      $('authMsg').textContent = String(e.message || e);
    });
  </script>
</body>
</html>
