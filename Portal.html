<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PureStay Portal</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- deploy: 2026-02-24T00:00:00Z -->
  <link rel="icon" href="brand/purestay_exact_SVG.svg" type="image/svg+xml">

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;800&family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0e0d0c;
      --bg:#ffffff;
      --muted:#6b6460;
      --border:#e7e1da;
      --card:#ffffff;
      --shadow:0 14px 38px rgba(0,0,0,.10);
      --radius: 16px;

      --maroon:#7A2E26;
      --maroon-700:#66271f;
      --gold:#C79A3B;
      --gold-700:#B78A2F;
      --ring:rgba(199,154,59,.38);

      --ok:#0f766e;
      --warn:#b45309;
      --bad:#b42318;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #f7f4f0;
      color:var(--ink);
      min-height:100vh;
    }
    a{color:var(--maroon); text-decoration:none}
    a:hover{text-decoration:underline}

    .hide{display:none !important;}

    .auth{
      min-height: 100vh;
      display:grid;
      place-items:center;
      padding: 28px 16px;
    }

    .authCard{
      width: min(880px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
    }

    .authTop{display:flex; align-items:center; gap:14px;}
    .authTop img{height:52px; width:auto; display:block;}
    .authTop h1{margin:0; font-family: Fraunces, ui-serif, Georgia, serif; font-weight:800; font-size:26px; letter-spacing:.2px;}
    .authTop .sub{color:var(--muted); font-size:13px; margin-top:2px;}

    .pill{font-family: var(--mono); font-size:12px; color:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#fff;}

    .btn{
      appearance:none;
      border: 1px solid transparent;
      background: var(--maroon);
      color: #fff;
      padding: 11px 14px;
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 18px 44px rgba(122,46,38,.18); background: var(--maroon-700);}
    .btn:focus-visible{outline:none; box-shadow: 0 0 0 3px var(--ring);}
    .btn.secondary{
      background: #fff;
      border-color: var(--border);
      color: var(--maroon);
      box-shadow: none;
    }
    .btn.secondary:hover{transform:none; box-shadow:none; background:#fff; border-color: rgba(199,154,59,.55)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .container{max-width: 1180px; margin:0 auto; padding: 18px 18px;}

    .appbar{
      position: sticky;
      top:0;
      z-index: 10;
      background: rgba(255,255,255,.88);
      backdrop-filter: saturate(180%) blur(10px);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .appbarInner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding: 10px 18px; max-width:1180px; margin:0 auto;}
    .appbrand{display:flex; align-items:center; gap:12px;}
    .appbrand img{height:46px; width:auto; display:block;}
    .appbrand .t{font-weight: 900; letter-spacing:.2px;}

    .layout{max-width:1180px; margin:0 auto; display:grid; grid-template-columns: 240px 1fr; gap: 16px; padding: 16px 18px 28px;}
    @media (max-width: 900px){ .layout{grid-template-columns: 1fr;} }

    .sidebar{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      height: fit-content;
    }

    .navTitle{font-size:12px; color:var(--muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; padding: 6px 8px 10px;}
    .navBtn{
      width: 100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      font-weight: 900;
      color: #3a2f2c;
      transition: background .15s ease, border-color .15s ease;
    }
    .navBtn:hover{background: rgba(199,154,59,.10); border-color: rgba(199,154,59,.22)}
    .navBtn.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .card .hd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .card .bd{padding:16px;}

    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      background: #fff;
      color: var(--ink);
      border:1px solid var(--border);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{box-shadow: 0 0 0 3px var(--ring); border-color: rgba(199,154,59,.55)}
    textarea{min-height: 120px; resize: vertical;}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .two{grid-template-columns:1fr;} }

    table{width:100%; border-collapse: collapse; font-size:13px;}
    th, td{padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:top;}
    th{color:var(--muted); font-weight:600; text-align:left; font-size:12px;}

    .badge{font-family: var(--mono); font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:#fff}
    .badge.ok{border-color: rgba(15,118,110,.25); color: rgba(15,118,110,1)}
    .badge.warn{border-color: rgba(180,83,9,.25); color: rgba(180,83,9,1)}

    .err{color: var(--bad); font-family: var(--mono); font-size:12px; white-space: pre-wrap;}
    .ok{color: var(--ok); font-family: var(--mono); font-size:12px; white-space: pre-wrap;}

    .small{font-size:12px;}
  </style>
</head>
<body>
  <div id="authView" class="auth">
    <div class="authCard">
      <div class="authTop">
        <img src="brand/purestay_exact_SVG.svg" alt="PureStay" />
        <div>
          <h1>Portal</h1>
          <div class="sub">Sign in to continue</div>
        </div>
      </div>

      <div style="height:16px"></div>
      <div class="two">
        <div>
          <label>Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="you@company.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row" style="justify-content:flex-start; gap:10px;">
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="signupBtn" class="btn secondary" type="button">Create account</button>
        <button id="seedBtn" class="btn secondary" type="button">Seed demo users</button>
      </div>
      <div style="height:12px"></div>
      <div id="authMsg" class="err"></div>
      <div id="authOk" class="ok"></div>
      <div id="seedMsg" class="ok"></div>
    </div>
  </div>

  <div id="appView" class="hide">
    <div class="appbar">
      <div class="appbarInner">
        <div class="appbrand">
          <img src="brand/purestay_exact_SVG.svg" alt="PureStay" />
          <div>
            <div class="t">Portal</div>
            <div class="muted small" id="roleLine">—</div>
          </div>
        </div>
        <div class="row">
          <div id="appUser" class="pill">—</div>
          <button id="logoutBtn" class="btn secondary">Logout</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <nav class="sidebar">
        <div class="navTitle">Menu</div>
        <div id="nav"></div>
      </nav>

      <main>
        <section class="card" id="appCard">
      <div class="hd">
        <h2 id="viewTitle">Overview</h2>
        <div class="row">
          <span class="badge" id="viewBadge">ready</span>
          <button id="refreshBtn" class="btn secondary hide">Refresh</button>
        </div>
      </div>
      <div class="bd">
        <div id="viewOverview">
          <div class="muted">Sign in to view your dashboard.</div>
        </div>

        <div id="viewLeads" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px;">
            <div class="row" style="flex: 1;">
              <input id="leadQ" placeholder="Search name, property, email, phone" style="max-width:420px" />
              <select id="leadStatus" style="max-width:200px">
                <option value="">All statuses</option>
                <option value="new">new</option>
                <option value="working">working</option>
                <option value="booked">booked</option>
                <option value="won">won</option>
                <option value="lost">lost</option>
              </select>
              <button id="loadLeadsBtn" class="btn secondary">Load</button>
            </div>
            <button id="newLeadToggle" class="btn secondary">New lead</button>
          </div>

          <div id="newLeadBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div class="two">
                <div><label>First name</label><input id="nlFirst" /></div>
                <div><label>Last name</label><input id="nlLast" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>Phone</label><input id="nlPhone" /></div>
                <div><label>Email</label><input id="nlEmail" type="email" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>Property / Community</label><input id="nlProp" /></div>
                <div><label>City, State</label><input id="nlCityState" placeholder="Raleigh, NC" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="nlNotes" placeholder="What did we learn? Any context for the next touch?"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createLeadBtn" class="btn">Create lead</button>
                <div id="createLeadMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="leadsMsg" class="err"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Property</th>
                  <th>City</th>
                  <th>Status</th>
                  <th>Assigned</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="leadsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewCalls" class="hide">
          <div class="card" style="background: #fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="selectedLeadLine" style="font-weight:700; margin-top:4px;">None</div>
                </div>
                <button id="pickFromLeads" class="btn secondary">Pick from Leads</button>
              </div>
              <div style="height:10px"></div>
              <div class="two">
                <div>
                  <label>Outcome</label>
                  <select id="callOutcome">
                    <option value="">Select…</option>
                    <option>no_answer</option>
                    <option>left_voicemail</option>
                    <option>not_interested</option>
                    <option>call_back</option>
                    <option>booked_meeting</option>
                    <option>qualified_handoff</option>
                  </select>
                </div>
                <div>
                  <label>Next status (optional)</label>
                  <select id="callLeadStatus">
                    <option value="">No change</option>
                    <option>working</option>
                    <option>booked</option>
                    <option>won</option>
                    <option>lost</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="callNotes" placeholder="Short, factual notes."></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="logCallBtn" class="btn">Log call</button>
                <button id="aiFollowupBtn" class="btn secondary">AI follow-up</button>
                <div id="callMsg" class="err"></div>
              </div>
              <div id="followupBox" class="card hide" style="margin-top:12px; background: #fff;">
                <div class="bd">
                  <div class="muted small">Generated follow-up</div>
                  <div style="height:8px"></div>
                  <div><label>Email subject</label><input id="fuSubject" /></div>
                  <div style="margin-top:10px;"><label>Email body</label><textarea id="fuEmail"></textarea></div>
                  <div style="margin-top:10px;"><label>SMS</label><textarea id="fuSms"></textarea></div>
                  <div style="margin-top:10px;"><label>Next step</label><input id="fuNext" /></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewEvents" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px;">
            <div class="row">
              <select id="eventStatus" style="max-width:220px">
                <option value="">All statuses</option>
                <option value="open">open</option>
                <option value="assigned">assigned</option>
                <option value="completed">completed</option>
                <option value="canceled">canceled</option>
              </select>
              <button id="loadEventsBtn" class="btn secondary">Load</button>
            </div>
            <button id="newEventToggle" class="btn secondary hide">New event</button>
          </div>

          <div id="newEventBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div class="two">
                <div><label>Title</label><input id="neTitle" placeholder="Property event" /></div>
                <div><label>Date</label><input id="neDate" type="date" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>City</label><input id="neCity" /></div>
                <div><label>State</label><input id="neState" placeholder="NC" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="neNotes"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createEventBtn" class="btn">Create event</button>
                <div id="createEventMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="eventsMsg" class="err"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th>Title</th>
                  <th>City</th>
                  <th>Status</th>
                  <th>Assigned</th>
                </tr>
              </thead>
              <tbody id="eventsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewPayments" class="hide">
          <div class="row" style="justify-content:space-between;">
            <button id="loadPayoutsBtn" class="btn secondary">Load</button>
          </div>
          <div style="height:14px"></div>
          <div id="payoutsMsg" class="err"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="payoutsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewDocs" class="hide">
          <div class="row" style="justify-content:space-between;">
            <button id="loadDocsBtn" class="btn secondary">Load</button>
          </div>
          <div id="docsAdmin" class="card hide" style="margin-top:14px; background: #fff;">
            <div class="bd">
              <div class="two">
                <div><label>Title</label><input id="docTitle" placeholder="Event Coordinator SOP" /></div>
                <div><label>Audience role (blank = all)</label><input id="docAudience" placeholder="event_coordinator" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>CSV or text content</label>
                <textarea id="docContent" placeholder="Paste CSV here…"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createDocBtn" class="btn">Save doc</button>
                <div id="createDocMsg" class="err"></div>
              </div>
            </div>
          </div>
          <div style="height:14px"></div>
          <div id="docsMsg" class="err"></div>
          <div id="docsList"></div>
        </div>

        <div id="viewManager" class="hide">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="muted small">Manager view</div>
              <div style="font-weight:700; margin-top:4px;">Role access matrix + users</div>
            </div>
            <div class="row">
              <button id="loadUsersBtn" class="btn secondary">Load users</button>
            </div>
          </div>
          <div style="height:12px"></div>
          <div class="card" style="background: #fff;">
            <div class="bd">
              <table>
                <thead>
                  <tr>
                    <th>Role</th>
                    <th>Can see</th>
                  </tr>
                </thead>
                <tbody id="roleMatrix"></tbody>
              </table>
            </div>
          </div>
          <div style="height:14px"></div>
          <div id="usersMsg" class="err"></div>
          <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>User ID</th>
                </tr>
              </thead>
              <tbody id="usersTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const ROLE_MATRIX = [
      { role: 'dialer', canSee: 'Leads assigned to dialer, log call outcomes, AI follow-up' },
      { role: 'in_person_setter', canSee: 'Leads assigned to in_person_setter, log outcomes, follow-ups' },
      { role: 'remote_setter', canSee: 'Leads assigned to remote_setter, log outcomes, follow-ups' },
      { role: 'closer', canSee: 'Leads assigned to closer, AI research, closing workflows' },
      { role: 'event_host', canSee: 'Assigned events and submit recaps' },
      { role: 'media_team', canSee: 'Assigned events + media/recap submissions' },
      { role: 'account_manager', canSee: 'Leads assigned to account_manager + AI research' },
      { role: 'event_coordinator', canSee: 'Create/dispatch events + manage assignments' },
      { role: 'manager', canSee: 'Everything' },
    ];

    const state = {
      token: '',
      me: null,
      activeTab: 'overview',
      leads: [],
      selectedLead: null,
    };

    function setBadge(kind, text){
      const b = $('viewBadge');
      b.textContent = text;
      b.className = 'badge ' + (kind || '');
    }

    function setTab(tab){
      state.activeTab = tab;
      const title = {
        overview: 'Overview',
        leads: 'Leads',
        calls: 'Calls',
        events: 'Events',
        payments: 'Payments',
        docs: 'Docs',
        manager: 'Manager'
      }[tab] || 'Overview';
      $('viewTitle').textContent = title;

      const views = ['Overview','Leads','Calls','Events','Payments','Docs','Manager'];
      for (const v of views) $('view'+v).classList.add('hide');
      $('view' + title).classList.remove('hide');

      for (const el of document.querySelectorAll('.navBtn')) el.classList.toggle('active', el.dataset.tab === tab);

      if (tab === 'leads') loadLeads().catch(()=>{});
      if (tab === 'events') loadEvents().catch(()=>{});
    }

    function showAuthView(message){
      $('authView').classList.remove('hide');
      $('appView').classList.add('hide');
      $('authMsg').textContent = message || '';
      const ok = $('authOk');
      if (ok) ok.textContent = '';
    }

    function showAppView(){
      $('authView').classList.add('hide');
      $('appView').classList.remove('hide');
    }

    async function api(path, { method='GET', body=null } = {}){
      const token = String(state.token || '').trim();
      if (!token) throw new Error('not_signed_in');

      const r = await fetch(path, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token,
        },
        body: body ? JSON.stringify(body) : undefined,
      });
      const j = await r.json().catch(() => null);
      if (!j || !j.ok) throw new Error(j?.error || ('http_' + r.status));
      return j;
    }

    async function refreshMe(){
      const token = String(state.token || '').trim();
      if (!token){
        state.me = null;
        showAuthView('');
        setTab('overview');
        return;
      }

      let me = null;
      try {
        me = await api('/api/portal/me');
        state.me = me;
      } catch (e) {
        // Token likely expired or invalid
        state.token = '';
        localStorage.removeItem('portal_access_token');
        state.me = null;
        showAuthView('Session expired. Please sign in again.');
        return;
      }

      showAppView();

  me = state.me;
      $('roleLine').textContent = me.profile.role;
      $('appUser').textContent = me.user.email;

      const navItems = [
        { id:'overview', label:'Overview' },
        { id:'leads', label:'Leads' },
        { id:'calls', label:'Calls' },
        { id:'events', label:'Events' },
        { id:'payments', label:'Payments' },
        { id:'docs', label:'Docs' },
      ];
      if (me.profile.role === 'manager') navItems.push({ id:'manager', label:'Manager' });

      $('nav').innerHTML = navItems
        .map((t) => `<button class="navBtn" type="button" data-tab="${t.id}">${t.label}</button>`)
        .join('');

      for (const el of document.querySelectorAll('.navBtn')){
        el.addEventListener('click', () => setTab(el.dataset.tab));
      }

      // Manager-only controls
      $('docsAdmin').classList.toggle('hide', me.profile.role !== 'manager');
      $('newEventToggle').classList.toggle('hide', !(me.profile.role === 'manager' || me.profile.role === 'event_coordinator'));

      // Overview
      $('viewOverview').innerHTML = `
        <div class="row" style="justify-content:space-between; gap:16px;">
          <div>
            <div class="muted small">Signed in</div>
            <div style="font-weight:900; margin-top:4px;">${me.user.email}</div>
          </div>
          <div>
            <div class="muted small">Role</div>
            <div style="margin-top:4px;"><span class="badge ok">${me.profile.role}</span></div>
          </div>
        </div>
      `;

      // Populate manager role matrix
      const rm = $('roleMatrix');
      rm.innerHTML = ROLE_MATRIX.map((r) => `<tr><td><span class="badge">${r.role}</span></td><td>${r.canSee}</td></tr>`).join('');

      setTab(state.activeTab || 'overview');
    }

    function fmtMoney(cents){
      const n = Number(cents || 0) / 100;
      return n.toLocaleString(undefined, { style:'currency', currency:'USD' });
    }

    async function loadLeads(){
      setBadge('warn', 'loading');
      $('leadsMsg').textContent = '';

      const q = $('leadQ').value.trim();
      const status = $('leadStatus').value;
      const qs = new URLSearchParams();
      if (q) qs.set('q', q);
      if (status) qs.set('status', status);
      qs.set('limit', '120');

      try{
        const j = await api('/api/portal/leads?' + qs.toString());
        state.leads = j.leads || [];

        const tb = $('leadsTbody');
        tb.innerHTML = state.leads.map((l) => {
          const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
          const prop = l.property_name || l.company || '';
          const city = [l.city, l.state].filter(Boolean).join(', ');
          const asg = l.assigned_role || '';
          return `
            <tr>
              <td><span class="badge">${l.id}</span></td>
              <td>${name}</td>
              <td>${prop}</td>
              <td class="muted">${city}</td>
              <td><span class="badge">${l.status}</span></td>
              <td class="muted">${asg}</td>
              <td><button class="btn secondary small" data-pick="${l.id}">Select</button></td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-pick]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.pick);
            state.selectedLead = state.leads.find((x) => Number(x.id) === id) || null;
            $('selectedLeadLine').textContent = state.selectedLead
              ? `#${state.selectedLead.id} • ${(state.selectedLead.first_name||'').trim()} ${(state.selectedLead.last_name||'').trim()}`.trim()
              : 'None';
            setTab('calls');
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('leadsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createLead(){
      $('createLeadMsg').textContent = '';
      const cityState = $('nlCityState').value.trim();
      let city = cityState, st = '';
      if (cityState.includes(',')){
        const parts = cityState.split(',');
        city = (parts[0] || '').trim();
        st = (parts[1] || '').trim();
      }

      try{
        await api('/api/portal/leads', {
          method: 'POST',
          body: {
            firstName: $('nlFirst').value,
            lastName: $('nlLast').value,
            phone: $('nlPhone').value,
            email: $('nlEmail').value,
            propertyName: $('nlProp').value,
            city,
            state: st,
            notes: $('nlNotes').value,
            status: 'new',
          }
        });
        $('newLeadBox').hidden = true;
        await loadLeads();
      } catch(e){
        $('createLeadMsg').textContent = String(e.message || e);
      }
    }

    async function logCall(){
      $('callMsg').textContent = '';
      if (!state.selectedLead) return $('callMsg').textContent = 'Select a lead first (from Leads tab).';

      const outcome = $('callOutcome').value;
      if (!outcome) return $('callMsg').textContent = 'Pick an outcome.';

      try{
        await api('/api/portal/calls', {
          method: 'POST',
          body: {
            leadId: state.selectedLead.id,
            outcome,
            notes: $('callNotes').value,
          }
        });

        const nextStatus = $('callLeadStatus').value;
        if (nextStatus){
          await api('/api/portal/leads', { method:'PATCH', body: { id: state.selectedLead.id, status: nextStatus } });
        }

        $('callMsg').textContent = '';
        setBadge('ok', 'saved');
      } catch(e){
        $('callMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function aiFollowup(){
      $('callMsg').textContent = '';
      $('followupBox').classList.add('hide');

      if (!state.selectedLead) return $('callMsg').textContent = 'Select a lead first (from Leads tab).';
      const outcome = $('callOutcome').value;

      setBadge('warn', 'thinking');
      try{
        const j = await api('/api/portal/ai/followup', {
          method: 'POST',
          body: {
            leadId: state.selectedLead.id,
            outcome,
            notes: $('callNotes').value,
          }
        });

        const fu = j.followup || {};
        $('fuSubject').value = fu.emailSubject || '';
        $('fuEmail').value = fu.emailBody || '';
        $('fuSms').value = fu.sms || '';
        $('fuNext').value = fu.nextStep || '';
        $('followupBox').classList.remove('hide');

        setBadge('ok', 'ready');
      } catch(e){
        $('callMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadEvents(){
      setBadge('warn', 'loading');
      $('eventsMsg').textContent = '';
      const status = $('eventStatus').value;
      const qs = new URLSearchParams();
      if (status) qs.set('status', status);
      qs.set('limit', '120');

      try{
        const j = await api('/api/portal/events?' + qs.toString());
        const events = j.events || [];

        $('eventsTbody').innerHTML = events.map((ev) => {
          const date = ev.event_date || '';
          const city = [ev.city, ev.state].filter(Boolean).join(', ');
          const asg = ev.assigned_role || '';
          return `
            <tr>
              <td><span class="badge">${ev.id}</span></td>
              <td class="muted">${date}</td>
              <td>${ev.title || ''}</td>
              <td class="muted">${city}</td>
              <td><span class="badge">${ev.status}</span></td>
              <td class="muted">${asg}</td>
            </tr>
          `;
        }).join('');

        setBadge('ok', 'loaded');
      } catch(e){
        $('eventsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createEvent(){
      $('createEventMsg').textContent = '';
      try{
        await api('/api/portal/events', {
          method: 'POST',
          body: {
            title: $('neTitle').value,
            eventDate: $('neDate').value,
            city: $('neCity').value,
            state: $('neState').value,
            notes: $('neNotes').value,
            status: 'open',
            assignedRole: 'event_host',
          }
        });
        $('newEventBox').hidden = true;
        await loadEvents();
      } catch(e){
        $('createEventMsg').textContent = String(e.message || e);
      }
    }

    async function loadPayouts(){
      setBadge('warn', 'loading');
      $('payoutsMsg').textContent = '';
      try{
        const j = await api('/api/portal/payouts?limit=120');
        const payouts = j.payouts || [];
        $('payoutsTbody').innerHTML = payouts.map((p) => `
          <tr>
            <td class="muted">${(p.created_at || '').slice(0,10)}</td>
            <td>${fmtMoney(p.amount_cents)}</td>
            <td><span class="badge">${p.status}</span></td>
            <td class="muted">${p.description || ''}</td>
          </tr>
        `).join('');
        setBadge('ok', 'loaded');
      } catch(e){
        $('payoutsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadDocs(){
      setBadge('warn', 'loading');
      $('docsMsg').textContent = '';
      try{
        const j = await api('/api/portal/docs?limit=80');
        const docs = j.docs || [];
        $('docsList').innerHTML = docs.map((d) => {
          const role = d.audience_role ? `<span class="badge">${d.audience_role}</span>` : `<span class="badge ok">all</span>`;
          const content = (d.content || '').slice(0, 2000);
          return `
            <div class="card" style="background: #fff; margin-bottom:12px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between;">
                  <div style="font-weight:800;">${d.title}</div>
                  ${role}
                </div>
                <div style="height:10px"></div>
                <pre style="white-space:pre-wrap; margin:0; font-family: var(--mono); font-size:12px; color: var(--text);">${escapeHtml(content)}</pre>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted">No docs yet.</div>';
        setBadge('ok', 'loaded');
      } catch(e){
        $('docsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createDoc(){
      $('createDocMsg').textContent = '';
      try{
        await api('/api/portal/docs', {
          method: 'POST',
          body: {
            title: $('docTitle').value,
            audienceRole: $('docAudience').value,
            content: $('docContent').value,
            source: 'manual_paste',
            meta: { format: 'csv_or_text' }
          }
        });
        $('docTitle').value = '';
        $('docAudience').value = '';
        $('docContent').value = '';
        await loadDocs();
      } catch(e){
        $('createDocMsg').textContent = String(e.message || e);
      }
    }

    async function loadUsers(){
      $('usersMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/users');
        $('usersTbody').innerHTML = (j.users || []).map((u) => `
          <tr>
            <td>${u.fullName || ''}</td>
            <td class="muted">${u.email || ''}</td>
            <td><span class="badge">${u.role}</span></td>
            <td class="muted" style="font-family:var(--mono); font-size:12px;">${u.userId}</td>
          </tr>
        `).join('');
        setBadge('ok', 'loaded');
      } catch(e){
        $('usersMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    function escapeHtml(s){
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function on(id, eventName, handler){
      const el = $(id);
      if (el) el.addEventListener(eventName, handler);
    }

    async function boot(){
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      $('seedMsg').textContent = '';

      // Restore prior session token if present.
      state.token = localStorage.getItem('portal_access_token') || '';
      await refreshMe();
    }

    on('loginBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      $('seedMsg').textContent = '';
      try{
        const email = $('email').value.trim();
        const password = $('password').value;

        const r = await fetch('/api/portal/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          throw new Error(det ? (msg + ': ' + det) : msg);
        }

        const token = String(j?.session?.access_token || '').trim();
        if (!token) throw new Error('login_failed');

        state.token = token;
        localStorage.setItem('portal_access_token', token);

        $('authOk').textContent = 'Signed in.';
        await refreshMe();
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      }
    });

    on('signupBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      $('seedMsg').textContent = '';
      try{
        const email = $('email').value.trim();
        const password = $('password').value;

        const r = await fetch('/api/portal/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          throw new Error(det ? (msg + ': ' + det) : msg);
        }

        const token = String(j?.session?.access_token || '').trim();
        if (!token) throw new Error('signup_failed');

        state.token = token;
        localStorage.setItem('portal_access_token', token);

        $('authOk').textContent = 'Account created.';
        await refreshMe();
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      }
    });

    function renderSeedResult(j){
      const users = Array.isArray(j?.users) ? j.users : [];
      const lines = [];
      lines.push(j?.ok ? 'Seed complete.' : 'Seed failed.');
      if (typeof j?.bootstrap !== 'undefined') lines.push('bootstrap=' + String(!!j.bootstrap));
      for (const u of users) {
        const status = u?.ok ? 'ok' : ('error: ' + String(u?.error || 'unknown'));
        const detail = String(u?.detail || '').trim();
        lines.push(`${u?.role || ''} ${u?.email || ''} ${status}${detail ? (' (' + detail + ')') : ''}`.trim());
      }
      return lines.join('\n');
    }

    on('seedBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      $('seedMsg').textContent = '';
      try{
        const email = $('email').value.trim();
        const password = $('password').value;
        const r = await fetch('/api/portal/seed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const j = await r.json().catch(() => null);
        if (!j) throw new Error('seed_failed');
        if (!j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          if (msg === 'missing_bearer_token') throw new Error('Sign in as manager to seed.');
          throw new Error(det ? (msg + ': ' + det) : msg);
        }
        $('seedMsg').textContent = renderSeedResult(j);
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      }
    });

    on('logoutBtn', 'click', async () => {
      state.token = '';
      localStorage.removeItem('portal_access_token');
      await refreshMe();
    });

    on('refreshBtn', 'click', () => refreshMe().catch(() => {}));

    on('loadLeadsBtn', 'click', () => loadLeads().catch(() => {}));
    on('newLeadToggle', 'click', () => { $('newLeadBox').hidden = !$('newLeadBox').hidden; });
    on('createLeadBtn', 'click', () => createLead().catch(() => {}));

    on('pickFromLeads', 'click', () => setTab('leads'));
    on('logCallBtn', 'click', () => logCall().catch(() => {}));
    on('aiFollowupBtn', 'click', () => aiFollowup().catch(() => {}));

    on('loadEventsBtn', 'click', () => loadEvents().catch(() => {}));
    on('newEventToggle', 'click', () => { $('newEventBox').hidden = !$('newEventBox').hidden; });
    on('createEventBtn', 'click', () => createEvent().catch(() => {}));

    on('loadPayoutsBtn', 'click', () => loadPayouts().catch(() => {}));

    on('loadDocsBtn', 'click', () => loadDocs().catch(() => {}));
    on('createDocBtn', 'click', () => createDoc().catch(() => {}));

    on('loadUsersBtn', 'click', () => loadUsers().catch(() => {}));

    boot().catch((e) => {
      $('authMsg').textContent = String(e.message || e);
    });
  </script>
</body>
</html>
