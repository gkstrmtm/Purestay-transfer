<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PureStay Portal</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- deploy: 2026-02-24T00:00:00Z -->
  <link rel="icon" href="brand/purestay_exact_SVG.svg" type="image/svg+xml">

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;800&family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{
      --ink:#0e0d0c;
      --bg:#ffffff;
      --muted:#6b6460;
      --border:#e7e1da;
      --card:#ffffff;
      --shadow:0 14px 38px rgba(0,0,0,.10);
      --radius: 16px;

      --maroon:#7A2E26;
      --maroon-700:#66271f;
      --gold:#C79A3B;
      --gold-700:#B78A2F;
      --ring:rgba(199,154,59,.38);

      --ok:#0f766e;
      --warn:#b45309;
      --bad:#b42318;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #f7f4f0;
      color:var(--ink);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:var(--maroon); text-decoration:none}
    a:hover{text-decoration:underline}

    .hide{display:none !important;}

    .auth{
      min-height: 100vh;
      display:grid;
      place-items:center;
      padding: 28px 16px;
    }

    .authCard{
      width: min(880px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
    }

    .authTop{display:flex; align-items:center; gap:14px;}
    .authTop img{height:52px; width:auto; display:block;}
    .authTop h1{margin:0; font-family: Fraunces, ui-serif, Georgia, serif; font-weight:800; font-size:26px; letter-spacing:.2px;}
    .authTop .sub{color:var(--muted); font-size:13px; margin-top:2px;}

    .pill{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:12px; font-weight:700; color:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#fff;}

    .btn{
      appearance:none;
      border: 1px solid transparent;
      background: var(--maroon);
      color: #fff;
      padding: 11px 14px;
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 18px 44px rgba(122,46,38,.18); background: var(--maroon-700);}
    .btn:focus-visible{outline:none; box-shadow: 0 0 0 3px var(--ring);}
    .btn.secondary{
      background: #fff;
      border-color: var(--border);
      color: var(--maroon);
      box-shadow: none;
    }
    .btn.secondary:hover{transform:none; box-shadow:none; background:#fff; border-color: rgba(199,154,59,.55)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .container{max-width: 1180px; margin:0 auto; padding: 18px 18px;}

    .appbar{
      position: sticky;
      top:0;
      z-index: 10;
      background: rgba(255,255,255,.88);
      backdrop-filter: saturate(180%) blur(10px);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .appbarInner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding: 10px 18px; max-width:none; margin:0;}
    .appbrand{display:flex; align-items:center; gap:12px;}
    .appbrand img{height:46px; width:auto; display:block;}
    .appbrand .t{font-weight: 900; letter-spacing:.2px;}

    .layout{max-width:none; margin:0; display:grid; grid-template-columns: 260px 1fr; gap: 0; padding: 0; width:100%;}
    @media (max-width: 900px){ .layout{grid-template-columns: 1fr;} }

    main{min-width:0; padding: 16px 18px 28px;}

    .sidebar{
      background:#fff;
      border-right:1px solid var(--border);
      padding: 14px 12px;
      position: sticky;
      top: 78px;
      height: calc(100vh - 78px);
      overflow:auto;
      min-width:0;
    }

    @media (max-width: 900px){
      .sidebar{position:relative; top:auto; height:auto; border-right:none; border-bottom:1px solid var(--border);}
    }

    .navTitle{font-size:12px; color:var(--muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; padding: 6px 8px 10px;}
    .navBtn{
      width: 100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      font-weight: 900;
      color: #3a2f2c;
      transition: background .15s ease, border-color .15s ease;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .navBtn:hover{background: rgba(199,154,59,.10); border-color: rgba(199,154,59,.22)}
    .navBtn.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}

    .navIco{width:22px; height:22px; border:1px solid var(--border); border-radius:8px; display:grid; place-items:center; font-size:12px; color:var(--muted); flex:0 0 auto; background:#fff;}
    .navLbl{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    @media (max-width: 900px){ main{padding: 16px 18px 28px;} }

    .iconBtn{appearance:none; border:1px solid var(--border); background:#fff; color: var(--maroon); border-radius: 12px; padding: 10px 12px; cursor:pointer; font-weight:900;}
    .iconBtn:hover{border-color: rgba(199,154,59,.55)}

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:visible;
    }
    .card .hd{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .card .hd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .card .bd{padding:16px;}

    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      background: #fff;
      color: var(--ink);
      border:1px solid var(--border);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    select{
      appearance:none;
      padding-right: 38px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%236b6460' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 14px 14px;
    }
    input:focus, select:focus, textarea:focus{box-shadow: 0 0 0 3px var(--ring); border-color: rgba(199,154,59,.55)}
    textarea{min-height: 120px; resize: vertical;}

    /* Talent editor: make locked/read-only fields look like display text (not disabled form controls). */
    .talAsText{background: transparent !important; border-color: transparent !important; box-shadow:none !important; padding-left:0 !important; padding-right:0 !important; color:#3a2f2c !important; background-image:none !important; appearance:none !important;}
    textarea.talAsText{padding-top:0 !important; padding-bottom:0 !important; min-height: 0 !important; height:auto !important;}
    .scrollBox{scrollbar-gutter: stable;}
    .scrollY{overflow:auto; scrollbar-gutter: stable;}
    .scrollCardList{overflow:auto; max-height: 52vh; scrollbar-gutter: stable;}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .two{grid-template-columns:1fr;} }

    table{width:100%; border-collapse: collapse; font-size:13px;}
    th, td{padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:top;}
    th{color:var(--muted); font-weight:600; text-align:left; font-size:12px;}

    tr.clickRow{cursor:pointer;}
    tr.clickRow:hover{background: rgba(199,154,59,.08);}
    tr.clickRow.selected{background: rgba(122,46,38,.06);}

    .badge{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:12px; font-weight:800; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:#fff}
    .badge.dot{padding:0; width:12px; height:12px; border-radius:999px; display:inline-block; border-width:2px; background:#fff;}
    .badge.ok{border-color: rgba(15,118,110,.25); color: rgba(15,118,110,1)}
    .badge.warn{border-color: rgba(180,83,9,.25); color: rgba(180,83,9,1)}

    .err{color: var(--bad); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:12px; white-space: pre-wrap;}
    .ok{color: var(--ok); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:12px; white-space: pre-wrap;}

    .segTabs{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .segBtn{appearance:none; border:1px solid var(--border); background:#fff; padding:9px 12px; border-radius:999px; font-weight:900; color:#3a2f2c; cursor:pointer;}
    .segBtn.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}

    .collapHdr{width:100%; appearance:none; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:10px; text-align:left; font-weight:900; color:#3a2f2c;}
    .collapHdr:focus-visible{outline:none; box-shadow: 0 0 0 3px var(--ring); border-color: rgba(199,154,59,.55)}
    .collapHdr .collapLeft{display:flex; align-items:baseline; gap:10px; min-width:0;}
    .collapHdr .collapHint{font-weight:700; color: var(--muted); font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .collapHdr .collapChev{font-weight:900; color: var(--muted); font-size:12px; flex:0 0 auto;}
    .collapBody{margin-top:10px;}

    .dd{position:relative;}
    .nativeSelectHidden{display:none !important;}
    .ddBtn{width:100%; appearance:none; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:12px; font-weight:900; color:#3a2f2c; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .ddBtn:focus-visible{outline:none; box-shadow: 0 0 0 3px var(--ring); border-color: rgba(199,154,59,.55)}
    .ddMenu{position:absolute; left:0; right:0; top: calc(100% + 8px); background:#fff; border:1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); padding: 6px; z-index: 220; max-height: 320px; overflow:auto;}
    .ddItem{width:100%; text-align:left; appearance:none; border:1px solid transparent; background:transparent; padding:10px 10px; border-radius:12px; cursor:pointer; font-weight:900; color:#3a2f2c;}
    .ddItem:hover{background: rgba(199,154,59,.10); border-color: rgba(199,154,59,.22)}
    .ddItem.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}

    .slotGrid{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .slotBtn{appearance:none; border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:999px; font-weight:900; color:#3a2f2c; cursor:pointer; font-size:12px;}
    .slotBtn.active{background: rgba(15,118,110,.08); border-color: rgba(15,118,110,.22); color: rgba(15,118,110,1)}
    .calGrid{display:grid; grid-template-columns: repeat(7, 1fr); gap: 8px;}
    .calCell{border:1px solid var(--border); background:#fff; border-radius: 12px; padding: 10px 10px; cursor:pointer; min-height: 42px;}
    .calCell:hover{border-color: rgba(199,154,59,.55)}
    .calCell.muted{opacity:.55;}
    .calCell.active{background: rgba(122,46,38,.06); border-color: rgba(122,46,38,.22)}

    .availGridWrap{overflow:auto; border:1px solid var(--border); border-radius: 14px; background:#fff;}
    .availWeekGrid{display:grid; grid-template-columns: 96px repeat(7, minmax(130px, 1fr)); min-width: 960px;}
    .availHeadCell{position: sticky; top: 0; z-index: 2; background:#fff; border-bottom:1px solid var(--border); padding:10px 10px; font-size:12px; color:var(--muted); font-weight:900;}
    .availHeadCell:first-child{left:0; z-index: 3; position: sticky;}
    .availHeadCell.pastDay{background: rgba(0,0,0,.03); color: rgba(0,0,0,.38)}
    .availTimeCell{position: sticky; left: 0; z-index: 1; background:#fff; border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:10px 10px; font-family: var(--mono); font-size:12px; color:var(--muted);}
    .availSlotCell{border-bottom:1px solid var(--border); border-right:1px solid var(--border); padding:6px; background:#fff;}
    .availSlotCell.pastDay{background: rgba(0,0,0,.02)}
    .availSlotBtn{width:100%; height:34px; appearance:none; border:1px solid rgba(0,0,0,.06); background: rgba(15,118,110,.04); border-radius: 10px; cursor:pointer;}
    .availSlotBtn:hover{border-color: rgba(199,154,59,.35)}
    .availSlotBtn.active{background: rgba(199,154,59,.30); border-color: rgba(199,154,59,.70); box-shadow: 0 0 0 2px rgba(199,154,59,.14) inset}
    .availSlotBtn[disabled]{cursor:not-allowed; opacity:.55; background: rgba(0,0,0,.03)}

    .stageBar{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .stageBtn{appearance:none; border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:900; color:#3a2f2c; display:flex; align-items:center; gap:8px;}
    .stageBtn:hover{border-color: rgba(199,154,59,.55)}
    .stageBtn.active{background: rgba(15,118,110,.08); border-color: rgba(15,118,110,.22); color: rgba(15,118,110,1)}
    .stageCount{font-family: var(--mono); font-size:12px; color: var(--muted); font-weight:900;}

    .pipe{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .pipeStage{display:flex; align-items:center; gap:10px;}
    .pipeNode{appearance:none; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius: 14px; cursor:pointer; box-shadow: none; display:flex; align-items:center; gap:10px; font-weight:900; color:#3a2f2c;}
    .pipeNode:hover{border-color: rgba(199,154,59,.55)}
    .pipeCount{font-family: var(--mono); font-size:12px; color: var(--muted); font-weight:900;}
    .pipeLine{height:2px; width:28px; background: rgba(0,0,0,.10); border-radius:999px;}

    .modalBackdrop{position:fixed; inset:0; background: rgba(0,0,0,.38); z-index: 80; display:none; padding: 20px;}
    .modalBackdrop.show{display:block;}
    .modal{max-width: 1040px; margin: 30px auto; background:#fff; border:1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow); overflow:hidden;}
    .modal.sm{max-width: 760px;}
    .modalHd{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; border-bottom:1px solid var(--border);}
    .modalHd .t{font-weight:900;}
    .modalBd{padding:16px;}
    .modalTwo{display:grid; grid-template-columns: 1fr 1fr; gap:12px; min-width:0;}
    @media (max-width: 860px){ .modalTwo{grid-template-columns: 1fr;} }
    .modalList{border:1px solid var(--border); border-radius: 14px; overflow:auto; max-height: 420px;}
    .modalList button{width:100%; text-align:left; background:#fff; border:0; border-bottom:1px solid var(--border); padding:10px 12px; cursor:pointer;}
    .modalList button:hover{background: rgba(199,154,59,.10)}
    .modalList button.active{background: rgba(15,118,110,.08)}
    .modalDetail{border:1px solid var(--border); border-radius: 14px; padding:12px; min-width:0;}
    .modalDetail .kv{display:grid; grid-template-columns: 120px 1fr; gap:8px 10px; font-size:13px;}
    .modalDetail .kv div:nth-child(odd){color:var(--muted); font-weight:800;}
    .modalDetail .kv div:nth-child(even){word-break:break-word;}

    .spin{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.14);
      border-top-color: rgba(122,46,38,.95);
      display: inline-block;
      vertical-align: -2px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .small{font-size:12px;}

    .wizardTop{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .wizardSteps{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .wizardStep{font-size:12px; font-weight:900; color:#3a2f2c; border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:999px; cursor:pointer;}
    .wizardStep.active{background: rgba(122,46,38,.08); border-color: rgba(122,46,38,.22); color: var(--maroon)}
    .wizardNav{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}

    .avatarCircle{width:40px; height:40px; border-radius:999px; overflow:hidden; background: rgba(0,0,0,.06); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-weight:950; color: rgba(0,0,0,.55); flex: 0 0 auto; background-size:cover; background-position:center; background-repeat:no-repeat;}
    .avatarCircle img{width:100%; height:100%; object-fit:cover; display:block;}
    .avatarCircle.lg{width:68px; height:68px; font-size:18px;}

    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; font-weight:800; font-size:12px;}
    .chip button{border:0; background:transparent; cursor:pointer; font-weight:950; color: rgba(0,0,0,.55); padding:0; line-height:1;}
    .chip button:hover{color: rgba(0,0,0,.85)}
    .chipAddRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .chipAddRow input{max-width:320px;}

    .relBadge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-weight:950; font-size:12px;}
    .relBadge.good{border-color: rgba(15,118,110,.35); background: rgba(15,118,110,.08); color: rgba(8,88,82,.95)}
    .relBadge.mid{border-color: rgba(199,154,59,.45); background: rgba(199,154,59,.10); color: rgba(120,86,18,.95)}
    .relBadge.bad{border-color: rgba(190,54,54,.35); background: rgba(190,54,54,.10); color: rgba(120,20,20,.95)}

    .relRange{width:260px; max-width:100%; height:10px; border-radius:999px; background: linear-gradient(90deg, rgba(190,54,54,.85), rgba(199,154,59,.95), rgba(15,118,110,.95)); outline: none; -webkit-appearance: none; appearance: none;}
    .relRange::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:999px; background:#fff; border:2px solid rgba(0,0,0,.25); cursor:pointer;}
    .relRange::-moz-range-thumb{width:18px; height:18px; border-radius:999px; background:#fff; border:2px solid rgba(0,0,0,.25); cursor:pointer;}

    .cropBox{width:260px; height:260px; border-radius:999px; border:1px solid var(--border); background: rgba(0,0,0,.04); overflow:hidden; position:relative; touch-action:none;}
    .cropBox img{position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); user-select:none; -webkit-user-drag:none;}
  </style>
</head>
<body>
  <div id="authView" class="auth">
    <div class="authCard">
      <div class="authTop">
        <img src="brand/purestay_exact_SVG.svg" alt="PureStay" />
        <div>
          <h1>Portal</h1>
          <div class="sub">Sign in to continue</div>
        </div>
      </div>

      <div style="height:16px"></div>
      <div class="two">
        <div>
          <label>Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="you@company.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="row" style="justify-content:flex-start; gap:10px;">
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="signupBtn" class="btn secondary" type="button">Create account</button>
      </div>
      <div style="height:12px"></div>
      <div id="authMsg" class="err"></div>
      <div id="authOk" class="ok"></div>
    </div>
  </div>

  <div id="appView" class="hide">
    <div class="appbar">
      <div class="appbarInner">
        <div class="appbrand">
          <img src="brand/purestay_exact_SVG.svg" alt="PureStay" />
          <div>
            <div class="t">Portal</div>
            <div class="muted small" id="roleLine">—</div>
          </div>
        </div>
        <div class="row">
          <div id="appUser" class="pill">—</div>
          <button id="logoutBtn" class="btn secondary">Logout</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <nav class="sidebar">
        <div id="nav"></div>
      </nav>
      <main class="main">
        <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
          <div>
            <div class="muted small">View</div>
            <div id="viewTitle" style="font-weight:900; margin-top:4px;">Overview</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div id="viewOverview"></div>

        <div id="viewAccounts" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px; align-items:flex-end; flex-wrap:wrap;">
            <div>
              <div class="muted small">Accounts</div>
              <div style="font-weight:900; margin-top:4px;">Account management</div>
              <div class="muted small" style="margin-top:4px;">Search, edit, sentiment, issues, and templates</div>
            </div>
            <div class="row" style="gap:8px;">
              <button id="accountsRefreshBtn" class="btn secondary" type="button">Refresh</button>
              <button id="accountsNewToggle" class="btn secondary" type="button">+ New</button>
            </div>
          </div>

          <div id="accountsNewBox" class="card" style="margin-top:14px; background:#fff;" hidden>
            <div class="bd">
              <div style="font-weight:900;">Create account</div>
              <div class="muted small" style="margin-top:4px;">Normally created automatically when a closer marks a deal as won.</div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Property name</label>
                  <input id="acctName" placeholder="Property / Community" />
                </div>
                <div>
                  <label>Property address</label>
                  <input id="acctAddress" placeholder="123 Main St, Raleigh, NC 27601" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Primary contact name</label>
                  <input id="acctContactName" placeholder="Jane Doe" />
                </div>
                <div>
                  <label>Primary contact email</label>
                  <input id="acctContactEmail" type="email" placeholder="jane@property.com" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Primary contact phone</label>
                  <input id="acctContactPhone" placeholder="(555) 555-5555" />
                </div>
                <div>
                  <label>Contract tier</label>
                  <select id="acctTier">
                    <option value="">Select…</option>
                    <option value="core">Core</option>
                    <option value="culture_shift">Culture Shift</option>
                    <option value="signature">Signature Stay</option>
                    <option value="custom">Custom</option>
                  </select>
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Term (months)</label>
                  <input id="acctTermMonths" type="number" min="0" step="1" placeholder="6" />
                </div>
                <div>
                  <label>Renewal reminder (days before end)</label>
                  <input id="acctReminderDays" type="number" min="0" step="1" placeholder="30" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Contract start date</label>
                  <input id="acctStart" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                </div>
                <div>
                  <label>Contract end date</label>
                  <input id="acctEnd" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                </div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes (internal)</label>
                <textarea id="acctNotes" placeholder="Onboarding context, expectations, issues..."></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="accountsCreateBtn" class="btn" type="button">Create</button>
                <div id="accountsCreateMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="accountsMsg" class="err"></div>

          <div class="two" style="grid-template-columns: 1fr 1.2fr;">
            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div class="muted small">Search</div>
                    <input id="accountsQ" placeholder="Search property, address, contact" />
                  </div>
                  <div>
                    <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                      <input id="accountsExpiring" type="checkbox" style="width:auto;" />
                      Expiring soon
                    </label>
                  </div>
                </div>
                <div style="height:10px"></div>
                <div id="accountsList" style="display:flex; flex-direction:column; gap:10px;"></div>
              </div>
            </div>

            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="muted small">Selected account</div>
                <div id="acctSelected" style="font-weight:900; margin-top:4px;">None</div>
                <div style="height:10px"></div>

                <div class="two">
                  <div>
                    <label>Property name</label>
                    <input id="acctEditName" placeholder="Property / Community" />
                  </div>
                  <div>
                    <label>Contract tier</label>
                    <input id="acctEditTier" placeholder="Core / Culture Shift / Signature Stay / custom" />
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <label>Property address</label>
                  <input id="acctEditAddress" placeholder="123 Main St, Raleigh, NC 27601" />
                </div>
                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Primary contact name</label>
                    <input id="acctEditContactName" placeholder="Jane Doe" />
                  </div>
                  <div>
                    <label>Primary contact email</label>
                    <input id="acctEditEmail" type="email" placeholder="jane@property.com" />
                  </div>
                </div>
                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Primary contact phone</label>
                    <input id="acctEditPhone" placeholder="(555) 555-5555" />
                  </div>
                  <div>
                    <label>Term (months)</label>
                    <input id="acctEditTermMonths" type="number" min="0" step="1" placeholder="6" />
                  </div>
                </div>
                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Contract start</label>
                    <input id="acctEditStart" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                  </div>
                  <div>
                    <label>Contract end</label>
                    <input id="acctEditEnd" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                  </div>
                </div>
                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Renewal reminder (days before end)</label>
                    <input id="acctEditReminderDays" type="number" min="0" step="1" placeholder="30" />
                  </div>
                  <div>
                    <label>Renewal reminder date</label>
                    <input id="acctEditReminderDate" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                  </div>
                </div>
                <div class="muted small" id="acctRenewalHint" style="margin-top:10px;"></div>
                <div style="margin-top:10px;">
                  <label>Notes</label>
                  <textarea id="acctEditNotes" placeholder="Internal notes"></textarea>
                </div>

                <div class="row" style="margin-top:10px;">
                  <button id="acctSaveBtn" class="btn" type="button">Save</button>
                  <button id="acctDeleteBtn" class="btn secondary" type="button">Delete</button>
                  <div id="acctSaveMsg" class="err"></div>
                </div>

                <div style="height:14px"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                  <div class="bd">
                    <div style="font-weight:900;">Sentiment log</div>
                    <div class="muted small" style="margin-top:4px;">Track relationship health over time</div>
                    <div style="height:10px"></div>
                    <div class="two">
                      <div>
                        <label>Sentiment</label>
                        <select id="sentimentKind">
                          <option value="green">green</option>
                          <option value="yellow">yellow</option>
                          <option value="red">red</option>
                        </select>
                      </div>
                      <div>
                        <label>Tags (optional)</label>
                        <input id="sentimentTags" placeholder="pricing, communication, recap quality" />
                      </div>
                    </div>
                    <div style="margin-top:10px;">
                      <label>Note</label>
                      <textarea id="sentimentNote" placeholder="What happened? What should we do next?"></textarea>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <button id="sentimentAddBtn" class="btn secondary" type="button">Add entry</button>
                      <div id="sentimentMsg" class="err"></div>
                    </div>
                    <div style="height:10px"></div>
                    <div id="sentimentList"></div>
                  </div>
                </div>

                <div style="height:14px"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                  <div class="bd">
                    <div style="font-weight:900;">Issues</div>
                    <div class="muted small" style="margin-top:4px;">Internal issue tracking and escalations</div>
                    <div style="height:10px"></div>
                    <div class="two">
                      <div>
                        <label>Severity</label>
                        <select id="issueSeverity">
                          <option value="low">low</option>
                          <option value="med">med</option>
                          <option value="high">high</option>
                        </select>
                      </div>
                      <div>
                        <label>Status</label>
                        <select id="issueStatus">
                          <option value="open">open</option>
                          <option value="resolved">resolved</option>
                        </select>
                      </div>
                    </div>
                    <div style="margin-top:10px;">
                      <label>Issue</label>
                      <textarea id="issueNote" placeholder="What is the issue? Who owns it? Any next steps?"></textarea>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <button id="issueAddBtn" class="btn secondary" type="button">Add issue</button>
                      <div id="issueMsg" class="err"></div>
                    </div>
                    <div style="height:10px"></div>
                    <div id="issueList"></div>
                  </div>
                </div>

                <div style="height:14px"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                  <div class="bd">
                    <div style="font-weight:900;">Templates</div>
                    <div class="muted small" style="margin-top:4px;">Email / SMS templates</div>
                    <div style="height:10px"></div>
                    <div class="two">
                      <div>
                        <label>Template type</label>
                        <select id="tplType">
                          <option value="email">email</option>
                          <option value="sms">sms</option>
                        </select>
                      </div>
                      <div>
                        <label>Name</label>
                        <input id="tplName" placeholder="Quarterly check-in" />
                      </div>
                    </div>
                    <div style="margin-top:10px;">
                      <label>Body</label>
                      <textarea id="tplBody" placeholder="Hi {{name}}, ..."></textarea>
                    </div>
                    <div class="row" style="margin-top:10px;">
                      <button id="tplSaveBtn" class="btn secondary" type="button">Save template</button>
                      <div id="tplMsg" class="err"></div>
                    </div>
                    <div style="height:10px"></div>
                    <div id="tplList"></div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <div id="viewLeads" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px;">
            <div class="row" style="flex: 1;">
              <input id="leadQ" placeholder="Search name, property, email, phone" style="max-width:420px" />
              <select id="leadStatus" style="max-width:200px">
                <option value="">All statuses</option>
                <option value="new">new</option>
                <option value="working">working</option>
                <option value="booked">booked</option>
                <option value="won">won</option>
                <option value="lost">lost</option>
              </select>
              <button id="loadLeadsBtn" class="btn secondary">Load</button>
            </div>
            <div class="row" style="gap:8px;">
              <button id="pullLeadsToggle" class="btn secondary hide" type="button">Pull leads</button>
              <button id="newLeadToggle" class="btn secondary" type="button">+ New lead</button>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="pipe" id="leadsPipeline"></div>
            </div>
          </div>

          <div id="pullLeadsBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div style="font-weight:900;">Pull leads (Google Maps)</div>
              <div class="muted small" style="margin-top:4px;">Apartment / multi-family offices. Phone + website included when available.</div>
              <div style="height:10px"></div>
              <div class="two">
                <div>
                  <label>City, State</label>
                  <input id="plCityState" placeholder="Raleigh, NC" />
                </div>
                <div>
                  <label>Keyword</label>
                  <input id="plKeyword" placeholder="apartment leasing office" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>Max leads</label>
                  <input id="plLimit" type="number" min="1" max="25" step="1" value="10" />
                </div>
                <div>
                  <label>Notes (optional)</label>
                  <input id="plNotes" placeholder="Any context to store on the leads" />
                </div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="pullLeadsBtn" class="btn" type="button">Pull now</button>
                <div id="pullLeadsMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div id="newLeadBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div class="two">
                <div><label>First name</label><input id="nlFirst" /></div>
                <div><label>Last name</label><input id="nlLast" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>Phone</label><input id="nlPhone" /></div>
                <div><label>Email</label><input id="nlEmail" type="email" /></div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>Property / Community</label><input id="nlProp" /></div>
                <div><label>City, State</label><input id="nlCityState" placeholder="Raleigh, NC" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="nlNotes" placeholder="What did we learn? Any context for the next touch?"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createLeadBtn" class="btn">Create lead</button>
                <div id="createLeadMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div id="leadsMsg" class="err"></div>
          <div id="leadsEmpty" class="muted small" style="margin-top:6px;"></div>

          <div class="two" style="align-items:flex-start; gap:14px;">
            <div>
              <div class="scrollBox" style="overflow:auto; border:1px solid var(--border); border-radius: 12px; max-height: 62vh;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Property</th>
                      <th>City</th>
                      <th>Status</th>
                      <th>Assigned</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="leadsTbody"></tbody>
                </table>
              </div>
            </div>

            <div class="leadDetailSticky" style="position: sticky; top: 12px;">
              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                    <div>
                      <div class="muted small">Selected lead</div>
                      <div id="leadDetailTitle" style="font-weight:900; margin-top:4px;">None</div>
                    </div>
                    <div class="row">
                      <button id="leadClearBtn" class="btn secondary" type="button">Clear</button>
                      <button id="leadDetailRefreshBtn" class="btn secondary" type="button">Refresh timeline</button>
                    </div>
                  </div>

                  <div style="height:10px"></div>
                  <div id="leadDetailMsg" class="err"></div>

                  <div class="two">
                    <div>
                      <label>Status</label>
                      <select id="leadEditStatus">
                        <option value="">(unchanged)</option>
                        <option value="new">new</option>
                        <option value="working">working</option>
                        <option value="booked">booked</option>
                        <option value="won">won</option>
                        <option value="lost">lost</option>
                      </select>
                    </div>
                    <div>
                      <label>Priority</label>
                      <select id="leadEditPriority">
                        <option value="">(unchanged)</option>
                        <option value="5">5</option>
                        <option value="4">4</option>
                        <option value="3">3</option>
                        <option value="2">2</option>
                        <option value="1">1</option>
                        <option value="0">0</option>
                        <option value="-1">-1</option>
                        <option value="-2">-2</option>
                        <option value="-3">-3</option>
                        <option value="-4">-4</option>
                        <option value="-5">-5</option>
                      </select>
                    </div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Assigned role</label>
                    <select id="leadEditAssignedRole">
                      <option value="">(unchanged)</option>
                      <option value="dialer">Remote Setter</option>
                      <option value="in_person_setter">In Person Setter</option>
                      <option value="closer">Closer</option>
                      <option value="event_host">Event Host</option>
                      <option value="event_coordinator">Event Coordinator</option>
                      <option value="media_team">Media Team</option>
                    </select>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Next follow up (ISO or free text)</label>
                    <input id="leadEditFollowup" placeholder="2026-02-25 14:30 ET" />
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <button id="leadSaveBtn" class="btn secondary" type="button">Save updates</button>
                    <div id="leadSaveMsg" class="err"></div>
                  </div>

                  <div style="height:14px"></div>

                  <div class="card" style="background:#fff; border-color: rgba(231,225,218,.9);">
                    <div class="bd" style="max-height: 44vh; overflow:auto;">
                      <div style="font-weight:900;">Timeline</div>
                      <div class="muted small" style="margin-top:4px;">Calls, closes, notes, and follow ups</div>
                      <div style="height:10px"></div>
                      <div id="timelineMsg" class="err"></div>
                      <div id="timelineList" class="scrollCardList"></div>

                      <div style="height:12px"></div>
                      <div>
                        <label>Add note</label>
                        <textarea id="timelineNote" placeholder="Add factual notes and next step."></textarea>
                      </div>
                      <div class="row" style="margin-top:10px;">
                        <button id="timelineAddBtn" class="btn" type="button">Add note</button>
                        <div id="timelineAddMsg" class="err"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewCalls" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px; margin-bottom:12px;">
            <div class="segTabs" style="gap:8px;">
              <button id="dialerSegCall" class="segBtn" type="button">Queue & Call</button>
              <button id="dialerSegActivity" class="segBtn" type="button">Activity</button>
              <button id="dialerSegBooked" class="segBtn" type="button">Booked</button>
              <button id="dialerSegTasks" class="segBtn" type="button">Tasks</button>
            </div>
          </div>

          <div id="dialerPaneCall">
            <div class="two" style="align-items:start;">
            <div class="card" style="background:#fff; margin-bottom:14px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">My queue</div>
                  <div class="muted small">Leads assigned to you or unassigned</div>
                </div>
                <div class="row">
                  <button id="loadQueueBtn" class="btn secondary" type="button">Load</button>
                </div>
              </div>
              <div style="height:10px"></div>
              <div id="queueMsg" class="err"></div>
                <div style="overflow:auto; max-height: 58vh; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Property</th>
                      <th>Status</th>
                      <th>Priority</th>
                      <th>Follow up</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="queueTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

            <div class="card" style="background: #fff; position: sticky; top: 14px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="selectedLeadLine" style="font-weight:700; margin-top:4px;">None</div>
                </div>
                <div class="row">
                  <button id="clearSelectedLeadBtn" class="btn secondary" type="button">Clear</button>
                  <button id="pickFromLeads" class="btn secondary" type="button">Pick from Leads</button>
                  <button id="openScheduleBtn" class="btn" type="button">Schedule…</button>
                </div>
              </div>
              <div style="height:10px"></div>
              <div id="dialerCallForm">
                <div class="two">
                  <div>
                    <label>Outcome</label>
                    <select id="callOutcome">
                      <option value="">Select…</option>
                      <option>no_answer</option>
                      <option>left_voicemail</option>
                      <option>not_interested</option>
                      <option>call_back</option>
                      <option>booked_meeting</option>
                      <option>qualified_handoff</option>
                    </select>
                  </div>
                  <div>
                    <label>Next status (optional)</label>
                    <select id="callLeadStatus">
                      <option value="">No change</option>
                      <option>working</option>
                      <option>booked</option>
                      <option>won</option>
                      <option>lost</option>
                    </select>
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <label>Next follow up</label>
                  <input id="callFollowup" placeholder="2026-02-25 14:30 ET" />
                </div>
                <div style="margin-top:10px;">
                  <label>Notes</label>
                  <textarea id="callNotes" placeholder="Short, factual notes."></textarea>
                </div>
                <div class="row" style="margin-top:10px;">
                  <button id="logCallBtn" class="btn">Log call</button>
                  <button id="aiFollowupBtn" class="btn secondary">AI follow-up</button>
                  <div id="callMsg" class="err"></div>
                </div>
                <div id="followupBox" class="card hide" style="margin-top:12px; background: #fff;">
                  <div class="bd">
                    <div class="muted small">Generated follow-up</div>
                    <div style="height:8px"></div>
                    <div><label>Email subject</label><input id="fuSubject" /></div>
                    <div style="margin-top:10px;"><label>Email body</label><textarea id="fuEmail"></textarea></div>
                    <div style="margin-top:10px;"><label>SMS</label><textarea id="fuSms"></textarea></div>
                    <div style="margin-top:10px;"><label>Next step</label><input id="fuNext" /></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          </div>

          <div style="height:14px"></div>
          </div>

          <div id="dialerPaneActivity" class="hide">
            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div style="font-weight:900;">Lead activity</div>
                    <div class="muted small">Calls, notes, appointments, and closes for the selected lead</div>
                  </div>
                  <button id="loadDialerTimelineBtn" class="btn secondary" type="button">Refresh</button>
                </div>
                <div style="height:10px"></div>
                <div id="dialerTimelineMsg" class="err"></div>
                <div id="dialerTimelineList" class="scrollCardList"></div>
              </div>
            </div>
          </div>

          <div id="dialerPaneBooked" class="hide">
            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div style="font-weight:900;">Booked meetings</div>
                    <div class="muted small">Meetings you scheduled (track outcomes in Activity)</div>
                  </div>
                  <div class="row">
                    <button id="dialerBookedRefreshBtn" class="btn secondary" type="button">Refresh</button>
                    <button id="dialerBookedOpenSchedule" class="btn" type="button">Schedule…</button>
                  </div>
                </div>

                <div style="height:10px"></div>
                <div id="dialerBookedMsg" class="err"></div>

                <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Lead</th>
                        <th>Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="dialerBookedTbody"></tbody>
                  </table>
                </div>

                <div style="height:12px"></div>
                <div class="muted small">Tip: Select a lead (Calls → Pick from Leads), then use “Schedule…”</div>
              </div>
            </div>
          </div>

          <div id="dialerPaneTasks" class="hide">
            <div class="card" style="background:#fff;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                  <div>
                    <div style="font-weight:900;">Tasks</div>
                    <div class="muted small">To-dos assigned to you or your role</div>
                  </div>
                  <div class="row">
                    <select id="dialerTasksScope" style="max-width:220px">
                      <option value="role">Role</option>
                      <option value="mine">My tasks</option>
                    </select>
                    <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                      <input id="dialerTasksOverdue" type="checkbox" style="width:auto;" />
                      Overdue only
                    </label>
                    <button id="loadDialerTasksBtn" class="btn secondary" type="button">Load</button>
                  </div>
                </div>
                <div style="height:10px"></div>
                <div id="dialerTasksMsg" class="err"></div>
                <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Due</th>
                        <th>Title</th>
                        <th>Lead</th>
                        <th>Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="dialerTasksTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewMeetings" class="hide">
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="segTabs" style="gap:8px; margin-bottom:12px;">
                <button id="meetingsSegList" class="segBtn" type="button">Meetings</button>
                <button id="meetingsSegAvailability" class="segBtn" type="button">Availability</button>
              </div>

              <div id="meetingsPaneList" class="hide">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">My meetings</div>
                  <div class="muted small">Upcoming and recent appointments</div>
                </div>
                <div class="row">
                  <button id="meetingsRefreshBtn" class="btn secondary" type="button">Refresh</button>
                  <button id="meetingsOpenSchedule" class="btn" type="button">Schedule…</button>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="meetingsMsg" class="err"></div>

              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Lead</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="meetingsTbody"></tbody>
                </table>
              </div>

              <div style="height:12px"></div>
              <div class="muted small">Use “Schedule…” to schedule for the selected lead.</div>

              </div>

              <div id="meetingsPaneAvailability" class="hide">
              <div id="meetingsAvailabilityCard" class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                    <div>
                      <div style="font-weight:900;">Availability</div>
                      <div class="muted small" style="margin-top:4px;">Select times you can take meetings. Times are shown in your local timezone (<span id="availTzLabel"></span>).</div>
                    </div>
                    <div class="row" style="gap:8px;">
                      <button id="availPrevWeek" class="btn secondary" type="button">Prev week</button>
                      <button id="availToday" class="btn secondary" type="button">This week</button>
                      <button id="availNextWeek" class="btn secondary" type="button">Next week</button>
                      <button id="availClearWeek" class="btn secondary" type="button">Clear week</button>
                      <button id="availSaveBtn" class="btn" type="button">Save</button>
                    </div>
                  </div>

                  <div style="height:10px"></div>
                  <div class="row" style="justify-content:space-between; gap:10px;">
                    <div class="muted small" id="availWeekLabel">—</div>
                  </div>
                  <div style="height:10px"></div>
                  <div id="availMsg" class="err"></div>

                  <div class="availGridWrap" style="margin-top:10px;">
                    <div class="availWeekGrid" id="availWeekGrid"></div>
                  </div>
                </div>
              </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewCloser" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px; margin-bottom:12px;">
            <div class="segTabs" style="gap:8px;">
              <button id="closerSegDisposition" class="segBtn" type="button">Disposition</button>
            </div>
          </div>

          <div id="closerPaneDisposition" class="hide">
          <div class="card" style="background: #fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected lead</div>
                  <div id="closerSelectedLead" style="font-weight:700; margin-top:4px;">None</div>
                </div>
                <div class="row">
                  <button id="closerClearLeadBtn" class="btn secondary" type="button">Clear</button>
                  <button id="closerPickLead" class="btn secondary" type="button">Pick from Leads</button>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                    <div>
                      <div style="font-weight:900;">AI Research</div>
                      <div class="muted small">Call prep from lead details</div>
                    </div>
                    <button id="aiResearchBtn" class="btn secondary">Generate</button>
                  </div>
                  <div style="height:10px"></div>
                  <div><label>Optional question</label><input id="researchQ" placeholder="What should I ask on discovery?" /></div>
                  <div style="height:10px"></div>
                  <div id="researchMsg" class="err"></div>
                  <div id="researchBox" class="card hide" style="margin-top:12px; background:#fff;">
                    <div class="bd">
                      <div><label>Summary</label><textarea id="researchSummary"></textarea></div>
                      <div style="margin-top:10px;"><label>Talking points</label><textarea id="researchTalking"></textarea></div>
                      <div style="margin-top:10px;"><label>Likely objections</label><textarea id="researchObjections"></textarea></div>
                      <div style="margin-top:10px;"><label>Next steps</label><textarea id="researchNext"></textarea></div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="height:14px"></div>

              <div class="card" style="background:#fff;">
                <div class="bd">
                  <div style="font-weight:900;">Close or Disposition</div>
                  <div style="height:10px"></div>

                  <div class="two">
                    <div>
                      <label>Disposition</label>
                      <select id="closeDisposition">
                        <option value="follow_up">follow_up</option>
                        <option value="won">won</option>
                        <option value="lost">lost</option>
                      </select>
                    </div>
                    <div>
                      <label>Closed on (if won)</label>
                      <input id="closeDate" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Package tier</label>
                      <select id="closePackage">
                        <option value="">Select…</option>
                        <option value="core">Core</option>
                        <option value="culture_shift">Culture Shift</option>
                        <option value="signature">Signature Stay</option>
                        <option value="custom">Custom</option>
                      </select>
                    </div>
                    <div>
                      <label>Package price (USD)</label>
                      <input id="closePackagePrice" type="number" min="0" step="0.01" placeholder="1000" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Initial payment (USD)</label>
                      <input id="closeInitial" type="number" min="0" step="0.01" placeholder="0" />
                    </div>
                    <div>
                      <label>Term length (months)</label>
                      <input id="closeTerm" type="number" min="1" step="1" placeholder="6" />
                    </div>
                  </div>

                  <div class="two" style="margin-top:10px;">
                    <div>
                      <label>Monthly pricing (USD)</label>
                      <input id="closeMonthly" type="number" min="0" step="0.01" placeholder="0" />
                    </div>
                    <div>
                      <label>Contract send date (optional)</label>
                      <input id="closeContractSend" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                    </div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Next steps (optional)</label>
                    <textarea id="closeNotes" placeholder="Short context for follow-up."></textarea>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <button id="closeSubmitBtn" class="btn">Submit</button>
                    <div id="closeMsg" class="err"></div>
                  </div>
                </div>
              </div>

          </div>
            </div>
          </div>
        </div>

        <div id="viewEvents" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px; align-items:flex-end; flex-wrap:wrap; position:relative; z-index:40;">
            <div class="row" style="gap:8px; flex-wrap:wrap;">
              <select id="eventStatus" style="max-width:220px">
                <option value="">All statuses</option>
                <option value="open">open</option>
                <option value="assigned">assigned</option>
                <option value="completed">completed</option>
                <option value="canceled">canceled</option>
              </select>
              <button id="loadEventsBtn" class="btn secondary" type="button">Refresh</button>
              <div id="eventsSegTabs" class="segTabs hide" style="gap:8px;">
                <button id="eventsSegMy" class="segBtn" type="button">My</button>
                <button id="eventsSegAll" class="segBtn" type="button">All</button>
              </div>
            </div>
            <button id="newEventToggle" class="btn secondary hide" type="button">New event</button>
          </div>

          <div id="newEventBox" class="card" style="margin-top:14px; background: #fff;" hidden>
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:center; gap:12px;">
                <div>
                  <div style="font-weight:900;">New event</div>
                  <div class="muted small" style="margin-top:4px;">Pick a property, then confirm details</div>
                </div>
                <button id="newEventCloseBtn" class="btn secondary small" type="button">Close</button>
              </div>

              <div style="height:12px"></div>

              <div class="two">
                <div>
                  <label>Property</label>
                  <select id="neAccountPick">
                    <option value="">Select…</option>
                  </select>
                  <div id="neAccountMsg" class="err" style="margin-top:6px;"></div>
                </div>
                <div><label>Date</label><input id="neDate" type="text" data-picker="date" placeholder="YYYY-MM-DD" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Property address</label>
                <input id="neAddress" placeholder="123 Main St" />
              </div>
              <div class="two" style="margin-top:10px;">
                <div><label>City</label><input id="neCity" /></div>
                <div><label>State</label><input id="neState" placeholder="NC" /></div>
              </div>
              <div style="margin-top:10px;">
                <label>Title (optional override)</label>
                <input id="neTitle" placeholder="Property event" />
              </div>
              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="neNotes"></textarea>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="createEventBtn" class="btn">Create event</button>
                <div id="createEventMsg" class="err"></div>
              </div>
            </div>
          </div>

          <div class="two" style="gap:12px; align-items:flex-start; margin-top:14px;">
            <div style="min-width:0;">
              <div id="eventsMsg" class="err"></div>
              <div class="card" style="background:#fff;">
                <div class="bd" style="padding:0;">
                  <div style="overflow:auto; max-height:65vh;">
                    <table>
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Date</th>
                          <th>Title</th>
                          <th>City</th>
                          <th>Status</th>
                          <th>Role</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="eventsTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div style="min-width:0;">
              <div id="eventDetailsEmpty" class="muted small">Select an event to see details.</div>
              <div id="eventDetailsWrap" class="hide">
          <div id="eventRecapWrap" class="card hide" style="margin-top:0; background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Selected event</div>
                  <div id="selectedEventLine" style="font-weight:900; margin-top:4px;">None</div>
                </div>
                <button id="closeRecapBtn" class="btn secondary" type="button">Close</button>
              </div>

              <div style="height:12px"></div>

              <div class="two">
                <div>
                  <label>Attendance estimate</label>
                  <input id="recapAttendance" type="number" min="0" step="1" placeholder="0" />
                </div>
                <div>
                  <label>How it went</label>
                  <select id="recapRating">
                    <option value="">Select…</option>
                    <option>excellent</option>
                    <option>good</option>
                    <option>ok</option>
                    <option>poor</option>
                  </select>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Issues reported</label>
                <select id="recapIssues">
                  <option value="">Select…</option>
                  <option value="no">no</option>
                  <option value="yes">yes</option>
                </select>
              </div>

              <div style="margin-top:10px;">
                <label>Issues details (if any)</label>
                <textarea id="recapIssuesDetails"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Host notes</label>
                <textarea id="recapNotes"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Standout moments / wins</label>
                <textarea id="recapStandouts"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Giveaway winners (if any)</label>
                <textarea id="recapGiveawayWinners" placeholder="Name / unit (or notes)"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Resident feedback highlights</label>
                <textarea id="recapFeedbackHighlights"></textarea>
              </div>

              <div style="margin-top:10px;">
                <label>Event flow doc link (optional)</label>
                <input id="recapEventFlowDoc" placeholder="https://..." />
              </div>

              <div style="margin-top:10px;">
                <label>Media links (one per line)</label>
                <textarea id="recapMedia" placeholder="https://...\nhttps://..."></textarea>
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="submitRecapBtn" class="btn">Submit recap</button>
                <div id="recapMsg" class="err"></div>
              </div>

              <div style="height:14px"></div>
              <div class="muted small" style="font-weight:900;">Recent recaps</div>
              <div style="height:8px"></div>
              <div id="recapsList" class="scrollCardList"></div>
            </div>
          </div>

          <div id="eventOpsWrap" class="card hide" style="margin-top:0; background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Coordinator / Ops</div>
                  <div style="font-weight:900; margin-top:4px;">Event operations</div>
                </div>
                <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                  <button id="closeOpsEventBtn" class="btn secondary" type="button">Close</button>
                  <button id="createFollowupsBtn" class="btn secondary" type="button">Create 24h follow-ups</button>
                </div>
              </div>

              <div id="eventOpsSelectedLine" class="muted small" style="margin-top:6px;"></div>

              <div style="height:10px"></div>
              <div id="eventOpsMsg" class="err"></div>
              <div id="eventOpsReadOnlyLine" class="muted small hide" style="margin-top:6px;">Read-only mode (view-as role preview).</div>

              <div style="height:12px"></div>

              <button class="collapHdr" type="button" data-collapse-target="opsStaffingBody" aria-expanded="true">
                <div class="collapLeft">
                  <span>Staffing</span>
                  <span id="opsStaffingHint" class="collapHint">Assign host/media and track acceptance</span>
                </div>
                <span class="collapChev" data-collapse-chev>▲</span>
              </button>

              <div id="opsStaffingBody" class="collapBody">
                <div class="row" style="gap:8px; flex-wrap:wrap;">
                  <select id="assignHostUser" style="min-width:260px;">
                    <option value="">Assign host…</option>
                  </select>
                  <button id="addHostBtn" class="btn secondary" type="button">Add host</button>
                </div>

                <div style="height:8px"></div>

                <div class="row" style="gap:8px; flex-wrap:wrap;">
                  <select id="assignMediaUser" style="min-width:260px;">
                    <option value="">Assign media…</option>
                  </select>
                  <button id="addMediaBtn" class="btn secondary" type="button">Add media</button>
                </div>

                <div style="height:10px"></div>
                <div id="assignmentsList" class="scrollCardList"></div>
                <div id="myAssignmentActions" class="hide" style="margin-top:10px;"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.25); margin-top:10px;">
                  <div class="bd">
                    <button class="collapHdr" type="button" data-collapse-target="opsFeedbackBody" aria-expanded="false">
                      <div class="collapLeft">
                        <span>Resident feedback</span>
                        <span class="collapHint">Link + submissions</span>
                      </div>
                      <span class="collapChev" data-collapse-chev>▼</span>
                    </button>

                    <div id="opsFeedbackBody" class="collapBody hide">
                      <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                        <div>
                          <div class="muted small">Feedback form</div>
                          <div style="font-weight:900; margin-top:4px;">Link & submissions</div>
                          <div class="muted small" style="margin-top:4px;">Generate a share link (or QR), then review submissions here.</div>
                        </div>
                        <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                          <button id="feedbackEnableBtn" class="btn secondary" type="button">Enable / Regenerate link</button>
                          <button id="feedbackLoadSummaryBtn" class="btn secondary" type="button">Load submissions</button>
                        </div>
                      </div>

                      <div style="height:10px"></div>
                      <div id="feedbackFormMsg" class="err"></div>

                      <label>Shareable link</label>
                      <div class="row" style="gap:8px; flex-wrap:wrap;">
                        <input id="feedbackLink" readonly placeholder="Enable feedback to generate a link" style="min-width:320px; flex:1;" />
                        <button id="feedbackCopyBtn" class="btn secondary" type="button">Copy</button>
                        <button id="feedbackOpenBtn" class="btn secondary" type="button">Open</button>
                      </div>

                      <div class="two" style="margin-top:10px;">
                        <div>
                          <label>Subtitle (optional)</label>
                          <input id="feedbackSubtitle" placeholder="Thanks for joining us..." />
                        </div>
                        <div>
                          <label>Thank-you message (optional)</label>
                          <input id="feedbackThanks" placeholder="Your feedback was received." />
                        </div>
                      </div>

                      <div style="margin-top:10px;">
                        <div style="font-weight:900;">Questions</div>
                        <div class="muted small" style="margin-top:4px;">Overall rating is always included.</div>
                        <div style="height:8px"></div>
                        <div id="feedbackQuestionsList"></div>
                        <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
                          <button id="feedbackAddQBtn" class="btn secondary" type="button">Add question</button>
                          <button id="feedbackSaveBtn" class="btn secondary" type="button">Save feedback form</button>
                        </div>
                      </div>

                      <div style="height:12px"></div>
                      <div id="feedbackSummaryLine" class="muted small"></div>
                      <div id="feedbackCommentsList" style="margin-top:10px;"></div>
                    </div>
                  </div>
                </div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.25); margin-top:10px;">
                  <div class="bd">
                    <button class="collapHdr" type="button" data-collapse-target="opsAiStaffingBody" aria-expanded="false">
                      <div class="collapLeft">
                        <span>AI staffing</span>
                        <span class="collapHint">Recommendations</span>
                      </div>
                      <span class="collapChev" data-collapse-chev>▼</span>
                    </button>

                    <div id="opsAiStaffingBody" class="collapBody hide">
                      <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                        <div>
                          <div class="muted small">Recommendations</div>
                          <div style="font-weight:900; margin-top:4px;">Suggested host + media</div>
                          <div class="muted small" style="margin-top:4px;">Suggest host + media based on location, specialties, and reliability.</div>
                        </div>
                        <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                          <button id="aiRecommendTalentBtn" class="btn secondary" type="button">AI recommend</button>
                          <button id="aiAssignTopTalentBtn" class="btn secondary" type="button">Assign top picks</button>
                        </div>
                      </div>
                      <div style="height:10px"></div>
                      <div id="talentAiMsg" class="err"></div>
                      <div id="talentAiList"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="height:12px"></div>

              <button class="collapHdr" type="button" data-collapse-target="opsChecklistBody" aria-expanded="true">
                <div class="collapLeft">
                  <span>Checklist</span>
                  <span class="collapHint">Track deliverables for AM/management</span>
                </div>
                <span class="collapChev" data-collapse-chev>▲</span>
              </button>

              <div id="opsChecklistBody" class="collapBody">
                <div class="row" style="gap:12px; flex-wrap:wrap;">
                  <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="chkRecapReceived" type="checkbox" style="width:auto;" />
                    Recap received
                  </label>
                  <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="chkMediaReceived" type="checkbox" style="width:auto;" />
                    Media received
                  </label>
                  <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="chkFeedbackReceived" type="checkbox" style="width:auto;" />
                    Feedback received
                  </label>
                  <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="chkReportSent" type="checkbox" style="width:auto;" />
                    Report sent
                  </label>
                </div>

                <div style="height:10px"></div>
                <button id="saveChecklistBtn" class="btn secondary" type="button">Save checklist</button>

                <div style="height:12px"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.25);">
                  <div class="bd">
                    <button class="collapHdr" type="button" data-collapse-target="opsReportBody" aria-expanded="false">
                      <div class="collapLeft">
                        <span>Report</span>
                        <span class="collapHint">Draft + send</span>
                      </div>
                      <span class="collapChev" data-collapse-chev>▼</span>
                    </button>

                    <div id="opsReportBody" class="collapBody hide">
                      <div class="muted small" style="margin-top:2px;">Generate a clean report for account manager + management, then copy or send.</div>

                      <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap;">
                        <button id="genReportDraftBtn" class="btn secondary" type="button">Generate draft</button>
                        <button id="copyReportDraftBtn" class="btn secondary" type="button">Copy</button>
                        <button id="sendReportDraftBtn" class="btn" type="button">Send report</button>
                      </div>

                      <div id="reportSentLine" class="muted small" style="margin-top:8px;"></div>
                      <div style="height:8px"></div>
                      <textarea id="reportDraftText" style="min-height:180px; font-family: var(--mono);" placeholder="Generate a draft to preview here..."></textarea>
                      <div id="reportDraftMsg" class="err" style="margin-top:8px;"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="height:12px"></div>

              <button class="collapHdr" type="button" data-collapse-target="opsPlanBody" aria-expanded="false">
                <div class="collapLeft">
                  <span>Plan</span>
                  <span class="collapHint">Strategy + event type</span>
                </div>
                <span class="collapChev" data-collapse-chev>▼</span>
              </button>

              <div id="opsPlanBody" class="collapBody hide">
                <div class="two">
                  <div>
                    <label>Strategy</label>
                    <select id="planStrategy">
                      <option value="">Select…</option>
                      <option value="anchor">Anchor</option>
                      <option value="momentum">Momentum</option>
                    </select>
                  </div>
                  <div>
                    <label>Event type</label>
                    <select id="planEventType">
                      <option value="">Select…</option>
                    </select>
                    <div class="muted small" style="margin-top:6px;">Search and pick an event type.</div>
                    <div id="planEventTypeDetails" class="muted small" style="margin-top:8px;"></div>
                    <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
                      <input id="planEventTypeQ" placeholder="search event types (e.g. student, class B, DJ, trivia...)" style="max-width:420px;" />
                      <button id="planEventTypeSearchBtn" class="btn secondary" type="button">Search</button>
                      <button id="planEventTypeResetBtn" class="btn secondary" type="button">Reset</button>
                      <div id="planEventTypeMsg" class="err"></div>
                    </div>
                  </div>
                </div>

                <div style="height:12px"></div>

                <div class="card" style="background:#fff; border-color: rgba(199,154,59,.25);">
                  <div class="bd">
                    <div class="muted small">Vendors</div>
                    <div style="font-weight:900; margin-top:4px;">Pick vendors for this plan</div>
                    <div class="muted small" style="margin-top:4px;">Search by vendor type/name. Example: “mobile DJ”, “band”, “photo booth”.</div>

                    <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap; align-items:center;">
                      <input id="planVendorQ" placeholder="search vendors (mobile DJ, band, catering...)" style="max-width:420px;" />
                      <button id="planVendorSearchBtn" class="btn secondary" type="button">Search</button>
                      <button id="planVendorSuggestBtn" class="btn secondary" type="button">Suggest from event type</button>
                      <div id="planVendorMsg" class="err"></div>
                    </div>

                    <div id="planVendorResults" class="scrollCardList" style="margin-top:10px;"></div>

                    <div style="height:10px"></div>
                    <div class="muted small" style="font-weight:900;">Selected vendors</div>
                    <div id="planVendorSelected" style="margin-top:8px;"></div>
                  </div>
                </div>

                <div style="margin-top:10px;">
                  <label>Justification</label>
                  <textarea id="planJustification" placeholder="Why this strategy/type for this property?"></textarea>
                </div>
                <div class="row" style="margin-top:10px;">
                  <button id="savePlanBtn" class="btn secondary" type="button">Save plan</button>
                </div>
              </div>

              <div style="height:12px"></div>

              <button class="collapHdr" type="button" data-collapse-target="opsBudgetBody" aria-expanded="false">
                <div class="collapLeft">
                  <span>Budget</span>
                  <span class="collapHint">Host/media + expenses</span>
                </div>
                <span class="collapChev" data-collapse-chev>▼</span>
              </button>

              <div id="opsBudgetBody" class="collapBody hide">
                <div class="muted small">Constraint: host pay ≥ 75% of media pay (when media included)</div>
                <div style="height:10px"></div>

                <div class="two">
                  <div><label>Host pay ($)</label><input id="budHost" type="number" min="0" step="0.01" /></div>
                  <div><label>Media pay ($)</label><input id="budMedia" type="number" min="0" step="0.01" /></div>
                </div>

                <div class="two" style="margin-top:10px;">
                  <div><label>Food/catering ($)</label><input id="budFood" type="number" min="0" step="0.01" /></div>
                  <div><label>Decor ($)</label><input id="budDecor" type="number" min="0" step="0.01" /></div>
                </div>

                <div class="two" style="margin-top:10px;">
                  <div><label>Supplies ($)</label><input id="budSupplies" type="number" min="0" step="0.01" /></div>
                  <div><label>Contingency ($)</label><input id="budContingency" type="number" min="0" step="0.01" /></div>
                </div>

                <div style="margin-top:10px;" class="row">
                  <button id="saveBudgetBtn" class="btn secondary" type="button">Save budget</button>
                  <div id="budgetMsg" class="err"></div>
                </div>
              </div>

              <div style="height:12px"></div>

              <button class="collapHdr" type="button" data-collapse-target="opsVendorsBody" aria-expanded="false">
                <div class="collapLeft">
                  <span>Vendors & event types</span>
                  <span class="collapHint">Browse</span>
                </div>
                <span class="collapChev" data-collapse-chev>▼</span>
              </button>

              <div id="opsVendorsBody" class="collapBody hide">
                <div class="two">
                  <div>
                    <label>Browse vendors</label>
                    <input id="vendorQ" placeholder="search vendors (name, city, state, etc.)" />
                    <div class="row" style="margin-top:8px;">
                      <button id="loadVendorsBtn" class="btn secondary" type="button">Search</button>
                      <button id="suggestVendorsBtn" class="btn secondary" type="button">Suggest nearby</button>
                      <button id="aiSuggestVendorsBtn" class="btn secondary" type="button">AI suggest</button>
                      <div id="vendorsMsg" class="err"></div>
                    </div>
                    <div id="vendorsList" class="scrollCardList" style="margin-top:10px;"></div>
                  </div>
                  <div>
                    <label>Browse event types</label>
                    <input id="eventTypeQ" placeholder="search event types" />
                    <div class="row" style="margin-top:8px;">
                      <button id="loadEventTypesBtn" class="btn secondary" type="button">Search</button>
                      <div id="eventTypesMsg" class="err"></div>
                    </div>
                    <div id="eventTypesList" class="scrollCardList" style="margin-top:10px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewOffers" class="hide">
          <div class="row" style="justify-content:space-between; gap:12px; align-items:flex-end; flex-wrap:wrap; position:relative; z-index:40;">
            <div class="row" style="gap:8px; flex-wrap:wrap;">
              <select id="offersStatePick" style="max-width:240px">
                <option value="">All offers</option>
                <option value="open">open</option>
                <option value="sent">sent</option>
                <option value="pending">pending</option>
                <option value="accepted">accepted</option>
                <option value="declined">declined</option>
              </select>
              <button id="loadOffersBtn" class="btn secondary" type="button">Refresh</button>
            </div>
          </div>

          <div style="height:14px"></div>
          <div class="card" style="background:#fff;">
            <div class="bd" style="padding:0;">
              <div class="bd">
                <div id="offersMsg" class="err"></div>
              </div>
              <div style="overflow:auto; max-height:70vh;">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Date</th>
                      <th>Title</th>
                      <th>City</th>
                      <th>Offer</th>
                      <th>Role</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="offersTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>
          <div id="offersDetailWrap" class="card hide" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
                <div>
                  <div class="muted small">Offer</div>
                  <div id="offersDetailTitle" style="font-weight:900; margin-top:4px;"></div>
                  <div id="offersDetailMeta" class="muted small" style="margin-top:6px;"></div>
                </div>
                <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                  <button id="offersDetailCloseBtn" class="btn secondary small" type="button">Close</button>
                  <button id="offersDetailViewEventBtn" class="btn secondary small" type="button">View event ops</button>
                </div>
              </div>
              <div style="height:10px"></div>
              <div id="offersDetailBody"></div>
            </div>
          </div>
        </div>

        <div id="viewTalent" class="hide">
          <div id="talentProfileEditorCard" class="card" style="background:#fff;">
            <div class="bd">
              <div class="wizardTop">
                <div>
                  <div class="muted small">Talent profile</div>
                  <div style="font-weight:900; margin-top:4px;">Bio, location, specialties</div>
                  <div id="talentEditingLine" class="muted small" style="margin-top:4px;"></div>
                </div>
                <div class="wizardNav">
                  <div class="wizardSteps" aria-label="Talent steps">
                    <button id="talStep1" class="wizardStep" type="button">Basics</button>
                    <button id="talStep2" class="wizardStep" type="button">Profile</button>
                    <button id="talStep3" class="wizardStep" type="button">Notes</button>
                    <button id="talStep4" class="wizardStep hide" type="button">Step 4</button>
                  </div>
                  <button id="talentRefreshBtn" class="btn secondary" type="button">Refresh</button>
                  <button id="talentStopEditingBtn" class="btn secondary hide" type="button">Cancel</button>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="talentMsg" class="err"></div>

              <div id="talentStep1" class="talStep" data-step="1">
                <div class="row" style="justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
                  <div class="row" style="gap:12px; align-items:center;">
                    <div id="talAvatarCircle" class="avatarCircle lg" aria-label="Profile photo"></div>
                    <div>
                      <div class="muted small">Profile photo</div>
                      <div class="row" style="gap:8px; margin-top:6px; flex-wrap:wrap;">
                        <input id="talAvatarFile" type="file" accept="image/*" class="hide" />
                        <button id="talAvatarUploadBtn" class="btn secondary small" type="button">Upload</button>
                        <button id="talAvatarRemoveBtn" class="btn secondary small" type="button">Remove</button>
                      </div>
                    </div>
                  </div>
                  <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                    <button id="talSelfEditBtn" class="btn secondary" type="button">Edit profile</button>
                    <button id="talSelfCancelBtn" class="btn secondary hide" type="button">Cancel</button>
                  </div>
                </div>

                <div style="height:10px"></div>
                <div class="two">
                  <div>
                    <label>Display name</label>
                    <input id="talDisplayName" placeholder="Preferred name" />
                  </div>
                  <div>
                    <label>Role</label>
                    <select id="talRole">
                      <option value="">Select…</option>
                      <option value="event_host">Event Host</option>
                      <option value="media_team">Media Team</option>
                    </select>
                  </div>
                </div>

                <div class="two" style="margin-top:10px;">
                  <div>
                    <label>Home base city</label>
                    <input id="talCity" placeholder="Charlotte" />
                  </div>
                  <div>
                    <label>Home base state</label>
                    <input id="talState" placeholder="NC" />
                  </div>
                </div>
              </div>

              <div id="talentStep2" class="talStep hide" data-step="2">
                <div>
                  <div style="font-weight:900;">Talent provided</div>
                  <div class="muted small" style="margin-top:4px;">Only the talent can edit these fields.</div>
                </div>

                <div style="height:10px"></div>

                <div>
                  <label>Specialties</label>
                  <div class="chipAddRow">
                    <input id="talPublicSpecialtyInput" placeholder="Add a specialty" />
                    <button id="talPublicSpecialtyAdd" class="btn secondary small" type="button">＋</button>
                  </div>
                  <div id="talPublicSpecialties" class="chips" style="margin-top:8px;"></div>
                </div>

                <div style="margin-top:10px;">
                  <label>Tone / style</label>
                  <div class="chipAddRow">
                    <input id="talPublicToneInput" placeholder="Add a tone" />
                    <button id="talPublicToneAdd" class="btn secondary small" type="button">＋</button>
                  </div>
                  <div id="talPublicTone" class="chips" style="margin-top:8px;"></div>
                </div>

                <div style="margin-top:10px;">
                  <label>Gear / capabilities</label>
                  <div class="chipAddRow">
                    <input id="talPublicGearInput" placeholder="Add a gear/capability" />
                    <button id="talPublicGearAdd" class="btn secondary small" type="button">＋</button>
                  </div>
                  <div id="talPublicGear" class="chips" style="margin-top:8px;"></div>
                </div>

                <div style="margin-top:10px;">
                  <label>Bio</label>
                  <textarea id="talBio" placeholder="Short bio used for matching and reporting"></textarea>
                </div>

                <div id="talInternalProfileBox" style="margin-top:14px;" class="hide">
                  <div style="font-weight:900;">Coordinator tags</div>
                  <div class="muted small" style="margin-top:4px;">Internal tags for staffing decisions (editable by coordinators).</div>

                  <div style="height:10px"></div>

                  <div>
                    <label>Specialties</label>
                    <div class="chipAddRow">
                      <input id="talInternalSpecialtyInput" placeholder="Add a specialty" />
                      <button id="talInternalSpecialtyAdd" class="btn secondary small" type="button">＋</button>
                    </div>
                    <div id="talInternalSpecialties" class="chips" style="margin-top:8px;"></div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Tone / style</label>
                    <div class="chipAddRow">
                      <input id="talInternalToneInput" placeholder="Add a tone" />
                      <button id="talInternalToneAdd" class="btn secondary small" type="button">＋</button>
                    </div>
                    <div id="talInternalTone" class="chips" style="margin-top:8px;"></div>
                  </div>

                  <div style="margin-top:10px;">
                    <label>Gear / capabilities</label>
                    <div class="chipAddRow">
                      <input id="talInternalGearInput" placeholder="Add gear/capability" />
                      <button id="talInternalGearAdd" class="btn secondary small" type="button">＋</button>
                    </div>
                    <div id="talInternalGear" class="chips" style="margin-top:8px;"></div>
                  </div>
                </div>
              </div>

              <div id="talentStep3" class="talStep hide" data-step="3">
                <div>
                  <label>Preferred pairings</label>
                  <div class="row" style="gap:8px; flex-wrap:wrap;">
                    <button id="talPublicPairingsAdd" class="btn secondary small" type="button">Add pairing</button>
                    <div class="muted small">Pick from Event Hosts + Media Team.</div>
                  </div>
                  <div id="talPublicPairings" class="chips" style="margin-top:8px;"></div>
                </div>

                <div id="talInternalNotesBox" class="hide" style="margin-top:12px;">
                  <label>Internal notes</label>
                  <textarea id="talInternalNotes"></textarea>
                </div>

                <div id="talPublicNotesBox" style="margin-top:12px;">
                  <label>Notes</label>
                  <textarea id="talPublicNotes" placeholder="Private notes you want to remember."></textarea>
                </div>
              </div>

              <div id="talentStep4" class="talStep hide" data-step="4">
                <div id="talReliabilityBox" class="hide">
                  <div style="font-weight:900;">Reliability</div>
                  <div class="muted small" style="margin-top:4px;">Internal coordinator rating used for staffing decisions.</div>

                  <div style="height:10px"></div>
                  <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap;">
                    <div>
                      <label>Reliability score</label>
                      <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
                        <input id="talReliabilityScore" class="relRange" type="range" min="0" max="100" step="1" />
                        <div id="talReliabilityScoreLabel" class="relBadge">Unrated</div>
                      </div>
                    </div>
                  </div>

                  <div style="margin-top:12px;">
                    <label>Reliability flags</label>
                    <div class="chipAddRow">
                      <input id="talReliabilityFlagInput" placeholder="Add a flag" />
                      <button id="talReliabilityFlagAdd" class="btn secondary small" type="button">＋</button>
                    </div>
                    <div id="talReliabilityFlags" class="chips" style="margin-top:8px;"></div>
                  </div>
                </div>

                <div id="talAvailabilityBox" class="hide">
                  <div style="font-weight:900;">Availability</div>
                  <div class="muted small" style="margin-top:4px;">Select times you are available. Times are shown in your local timezone (<span id="talAvailTzLabel"></span>).</div>

                  <div style="height:10px"></div>
                  <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
                    <div class="muted small" id="talAvailWeekLabel">—</div>
                    <div class="row" style="gap:8px; flex-wrap:wrap;">
                      <button id="talAvailPrevWeek" class="btn secondary" type="button">Prev week</button>
                      <button id="talAvailToday" class="btn secondary" type="button">This week</button>
                      <button id="talAvailNextWeek" class="btn secondary" type="button">Next week</button>
                      <button id="talAvailClearWeek" class="btn secondary" type="button">Clear week</button>
                      <button id="talAvailSaveBtn" class="btn" type="button">Save</button>
                    </div>
                  </div>

                  <div style="height:10px"></div>
                  <div id="talAvailMsg" class="err"></div>

                  <div class="availGridWrap" style="margin-top:10px;">
                    <div class="availWeekGrid" id="talAvailWeekGrid"></div>
                  </div>
                </div>
              </div>

              <div class="row" style="margin-top:12px; justify-content:space-between;">
                <div class="row" style="gap:8px;">
                  <button id="talPrevBtn" class="btn secondary" type="button">Back</button>
                  <button id="talNextBtn" class="btn secondary" type="button">Next</button>
                </div>
                <button id="talentSaveBtn" class="btn" type="button">Save profile</button>
              </div>
            </div>
          </div>

          <div id="talentDirectoryWrap" class="card hide" style="margin-top:14px; background:#fff;">
            <div class="bd">
              <div class="muted small">Coordinator tools</div>
              <div class="collapHdr" style="margin-top:8px;">
                <div class="collapLeft">
                  <span>Talent directory</span>
                  <span class="collapHint">Browse and search talent profiles</span>
                </div>
              </div>

              <div id="talentDirBody" class="collapBody">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
                  <div class="muted small">Search</div>
                  <div style="max-width:360px; width:100%;">
                    <input id="talentQ" placeholder="search by name, city/state, specialty" />
                  </div>
                </div>

                <div style="height:10px"></div>
                <div id="talentDirMsg" class="err"></div>

                <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px; margin-top:8px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Talent</th>
                        <th>Role</th>
                        <th>Reliability</th>
                        <th>Availability</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="talentUsersTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewPayments" class="hide">
          <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
            <div>
              <div class="muted small">Finance</div>
              <div style="font-weight:900; margin-top:4px;">Payouts</div>
            </div>
            <div class="row" style="gap:8px; flex-wrap:wrap;">
              <select id="payoutsPeriodPick" style="min-width:150px;">
                <option value="0">All time</option>
                <option value="7">Last 7 days</option>
                <option value="30">Last 30 days</option>
              </select>
              <select id="payoutsStatusPick" style="min-width:150px;">
                <option value="">All statuses</option>
                <option value="paid">Paid</option>
                <option value="pending">Pending</option>
              </select>
              <input id="payoutsQ" placeholder="Search payouts" style="min-width:220px; max-width:320px;" />
              <button id="payoutsSearchBtn" class="btn secondary" type="button">Search</button>
              <button id="loadPayoutsBtn" class="btn secondary" type="button">Refresh</button>
            </div>
          </div>
          <div style="height:14px"></div>
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div id="payoutsMsg" class="err"></div>
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; margin-top:6px;">
                <div>
                  <div id="payoutsTotals" class="muted small"></div>
                  <div id="payoutsTotalBig" style="font-weight:950; font-size:34px; letter-spacing:-0.02em; margin-top:2px;">$0.00</div>
                  <div id="payoutsTotalsSub" class="muted small" style="margin-top:4px;"></div>
                </div>
              </div>
              <div id="payoutsEmpty" class="muted small" style="margin-top:10px;"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px; margin-top:10px;">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Description</th>
                    </tr>
                  </thead>
                  <tbody id="payoutsTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="viewManager" class="hide">
          <div class="segTabs" style="gap:8px; margin-bottom:12px;">
            <button id="mgrSegStats" class="segBtn" type="button">Stats</button>
            <button id="mgrSegTasks" class="segBtn" type="button">Tasks</button>
            <button id="mgrSegUsers" class="segBtn" type="button">Users</button>
          </div>

          <div id="mgrPaneStats" class="hide">
          <div id="mgrStatsCard" class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div class="muted small">Operations</div>
                  <div style="font-weight:900; margin-top:4px;">Stats</div>
                </div>
              </div>
              <div style="height:10px"></div>
              <div id="statsMsg" class="err"></div>
              <div id="statsBox" class="row" style="gap:10px; flex-wrap:wrap;"></div>
            </div>
          </div>

          </div>

          <div id="mgrPaneTasks" class="hide">
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Tasks</div>
                  <div class="muted small">Create and manage operational tasks</div>
                </div>
                <div class="row">
                  <label class="muted small" style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="dispatchOverdueOnly" type="checkbox" style="width:auto;" />
                    Overdue only
                  </label>
                  <button id="scanDispatchBtn" class="btn secondary" type="button">Scan overdue</button>
                  <button id="loadDispatchBtn" class="btn secondary" type="button">Load tasks</button>
                </div>
              </div>

              <div style="height:12px"></div>
              <div class="two">
                <div>
                  <label>Status filter</label>
                  <select id="dispatchStatus">
                    <option value="">Open and assigned</option>
                    <option value="open">open</option>
                    <option value="assigned">assigned</option>
                    <option value="completed">completed</option>
                    <option value="cancelled">cancelled</option>
                  </select>
                </div>
                <div>
                  <label>Assigned role filter</label>
                  <select id="dispatchRole">
                    <option value="">All roles</option>
                    <option value="dialer">Remote Setter</option>
                    <option value="in_person_setter">In Person Setter</option>
                    <option value="closer">Closer</option>
                    <option value="event_host">Event Host</option>
                    <option value="event_coordinator">Event Coordinator</option>
                    <option value="media_team">Media Team</option>
                  </select>
                </div>
              </div>

              <div style="height:10px"></div>
              <div id="dispatchMsg" class="err"></div>

              <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35);">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
                    <div style="font-weight:900;">Create task</div>
                    <button class="btn secondary small" type="button" data-collapse-target="dispatchCreateBody" aria-expanded="false" title="Collapse/expand">
                      <span data-collapse-chev>▼</span>
                    </button>
                  </div>
                  <div style="height:10px"></div>

                  <div id="dispatchCreateBody" class="hide">
                    <div class="two">
                      <div>
                        <label>Lead ID (optional)</label>
                        <input id="dispatchLeadId" placeholder="123" />
                        <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
                          <button id="dispatchPickLead" class="btn secondary small" type="button">Pick from Leads</button>
                          <button id="dispatchUseSelectedLead" class="btn secondary small" type="button">Use selected</button>
                          <div class="muted small" id="dispatchLeadLine">None</div>
                        </div>
                      </div>
                      <div>
                        <label>Assigned role</label>
                        <select id="dispatchAssignedRole">
                          <option value="">Select…</option>
                          <option value="dialer">Remote Setter</option>
                          <option value="in_person_setter">In Person Setter</option>
                          <option value="closer">Closer</option>
                          <option value="event_host">Event Host</option>
                          <option value="event_coordinator">Event Coordinator</option>
                          <option value="media_team">Media Team</option>
                        </select>
                      </div>
                    </div>

                    <div style="margin-top:10px;">
                      <label>Title</label>
                      <input id="dispatchTitle" placeholder="Example: Pull comps and prep talking points" />
                    </div>

                    <div class="two" style="margin-top:10px;">
                      <div>
                        <label>Due date</label>
                        <input id="dispatchDueDate" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                      </div>
                      <div>
                        <label>Due time</label>
                        <input id="dispatchDueTime" type="text" data-picker="time" placeholder="HH:MM" />
                      </div>
                    </div>

                    <div style="margin-top:10px;">
                      <label>Priority</label>
                      <select id="dispatchPriority">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="-1">-1</option>
                        <option value="-2">-2</option>
                        <option value="-3">-3</option>
                        <option value="-4">-4</option>
                        <option value="-5">-5</option>
                      </select>
                    </div>

                    <div style="margin-top:10px;">
                      <label>Notes</label>
                      <textarea id="dispatchNotes" placeholder="Context and expected output."></textarea>
                    </div>

                    <div class="row" style="margin-top:10px;">
                      <button id="dispatchCreateBtn" class="btn" type="button">Create</button>
                      <div id="dispatchCreateMsg" class="err"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="height:12px"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Due</th>
                      <th>Title</th>
                      <th>Role</th>
                      <th>Assigned</th>
                      <th>Lead</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="dispatchTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>
          <div class="muted small">Tip: keep Tasks scoped by role + status.</div>
          </div>

          <div id="mgrPaneUsers" class="hide">
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
                <div>
                  <div style="font-weight:900;">Users</div>
                  <div class="muted small">Team roster and availability</div>
                </div>
              </div>
              <div style="height:14px"></div>
              <div id="usersMsg" class="err"></div>
              <div style="overflow:auto; border:1px solid var(--border); border-radius: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Availability</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="usersTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
        </section>

    <div id="scheduleModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-label="Schedule meeting">
      <div class="modal sm">
        <div class="modalHd">
          <div>
            <div class="t" id="scheduleModalTitle">Schedule meeting</div>
            <div class="muted small" id="scheduleModalSub">For selected lead</div>
          </div>
          <div class="row" style="gap:8px;">
            <button id="schedulePickLead" class="btn secondary" type="button">Pick from Leads</button>
            <button id="scheduleClose" class="btn secondary" type="button">Close</button>
          </div>
        </div>
        <div class="modalBd">
          <div class="card" style="background:#fff; border-color: rgba(199,154,59,.35); box-shadow:none;">
            <div class="bd">
              <div class="muted small">Selected lead</div>
              <div id="scheduleLeadLine" style="font-weight:900; margin-top:4px;">None</div>

              <div style="height:12px"></div>
              <div class="two">
                <div>
                  <label>Date</label>
                  <input id="scheduleDate" type="text" data-picker="date" placeholder="YYYY-MM-DD" />
                </div>
                <div>
                  <label>Start time</label>
                  <input id="scheduleStart" type="text" data-picker="time" placeholder="HH:MM" />
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Notes</label>
                <textarea id="scheduleNotes" placeholder="Agenda and next steps."></textarea>
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="scheduleSaveBtn" class="btn" type="button">Schedule</button>
                <button id="scheduleClearLead" class="btn secondary" type="button">Clear lead</button>
                <div id="scheduleMsg" class="err"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="peoplePickModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-label="Pick person">
      <div class="modal">
        <div class="modalHd">
          <div>
            <div class="t" id="peoplePickTitle">Pick person</div>
            <div class="muted small" id="peoplePickSub">Event hosts + media team</div>
          </div>
          <div class="row" style="gap:8px;">
            <button id="peoplePickClose" class="btn secondary" type="button">Close</button>
          </div>
        </div>
        <div class="modalBd">
          <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
            <input id="peoplePickQ" placeholder="Search by name or email" style="min-width:240px;" />
            <div class="muted small" id="peoplePickCount"></div>
          </div>
          <div style="height:10px"></div>
          <div id="peoplePickList" class="modalList"></div>
        </div>
      </div>
    </div>

    <div id="avatarCropModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-label="Crop profile photo">
      <div class="modal sm">
        <div class="modalHd">
          <div>
            <div class="t">Crop photo</div>
            <div class="muted small">Drag to position, then save.</div>
          </div>
          <div class="row" style="gap:8px;">
            <button id="avatarCropCancel" class="btn secondary" type="button">Cancel</button>
            <button id="avatarCropSave" class="btn" type="button">Save</button>
          </div>
        </div>
        <div class="modalBd">
          <div class="row" style="justify-content:center;">
            <div id="avatarCropBox" class="cropBox">
              <img id="avatarCropImg" alt="Crop" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div>
            <label>Zoom</label>
            <input id="avatarCropZoom" type="range" min="1" max="3" step="0.01" value="1" />
          </div>
          <div style="height:10px"></div>
          <div id="avatarCropMsg" class="err"></div>
        </div>
      </div>
    </div>

    <div id="pipelineModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-label="Pipeline stage">
      <div class="modal">
        <div class="modalHd">
          <div>
            <div class="t" id="pipelineModalTitle">Pipeline</div>
            <div class="muted small" id="pipelineModalSub">—</div>
          </div>
          <div class="row" style="gap:8px;">
            <button id="pipelinePrev" class="btn secondary" type="button">Prev</button>
            <button id="pipelineNext" class="btn secondary" type="button">Next</button>
            <button id="pipelineClose" class="btn secondary" type="button">Close</button>
          </div>
        </div>
        <div class="modalBd">
          <div class="modalTwo">
            <div>
              <div class="muted small" style="font-weight:900;">Leads</div>
              <div style="height:8px"></div>
              <div id="pipelineModalList" class="modalList"></div>
            </div>
            <div>
              <div class="muted small" style="font-weight:900;">Lead</div>
              <div style="height:8px"></div>
              <div id="pipelineModalDetail" class="modalDetail"></div>
              <div class="row" style="margin-top:10px;">
                <button id="pipelineOpenLead" class="btn" type="button">Open lead</button>
              </div>
              <div class="muted small" style="margin-top:8px;">Tip: click a lead, then Prev/Next to browse.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    (function stripCloudflareChallengeParams(){
      try{
        const u = new URL(window.location.href);
        let changed = false;
        for (const k of Array.from(u.searchParams.keys())){
          if (k.startsWith('__cf_chl_') || k.startsWith('cf_chl_')) {
            u.searchParams.delete(k);
            changed = true;
          }
        }
        if (changed) {
          const qs = u.searchParams.toString();
          const next = u.pathname + (qs ? ('?' + qs) : '') + (u.hash || '');
          window.history.replaceState({}, '', next);
        }
      } catch(_e) {}
    })();

    const $ = (id) => document.getElementById(id);

    const enhancedSelects = new Map();

    function selectSignature(sel){
      try{
        const parts = [];
        for (const o of Array.from(sel?.options || [])) {
          parts.push([String(o.value), String(o.textContent || ''), o.disabled ? '1' : '0'].join('\u0001'));
        }
        return parts.join('\u0002');
      } catch { return ''; }
    }

    function closeAllDdMenus(){
      for (const { btn, menu } of enhancedSelects.values()){
        if (menu && !menu.classList.contains('hide')) menu.classList.add('hide');
        if (btn) btn.setAttribute('aria-expanded', 'false');
      }
    }

    function buildEnhancedSelectMenu(sel){
      const entry = enhancedSelects.get(sel);
      if (!entry) return;
      const { menu } = entry;
      if (!menu) return;

      const opts = Array.from(sel.options || []);
      menu.innerHTML = opts.map((o, idx) => {
        const v = String(o.value);
        const t = String(o.textContent || o.label || v);
        const dis = o.disabled ? 'disabled' : '';
        return `<button type="button" class="ddItem" role="option" data-dd-value="${escapeHtml(v)}" data-dd-idx="${idx}" ${dis}>${escapeHtml(t || '—')}</button>`;
      }).join('');

      for (const item of menu.querySelectorAll('button[data-dd-idx]')){
        item.addEventListener('click', () => {
          if (item.disabled) return;
          const idx = Number(item.dataset.ddIdx || -1);
          const opt = sel.options && sel.options[idx];
          if (!opt) return;
          sel.value = String(opt.value);
          sel.dispatchEvent(new Event('change', { bubbles: true }));
          syncEnhancedSelect(sel);
          closeAllDdMenus();
        });
      }
    }

    function syncEnhancedSelect(sel){
      const entry = enhancedSelects.get(sel);
      if (!entry) return;
      const { btn, menu, labelEl } = entry;
      if (!btn || !labelEl) return;

      const sig = selectSignature(sel);
      if (sig !== entry.sig) {
        entry.sig = sig;
        buildEnhancedSelectMenu(sel);
      }

      const opt = sel.selectedOptions && sel.selectedOptions[0]
        ? sel.selectedOptions[0]
        : (sel.options ? sel.options[sel.selectedIndex] : null);
      const txt = opt ? String(opt.textContent || opt.label || opt.value || '') : '';
      labelEl.textContent = txt || 'Select…';

      btn.disabled = !!sel.disabled;

      if (menu) {
        for (const item of menu.querySelectorAll('button.ddItem')){
          const v = String(item.dataset.ddValue || '');
          item.classList.toggle('active', String(sel.value) === v);
        }
      }
    }

    function enhanceSelect(sel){
      if (!sel || !(sel instanceof HTMLSelectElement)) return;
      if (enhancedSelects.has(sel)) return;
      if (sel.closest('.dd')) return;
      if (sel.dataset && sel.dataset.noEnhance === '1') return;

      const parent = sel.parentNode;
      if (!parent) return;

      const wrap = document.createElement('div');
      wrap.className = 'dd';

      // Preserve inline sizing styles on the original select.
      const inlineStyle = sel.getAttribute('style');
      if (inlineStyle) {
        wrap.setAttribute('style', inlineStyle);
        sel.removeAttribute('style');
      }

      parent.insertBefore(wrap, sel);
      wrap.appendChild(sel);

      sel.classList.add('nativeSelectHidden');

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'ddBtn';
      btn.setAttribute('aria-haspopup', 'listbox');
      btn.setAttribute('aria-expanded', 'false');

      const labelEl = document.createElement('span');
      labelEl.textContent = 'Select…';
      const caret = document.createElement('span');
      caret.innerHTML = '&#9662;';
      caret.setAttribute('aria-hidden', 'true');
      caret.style.opacity = '0.6';
      caret.style.fontSize = '12px';

      btn.appendChild(labelEl);
      btn.appendChild(caret);

      const menu = document.createElement('div');
      menu.className = 'ddMenu hide';
      menu.setAttribute('role', 'listbox');

      wrap.appendChild(btn);
      wrap.appendChild(menu);

      enhancedSelects.set(sel, { wrap, btn, menu, labelEl, sig: '' });
      buildEnhancedSelectMenu(sel);
      syncEnhancedSelect(sel);

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const open = !menu.classList.contains('hide');
        closeAllDdMenus();
        if (!open) {
          menu.classList.remove('hide');
          btn.setAttribute('aria-expanded', 'true');
        }
      });

      sel.addEventListener('change', () => syncEnhancedSelect(sel));
    }

    function enhanceAllSelects(){
      for (const sel of document.querySelectorAll('select')) {
        enhanceSelect(sel);
      }
    }

    // Keep custom dropdown labels in sync with programmatic select.value changes.
    setInterval(() => {
      for (const sel of enhancedSelects.keys()) syncEnhancedSelect(sel);
    }, 600);

    document.addEventListener('click', (ev) => {
      // Click outside closes any open menus.
      if (!(ev.target instanceof Element)) { closeAllDdMenus(); return; }
      if (!ev.target.closest('.dd')) closeAllDdMenus();
    });

    function setAuthLoading(loading, label){
      const loginBtn = $('loginBtn');
      const signupBtn = $('signupBtn');
      if (loginBtn) {
        loginBtn.disabled = !!loading;
        loginBtn.textContent = loading ? (label || 'Signing in…') : 'Sign in';
      }
      if (signupBtn) {
        signupBtn.disabled = !!loading;
        signupBtn.textContent = loading ? 'Working…' : 'Create account';
      }
      const ok = $('authOk');
      if (ok) ok.innerHTML = loading ? `<span class="spin"></span> ${escapeHtml(label || 'Signing in…')}` : '';
    }

    function withTimeout(promise, ms, label){
      let t;
      const timeout = new Promise((_, rej) => {
        t = setTimeout(() => rej(new Error(label || 'request_timeout')), ms);
      });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    }

    // If something breaks in JS, surface it instead of silently doing nothing.
    window.addEventListener('error', (ev) => {
      const msg = String(ev?.message || 'script_error');
      const el = $('authMsg');
      if (el) el.textContent = msg;
    });
    window.addEventListener('unhandledrejection', (ev) => {
      const msg = String(ev?.reason?.message || ev?.reason || 'promise_rejection');
      const el = $('authMsg');
      if (el) el.textContent = msg;
    });

    const state = {
      token: '',
      me: null,
      activeTab: 'overview',
      meetingsSubtab: 'list',
      eventsSubtab: 'all',
      payoutsPeriodDays: 30,
      managerSubtab: '',
      viewAsRole: '',
      viewAsUserId: '',
      dialerSubtab: 'call',
      closerSubtab: 'disposition',
      leads: [],
      selectedLead: null,
      events: [],
      selectedEvent: null,
      pendingSelectEventId: null,
      offers: [],
      selectedOfferEventId: null,
      appointments: [],
      dispatch: [],
      pickLeadReturnTab: 'calls',
      usersCache: [],
      talent: {
        my: null,
        profiles: [],
        editUserId: '',
        q: '',
        qTimer: null,
        step: 1,
        selfEditing: false,
        form: null,
        avail: { weekOffset: 0, byDate: {}, tz: '', drag: { active: false, mode: '' }, viewUserId: '' },
      },
      closerQueue: [],
      allowedTabs: null,
      ui: { sidebarCollapsed: false, collapse: {}, _opsCollapseInit: false },
      availability: { weekOffset: 0, byDate: {}, tz: '', drag: { active: false, mode: '' } },
    };

    state.peoplePick = { open: false, q: '', onPick: null };
    state.avatarCrop = { open: false, dataUrl: '', dx: 0, dy: 0, zoom: 1, _drag: null };
    state._availabilityCache = {}; // userId -> { loadedAt, availability }

    const scheduleModalState = { after: null };

    function setSessionTokens(session){
      const s = (session && typeof session === 'object') ? session : {};
      const access = String(s.access_token || '').trim();
      const refresh = String(s.refresh_token || '').trim();
      const expiresAt = s.expires_at != null ? String(s.expires_at).trim() : '';
      if (access) {
        state.token = access;
        localStorage.setItem('portal_access_token', access);
      }
      if (refresh) {
        state.refreshToken = refresh;
        localStorage.setItem('portal_refresh_token', refresh);
      }
      if (expiresAt) {
        state.expiresAt = expiresAt;
        localStorage.setItem('portal_expires_at', expiresAt);
      }
    }

    function clearSession(){
      state.token = '';
      state.refreshToken = '';
      state.expiresAt = '';
      localStorage.removeItem('portal_access_token');
      localStorage.removeItem('portal_refresh_token');
      localStorage.removeItem('portal_expires_at');
    }

    async function refreshSessionToken(){
      const refresh = String(state.refreshToken || '').trim() || String(localStorage.getItem('portal_refresh_token') || '').trim();
      if (!refresh) throw new Error('missing_refresh_token');

      const r = await withTimeout(fetch('/api/portal/refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ refresh_token: refresh }),
      }), 15000, 'refresh_timeout');

      const j = await r.json().catch(() => null);
      if (!j || !j.ok) {
        const msg = String(j?.error || ('http_' + r.status));
        const det = String(j?.detail || '').trim();
        throw new Error(det ? (msg + ': ' + det) : msg);
      }

      setSessionTokens(j.session || {});
      return true;
    }

    function restoreUiPrefs(){ /* sidebar is no longer collapsible */ }

    function setMeetingsSubtab(next){
      state.meetingsSubtab = String(next || 'list');
      renderMeetingsSubtab();
      // Load data for the active pane.
      if (state.activeTab === 'meetings') {
        if (state.meetingsSubtab === 'availability') loadAvailability().catch(()=>{});
        else loadAppointmentsInto('meetingsTbody', 'meetingsMsg').catch(()=>{});
      }
    }

    function setPayoutsPeriodDays(days){
      const d = Number(days || 0);
      state.payoutsPeriodDays = Number.isFinite(d) ? Math.max(0, Math.trunc(d)) : 0;
      renderPayoutsPeriodSeg();
      if (state.activeTab === 'payments') {
        loadPayouts().catch(()=>{});
      }
    }

    function setManagerSubtab(next){
      const canSeeUsers = isManagerUser();
      let n = String(next || 'tasks');
      if (n === 'users' && !canSeeUsers) n = 'tasks';
      state.managerSubtab = n;
      renderManagerSubtab();

      if (state.activeTab === 'manager') {
        if (state.managerSubtab === 'stats') {
          if (['manager','event_coordinator'].includes(effectiveRole())) loadStats().catch(()=>{});
        }
        if (state.managerSubtab === 'tasks') {
          // Default: keep the create-task panel collapsed.
          if ($('dispatchCreateBody')) restoreCollapsedFromState('dispatchCreateBody', true);
          loadDispatchManager().catch(()=>{});
        }
        if (state.managerSubtab === 'users') {
          loadUsers().catch(() => {});
        }
      }
    }

    function renderManagerSubtab(){
      const canSeeUsers = isManagerUser();
      const usersBtn = $('mgrSegUsers');
      const usersPane = $('mgrPaneUsers');
      if (usersBtn) usersBtn.classList.toggle('hide', !canSeeUsers);

      const t0raw = String(state.managerSubtab || 'tasks');
      const t0 = (!canSeeUsers && t0raw === 'users') ? 'tasks' : t0raw;
      const map = {
        stats: { btn: 'mgrSegStats', pane: 'mgrPaneStats' },
        tasks: { btn: 'mgrSegTasks', pane: 'mgrPaneTasks' },
        users: { btn: 'mgrSegUsers', pane: 'mgrPaneUsers' },
      };
      const t = map[t0] ? t0 : 'tasks';
      if (t !== t0) state.managerSubtab = t;
      for (const k of Object.keys(map)){
        if (k === 'users' && !canSeeUsers) {
          if (usersPane) usersPane.classList.add('hide');
          continue;
        }
        const btn = $(map[k].btn);
        const pane = $(map[k].pane);
        if (btn) btn.classList.toggle('active', k === t);
        if (pane) pane.classList.toggle('hide', k !== t);
      }
    }

    function openScheduleModal({ after } = {}){
      const modal = $('scheduleModal');
      if (!modal) return;
      scheduleModalState.after = typeof after === 'function' ? after : null;
      const lead = state.selectedLead;
      const line = $('scheduleLeadLine');
      if (line) line.textContent = lead ? leadLabelLine(lead) : 'None';
      if ($('scheduleMsg')) $('scheduleMsg').textContent = '';
      modal.classList.add('show');
      initPickersOnce();
    }

    function closeScheduleModal(){
      const modal = $('scheduleModal');
      if (!modal) return;
      modal.classList.remove('show');
      scheduleModalState.after = null;
      if ($('scheduleMsg')) $('scheduleMsg').textContent = '';
    }

    async function scheduleFromModal(){
      return scheduleAppointmentFrom({
        dateId: 'scheduleDate',
        timeId: 'scheduleStart',
        notesId: 'scheduleNotes',
        msgId: 'scheduleMsg',
        after: async () => {
          if (scheduleModalState.after) await scheduleModalState.after();
          closeScheduleModal();
        }
      });
    }

    function renderMeetingsSubtab(){
      const t = String(state.meetingsSubtab || 'list');
      const er = effectiveRole();
      const map = {
        list: { btn: 'meetingsSegList', pane: 'meetingsPaneList' },
        availability: { btn: 'meetingsSegAvailability', pane: 'meetingsPaneAvailability' },
      };
      // Event roles only need availability here.
      const listBtn = $(map.list.btn);
      if (listBtn) listBtn.classList.toggle('hide', ['event_host','media_team'].includes(er));
      const keys = Object.keys(map);
      for (const k of keys) {
        const btn = $(map[k].btn);
        const pane = $(map[k].pane);
        if (btn) btn.classList.toggle('active', k === t);
        if (pane) pane.classList.toggle('hide', k !== t);
      }
    }

    function renderPayoutsPeriodSeg(){
      const days = Number(state.payoutsPeriodDays || 0);
      const pick = $('payoutsPeriodPick');
      if (pick) pick.value = String(Number.isFinite(days) ? Math.max(0, Math.trunc(days)) : 0);
      const status = $('payoutsStatusPick');
      if (status) status.value = String(state.payoutsStatus || '');
      const q = $('payoutsQ');
      if (q) q.value = String(state.payoutsQ || '');
    }

    function renderEventsSubtabSeg(){
      const t0 = String(state.eventsSubtab || 'all');
      const canAll = canSeeAllEventsForRole();
      const t = (!canAll && t0 === 'all') ? 'my' : t0;
      if (t !== t0) state.eventsSubtab = t;
      const btnMy = $('eventsSegMy');
      const btnAll = $('eventsSegAll');
      if (btnAll) btnAll.classList.toggle('hide', !canAll);
      if (btnMy) btnMy.classList.toggle('active', t === 'my');
      if (btnAll) btnAll.classList.toggle('active', t === 'all');
    }

    function canSeeAllEventsForRole(){
      const er = effectiveRole();
      if (!['event_host','media_team'].includes(er)) return true;
      // Hosts/Media should not see "All" unless a real manager is previewing.
      return isManagerUser();
    }

    function setEventsSubtab(next){
      const t0 = String(next || 'all');
      const canAll = canSeeAllEventsForRole();
      const next0 = (!canAll && t0 === 'all') ? 'my' : t0;
      const t = (next0 === 'my' || next0 === 'all' || next0 === 'offers') ? next0 : (canAll ? 'all' : 'my');
      state.eventsSubtab = t;
      renderEventsSubtabSeg();
      loadEvents().catch(() => {});
    }

    function getEventAssignments(ev){
      const e = (ev && typeof ev === 'object') ? ev : {};
      const meta = (e.meta && typeof e.meta === 'object') ? e.meta : {};
      return Array.isArray(meta.assignments) ? meta.assignments : [];
    }

    function myAssignmentForEvent(ev, role, userId){
      const uid = String(userId || '').trim();
      if (!uid) return null;
      const r = String(role || '').trim();
      const arr = getEventAssignments(ev);
      const hit = arr.find((a) => String(a?.userId || '').trim() === uid && (!r || String(a?.role || '').trim() === r));
      return hit && typeof hit === 'object' ? hit : null;
    }

    function eventIsMineForRole(ev, role, userId){
      const uid = String(userId || '').trim();
      if (!uid) return false;
      const e = (ev && typeof ev === 'object') ? ev : {};
      if (String(e.assigned_user_id || '') === uid) return true;
      const a = myAssignmentForEvent(e, role, uid);
      return String(a?.status || '').trim() === 'accepted';
    }

    async function respondAssignmentForEvent(eventId, role, decision){
      const eventIdNum = Number(eventId);
      if (!Number.isFinite(eventIdNum) || eventIdNum <= 0) throw new Error('invalid_event_id');
      const r = String(role || '').trim();
      const d = String(decision || '').trim();
      await api('/api/portal/event_assignments', { method: 'PATCH', body: { action: 'respond', eventId: eventIdNum, role: r, decision: d } });
    }

    function setBadge(kind, text){
      const b = $('viewBadge');
      if (!b) return;
      b.textContent = '';
      b.className = 'badge dot' + (kind ? (' ' + kind) : '');
    }

    const ROLE_ORDER = [
      'dialer',
      'remote_setter',
      'in_person_setter',
      'closer',
      'account_manager',
      'event_host',
      'event_coordinator',
      'media_team',
      'manager',
    ];

    const MANAGER_VIEW_OPTIONS = [
      { role: 'manager', label: 'Manager' },
      { role: 'remote_setter', label: 'Remote Setter' },
      { role: 'in_person_setter', label: 'In Person Setter' },
      { role: 'closer', label: 'Closer' },
      { role: 'account_manager', label: 'Account Manager' },
      { role: 'event_host', label: 'Event Host' },
      { role: 'event_coordinator', label: 'Event Coordinator' },
      { role: 'media_team', label: 'Media Team' },
    ];

    function roleViewLabel(role){
      const r = String(role || '').trim();
      const map = {
        dialer: 'Remote Setter',
        remote_setter: 'Remote Setter',
        in_person_setter: 'In Person Setter',
        closer: 'Closer',
        account_manager: 'Account Manager',
        event_host: 'Event Host',
        event_coordinator: 'Event Coordinator',
        media_team: 'Media Team',
        manager: 'Manager',
      };
      return map[r] || (r ? r.replaceAll('_', ' ') : '—');
    }

    function viewingLabel(role){
      return roleViewLabel(role);
    }

    function roleLabel(role){
      return roleViewLabel(role);
    }

    function myRole(){
      return String(state.me?.profile?.role || '').trim();
    }

    function isManagerUser(){
      return myRole() === 'manager';
    }

    function effectiveRole(){
      if (!isManagerUser()) return myRole();
      const v = String(state.viewAsRole || '').trim();
      return v || 'manager';
    }

    function canLoadUserDirectory(){
      const r = effectiveRole();
      return isManagerUser() || r === 'event_coordinator' || ['dialer','remote_setter','in_person_setter'].includes(r);
    }

    function viewAsUserLabel(userId){
      const id = String(userId || '').trim();
      if (!id) return '';
      const u = (state.usersCache || []).find((x) => String(x.userId) === id);
      if (!u) return '';
      return String(u.fullName || u.email || '').trim();
    }

    function roleKeysForPeople(role){
      const r = String(role || '').trim();
      if (!r) return [];
      return [r];
    }

    function pickPreferredUserForRole(role, people){
      const r = String(role || '').trim().toLowerCase();
      const rows = Array.isArray(people) ? people : [];
      if (!r || !rows.length) return null;
      // Prefer the canonical demo user for the role: `${role}@...`
      const exactEmail = rows.find((u) => String(u?.email || '').trim().toLowerCase().startsWith(r + '@'));
      if (exactEmail) return exactEmail;
      return rows[0] || null;
    }

    function usersForViewAsRole(role){
      const keys = roleKeysForPeople(role);
      const all = Array.isArray(state.usersCache) ? state.usersCache : [];
      const users = all.filter((u) => keys.includes(String(u.role || '').trim()));
      users.sort((a, b) => {
        const an = String(a.fullName || a.email || a.userId || '');
        const bn = String(b.fullName || b.email || b.userId || '');
        return an.localeCompare(bn);
      });
      return users;
    }

    async function ensureUsersCache(){
      if (!canLoadUserDirectory()) return;
      if (Array.isArray(state.usersCache) && state.usersCache.length) return;
      try {
        const j = await api('/api/portal/users');
        state.usersCache = j.users || [];
      } catch(_e) {}
    }

    function setViewAsRole(nextRole){
      const raw = String(nextRole || '').trim();
      state.viewAsRole = raw === 'manager' ? '' : raw;
      state.viewAsUserId = '';

      const finish = () => {
        const er = effectiveRole();
        if (['dialer','in_person_setter','remote_setter'].includes(er)) {
          state.activeTab = 'calls';
          if (er === 'in_person_setter') state.dialerSubtab = 'booked';
        }
        else if (er === 'closer') state.activeTab = 'closer';
        else if (er === 'account_manager') state.activeTab = 'accounts';
        else if (er === 'event_coordinator') state.activeTab = 'manager';
        else if (['event_host','media_team'].includes(er)) state.activeTab = 'events';
        else state.activeTab = 'overview';

        refreshMe().catch(() => {});
      };

      finish();
    }

    function setViewAsUserId(nextUserId){
      const v = String(nextUserId || '').trim();
      state.viewAsUserId = v;
      if (v) {
        const u = (Array.isArray(state.usersCache) ? state.usersCache : []).find((x) => String(x.userId) === v);
        const theirRole = String(u?.role || '').trim();
        if (theirRole) state.viewAsRole = theirRole;
      }
      refreshMe().catch(() => {});
    }

    function setDialerSubtab(next){
      state.dialerSubtab = String(next || 'call');
      renderDialerSubtab();
      queueAutoRefreshSoon();
    }

    function renderDialerSubtab(){
      const t = String(state.dialerSubtab || 'call');
      const map = {
        call: { btn: 'dialerSegCall', pane: 'dialerPaneCall' },
        activity: { btn: 'dialerSegActivity', pane: 'dialerPaneActivity' },
        booked: { btn: 'dialerSegBooked', pane: 'dialerPaneBooked' },
        tasks: { btn: 'dialerSegTasks', pane: 'dialerPaneTasks' },
      };
      const keys = Object.keys(map);
      for (const k of keys) {
        const btn = $(map[k].btn);
        const pane = $(map[k].pane);
        if (btn) btn.classList.toggle('active', k === t);
        if (pane) pane.classList.toggle('hide', k !== t);
      }
    }

    function setCloserSubtab(next){
      state.closerSubtab = String(next || 'disposition');
      renderCloserSubtab();
      queueAutoRefreshSoon();
    }

    function renderCloserSubtab(){
      const t0 = String(state.closerSubtab || 'disposition');
      const t = (t0 === 'disposition') ? t0 : 'disposition';
      if (t !== t0) state.closerSubtab = t;
      const map = {
        disposition: { btn: 'closerSegDisposition', pane: 'closerPaneDisposition' },
      };
      const keys = Object.keys(map);
      for (const k of keys) {
        const btn = $(map[k].btn);
        const pane = $(map[k].pane);
        if (btn) btn.classList.toggle('active', k === t);
        if (pane) pane.classList.toggle('hide', k !== t);
      }
    }

    function hideManualLoadButtons(){
      // Keep manual refresh/load controls visible.
    }

    let autoRefreshTimer = null;
    let autoRefreshQueued = false;

    function queueAutoRefreshSoon(){
      if (String(state.activeTab || '') === 'payments') return;
      if (autoRefreshQueued) return;
      autoRefreshQueued = true;
      setTimeout(async () => {
        autoRefreshQueued = false;
        await autoRefreshActiveView().catch(()=>{});
      }, 350);
    }

    function startAutoRefresh(){
      // Disabled: periodic auto-refresh caused visible UI flicker.
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      autoRefreshTimer = null;
    }

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) queueAutoRefreshSoon();
    });

    function setTab(tab){
      const allowed = Array.isArray(state.allowedTabs) ? state.allowedTabs : null;
      const safeTab = (allowed && !allowed.includes(tab)) ? (allowed[0] || 'overview') : tab;

      state.activeTab = safeTab;
      const er = effectiveRole();
      const callsTitle = er === 'in_person_setter' ? 'Booked' : 'Calls';
      const eventsTitle = (er === 'media_team') ? 'Media' : 'Events';
      const title = {
        overview: 'Overview',
        leads: 'Leads',
        calls: callsTitle,
        meetings: (['event_host','media_team'].includes(er) ? 'Availability' : 'My meetings'),
        accounts: 'Accounts',
        closer: 'Sales',
        events: eventsTitle,
        offers: 'Offers',
        talent: 'Talent',
        payments: 'Payouts',
        manager: 'Operations'
      }[safeTab] || 'Overview';
      const viewKey = {
        overview: 'Overview',
        leads: 'Leads',
        calls: 'Calls',
        meetings: 'Meetings',
        accounts: 'Accounts',
        closer: 'Closer',
        events: 'Events',
        offers: 'Offers',
        talent: 'Talent',
        payments: 'Payments',
        manager: 'Manager'
      }[safeTab] || 'Overview';

      $('viewTitle').textContent = title;

      const views = ['Overview','Leads','Calls','Meetings','Accounts','Closer','Events','Offers','Talent','Payments','Manager'];
      for (const v of views) $('view'+v).classList.add('hide');
      const viewEl = $('view' + viewKey);
      if (viewEl) viewEl.classList.remove('hide');

      for (const el of document.querySelectorAll('.navBtn')) {
        el.classList.toggle('active', el.dataset.tab === safeTab);
      }

      // Ensure newly shown selects are enhanced.
      enhanceAllSelects();

      if (safeTab === 'overview') loadOverview().catch(()=>{});
      if (safeTab === 'leads') loadLeads().catch(()=>{});
      if (safeTab === 'events') {
        const seg = $('eventsSegTabs');
        const canSeg = ['event_host','media_team'].includes(er);
        const canAll = canSeeAllEventsForRole();
        const showSeg = canSeg;
        if (seg) seg.classList.toggle('hide', !showSeg);

        if (canSeg && !['my','all'].includes(String(state.eventsSubtab || ''))) state.eventsSubtab = 'my';
        if (canSeg && !canAll) state.eventsSubtab = 'my';
        if (!canSeg) state.eventsSubtab = 'all';
        renderEventsSubtabSeg();
        loadEvents().catch(()=>{});
      }
      if (safeTab === 'offers') {
        loadOffers().catch(()=>{});
      }
      if (safeTab === 'talent') loadTalentTab().catch(()=>{});
      if (safeTab === 'meetings') {
        if (['event_host','media_team'].includes(er)) state.meetingsSubtab = 'availability';
        renderMeetingsSubtab();
        if (state.meetingsSubtab === 'availability') loadAvailability().catch(()=>{});
        else loadAppointmentsInto('meetingsTbody', 'meetingsMsg').catch(()=>{});
      }
      if (safeTab === 'payments') {
        renderPayoutsPeriodSeg();
        loadPayouts().catch(()=>{});
      }
      if (safeTab === 'accounts') {
        loadAccounts().catch(()=>{});
      }
      if (safeTab === 'closer') {
        renderCloserSubtab();
        // Closer Dispatch removed from Sales.
      }
      if (safeTab === 'calls') {
        renderDialerSubtab();
        if (state.dialerSubtab === 'call') loadQueue().catch(()=>{});
        if (state.dialerSubtab === 'activity') {
          if (state.selectedLead && state.selectedLead.id) loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
        }
        if (state.dialerSubtab === 'tasks') {
          loadDispatchInto('dialerTasksTbody', 'dialerTasksMsg', { overdueOnly: !!$('dialerTasksOverdue')?.checked, scope: String($('dialerTasksScope')?.value || 'role') }).catch(()=>{});
        }
        if (state.dialerSubtab === 'booked') {
          loadDialerBooked().catch(()=>{});
        }
      }
      if (tab === 'manager') {
        if (!state.managerSubtab) {
          state.managerSubtab = (effectiveRole() === 'event_coordinator') ? 'stats' : 'tasks';
        }
        renderManagerSubtab();
        if (state.managerSubtab === 'stats') {
          if (['manager','event_coordinator'].includes(effectiveRole())) loadStats().catch(()=>{});
        } else if (state.managerSubtab === 'tasks') {
          loadDispatchManager().catch(()=>{});
        } else if (state.managerSubtab === 'users') {
          loadUsers().catch(() => {});
        }
      }

    }

    async function autoRefreshActiveView(){
      const tab = String(state.activeTab || 'overview');
      if (!state.token) return;
      if (tab === 'overview') {
        await loadOverview().catch(()=>{});
      }
      if (tab === 'leads') {
        await loadLeads().catch(()=>{});
        if (state.selectedLead?.id) await loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
      }
      if (tab === 'calls') {
        renderDialerSubtab();
        if (state.dialerSubtab === 'call') await loadQueue().catch(()=>{});
        if (state.dialerSubtab === 'activity') {
          if (state.selectedLead?.id) await loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
        }
        if (state.dialerSubtab === 'tasks') {
          await loadDispatchInto('dialerTasksTbody', 'dialerTasksMsg', { overdueOnly: !!$('dialerTasksOverdue')?.checked, scope: String($('dialerTasksScope')?.value || 'role') }).catch(()=>{});
        }
        if (state.dialerSubtab === 'booked') {
          await loadDialerBooked().catch(()=>{});
        }
      }
      if (tab === 'closer') {
        renderCloserSubtab();
        // Closer Dispatch removed from Sales.
      }
      if (tab === 'meetings') {
        if (String(state.meetingsSubtab || '') === 'availability') {
          await loadAvailability().catch(()=>{});
        } else {
          await loadAppointmentsInto('meetingsTbody', 'meetingsMsg').catch(()=>{});
        }
      }
      if (tab === 'accounts') {
        await loadAccounts().catch(()=>{});
      }
      if (tab === 'events') {
        await loadEvents().catch(()=>{});
        if (state.selectedEvent?.id && ['event_host','media_team'].includes(effectiveRole())) {
          await loadRecaps(state.selectedEvent.id).catch(()=>{});
        }
      }
      if (tab === 'talent') {
        await loadTalentTab().catch(()=>{});
      }
      if (tab === 'payments') {
        // Manual refresh only.
      }
      if (tab === 'manager') {
        renderManagerSubtab();
        if (state.managerSubtab === 'stats') {
          if (['manager','event_coordinator'].includes(effectiveRole())) await loadStats().catch(()=>{});
        }
        if (state.managerSubtab === 'tasks') {
          await loadDispatchManager().catch(()=>{});
        }
      }
    }

    function showAuthView(message){
      $('authView').classList.remove('hide');
      $('appView').classList.add('hide');
      $('authMsg').textContent = message || '';
      const ok = $('authOk');
      if (ok) ok.textContent = '';
    }

    function showAppView(){
      $('authView').classList.add('hide');
      $('appView').classList.remove('hide');
    }

    async function api(path, { method='GET', body=null } = {}){
      const token = String(state.token || '').trim();
      if (!token) throw new Error('not_signed_in');

      const headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token,
      };

      // Manager-only: pass effective view-as role to the server so it can
      // enforce scoping (and read-only) server-side.
      const viewAs = isManagerUser() ? String(state.viewAsRole || '').trim() : '';
      const viewAsUserId = isManagerUser() ? String(state.viewAsUserId || '').trim() : '';
      const p = String(path || '');
      const exclude = [
        '/api/portal/me',
        '/api/portal/users',
        '/api/portal/stats',
        '/api/portal/dispatch_scan',
        '/api/portal/seed',
      ];
      const excluded = exclude.some((x) => p.startsWith(x));
      if (viewAs && p.startsWith('/api/portal/') && !excluded) {
        headers['X-Portal-View-As'] = viewAs;
        if (viewAsUserId) headers['X-Portal-View-As-User'] = viewAsUserId;
      }

      async function doReq(){
        const rr = await fetch(path, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined,
        });
        const jj = await rr.json().catch(() => null);
        return { rr, jj };
      }

      let { rr: r, jj: j } = await doReq();

      // If the access token expired, try one refresh + retry.
      if ((!j || !j.ok) && (r.status === 401 || String(j?.error || '') === 'invalid_token')) {
        try{
          await refreshSessionToken();
          headers.Authorization = 'Bearer ' + String(state.token || '').trim();
          const retry = await doReq();
          r = retry.rr;
          j = retry.jj;
        } catch(_e){
          // fall through to normal error handling
        }
      }

      if (!j || !j.ok) {
        const err = String(j?.error || ('http_' + r.status));
        if (err === 'view_as_read_only') throw new Error('View-as is read-only');
        if (err === 'view_as_requires_user') throw new Error('Read-only mode (role preview).');
        throw new Error(err);
      }
      if (String(method || 'GET').toUpperCase() !== 'GET') {
        queueAutoRefreshSoon();
      }
      return j;
    }

    async function refreshMe(){
      const token = String(state.token || '').trim();
      if (!token){
        state.me = null;
        showAuthView('');
        setTab('overview');
        return;
      }

      let me = null;
      try {
        me = await api('/api/portal/me');
        state.me = me;
      } catch (e) {
        // Try refresh once before forcing re-auth.
        try{
          await refreshSessionToken();
          me = await api('/api/portal/me');
          state.me = me;
        } catch(_e){
          clearSession();
          state.me = null;
          showAuthView('Session expired. Please sign in again.');
          return;
        }
      }

      showAppView();

      me = state.me;
      const realRole = String(me.profile.role || '').trim();
      const er = effectiveRole();

      // Managers may need the user roster in manager tools.
      if (isManagerUser()) await ensureUsersCache();

      const vRole = isManagerUser() ? String(state.viewAsRole || '').trim() : '';
      const inViewAs = isManagerUser() && !!vRole;
      $('roleLine').textContent = inViewAs
        ? `As ${roleViewLabel(er)}`
        : roleViewLabel(realRole);
      $('appUser').textContent = me.user.email;

      const navItems = [];
      navItems.push({ id:'overview', label:'Overview' });

      const leadsAllowed = ['dialer','remote_setter','in_person_setter','closer','account_manager','manager'].includes(er);
      if (leadsAllowed) navItems.push({ id:'leads', label:'Leads' });
      if (er === 'manager') {
        navItems.push({ id:'meetings', label:'Meetings' });
      }
      if (['dialer','remote_setter','in_person_setter'].includes(er)) {
        navItems.push({ id:'calls', label: er === 'in_person_setter' ? 'Booked' : 'Calls' });
        navItems.push({ id:'meetings', label:'Meetings' });
      }
      if (er === 'closer') {
        navItems.push({ id:'closer', label:'Sales' });
        navItems.push({ id:'meetings', label:'Meetings' });
      }
      if (er === 'account_manager') {
        navItems.push({ id:'meetings', label:'Meetings' });
      }
      if (er === 'account_manager' || er === 'manager') {
        navItems.push({ id:'accounts', label:'Accounts' });
      }

      if (['event_host','media_team','event_coordinator'].includes(er)) {
        navItems.push({ id:'offers', label:'Offers' });

        if (['event_host','media_team'].includes(er)) {
          navItems.push({ id:'meetings', label:'Availability' });
        }

        const label = (er === 'media_team') ? 'Media' : 'Events';
        navItems.push({ id:'events', label });

        if (er === 'event_coordinator') navItems.push({ id:'talent', label:'Talent' });
        if (['event_host','media_team'].includes(er)) navItems.push({ id:'talent', label:'Profile' });
      }
      if (er === 'event_coordinator' || er === 'manager') {
        navItems.push({ id:'manager', label:'Operations' });
      }
      navItems.push({ id:'payments', label:'Payouts' });

      // Managers should also be able to view offers.
      if (er === 'manager') {
        // Insert Offers near Events if present; otherwise append.
        const hasOffers = navItems.some((x) => x.id === 'offers');
        if (!hasOffers) {
          const idx = navItems.findIndex((x) => x.id === 'events');
          if (idx >= 0) navItems.splice(idx, 0, { id:'offers', label:'Offers' });
          else navItems.push({ id:'offers', label:'Offers' });
        }
      }

      const viewAsHtml = isManagerUser() ? (() => {
        const currentRole = String(state.viewAsRole || '').trim() || 'manager';

        const activeOpt = MANAGER_VIEW_OPTIONS.find((o) => String(o.role) === String(currentRole)) || MANAGER_VIEW_OPTIONS[0];
        const viewSelect = `
          <div class="navTitle">View as</div>
          <div class="dd" id="viewRoleDd" style="margin-top:6px;">
            <button id="viewRoleBtn" class="ddBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
              <span>${escapeHtml(activeOpt?.label || 'Manager')}</span>
              <span class="muted small">▼</span>
            </button>
            <div id="viewRoleMenu" class="ddMenu hide" role="listbox" aria-label="View as">
              ${MANAGER_VIEW_OPTIONS.map((o) => {
                const active = String(o.role) === String(currentRole);
                return `<button class="ddItem ${active ? 'active' : ''}" type="button" data-view-role="${escapeHtml(o.role)}">${escapeHtml(o.label)}</button>`;
              }).join('')}
            </div>
          </div>
        `;

        return `${viewSelect}<div style="height:10px"></div><div class="navTitle">Menu</div>`;
      })() : '<div class="navTitle">Menu</div>';

      const ico = {
        overview: 'O',
        leads: 'L',
        calls: 'C',
        meetings: 'M',
        accounts: 'A',
        closer: 'S',
        offers: '✦',
        events: 'E',
        talent: 'T',
        payments: '$',
        manager: '⚙',
      };

      $('nav').innerHTML = viewAsHtml + navItems
        .map((t) => `<button class="navBtn" type="button" data-tab="${t.id}"><span class="navIco">${escapeHtml(ico[t.id] || '•')}</span><span class="navLbl">${escapeHtml(t.label)}</span></button>`)
        .join('');

      state.allowedTabs = navItems.map((t) => t.id);
      if (state.allowedTabs.length && !state.allowedTabs.includes(String(state.activeTab || 'overview'))) {
        state.activeTab = state.allowedTabs[0];
      }

      // Role-specific UI tweaks
      try {
        const setterMode = (er === 'in_person_setter');
        const seg = $('dialerSegCall');
        if (seg) seg.textContent = setterMode ? 'Queue' : 'Queue & Call';
        const form = $('dialerCallForm');
        if (form) form.classList.toggle('hide', setterMode);
        if (setterMode && state.dialerSubtab === 'call') state.dialerSubtab = 'booked';
      } catch(_e) {}

      const mgrStats = $('mgrStatsCard');
      if (mgrStats) mgrStats.classList.toggle('hide', !(['manager','event_coordinator'].includes(effectiveRole())));

      // Setter-only: show Pull Leads button.
      try {
        // View-as should behave like the selected role.
        const canPull = ['remote_setter','in_person_setter'].includes(er);
        const pl = $('pullLeadsToggle');
        if (pl) pl.classList.toggle('hide', !canPull);
      } catch(_e) {}

      for (const el of document.querySelectorAll('.navBtn[data-tab]')){
        el.addEventListener('click', () => setTab(el.dataset.tab));
      }

      // Custom Views dropdown (manager)
      try {
        const ddBtn = $('viewRoleBtn');
        const ddMenu = $('viewRoleMenu');
        if (ddBtn && ddMenu) {
          const close = () => {
            ddMenu.classList.add('hide');
            ddBtn.setAttribute('aria-expanded', 'false');
          };
          const toggle = () => {
            const open = !ddMenu.classList.contains('hide');
            if (open) close();
            else {
              ddMenu.classList.remove('hide');
              ddBtn.setAttribute('aria-expanded', 'true');
            }
          };

          ddBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggle();
          });
          for (const item of ddMenu.querySelectorAll('button[data-view-role]')) {
            item.addEventListener('click', () => {
              const role = String(item.dataset.viewRole || '').trim();
              close();
              setViewAsRole(role);
            });
          }

          if (window.__portalViewDdCloser) document.removeEventListener('click', window.__portalViewDdCloser, true);
          window.__portalViewDdCloser = (ev) => {
            const dd = $('viewRoleDd');
            if (!dd) return;
            if (dd.contains(ev.target)) return;
            close();
          };
          document.addEventListener('click', window.__portalViewDdCloser, true);
        }
      } catch(_e) {}

      // No explicit exit button: managers can switch back to Manager in the Views dropdown.

      // Manager-only controls
      $('newEventToggle').classList.toggle('hide', !(['manager','event_coordinator'].includes(er)));

      // Events My/All segment only applies to host/media (and only in Events tab).
      const eventsSeg = $('eventsSegTabs');
      if (eventsSeg) eventsSeg.classList.toggle('hide', true);

      // Overview
      $('viewOverview').innerHTML = `
        <div class="row" style="justify-content:space-between; gap:16px;">
          <div>
            <div class="muted small">Signed in</div>
            <div style="font-weight:900; margin-top:4px;">${me.user.email}</div>
          </div>
          <div>
            <div class="muted small">Role</div>
            <div style="margin-top:4px;"><span class="badge ok">${escapeHtml(inViewAs ? roleViewLabel(er) : roleViewLabel(realRole))}</span></div>
            ${inViewAs && state.viewAsUserId ? `<div class="muted small" style="margin-top:6px;">${escapeHtml(viewAsUserLabel(state.viewAsUserId) || '')}</div>` : ''}
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="muted small">At-a-glance only (no mixed workflows).</div>
        <div style="height:10px"></div>
        <div id="overviewMsg" class="err"></div>
        ${(!inViewAs && me.profile.role === 'manager' && !isManagerViewAsPreviewOnly()) ? `
          <div class="card" style="margin: 10px 0 14px 0;">
            <div class="bd">
              <div style="font-weight:900;">Demo data</div>
              <div class="muted small" style="margin-top:4px;">Seeds realistic leads, events, recaps, payouts, docs, accounts, and availability.</div>
              <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                <button id="seedDemoBtn" class="btn secondary" type="button">Seed demo data</button>
                <button id="seedDemoMoreBtn" class="btn secondary" type="button">Seed more (additive)</button>
                <button id="seedDemoForceBtn" class="btn" type="button">Reseed (overwrite demo)</button>
              </div>
              <div id="seedDemoMsg" class="muted small" style="margin-top:8px;"></div>
            </div>
          </div>
        ` : ''}
        <div id="overviewCards" class="two"></div>
      `;

      // Demo seeding controls (manager only)
      try {
        const seedDemo = async ({ force = false, append = false } = {}) => {
          const msg = $('seedDemoMsg');
          if (msg) msg.textContent = force ? 'Reseeding demo data…' : (append ? 'Seeding more demo data…' : 'Seeding demo data…');
          try {
            const j = await api('/api/portal/seed', {
              method: 'POST',
              body: {
                demoData: true,
                seedData: true,
                force: !!force,
                append: !!append,
              },
            });
            const demo = j && j.demo ? j.demo : null;
            const state = demo && demo.seedState ? demo.seedState : null;
            if (msg) {
              if (demo && demo.alreadySeeded) msg.textContent = 'Demo data already seeded. Use Seed more (additive) to add on top, or Reseed to overwrite demo records.';
              else if (state && state.counts) {
                const verb = append ? 'Added' : 'Seeded';
                const runs = Array.isArray(state.runs) ? state.runs.length : null;
                msg.textContent = `${verb}: ${state.counts.leads} leads, ${state.counts.events} events, ${state.counts.appointments} meetings, ${state.counts.payouts} payouts, ${state.counts.accounts} accounts.${runs ? ` Runs: ${runs}.` : ''}`;
              }
              else msg.textContent = 'Seed complete.';
            }
            // Refresh whatever the user is looking at.
            await loadOverview().catch(() => {});
            if (String(state.activeTab || '') === 'payments') await loadPayouts().catch(() => {});
            else await autoRefreshActiveView().catch(() => {});
          } catch(e) {
            if (msg) msg.textContent = String(e.message || e);
          }
        };

        const b1 = $('seedDemoBtn');
        if (b1) b1.addEventListener('click', () => seedDemo({ force: true, append: false }));
        const bMore = $('seedDemoMoreBtn');
        if (bMore) bMore.addEventListener('click', () => seedDemo({ force: false, append: true }));
        const b2 = $('seedDemoForceBtn');
        if (b2) b2.addEventListener('click', () => seedDemo({ force: true, append: false }));
      } catch(_e) {}

      hideManualLoadButtons();
      startAutoRefresh();

      setTab(state.activeTab || 'overview');
    }

    async function loadOverview(){
      const box = $('overviewCards');
      const msg = $('overviewMsg');
      if (!box) return;
      if (msg) msg.textContent = '';

      const er = effectiveRole();
      setBadge('warn', 'loading');

      const cards = [];
      const fmtNum = (n) => Number(n || 0).toLocaleString();
      const sumMoney = (rows) => (Array.isArray(rows) ? rows : []).reduce((a, r) => a + (Number(r.amount_cents || 0) / 100), 0);
      const todayYmd = new Date().toISOString().slice(0, 10);

      try{
        if (['dialer','in_person_setter','remote_setter'].includes(er)) {
          const [qR, aR, dR, pR] = await Promise.allSettled([
            api('/api/portal/queue?kind=dialer&limit=200'),
            api('/api/portal/appointments?limit=200'),
            api('/api/portal/dispatch?limit=200&scope=role'),
            api('/api/portal/payouts?limit=30'),
          ]);

          const queue = qR.status === 'fulfilled' ? (qR.value.leads || []) : [];
          const appts = aR.status === 'fulfilled' ? (aR.value.appointments || []) : [];
          const tasks = dR.status === 'fulfilled' ? (dR.value.tasks || []) : [];
          const payouts = pR.status === 'fulfilled' ? (pR.value.payouts || []) : [];

          const openTasks = tasks.filter((t) => ['open','assigned'].includes(String(t.status || '')));
          const overdueTasks = openTasks.filter((t) => isOverdue(t));

          cards.push({
            title: 'Queue',
            sub: 'Leads in your call queue',
            value: fmtNum(queue.length),
            hint: 'Open Calls → Queue & Call',
          });

          cards.push({
            title: 'Booked',
            sub: 'Meetings you scheduled',
            value: fmtNum(appts.length),
            hint: 'Open Calls → Booked',
          });

          cards.push({
            title: 'Tasks',
            sub: 'Open tasks',
            value: `${fmtNum(openTasks.length)}${overdueTasks.length ? (` • overdue ${fmtNum(overdueTasks.length)}`) : ''}`,
            hint: 'Open Calls → Tasks',
          });

          cards.push({
            title: 'Commissions',
            sub: 'Recent payouts',
            value: `$${sumMoney(payouts).toFixed(2)}`,
            hint: 'Open Payouts',
          });
        } else if (['closer','account_manager'].includes(er)) {
          const [aR, dR, vR, pR] = await Promise.allSettled([
            api('/api/portal/appointments?limit=200'),
            api('/api/portal/dispatch?limit=200&scope=role'),
            api('/api/portal/availability'),
            api('/api/portal/payouts?limit=30'),
          ]);

          const appts = aR.status === 'fulfilled' ? (aR.value.appointments || []) : [];
          const tasks = dR.status === 'fulfilled' ? (dR.value.tasks || []) : [];
          const payouts = pR.status === 'fulfilled' ? (pR.value.payouts || []) : [];
          const slots = vR.status === 'fulfilled' ? (vR.value.availability?.slots || null) : null;
          const byDate = slots && typeof slots === 'object' && slots.byDate && typeof slots.byDate === 'object' ? slots.byDate : null;
          const days = byDate ? Object.keys(byDate).length : 0;

          const upcoming = appts.filter((a) => String(a.status || '') === 'scheduled');
          const openTasks = tasks.filter((t) => ['open','assigned'].includes(String(t.status || '')));
          const overdueTasks = openTasks.filter((t) => isOverdue(t));

          cards.push({ title: 'Meetings', sub: 'Scheduled appointments', value: fmtNum(upcoming.length), hint: 'Open Sales → Meetings' });
          cards.push({ title: 'Availability', sub: 'Days with slots saved', value: fmtNum(days), hint: 'Open Sales → Availability' });
          cards.push({ title: 'Tasks', sub: 'Open tasks', value: `${fmtNum(openTasks.length)}${overdueTasks.length ? (` • overdue ${fmtNum(overdueTasks.length)}`) : ''}`, hint: 'Open Sales → Tasks' });
          cards.push({ title: 'Commissions', sub: 'Recent payouts', value: `$${sumMoney(payouts).toFixed(2)}`, hint: 'Open Payouts' });
        } else if (['event_host','media_team'].includes(er)) {
          const [eR, vR, pR] = await Promise.allSettled([
            api('/api/portal/events?limit=200'),
            api('/api/portal/availability'),
            api('/api/portal/payouts?limit=30'),
          ]);

          const events = eR.status === 'fulfilled' ? (eR.value.events || []) : [];
          const payouts = pR.status === 'fulfilled' ? (pR.value.payouts || []) : [];
          const slots = vR.status === 'fulfilled' ? (vR.value.availability?.slots || null) : null;
          const byDate = slots && typeof slots === 'object' && slots.byDate && typeof slots.byDate === 'object' ? slots.byDate : null;
          const days = byDate ? Object.keys(byDate).length : 0;

          const offersOpen = events.filter((ev) => {
            const asg = String(ev.assigned_role || '').trim();
            return String(ev.status || 'open') === 'open' && !ev.assigned_user_id && asg === er;
          });

          const upcoming = events.filter((ev) => {
            const d = String(ev.event_date || '').trim();
            if (!d) return false;
            return d >= todayYmd && ['assigned','scheduled','completed','canceled','cancelled','open'].includes(String(ev.status || 'open'));
          });

          const assignedToMe = events.filter((ev) => {
            const id = String(state.me?.user?.id || '').trim();
            return !!id && String(ev.assigned_user_id || '') === id;
          });

          cards.push({ title: 'Offers', sub: 'Open offers for your role', value: fmtNum(offersOpen.length), hint: 'Open Offers' });
          cards.push({ title: 'Upcoming', sub: 'Upcoming events you can see', value: fmtNum(upcoming.length), hint: 'Open Events' });
          cards.push({ title: 'Assigned', sub: 'Events assigned to you', value: fmtNum(assignedToMe.length), hint: 'Open Events → My' });
          cards.push({ title: 'Availability', sub: 'Days with slots saved', value: fmtNum(days), hint: 'Open Availability' });
          cards.push({ title: 'Payouts', sub: 'Recent payouts', value: `$${sumMoney(payouts).toFixed(2)}`, hint: 'Open Payouts' });
        } else if (er === 'event_coordinator') {
          const [sR, eR, pR] = await Promise.allSettled([
            api('/api/portal/stats?scope=all'),
            api('/api/portal/events?limit=200'),
            api('/api/portal/payouts?limit=30'),
          ]);

          const stats = sR.status === 'fulfilled' ? sR.value : {};
          const c = stats.leadCounts || {};
          const events = eR.status === 'fulfilled' ? (eR.value.events || []) : [];
          const payouts = pR.status === 'fulfilled' ? (pR.value.payouts || []) : [];

          const openOffers = events.filter((ev) => String(ev.status || 'open') === 'open' && !ev.assigned_user_id && ['event_host','media_team'].includes(String(ev.assigned_role || '').trim()));
          const upcomingEvents = events.filter((ev) => {
            const d = String(ev.event_date || '').trim();
            return !!d && d >= todayYmd;
          });

          cards.push({ title: 'Leads', sub: 'New / working / booked', value: `${fmtNum(c.new ?? 0)} / ${fmtNum(c.working ?? 0)} / ${fmtNum(c.booked ?? 0)}`, hint: 'Open Leads' });
          cards.push({ title: 'Events', sub: 'Upcoming events visible', value: fmtNum(upcomingEvents.length), hint: 'Open Events' });
          cards.push({ title: 'Offers', sub: 'Open offers (host + media)', value: fmtNum(openOffers.length), hint: 'Open Offers' });
          cards.push({ title: 'Dispatch', sub: 'Open / overdue', value: `${fmtNum(stats.dispatchOpen ?? 0)} / ${fmtNum(stats.dispatchOverdue ?? 0)}`, hint: 'Open Operations → Tasks' });
          cards.push({ title: 'Payouts', sub: 'Recent payouts', value: `$${sumMoney(payouts).toFixed(2)}`, hint: 'Open Payouts' });
        } else if (er === 'manager') {
          const [sR, pR, eR] = await Promise.allSettled([
            api('/api/portal/stats?scope=all'),
            api('/api/portal/payouts?limit=30'),
            api('/api/portal/events?limit=200'),
          ]);
          const stats = sR.status === 'fulfilled' ? sR.value : {};
          const c = stats.leadCounts || {};
          const payouts = pR.status === 'fulfilled' ? (pR.value.payouts || []) : [];
          const events = eR.status === 'fulfilled' ? (eR.value.events || []) : [];

          const openOffers = events.filter((ev) => String(ev.status || 'open') === 'open' && !ev.assigned_user_id && ['event_host','media_team'].includes(String(ev.assigned_role || '').trim()));

          cards.push({ title: 'Lead pipeline', sub: 'New / working / booked', value: `${fmtNum(c.new ?? 0)} / ${fmtNum(c.working ?? 0)} / ${fmtNum(c.booked ?? 0)}`, hint: 'Open Leads' });
          cards.push({ title: 'Calls', sub: 'Calls in last 24h', value: fmtNum(stats.callsLast24h ?? 0), hint: 'Open Operations → Stats' });
          cards.push({ title: 'Dispatch', sub: 'Open / overdue', value: `${fmtNum(stats.dispatchOpen ?? 0)} / ${fmtNum(stats.dispatchOverdue ?? 0)}`, hint: 'Open Operations → Tasks' });
          cards.push({ title: 'Offers', sub: 'Open offers (host + media)', value: fmtNum(openOffers.length), hint: 'Open Offers' });
          cards.push({ title: 'Payouts', sub: 'Recent payouts', value: `$${sumMoney(payouts).toFixed(2)}`, hint: 'Open Payouts' });
        } else {
          cards.push({ title: 'Menu', sub: 'Use the menu to open your area', value: '—', hint: '' });
        }

        box.innerHTML = cards.map((c) => `
          <div class="card" style="background:#fff;">
            <div class="bd">
              <div class="muted small">${escapeHtml(c.sub || '')}</div>
              <div style="font-weight:900; font-size:18px; margin-top:6px;">${escapeHtml(c.value || '')}</div>
              <div style="height:6px"></div>
              <div class="muted small" style="font-weight:900; letter-spacing:.1px;">${escapeHtml(c.title || '')}</div>
              ${c.hint ? `<div class="muted small" style="margin-top:6px;">${escapeHtml(c.hint)}</div>` : ''}
            </div>
          </div>
        `).join('');
        setBadge('ok', 'ready');
      } catch(e){
        if (msg) msg.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    function requireSelectedLead(where){
      if (!state.selectedLead || !state.selectedLead.id) {
        const msg = where ? (where + ': select a lead first') : 'select a lead first';
        throw new Error(msg);
      }
      return state.selectedLead;
    }

    function setSelectedLeadLine(){
      const l = state.selectedLead;
      const line = l
        ? `#${l.id} • ${[l.first_name, l.last_name].filter(Boolean).join(' ').trim()} • ${l.property_name || l.company || ''}`.trim()
        : 'None';
      if ($('selectedLeadLine')) $('selectedLeadLine').textContent = line;
      if ($('closerSelectedLead')) $('closerSelectedLead').textContent = line;
      if ($('leadDetailTitle')) $('leadDetailTitle').textContent = line;
      if ($('dispatchLeadLine')) $('dispatchLeadLine').textContent = line;
      if ($('mgrLeadLine')) $('mgrLeadLine').textContent = line;

      // When cleared, make downstream panes obvious.
      if (!l) {
        if ($('timelineList')) $('timelineList').innerHTML = '<div class="muted small">Select a lead to view timeline.</div>';
        if ($('dialerTimelineList')) $('dialerTimelineList').innerHTML = '<div class="muted small">Select a lead to view activity.</div>';
        if ($('leadDetailMsg')) $('leadDetailMsg').textContent = '';
      }

      // Populate lead edit defaults for convenience
      if (l) {
        if ($('leadEditStatus')) $('leadEditStatus').value = '';
        if ($('leadEditPriority')) $('leadEditPriority').value = '';
        if ($('leadEditAssignedRole')) $('leadEditAssignedRole').value = '';
        const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
        if ($('leadEditFollowup')) $('leadEditFollowup').value = fu;
      }
    }

    function clearSelectedLead(){
      state.selectedLead = null;
      try{
        if ($('meetingScheduleMsg')) $('meetingScheduleMsg').textContent = '';
        if ($('dialerBookedScheduleMsg')) $('dialerBookedScheduleMsg').textContent = '';
        if ($('callMsg')) $('callMsg').textContent = '';
        if ($('closeMsg')) $('closeMsg').textContent = '';
      } catch(_e) {}
      setSelectedLeadLine();
    }

    function leadDisplayName(l){
      if (!l) return '';
      const name = [l.first_name, l.last_name].filter(Boolean).join(' ').trim();
      const prop = l.property_name || l.company || '';
      return [name || '(no name)', prop].filter(Boolean).join(' • ');
    }

    function activityLabel(a){
      const t = String(a.activity_type || '');
      if (t === 'call') return 'Call';
      if (t === 'close') return 'Close';
      if (t === 'note') return 'Note';
      return t || 'Activity';
    }

    function renderTimeline(listElId, msgElId, items){
      const msgEl = msgElId ? $(msgElId) : null;
      const listEl = $(listElId);
      if (!listEl) return;
      if (msgEl) msgEl.textContent = '';

      const arr = Array.isArray(items) ? items : [];
      if (!arr.length) {
        listEl.innerHTML = '<div class="muted small">No activity yet.</div>';
        return;
      }

      listEl.innerHTML = arr.map((a) => {
        const when = String(a.created_at || '').replace('T', ' ').slice(0, 19);
        const label = activityLabel(a);
        const outcome = a.outcome ? `<span class="badge">${escapeHtml(a.outcome)}</span>` : '';
        const notes = a.notes ? `<div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(a.notes)}</div>` : '';
        const payload = a.payload && typeof a.payload === 'object' ? a.payload : {};
        const fu = payload.followup || '';
        const fuLine = fu ? `<div class="muted small" style="margin-top:6px;">Follow up: ${escapeHtml(String(fu))}</div>` : '';
        return `
          <div class="card" style="background:#fff; margin-bottom:10px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; gap:10px; align-items:flex-start;">
                <div>
                  <div class="muted small">${escapeHtml(when)}</div>
                  <div style="font-weight:900; margin-top:4px;">${escapeHtml(label)}</div>
                </div>
                <div class="row">${outcome}</div>
              </div>
              ${notes}
              ${fuLine}
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadTimelineInto(listElId, msgElId){
      const msgEl = msgElId ? $(msgElId) : null;
      if (msgEl) msgEl.textContent = '';
      try{
        const lead = requireSelectedLead('Timeline');
        const j = await api('/api/portal/activities?leadId=' + encodeURIComponent(String(lead.id)) + '&limit=80');
        renderTimeline(listElId, msgElId, j.activities || []);
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
      }
    }

    async function addTimelineNote(noteElId, msgElId, listElId){
      const msgEl = msgElId ? $(msgElId) : null;
      if (msgEl) msgEl.textContent = '';
      try{
        const lead = requireSelectedLead('Add note');
        const notes = String($(noteElId)?.value || '').trim();
        if (!notes) throw new Error('Write a note');
        const fu = String($('leadEditFollowup')?.value || '').trim();

        await api('/api/portal/activities', {
          method: 'POST',
          body: {
            leadId: lead.id,
            activityType: 'note',
            notes,
            payload: fu ? { followup: fu } : {},
          }
        });

        const nEl = $(noteElId);
        if (nEl) nEl.value = '';
        await loadTimelineInto(listElId, msgElId);
        setBadge('ok', 'saved');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
      }
    }

    async function saveLeadEdits(){
      $('leadSaveMsg').textContent = '';
      try{
        const lead = requireSelectedLead('Lead update');
        const patch = { id: lead.id };

        const st = $('leadEditStatus').value;
        const pr = $('leadEditPriority').value;
        const ar = $('leadEditAssignedRole').value;
        const fu = $('leadEditFollowup').value.trim();

        if (st) patch.status = st;
        if (pr !== '') patch.priority = Number(pr);
        if (ar) patch.assignedRole = ar;

        // Merge meta followup
        const nextMeta = Object.assign({}, (lead.meta && typeof lead.meta === 'object') ? lead.meta : {});
        if (fu) nextMeta.followup = fu;
        if (!fu && 'followup' in nextMeta) delete nextMeta.followup;
        patch.meta = nextMeta;

        await api('/api/portal/leads', { method:'PATCH', body: patch });
        await loadLeads();
        // Preserve selected lead instance from refreshed list
        state.selectedLead = state.leads.find((x) => Number(x.id) === Number(lead.id)) || state.selectedLead;
        setSelectedLeadLine();
        await loadTimelineInto('timelineList', 'timelineMsg');
        setBadge('ok', 'updated');
      } catch(e){
        $('leadSaveMsg').textContent = String(e.message || e);
      }
    }

    async function loadQueue(){
      $('queueMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/queue?kind=dialer&limit=50');
        const leads = j.leads || [];
        const tb = $('queueTbody');
        if (!tb) return;

        if (!leads.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No queue items.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = leads.map((l) => {
          const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
          const prop = l.property_name || l.company || '';
          const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
          const canClaim = !l.assigned_user_id;
          const claimBtn = canClaim ? `<button class="btn small" data-queue-claim="${l.id}">Claim</button>` : '';
          return `
            <tr>
              <td><span class="badge">${l.id}</span></td>
              <td>${escapeHtml(name)}</td>
              <td class="muted">${escapeHtml(prop)}</td>
              <td><span class="badge">${escapeHtml(l.status || '')}</span></td>
              <td class="muted">${escapeHtml(String(l.priority ?? 0))}</td>
              <td class="muted">${escapeHtml(fu)}</td>
              <td><button class="btn secondary small" data-queue-pick="${l.id}">Select</button> ${claimBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-queue-pick]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.queuePick);
            const l = leads.find((x) => Number(x.id) === id) || null;
            state.selectedLead = l;
            setSelectedLeadLine();
          });
        }

        for (const btn of tb.querySelectorAll('button[data-queue-claim]')){
          btn.addEventListener('click', async () => {
            $('queueMsg').textContent = '';
            try{
              const id = Number(btn.dataset.queueClaim);
              await api('/api/portal/leads', { method:'PATCH', body: { id, assignedUserId: state.me.user.id, status: 'working' } });
              await loadQueue();
              setBadge('ok', 'claimed');
            } catch(e){
              $('queueMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('queueMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadStats(){
      $('statsMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/stats?scope=all');
        const c = j.leadCounts || {};
        const box = $('statsBox');
        if (box) {
          const tiles = [
            { k: 'new', v: Number(c.new ?? 0), kind: 'ok' },
            { k: 'working', v: Number(c.working ?? 0), kind: '' },
            { k: 'booked', v: Number(c.booked ?? 0), kind: '' },
            { k: 'won', v: Number(c.won ?? 0), kind: 'ok' },
            { k: 'lost', v: Number(c.lost ?? 0), kind: 'warn' },
            { k: 'calls (24h)', v: Number(j.callsLast24h ?? 0), kind: '' },
            { k: 'upcoming appts', v: Number(j.upcomingAppointments ?? 0), kind: '' },
            { k: 'dispatch open', v: Number(j.dispatchOpen ?? 0), kind: '' },
            { k: 'dispatch overdue', v: Number(j.dispatchOverdue ?? 0), kind: 'warn' },
          ];

          // Coordinator/manager: include event + offer throughput (derived from events feed).
          try{
            const er = effectiveRole();
            if (['event_coordinator','manager'].includes(er)) {
              const je = await api('/api/portal/events?limit=200');
              const all = Array.isArray(je.events) ? je.events : [];
              const realEvents = all.filter((ev) => {
                const area = String(ev?.area_tag || '').trim();
                const kind = String(ev?.meta?.kind || '').trim();
                const k = (kind || area).trim();
                return k !== 'appointment' && k !== 'dispatch';
              });

              const today = new Date();
              const yyyy = today.getUTCFullYear();
              const mm = String(today.getUTCMonth() + 1).padStart(2, '0');
              const dd = String(today.getUTCDate()).padStart(2, '0');
              const todayIso = `${yyyy}-${mm}-${dd}`;

              const in30 = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
              const y30 = in30.getUTCFullYear();
              const m30 = String(in30.getUTCMonth() + 1).padStart(2, '0');
              const d30 = String(in30.getUTCDate()).padStart(2, '0');
              const iso30 = `${y30}-${m30}-${d30}`;

              const upcoming30 = realEvents.filter((ev) => {
                const d = String(ev?.event_date || '').trim();
                return d && d >= todayIso && d <= iso30;
              });

              const offerEvents = realEvents.filter((ev) => ['event_host','media_team'].includes(String(ev?.assigned_role || '').trim()));
              const offerCounts = { open: 0, sent: 0, pending: 0, accepted: 0, declined: 0 };
              for (const ev of offerEvents) {
                const sum = offerSummaryForEvent(ev);
                const st = String(sum.offerState || '').trim();
                if (st && Object.prototype.hasOwnProperty.call(offerCounts, st)) offerCounts[st] += 1;
              }

              tiles.push(
                { k: 'events (30d)', v: Number(upcoming30.length || 0), kind: '' },
                { k: 'offers open', v: Number(offerCounts.open || 0), kind: '' },
                { k: 'offers pending', v: Number(offerCounts.pending || 0), kind: 'warn' },
                { k: 'offers accepted', v: Number(offerCounts.accepted || 0), kind: 'ok' },
              );
            }
          } catch(_e) {}

          box.innerHTML = tiles.map((t) => `
            <div class="card" style="background:#fff; min-width: 170px; flex: 1 1 170px;">
              <div class="bd" style="padding:12px 12px;">
                <div class="muted small" style="font-weight:900;">${escapeHtml(String(t.k || ''))}</div>
                <div style="margin-top:6px;"><span class="badge ${escapeHtml(String(t.kind || ''))}">${escapeHtml(String(t.v ?? 0))}</span></div>
              </div>
            </div>
          `).join('');
        }
        setBadge('ok', 'loaded');
      } catch(e){
        $('statsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadTeamAvailability(){
      // Legacy (Team availability card removed). Keep as a safe no-op.
      const msg = $('teamAvailMsg');
      const box = $('teamAvailList');
      if (!msg && !box) return;
      if (msg) msg.textContent = '';
      if (box) box.innerHTML = '';
      try{
        if (!state.usersCache || !Array.isArray(state.usersCache) || !state.usersCache.length) {
          await loadUsers();
        }
        if (!state.usersCache || !Array.isArray(state.usersCache) || !state.usersCache.length) throw new Error('No users found');
        const users = state.usersCache.slice(0, 60);
        const rows = [];
        for (const u of users) {
          // eslint-disable-next-line no-await-in-loop
          const j = await api('/api/portal/availability?userId=' + encodeURIComponent(String(u.userId)));
          const notes = String(j.availability?.notes || '').trim();
          const slots = (j.availability?.slots && typeof j.availability.slots === 'object') ? j.availability.slots : null;
          const byDate = (slots && slots.byDate && typeof slots.byDate === 'object') ? slots.byDate : null;

          let text = notes;
          if (!text && byDate) {
            const days = Object.keys(byDate);
            let total = 0;
            for (const d of days) {
              const arr = Array.isArray(byDate[d]) ? byDate[d] : [];
              total += arr.length;
            }
            if (days.length && total) {
              text = `Slots: ${total} across ${days.length} days`;
            }
          }

          if (!text) continue;
          rows.push({ u, notes: text, updatedAt: j.availability?.updatedAt || '' });
        }
        if (!rows.length) {
          if (box) box.innerHTML = '<div class="muted small">No availability saved.</div>';
          return;
        }
        if (box) {
          const canEditProfiles = ['event_coordinator','manager'].includes(effectiveRole());
          box.innerHTML = rows.map((r) => {
            const uid = String(r?.u?.userId || '').trim();
            const editBtn = (canEditProfiles && uid)
              ? `<button class="btn secondary small" type="button" data-avail-edit-profile="${escapeHtml(uid)}">Edit profile</button>`
              : '';

            return `
            <div class="card" style="background:#fff; margin-bottom:10px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; gap:10px;">
                  <div>
                    <div style="font-weight:900;">${escapeHtml(r.u.email || r.u.userId)}</div>
                    <div class="muted small" style="margin-top:4px;">${escapeHtml(viewingLabel(r.u.role || ''))}</div>
                  </div>
                  <div class="row" style="gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap;">
                    <div class="muted small">${escapeHtml(String(r.updatedAt || '').slice(0,19).replace('T',' '))}</div>
                    ${editBtn}
                  </div>
                </div>
                <div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(r.notes)}</div>
              </div>
            </div>
            `;
          }).join('');

          for (const btn of box.querySelectorAll('button[data-avail-edit-profile]')){
            btn.addEventListener('click', () => {
              const userId = String(btn.getAttribute('data-avail-edit-profile') || '').trim();
              if (!userId) return;
              state.talent.editUserId = userId;
              state.talent.step = 1;
              setTab('talent');
            });
          }
        }
      } catch(e){
        if (msg) msg.textContent = String(e.message || e);
      }
    }

    function dispatchDue(task){
      const d = String(task?.event_date || '');
      const t = String(task?.start_time || '');
      return [d, t].filter(Boolean).join(' ');
    }

    function isOverdue(task){
      const st = String(task?.status || '');
      if (['completed', 'cancelled'].includes(st)) return false;
      const d = String(task?.event_date || '');
      if (!d) return false;
      const now = new Date();
      const yyyy = now.getUTCFullYear();
      const mm = String(now.getUTCMonth() + 1).padStart(2, '0');
      const dd = String(now.getUTCDate()).padStart(2, '0');
      const today = `${yyyy}-${mm}-${dd}`;
      return d < today;
    }

    async function loadDispatchInto(tbodyId, msgId, { overdueOnly = false, scope = '' } = {}){
      const tb = $(tbodyId);
      const msgEl = $(msgId);
      if (!tb) return;
      if (msgEl) msgEl.textContent = '';
      setBadge('warn', 'loading');
      try{
        const qs = [];
        qs.push('limit=80');
        if (overdueOnly) qs.push('overdue=1');
        if (scope) qs.push('scope=' + encodeURIComponent(scope));
        const j = await api('/api/portal/dispatch?' + qs.join('&'));
        const tasks = (j.tasks || []).filter((t) => !['completed','cancelled'].includes(String(t.status || '')));
        state.dispatch = tasks;
        if (!tasks.length) {
          tb.innerHTML = '<tr><td colspan="5" class="muted">No tasks.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        const meId = state.me?.user?.id;
        const role = String(state.me?.profile?.role || '');

        tb.innerHTML = tasks.map((t) => {
          const meta = t.meta && typeof t.meta === 'object' ? t.meta : {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = String(t.status || '');
          const due = dispatchDue(t);
          const overdue = isOverdue(t) ? '<span class="badge warn">overdue</span>' : '';
          const escalated = meta.escalatedAt ? '<span class="badge warn">escalated</span>' : '';
          const canClaim = !t.assigned_user_id && st === 'open' && role && t.assigned_role === role;
          const canComplete = (t.assigned_user_id && meId && t.assigned_user_id === meId) || String(state.me?.profile?.role || '') === 'manager';
          const claimBtn = canClaim ? `<button class="btn small" data-task-claim="${t.id}">Claim</button>` : '';
          const doneBtn = canComplete ? `<button class="btn secondary small" data-task-done="${t.id}">Done</button>` : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(due)}</td>
              <td>${escapeHtml(String(t.title || ''))} ${overdue} ${escalated}</td>
              <td class="muted">${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>${claimBtn} ${doneBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-task-claim]')){
          btn.addEventListener('click', async () => {
            if (msgEl) msgEl.textContent = '';
            try{
              const id = Number(btn.dataset.taskClaim);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, assignedUserId: state.me.user.id, status: 'assigned' } });
              await loadDispatchInto(tbodyId, msgId);
              setBadge('ok', 'claimed');
            } catch(e){
              if (msgEl) msgEl.textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-task-done]')){
          btn.addEventListener('click', async () => {
            if (msgEl) msgEl.textContent = '';
            try{
              const id = Number(btn.dataset.taskDone);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'completed' } });
              await loadDispatchInto(tbodyId, msgId);
              setBadge('ok', 'done');
            } catch(e){
              if (msgEl) msgEl.textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadDispatchManager(){
      const tb = $('dispatchTbody');
      $('dispatchMsg').textContent = '';
      if (!tb) return;
      setBadge('warn', 'loading');
      try{
        const statusFilter = String($('dispatchStatus')?.value || '').trim();
        const roleFilter = String($('dispatchRole')?.value || '').trim();
        const overdueOnly = !!$('dispatchOverdueOnly')?.checked;

        const qs = [];
        qs.push('limit=180');
        if (statusFilter) qs.push('status=' + encodeURIComponent(statusFilter));
        if (roleFilter) qs.push('assignedRole=' + encodeURIComponent(roleFilter));
        if (overdueOnly) qs.push('overdue=1');

        const j = await api('/api/portal/dispatch?' + qs.join('&'));
        let tasks = (j.tasks || []);
        if (!statusFilter) {
          // Default view: show open/assigned only.
          tasks = tasks.filter((t) => ['open', 'assigned'].includes(String(t.status || '')));
        }
        state.dispatch = tasks;
        if (!tasks.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No tasks.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = tasks.map((t) => {
          const meta = t.meta && typeof t.meta === 'object' ? t.meta : {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = String(t.status || '');
          const due = dispatchDue(t);
          const overdue = isOverdue(t) ? '<span class="badge warn">overdue</span>' : '';
          const escalated = meta.escalatedAt ? '<span class="badge warn">escalated</span>' : '';
          const assigned = t.assigned_user_id ? String(t.assigned_user_id).slice(0, 8) : '';
          const canEscalate = isOverdue(t) && !meta.escalatedAt && !['completed','cancelled'].includes(st);
          const escBtn = canEscalate ? `<button class="btn secondary small" data-mgr-escalate="${t.id}">Escalate</button>` : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(due)}</td>
              <td>${escapeHtml(String(t.title || ''))} ${overdue} ${escalated}</td>
              <td><span class="badge">${escapeHtml(viewingLabel(String(t.assigned_role || '')))}</span></td>
              <td class="muted" style="font-family:var(--mono); font-size:12px;">${escapeHtml(assigned)}</td>
              <td class="muted">${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>
                <button class="btn secondary small" data-mgr-done="${t.id}">Done</button>
                <button class="btn secondary small" data-mgr-cancel="${t.id}">Cancel</button>
                ${escBtn}
              </td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-mgr-done]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrDone);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'completed' } });
              await loadDispatchManager();
              setBadge('ok', 'done');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-mgr-cancel]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrCancel);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, status: 'cancelled' } });
              await loadDispatchManager();
              setBadge('ok', 'cancelled');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-mgr-escalate]')){
          btn.addEventListener('click', async () => {
            $('dispatchMsg').textContent = '';
            try{
              const id = Number(btn.dataset.mgrEscalate);
              await api('/api/portal/dispatch', { method:'PATCH', body: { id, action: 'escalate' } });
              await loadDispatchManager();
              setBadge('ok', 'escalated');
            } catch(e){
              $('dispatchMsg').textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('dispatchMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createDispatchTask(){
      $('dispatchCreateMsg').textContent = '';
      try{
        const assignedRole = String($('dispatchAssignedRole').value || '').trim();
        if (!assignedRole) throw new Error('Select an assigned role');
        const title = String($('dispatchTitle').value || '').trim();
        if (!title) throw new Error('Enter a title');

        const leadIdRaw = String($('dispatchLeadId').value || '').trim();
        const leadId = leadIdRaw ? Number(leadIdRaw) : (state.selectedLead ? Number(state.selectedLead.id) : null);
        const body = {
          leadId: leadId || null,
          title,
          assignedRole,
          dueDate: $('dispatchDueDate').value || null,
          dueTime: $('dispatchDueTime').value || '',
          priority: Number($('dispatchPriority').value || 0),
          notes: String($('dispatchNotes').value || ''),
        };

        await api('/api/portal/dispatch', { method:'POST', body });
        $('dispatchTitle').value = '';
        $('dispatchNotes').value = '';
        await loadDispatchManager();
        setBadge('ok', 'created');
      } catch(e){
        $('dispatchCreateMsg').textContent = String(e.message || e);
      }
    }

    async function scanDispatchOverdue(){
      $('dispatchMsg').textContent = '';
      try{
        const j = await api('/api/portal/dispatch_scan', { method:'POST', body: {} });
        $('dispatchMsg').textContent = `Scanned ${Number(j.scanned || 0)}; escalated ${Number(j.escalated || 0)}`;
        await loadDispatchManager();
        setBadge('ok', 'scanned');
      } catch(e){
        $('dispatchMsg').textContent = String(e.message || e);
      }
    }

    async function aiResearch(){
      $('researchMsg').textContent = '';
      $('researchBox').classList.add('hide');
      try{
        const lead = requireSelectedLead('AI research');
        const question = $('researchQ').value.trim();
        const j = await api('/api/portal/ai/research', {
          method: 'POST',
          body: { leadId: lead.id, question },
        });
        const r = j.research || {};
        $('researchSummary').value = String(r.summary || '');
        $('researchTalking').value = Array.isArray(r.talkingPoints) ? r.talkingPoints.join('\n') : '';
        $('researchObjections').value = Array.isArray(r.likelyObjections) ? r.likelyObjections.join('\n') : '';
        $('researchNext').value = Array.isArray(r.nextSteps) ? r.nextSteps.join('\n') : '';
        $('researchBox').classList.remove('hide');
      } catch(e){
        $('researchMsg').textContent = String(e.message || e);
      }
    }

    async function submitClose(){
      $('closeMsg').textContent = '';
      try{
        const lead = requireSelectedLead('Close');

        const disposition = String($('closeDisposition').value || 'follow_up');
        const payload = {
          disposition,
          closedOn: $('closeDate').value || null,
          packageTier: $('closePackage').value || null,
          packagePrice: Number($('closePackagePrice').value || 0),
          initialPayment: Number($('closeInitial').value || 0),
          termMonths: Number($('closeTerm').value || 0),
          monthlyPricing: Number($('closeMonthly').value || 0),
          contractSendDate: $('closeContractSend').value || null,
          notes: $('closeNotes').value || '',
        };

        const nextStatus = disposition === 'won' ? 'won' : (disposition === 'lost' ? 'lost' : 'working');

        await api('/api/portal/close', {
          method: 'POST',
          body: { leadId: lead.id, status: nextStatus, payload },
        });

        $('closeMsg').textContent = '';
        setBadge('ok', 'submitted');
      } catch(e){
        $('closeMsg').textContent = String(e.message || e);
      }
    }

    function fmtDate(d){
      const s = String(d || '');
      if (!s) return '';
      return s.slice(0,10);
    }

    function fmtTime(t){
      const s = String(t || '');
      if (!s) return '';
      return s;
    }

    async function loadAppointmentsInto(tbodyId, msgId){
      // Back-compat signature; opts is supported below.
      return loadAppointmentsIntoWithOpts(tbodyId, msgId, {});
    }

    async function openLeadById(leadId, { goTab = 'calls', goDialerSubtab = 'activity' } = {}){
      const id = Number(leadId || 0);
      if (!id) throw new Error('missing_lead_id');
      const j = await api('/api/portal/activities?leadId=' + encodeURIComponent(String(id)) + '&limit=80');
      state.selectedLead = j.lead || { id };
      setSelectedLeadLine();
      setTab(goTab);
      if (goTab === 'calls') setDialerSubtab(goDialerSubtab);
      await loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
    }

    async function loadAppointmentsIntoWithOpts(tbodyId, msgId, { allowComplete = true, allowOpenLead = false } = {}){
      const tb = $(tbodyId);
      const msgEl = $(msgId);
      if (!tb) return;
      if (msgEl) msgEl.textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/appointments?limit=80');
        const appts = j.appointments || [];
        state.appointments = appts;

        if (!appts.length){
          tb.innerHTML = '<tr><td colspan="5" class="muted">No appointments yet.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        const canMarkComplete = !!allowComplete && (isManagerUser() || ['closer','account_manager'].includes(effectiveRole()));

        tb.innerHTML = appts.map((a) => {
          const meta = a.meta || {};
          const leadLine = meta.leadLabel || (meta.leadId ? ('Lead #' + meta.leadId) : '');
          const st = a.status || '';
          const doneBtn = (canMarkComplete && st !== 'completed')
            ? `<button class="btn secondary small" data-appt-done="${a.id}" data-appt-msg="${escapeHtml(msgId)}">Mark completed</button>`
            : '';

          const openBtn = (allowOpenLead && meta.leadId)
            ? `<button class="btn secondary small" data-appt-open="${Number(meta.leadId)}">Open</button>`
            : '';
          return `
            <tr>
              <td class="muted">${escapeHtml(fmtDate(a.event_date))}</td>
              <td class="muted">${escapeHtml(fmtTime(a.start_time))}</td>
              <td>${escapeHtml(leadLine)}</td>
              <td><span class="badge">${escapeHtml(st)}</span></td>
              <td>${openBtn} ${doneBtn}</td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-appt-done]')){
          btn.addEventListener('click', async () => {
            const m = $(msgId);
            if (m) m.textContent = '';
            try{
              const id = Number(btn.dataset.apptDone);
              await api('/api/portal/appointments', { method:'PATCH', body: { id, status:'completed' } });
              await loadAppointmentsIntoWithOpts(tbodyId, msgId, { allowComplete, allowOpenLead });
            } catch(e){
              if (m) m.textContent = String(e.message || e);
            }
          });
        }

        for (const btn of tb.querySelectorAll('button[data-appt-open]')){
          btn.addEventListener('click', async () => {
            const m = $(msgId);
            if (m) m.textContent = '';
            try{
              const id = Number(btn.dataset.apptOpen);
              await openLeadById(id, { goTab: 'calls', goDialerSubtab: 'activity' });
            } catch(e){
              if (m) m.textContent = String(e.message || e);
            }
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadAppointments(){
      if (!$('apptsTbody')) return;
      return loadAppointmentsIntoWithOpts('apptsTbody', 'apptsMsg', { allowComplete: true, allowOpenLead: false });
    }

    async function loadDialerBooked(){
      if (!$('dialerBookedTbody')) return;
      return loadAppointmentsIntoWithOpts('dialerBookedTbody', 'dialerBookedMsg', { allowComplete: false, allowOpenLead: true });
    }

    async function scheduleDialerBooked(){
      openScheduleModal({ after: () => loadDialerBooked() });
    }

    async function loadCloserQueue(){
      if (!$('closerQueueTbody')) return;
      $('closerQueueMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/queue?kind=closer&limit=60');
        const leads = j.leads || [];
        state.closerQueue = leads;
        const tb = $('closerQueueTbody');
        renderPipelineTimeline('closerPipeline', leads, { context: 'closer' });

        if (!leads.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No pipeline items.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = leads.map((l) => {
          const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
          const prop = l.property_name || l.company || '';
          const fu = l.meta && typeof l.meta === 'object' ? String(l.meta.followup || '') : '';
          return `
            <tr>
              <td><span class="badge">${l.id}</span></td>
              <td>${escapeHtml(name)}</td>
              <td class="muted">${escapeHtml(prop)}</td>
              <td><span class="badge">${escapeHtml(l.status || '')}</span></td>
              <td class="muted">${escapeHtml(String(l.priority ?? 0))}</td>
              <td class="muted">${escapeHtml(fu)}</td>
              <td><button class="btn secondary small" data-closer-pick="${l.id}">Select</button></td>
            </tr>
          `;
        }).join('');

        for (const btn of tb.querySelectorAll('button[data-closer-pick]')){
          btn.addEventListener('click', () => {
            const id = Number(btn.dataset.closerPick);
            const l = leads.find((x) => Number(x.id) === id) || null;
            state.selectedLead = l;
            setSelectedLeadLine();
            loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
          });
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('closerQueueMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function scheduleAppointmentFrom({ dateId, timeId, notesId, msgId, after } = {}){
      const msgEl = $(msgId);
      if (msgEl) msgEl.textContent = '';
      try{
        const lead = requireSelectedLead('Meeting');
        const eventDate = String($(dateId)?.value || '');
        const startTime = String($(timeId)?.value || '');
        if (!eventDate) throw new Error('Pick a date');
        if (!startTime) throw new Error('Pick a start time');

        await api('/api/portal/appointments', {
          method:'POST',
          body: {
            leadId: lead.id,
            eventDate,
            startTime,
            notes: String($(notesId)?.value || ''),
          }
        });

        const notesEl = $(notesId);
        if (notesEl) notesEl.value = '';
        if (after) await after();
        setBadge('ok', 'scheduled');
      } catch(e){
        if (msgEl) msgEl.textContent = String(e.message || e);
      }
    }

    async function scheduleAppointment(){
      return scheduleAppointmentFrom({
        dateId: 'apptDate',
        timeId: 'apptStart',
        notesId: 'apptNotes',
        msgId: 'scheduleApptMsg',
        after: () => loadAppointments(),
      });
    }

    async function scheduleMeeting(){
      openScheduleModal({ after: () => loadAppointmentsInto('meetingsTbody', 'meetingsMsg') });
    }

    function localTz(){
      try { return Intl.DateTimeFormat().resolvedOptions().timeZone || ''; } catch { return ''; }
    }

    function isoToday(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function addMonths(date, offset){
      const d = new Date(date.getTime());
      d.setMonth(d.getMonth() + Number(offset || 0));
      return d;
    }

    function ymd(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function monthLabel(d){
      const m = d.toLocaleString(undefined, { month: 'long' });
      return `${m} ${d.getFullYear()}`;
    }

    function ensureAvailInit(){
      // Treat slots as floating local times; always show in viewer's local timezone.
      state.availability.tz = localTz() || '';
      if (typeof state.availability.weekOffset !== 'number') state.availability.weekOffset = Number(state.availability.weekOffset || 0);
      if (!state.availability.byDate || typeof state.availability.byDate !== 'object') state.availability.byDate = {};
      if (!state.availability.drag || typeof state.availability.drag !== 'object') state.availability.drag = { active: false, mode: '' };
    }

    function addDays(date, n){
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + Number(n || 0));
      return d;
    }

    function startOfWeekMonday(date){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const dow = d.getDay();
      const diff = (dow + 6) % 7; // Monday -> 0
      d.setDate(d.getDate() - diff);
      return d;
    }

    function dayHeadLabel(date){
      try{
        return date.toLocaleDateString(undefined, { weekday:'short', month:'numeric', day:'numeric' });
      } catch {
        return ymd(date);
      }
    }

    function timeLabel(hhmm){
      const s = String(hhmm || '');
      const parts = s.split(':');
      const h = Number(parts[0] || 0);
      const m = Number(parts[1] || 0);
      const d = new Date();
      d.setHours(h, m, 0, 0);
      try{
        return d.toLocaleTimeString(undefined, { hour:'numeric', minute:'2-digit' });
      } catch {
        return s;
      }
    }

    function availabilityEditable(){
      const er = effectiveRole();
      if (!['dialer','remote_setter','in_person_setter','closer','account_manager','manager','event_coordinator','event_host','media_team'].includes(er)) return false;
      return true;
    }

    function weekDates(){
      ensureAvailInit();
      const off = Number(state.availability.weekOffset || 0);
      const base = addDays(new Date(), off * 7);
      const start = startOfWeekMonday(base);
      return Array.from({ length: 7 }, (_, i) => addDays(start, i));
    }

    function setAvailSlot(dateYmd, hhmm, on){
      ensureAvailInit();
      const d = String(dateYmd || '');
      const t = String(hhmm || '');
      if (!d || !t) return;
      const arr = Array.isArray(state.availability.byDate[d]) ? state.availability.byDate[d].slice() : [];
      const set = new Set(arr.map(String));
      if (on) set.add(t);
      else set.delete(t);
      const next = Array.from(set).sort();
      if (next.length) state.availability.byDate[d] = next;
      else delete state.availability.byDate[d];
    }

    function hasAvailSlot(dateYmd, hhmm){
      const d = String(dateYmd || '');
      const t = String(hhmm || '');
      const arr = Array.isArray(state.availability.byDate?.[d]) ? state.availability.byDate[d] : [];
      return arr.includes(t);
    }

    function timeSlots(){
      const out = [];
      for (let h = 8; h <= 20; h++) {
        for (const m of [0, 30]) {
          if (h === 20 && m > 0) continue;
          out.push(String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0'));
        }
      }
      return out;
    }

    function renderAvailWeekGrid(){
      ensureAvailInit();
      const grid = $('availWeekGrid');
      if (!grid) return;

      const todayKey = isoToday();

      const tz = localTz() || '';
      const tzLabel = $('availTzLabel');
      if (tzLabel) tzLabel.textContent = tz || 'local';

      const week = weekDates();
      const weekLabel = $('availWeekLabel');
      if (weekLabel) weekLabel.textContent = `${ymd(week[0])} – ${ymd(week[6])}`;

      const editable = availabilityEditable();
      const ro = $('availReadOnlyNote');
      if (ro) ro.style.display = (!editable) ? 'block' : 'none';
      const saveBtn = $('availSaveBtn');
      if (saveBtn) saveBtn.disabled = !editable;
      const clearBtn = $('availClearWeek');
      if (clearBtn) clearBtn.disabled = !editable;

      const head = [];
      head.push(`<div class="availHeadCell"></div>`);
      for (const d of week) {
        const dateKey = ymd(d);
        const pastDay = (dateKey < todayKey);
        head.push(`<div class="availHeadCell ${pastDay ? 'pastDay' : ''}">${escapeHtml(dayHeadLabel(d))}<div class="muted" style="margin-top:2px; font-weight:700;">${escapeHtml(dateKey)}</div></div>`);
      }

      const rows = [];
      const times = timeSlots();
      for (const t of times) {
        rows.push(`<div class="availTimeCell">${escapeHtml(timeLabel(t))}</div>`);
        for (const d of week) {
          const dateKey = ymd(d);
          const active = hasAvailSlot(dateKey, t);
          const pastDay = (dateKey < todayKey);
          if (editable) {
            rows.push(
              `<div class="availSlotCell ${pastDay ? 'pastDay' : ''}"><button type="button" class="availSlotBtn ${active ? 'active' : ''}" data-avail-date="${escapeHtml(dateKey)}" data-avail-time="${escapeHtml(t)}" aria-pressed="${active ? 'true' : 'false'}" ${pastDay ? 'disabled' : ''}></button></div>`
            );
          } else {
            rows.push(
              `<div class="availSlotCell ${pastDay ? 'pastDay' : ''}"><div class="availSlotBtn ${active ? 'active' : ''}" data-avail-date="${escapeHtml(dateKey)}" data-avail-time="${escapeHtml(t)}" aria-hidden="true"></div></div>`
            );
          }
        }
      }

      grid.innerHTML = head.join('') + rows.join('');

      // Drag multi-select (Excel-ish).
      const drag = state.availability.drag;
      drag.active = false;
      drag.mode = '';

      // Read-only view: no pointer handlers.
      if (!editable) {
        grid.onpointerdown = null;
        grid.onpointerover = null;
        grid.onpointerup = null;
        grid.onpointercancel = null;
        return;
      }

      const applyCell = (btn) => {
        if (btn.disabled) return;
        const dateKey = String(btn.dataset.availDate || '');
        const t = String(btn.dataset.availTime || '');
        if (!dateKey || !t) return;
        if (!availabilityEditable()) return;
        const wantOn = drag.mode === 'add';
        setAvailSlot(dateKey, t, wantOn);
        const on = hasAvailSlot(dateKey, t);
        btn.classList.toggle('active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      };

      grid.onpointerdown = (ev) => {
        const btn = ev.target && ev.target.closest ? ev.target.closest('button.availSlotBtn') : null;
        if (!btn) return;
        ev.preventDefault();
        const dateKey = String(btn.dataset.availDate || '');
        const t = String(btn.dataset.availTime || '');
        const currentlyOn = hasAvailSlot(dateKey, t);
        drag.active = true;
        drag.mode = currentlyOn ? 'remove' : 'add';
        applyCell(btn);
        try { btn.setPointerCapture(ev.pointerId); } catch(_e) {}
      };

      grid.onpointerover = (ev) => {
        if (!drag.active) return;
        const btn = ev.target && ev.target.closest ? ev.target.closest('button.availSlotBtn') : null;
        if (!btn) return;
        applyCell(btn);
      };

      const endDrag = () => {
        drag.active = false;
        drag.mode = '';
      };
      grid.onpointerup = endDrag;
      grid.onpointercancel = endDrag;
      document.addEventListener('pointerup', endDrag, { once: true });
    }

    async function loadAvailability(){
      if (!$('availWeekGrid')) return;
      const card = $('meetingsAvailabilityCard');
      const show = ['dialer','remote_setter','in_person_setter','closer','account_manager','manager','event_coordinator','event_host','media_team'].includes(effectiveRole());
      if (card) card.classList.toggle('hide', !show);
      if (!show) return;
      $('availMsg').textContent = '';
      ensureAvailInit();

      try{
        state.availability.viewUserId = '';
        const j = await api('/api/portal/availability');
        const slots = j.availability?.slots && typeof j.availability.slots === 'object' ? j.availability.slots : {};
        const byDate = slots.byDate && typeof slots.byDate === 'object' ? slots.byDate : {};
        state.availability.byDate = byDate;
        state.availability.tz = localTz() || '';
        renderAvailWeekGrid();
        setBadge('ok', 'ready');
      } catch(e){
        $('availMsg').textContent = String(e.message || e);
      }
    }

    async function saveAvailability(){
      $('availMsg').textContent = '';
      ensureAvailInit();
      const btn = $('availSaveBtn');
      const wasDisabled = btn ? btn.disabled : false;
      if (btn) btn.disabled = true;
      try{
        await api('/api/portal/availability', {
          method: 'PUT',
          body: {
            slots: {
              tz: localTz() || '',
              byDate: state.availability.byDate || {},
            }
          }
        });
        $('availMsg').textContent = `Saved ${new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}`;
        setBadge('ok', 'saved');
      } catch(e){
        $('availMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      } finally {
        if (btn) btn.disabled = wasDisabled ? true : !availabilityEditable();
      }
    }

    // Accounts (Account Manager)

    function ensureAccountsInit(){
      state.accounts = state.accounts || {
        list: [],
        selectedId: '',
        selected: null,
        sentiment: [],
        issues: [],
        templates: [],
        qTimer: null,
      };
    }

    function accountsEditable(){
      const er = effectiveRole();
      if (!['account_manager','manager'].includes(er)) return false;
      return true;
    }

    function cleanYmd(s){
      const v = String(s || '').trim();
      if (!v) return '';
      if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return '';
      return v;
    }

    function addDaysYmd(ymd, days){
      const s = cleanYmd(ymd);
      if (!s) return '';
      const d = new Date(s + 'T00:00:00');
      if (Number.isNaN(d.getTime())) return '';
      d.setDate(d.getDate() + Number(days || 0));
      const yyyy = String(d.getFullYear()).padStart(4,'0');
      const mm = String(d.getMonth() + 1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function daysInMonth(y, m0){
      return new Date(y, m0 + 1, 0).getDate();
    }

    function addMonthsYmd(ymd, months){
      const s = cleanYmd(ymd);
      if (!s) return '';
      const m = Math.trunc(Number(months || 0));
      if (!Number.isFinite(m) || !m) return s;
      const [yyyy, mm, dd] = s.split('-').map((x)=>Number(x));
      if (!yyyy || !mm || !dd) return '';
      const fromM0 = mm - 1;
      const base = new Date(yyyy, fromM0, 1);
      base.setMonth(base.getMonth() + m);
      const ty = base.getFullYear();
      const tm0 = base.getMonth();
      const day = Math.min(dd, daysInMonth(ty, tm0));
      const out = new Date(ty, tm0, day);
      const outY = String(out.getFullYear()).padStart(4,'0');
      const outM = String(out.getMonth() + 1).padStart(2,'0');
      const outD = String(out.getDate()).padStart(2,'0');
      return `${outY}-${outM}-${outD}`;
    }

    function computeContractEnd({ contractStart, termMonths, contractEnd }){
      const end = cleanYmd(contractEnd);
      if (end) return end;
      const start = cleanYmd(contractStart);
      const tm = Math.trunc(Number(termMonths || 0));
      if (!start || !Number.isFinite(tm) || tm <= 0) return '';
      return addMonthsYmd(start, tm);
    }

    function computeRenewalReminderDate({ contractEnd, reminderDays }){
      const end = cleanYmd(contractEnd);
      if (!end) return '';
      const days = Math.trunc(Number(reminderDays || 30));
      const safe = Number.isFinite(days) ? Math.max(0, Math.min(3650, days)) : 30;
      return addDaysYmd(end, -safe);
    }

    function renderRenewalHint({ elId, contractStart, termMonths, contractEnd, reminderDays }){
      const el = $(elId);
      if (!el) return;
      const end = computeContractEnd({ contractStart, termMonths, contractEnd });
      const rr = computeRenewalReminderDate({ contractEnd: end, reminderDays });
      if (!end && !rr) { el.textContent = ''; return; }
      const bits = [];
      if (end) bits.push('Contract end: ' + end);
      if (rr) bits.push('Renewal reminder: ' + rr);
      el.textContent = bits.join(' • ');
    }

    function syncNewAccountDerived(){
      const start = cleanYmd($('acctStart')?.value);
      const termMonths = Math.trunc(Number($('acctTermMonths')?.value || 0));
      const end = computeContractEnd({ contractStart: start, termMonths, contractEnd: $('acctEnd')?.value });
      if ($('acctEnd') && !$('acctEnd').value && end) $('acctEnd').value = end;
    }

    function syncEditAccountDerived(){
      const start = cleanYmd($('acctEditStart')?.value);
      const termMonths = Math.trunc(Number($('acctEditTermMonths')?.value || 0));
      const reminderDays = Math.trunc(Number($('acctEditReminderDays')?.value || 30));
      const end = computeContractEnd({ contractStart: start, termMonths, contractEnd: $('acctEditEnd')?.value });
      if ($('acctEditEnd') && !$('acctEditEnd').value && end) $('acctEditEnd').value = end;
      const rr = computeRenewalReminderDate({ contractEnd: end, reminderDays });
      if ($('acctEditReminderDate')) $('acctEditReminderDate').value = rr || '';
      renderRenewalHint({ elId: 'acctRenewalHint', contractStart: start, termMonths, contractEnd: end, reminderDays });
    }

    function accountMatchesQ(a, q){
      const qq = String(q || '').trim().toLowerCase();
      if (!qq) return true;
      const hay = [
        a?.name,
        a?.propertyName,
        a?.address,
        a?.city,
        a?.state,
        a?.postalCode,
        a?.primaryContactName,
        a?.primaryContactEmail,
        a?.primaryContactPhone,
        a?.contractTier,
        a?.tier,
        a?.contractStart,
        a?.contractEnd,
        a?.renewalReminderDate,
        a?.email,
        a?.phone,
        a?.notes,
      ]
        .map((x) => String(x || '').toLowerCase())
        .join(' ');
      return hay.includes(qq);
    }

    function renderAccounts(){
      ensureAccountsInit();
      const list = $('accountsList');
      if (!list) return;
      const q = String($('accountsQ')?.value || '').trim();
      const expiring = !!$('accountsExpiring')?.checked;

      const items = (Array.isArray(state.accounts.list) ? state.accounts.list : [])
        .filter((a) => accountMatchesQ(a, q));

      const soonDays = 45;
      const now = new Date();
      const soon = new Date(now.getTime() + soonDays * 86400 * 1000);
      const filtered = expiring ? items.filter((a) => {
        const end = String(a?.contractEnd || '').trim();
        if (!end) return false;
        const d = new Date(end + 'T00:00:00');
        if (Number.isNaN(d.getTime())) return false;
        return d <= soon;
      }) : items;

      if (!filtered.length) {
        list.innerHTML = '<div class="muted small">No accounts yet.</div>';
        return;
      }

      const sel = String(state.accounts.selectedId || '');
      list.innerHTML = filtered.map((a) => {
        const id = String(a?.id || '');
        const active = id && id === sel;
        const name = String(a?.propertyName || a?.name || '').trim() || '(no property)';
        const tier = String(a?.contractTier || a?.tier || '').trim();
        const end = String(a?.contractEnd || '').trim();
        const rr = String(a?.renewalReminderDate || '').trim();
        const contact = String(a?.primaryContactName || '').trim();
        const meta = [
          contact ? contact : '',
          tier ? ('tier ' + tier) : '',
          rr ? ('remind ' + rr) : (end ? ('ends ' + end) : ''),
        ].filter(Boolean).join(' • ');
        return `
          <button type="button" class="card" data-acct-pick="${escapeHtml(id)}" style="text-align:left; background:#fff; border-color:${active ? 'rgba(199,154,59,.55)' : 'rgba(199,154,59,.25)'}">
            <div class="bd">
              <div style="font-weight:900;">${escapeHtml(name)}</div>
              ${meta ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(meta)}</div>` : ''}
            </div>
          </button>
        `;
      }).join('');

      for (const btn of list.querySelectorAll('[data-acct-pick]')) {
        btn.addEventListener('click', () => {
          selectAccount(String(btn.dataset.acctPick || '')).catch(()=>{});
        });
      }
    }

    function renderSelectedAccount(){
      ensureAccountsInit();
      const a = state.accounts.selected;
      $('acctSelected').textContent = a ? (String(a.propertyName || a.name || '').trim() || '(no property)') : 'None';

      const editable = accountsEditable();
      const disable = !editable || !a;
      const ids = [
        'acctEditName','acctEditAddress','acctEditContactName','acctEditEmail','acctEditPhone',
        'acctEditTier','acctEditTermMonths','acctEditStart','acctEditEnd','acctEditReminderDays','acctEditReminderDate',
        'acctEditNotes','acctSaveBtn','acctDeleteBtn',
        'sentimentKind','sentimentTags','sentimentNote','sentimentAddBtn',
        'issueSeverity','issueStatus','issueNote','issueAddBtn',
        'tplType','tplName','tplBody','tplSaveBtn'
      ];
      for (const id of ids) {
        const el = $(id);
        if (!el) continue;
        if (id === 'tplType' || id === 'tplName' || id === 'tplBody' || id === 'tplSaveBtn') {
          // Templates are global; allow even without selecting an account (if editable).
          el.disabled = !editable;
        } else {
          el.disabled = disable;
        }
      }

      // Derived field should not be edited directly.
      if ($('acctEditReminderDate')) $('acctEditReminderDate').disabled = true;

      // New toggle should be disabled in view-as.
      if ($('accountsNewToggle')) $('accountsNewToggle').disabled = !editable;

      // New-account form
      const newIds = ['acctName','acctAddress','acctContactName','acctContactEmail','acctContactPhone','acctTier','acctTermMonths','acctReminderDays','acctStart','acctEnd','acctNotes','accountsCreateBtn'];
      for (const id of newIds) {
        const el = $(id);
        if (el) el.disabled = !editable;
      }

      if (!a) {
        if ($('acctEditName')) $('acctEditName').value = '';
        if ($('acctEditAddress')) $('acctEditAddress').value = '';
        if ($('acctEditContactName')) $('acctEditContactName').value = '';
        if ($('acctEditTier')) $('acctEditTier').value = '';
        if ($('acctEditTermMonths')) $('acctEditTermMonths').value = '';
        if ($('acctEditStart')) $('acctEditStart').value = '';
        if ($('acctEditEnd')) $('acctEditEnd').value = '';
        if ($('acctEditReminderDays')) $('acctEditReminderDays').value = '';
        if ($('acctEditReminderDate')) $('acctEditReminderDate').value = '';
        if ($('acctEditEmail')) $('acctEditEmail').value = '';
        if ($('acctEditPhone')) $('acctEditPhone').value = '';
        if ($('acctEditNotes')) $('acctEditNotes').value = '';
        if ($('acctRenewalHint')) $('acctRenewalHint').textContent = '';
        $('sentimentList').innerHTML = '<div class="muted small">Select an account.</div>';
        $('issueList').innerHTML = '<div class="muted small">Select an account.</div>';
        return;
      }

      const contractStart = String(a.contractStart || '');
      const termMonths = Number(a.termMonths || 0);
      const contractEnd = computeContractEnd({ contractStart, termMonths, contractEnd: a.contractEnd });
      const reminderDays = Number(a.renewalReminderDays != null ? a.renewalReminderDays : 30);
      const reminderDate = cleanYmd(a.renewalReminderDate) || computeRenewalReminderDate({ contractEnd, reminderDays });

      if ($('acctEditName')) $('acctEditName').value = String(a.propertyName || a.name || '');
      if ($('acctEditAddress')) $('acctEditAddress').value = String(a.address || '');
      if ($('acctEditContactName')) $('acctEditContactName').value = String(a.primaryContactName || '');
      if ($('acctEditTier')) $('acctEditTier').value = String(a.contractTier || a.tier || '');
      if ($('acctEditTermMonths')) $('acctEditTermMonths').value = String(a.termMonths != null ? a.termMonths : '');
      if ($('acctEditStart')) $('acctEditStart').value = cleanYmd(a.contractStart) || '';
      if ($('acctEditEnd')) $('acctEditEnd').value = contractEnd || '';
      if ($('acctEditReminderDays')) $('acctEditReminderDays').value = String(a.renewalReminderDays != null ? a.renewalReminderDays : 30);
      if ($('acctEditReminderDate')) $('acctEditReminderDate').value = reminderDate || '';
      if ($('acctEditEmail')) $('acctEditEmail').value = String(a.primaryContactEmail || a.email || '');
      if ($('acctEditPhone')) $('acctEditPhone').value = String(a.primaryContactPhone || a.phone || '');
      if ($('acctEditNotes')) $('acctEditNotes').value = String(a.notes || '');

      renderRenewalHint({
        elId: 'acctRenewalHint',
        contractStart: cleanYmd(a.contractStart),
        termMonths: a.termMonths,
        contractEnd,
        reminderDays: a.renewalReminderDays,
      });
    }

    function renderSentiment(){
      ensureAccountsInit();
      const el = $('sentimentList');
      if (!el) return;
      const items = Array.isArray(state.accounts.sentiment) ? state.accounts.sentiment : [];
      if (!items.length) {
        el.innerHTML = '<div class="muted small">No sentiment entries yet.</div>';
        return;
      }
      el.innerHTML = items.slice().reverse().map((x) => {
        const when = String(x?.createdAt || '');
        const kind = String(x?.kind || '');
        const tags = Array.isArray(x?.tags) ? x.tags.join(', ') : String(x?.tags || '');
        const note = String(x?.note || '');
        const meta = [kind ? kind.toUpperCase() : '', tags ? ('tags: ' + tags) : ''].filter(Boolean).join(' • ');
        return `
          <div class="card" style="background:#fff; margin-top:10px;">
            <div class="bd">
              <div class="muted small">${escapeHtml(when)}</div>
              ${meta ? `<div class="small" style="margin-top:4px; font-weight:900;">${escapeHtml(meta)}</div>` : ''}
              ${note ? `<div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(note)}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderIssues(){
      ensureAccountsInit();
      const el = $('issueList');
      if (!el) return;
      const items = Array.isArray(state.accounts.issues) ? state.accounts.issues : [];
      if (!items.length) {
        el.innerHTML = '<div class="muted small">No issues yet.</div>';
        return;
      }
      el.innerHTML = items.slice().reverse().map((x) => {
        const when = String(x?.createdAt || '');
        const sev = String(x?.severity || '');
        const st = String(x?.status || '');
        const note = String(x?.note || '');
        const meta = [sev ? ('sev ' + sev) : '', st ? st : ''].filter(Boolean).join(' • ');
        return `
          <div class="card" style="background:#fff; margin-top:10px;">
            <div class="bd">
              <div class="muted small">${escapeHtml(when)}</div>
              ${meta ? `<div class="small" style="margin-top:4px; font-weight:900;">${escapeHtml(meta)}</div>` : ''}
              ${note ? `<div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(note)}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTemplates(){
      ensureAccountsInit();
      const el = $('tplList');
      if (!el) return;
      const items = Array.isArray(state.accounts.templates) ? state.accounts.templates : [];
      if (!items.length) {
        el.innerHTML = '<div class="muted small">No templates yet.</div>';
        return;
      }
      el.innerHTML = items.slice().reverse().map((t) => {
        const name = String(t?.name || '').trim() || '(no name)';
        const type = String(t?.type || '').trim();
        const body = String(t?.body || '').trim();
        return `
          <div class="card" style="background:#fff; margin-top:10px;">
            <div class="bd">
              <div style="font-weight:900;">${escapeHtml(name)}</div>
              ${type ? `<div class="muted small" style="margin-top:2px;">${escapeHtml(type)}</div>` : ''}
              ${body ? `<div class="small" style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(body)}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadAccounts(){
      ensureAccountsInit();
      if (!$('viewAccounts')) return;
      $('accountsMsg').textContent = '';
      $('acctSaveMsg').textContent = '';
      const show = (effectiveRole() === 'account_manager' || effectiveRole() === 'manager');
      $('viewAccounts').classList.toggle('hide', !show);
      if (!show) return;

      try {
        const expiring = !!$('accountsExpiring')?.checked;
        const q = String($('accountsQ')?.value || '').trim();
        const url = '/api/portal/accounts'
          + (q || expiring ? ('?' + new URLSearchParams({
            q: q || '',
            expiringSoon: expiring ? '1' : '0'
          }).toString()) : '');
        const j = await api(url);
        state.accounts.list = Array.isArray(j.accounts) ? j.accounts : [];

        // Keep selection if possible
        const sel = String(state.accounts.selectedId || '');
        const found = sel ? state.accounts.list.find((x) => String(x?.id || '') === sel) : null;
        if (found) {
          state.accounts.selected = found;
        } else {
          state.accounts.selectedId = '';
          state.accounts.selected = null;
        }

        renderAccounts();
        renderSelectedAccount();

        if (!state.accounts.templates.length) {
          await loadTemplates().catch(()=>{});
        }
      } catch (e) {
        $('accountsMsg').textContent = String(e.message || e);
      }
    }

    async function selectAccount(accountId){
      ensureAccountsInit();
      $('acctSaveMsg').textContent = '';
      const id = String(accountId || '').trim();
      state.accounts.selectedId = id;
      state.accounts.selected = (Array.isArray(state.accounts.list) ? state.accounts.list : []).find((x) => String(x?.id || '') === id) || null;
      renderAccounts();
      renderSelectedAccount();
      await loadSentiment().catch(()=>{});
      await loadIssues().catch(()=>{});
    }

    async function createAccount(){
      ensureAccountsInit();
      $('accountsCreateMsg').textContent = '';
      try {
        const name = String($('acctName').value || '').trim();
        const addr = String($('acctAddress').value || '').trim();
        const contactName = String($('acctContactName').value || '').trim();
        if (!name) throw new Error('property_name_required');
        if (!addr) throw new Error('property_address_required');
        if (!contactName) throw new Error('primary_contact_name_required');

        const termMonths = Math.trunc(Number($('acctTermMonths').value || 0));
        const reminderDays = Math.trunc(Number($('acctReminderDays').value || 30));
        const contractStart = cleanYmd($('acctStart').value) || '';
        const contractEnd = computeContractEnd({ contractStart, termMonths, contractEnd: $('acctEnd').value });
        const body = {
          name,
          propertyName: name,
          address: addr,
          primaryContactName: contactName,
          primaryContactEmail: String($('acctContactEmail').value || '').trim(),
          primaryContactPhone: String($('acctContactPhone').value || '').trim(),
          contractTier: String($('acctTier').value || '').trim(),
          tier: String($('acctTier').value || '').trim(),
          termMonths: Number.isFinite(termMonths) ? termMonths : 0,
          renewalReminderDays: Number.isFinite(reminderDays) ? reminderDays : 30,
          contractStart,
          contractEnd,
          email: String($('acctContactEmail').value || '').trim(),
          phone: String($('acctContactPhone').value || '').trim(),
          notes: String($('acctNotes').value || '').trim(),
        };
        const j = await api('/api/portal/accounts', { method:'POST', body });
        $('accountsNewBox').hidden = true;
        $('acctName').value = '';
        $('acctAddress').value = '';
        $('acctContactName').value = '';
        $('acctContactEmail').value = '';
        $('acctContactPhone').value = '';
        $('acctTier').value = '';
        $('acctTermMonths').value = '';
        $('acctReminderDays').value = '';
        $('acctStart').value = '';
        $('acctEnd').value = '';
        $('acctNotes').value = '';

        await loadAccounts();
        const id = String(j?.account?.id || '').trim();
        if (id) await selectAccount(id);
      } catch (e) {
        $('accountsCreateMsg').textContent = String(e.message || e);
      }
    }

    async function saveAccount(){
      ensureAccountsInit();
      $('acctSaveMsg').textContent = '';
      try {
        const a = state.accounts.selected;
        if (!a || !a.id) throw new Error('select_account');

        const name = String($('acctEditName').value || '').trim();
        if (!name) throw new Error('property_name_required');

        const termMonths = Math.trunc(Number($('acctEditTermMonths').value || 0));
        const reminderDays = Math.trunc(Number($('acctEditReminderDays').value || 30));
        const contractStart = cleanYmd($('acctEditStart').value) || '';
        const contractEnd = computeContractEnd({ contractStart, termMonths, contractEnd: $('acctEditEnd').value });
        const reminderDate = computeRenewalReminderDate({ contractEnd, reminderDays });

        const patch = {
          name,
          propertyName: name,
          address: String($('acctEditAddress').value || '').trim(),
          primaryContactName: String($('acctEditContactName').value || '').trim(),
          primaryContactEmail: String($('acctEditEmail').value || '').trim(),
          primaryContactPhone: String($('acctEditPhone').value || '').trim(),
          contractTier: String($('acctEditTier').value || '').trim(),
          tier: String($('acctEditTier').value || '').trim(),
          termMonths: Number.isFinite(termMonths) ? termMonths : 0,
          renewalReminderDays: Number.isFinite(reminderDays) ? reminderDays : 30,
          contractStart,
          contractEnd,
          renewalReminderDate: reminderDate,
          email: String($('acctEditEmail').value || '').trim(),
          phone: String($('acctEditPhone').value || '').trim(),
          notes: String($('acctEditNotes').value || '').trim(),
        };
        const j = await api('/api/portal/accounts', { method:'PUT', body: { id: a.id, patch } });
        const updated = j?.account || null;
        if (updated && updated.id) {
          // update local list
          state.accounts.list = (Array.isArray(state.accounts.list) ? state.accounts.list : []).map((x) => String(x?.id || '') === String(updated.id) ? updated : x);
          state.accounts.selected = updated;
        }
        renderAccounts();
        renderSelectedAccount();
        $('acctSaveMsg').textContent = '';
        setBadge('ok', 'saved');
      } catch (e) {
        $('acctSaveMsg').textContent = String(e.message || e);
      }
    }

    async function deleteAccount(){
      ensureAccountsInit();
      $('acctSaveMsg').textContent = '';
      try {
        const a = state.accounts.selected;
        if (!a || !a.id) throw new Error('select_account');
        const ok = confirm('Delete this account?');
        if (!ok) return;
        await api('/api/portal/accounts', { method:'DELETE', body: { id: a.id } });
        state.accounts.selectedId = '';
        state.accounts.selected = null;
        state.accounts.sentiment = [];
        state.accounts.issues = [];
        await loadAccounts();
        renderSelectedAccount();
        renderSentiment();
        renderIssues();
      } catch (e) {
        $('acctSaveMsg').textContent = String(e.message || e);
      }
    }

    async function loadSentiment(){
      ensureAccountsInit();
      $('sentimentMsg').textContent = '';
      const a = state.accounts.selected;
      if (!a || !a.id) { state.accounts.sentiment = []; renderSentiment(); return; }
      try {
        const j = await api('/api/portal/account_sentiment?accountId=' + encodeURIComponent(String(a.id)));
        state.accounts.sentiment = Array.isArray(j.entries) ? j.entries : [];
        renderSentiment();
      } catch (e) {
        $('sentimentMsg').textContent = String(e.message || e);
      }
    }

    async function addSentiment(){
      ensureAccountsInit();
      $('sentimentMsg').textContent = '';
      const a = state.accounts.selected;
      if (!a || !a.id) { $('sentimentMsg').textContent = 'select an account'; return; }
      try {
        const tags = String($('sentimentTags').value || '').split(',').map((x)=>x.trim()).filter(Boolean).slice(0, 10);
        await api('/api/portal/account_sentiment', {
          method:'POST',
          body: {
            accountId: a.id,
            kind: String($('sentimentKind').value || 'green'),
            tags,
            note: String($('sentimentNote').value || '').trim(),
          }
        });
        $('sentimentTags').value = '';
        $('sentimentNote').value = '';
        await loadSentiment();
      } catch (e) {
        $('sentimentMsg').textContent = String(e.message || e);
      }
    }

    async function loadIssues(){
      ensureAccountsInit();
      $('issueMsg').textContent = '';
      const a = state.accounts.selected;
      if (!a || !a.id) { state.accounts.issues = []; renderIssues(); return; }
      try {
        const j = await api('/api/portal/account_issues?accountId=' + encodeURIComponent(String(a.id)));
        state.accounts.issues = Array.isArray(j.issues) ? j.issues : [];
        renderIssues();
      } catch (e) {
        $('issueMsg').textContent = String(e.message || e);
      }
    }

    async function addIssue(){
      ensureAccountsInit();
      $('issueMsg').textContent = '';
      const a = state.accounts.selected;
      if (!a || !a.id) { $('issueMsg').textContent = 'select an account'; return; }
      try {
        await api('/api/portal/account_issues', {
          method:'POST',
          body: {
            accountId: a.id,
            severity: String($('issueSeverity').value || 'low'),
            status: String($('issueStatus').value || 'open'),
            note: String($('issueNote').value || '').trim(),
          }
        });
        $('issueNote').value = '';
        await loadIssues();
      } catch (e) {
        $('issueMsg').textContent = String(e.message || e);
      }
    }

    async function loadTemplates(){
      ensureAccountsInit();
      $('tplMsg').textContent = '';
      try {
        const j = await api('/api/portal/account_templates');
        state.accounts.templates = Array.isArray(j.templates) ? j.templates : [];
        renderTemplates();
      } catch (e) {
        $('tplMsg').textContent = String(e.message || e);
      }
    }

    async function saveTemplate(){
      ensureAccountsInit();
      $('tplMsg').textContent = '';
      try {
        const type = String($('tplType').value || 'email');
        const name = String($('tplName').value || '').trim();
        const body = String($('tplBody').value || '').trim();
        if (!name) throw new Error('name_required');
        if (!body) throw new Error('body_required');
        await api('/api/portal/account_templates', { method:'POST', body: { type, name, body } });
        $('tplName').value = '';
        $('tplBody').value = '';
        await loadTemplates();
      } catch (e) {
        $('tplMsg').textContent = String(e.message || e);
      }
    }

    function setSelectedEvent(eventObj){
      state.selectedEvent = eventObj || null;
      const e = state.selectedEvent;
      $('selectedEventLine').textContent = e ? `#${e.id} • ${e.title || ''} • ${(e.event_date || '')}`.trim() : 'None';

      if ($('eventOpsSelectedLine')) $('eventOpsSelectedLine').textContent = e ? `Selected: #${e.id} • ${e.title || ''} • ${(e.event_date || '')}`.trim() : '';

      const empty = $('eventDetailsEmpty');
      const wrap = $('eventDetailsWrap');
      if (empty) empty.classList.toggle('hide', !!e);
      if (wrap) wrap.classList.toggle('hide', !e);

      // Coordinators/managers manage ops; hosts/media do recaps.
      const er0 = effectiveRole();
      const showRecap = !!(e && ['event_host','media_team'].includes(er0));
      $('eventRecapWrap').classList.toggle('hide', !showRecap);

      if (e && showRecap) {
        const er = effectiveRole();
        const effectiveUserId = (isManagerUser() && String(state.viewAsUserId || '').trim())
          ? String(state.viewAsUserId || '').trim()
          : String(state.me?.user?.id || '');
        const myAsg = myAssignmentForEvent(e, er, effectiveUserId);
        const myStatus = String(myAsg?.status || '').trim();

        const isMedia = er === 'media_team';
        const recapEditable = isCoordinatorRole()
          || (er === 'event_host' && eventIsMineForRole(e, 'event_host', effectiveUserId))
          || (isMedia && myStatus === 'accepted');

        // Media team doesn't fill host recap fields.
        const hostOnlyIds = ['recapAttendance','recapRating','recapIssues','recapIssuesDetails','recapNotes','recapStandouts','recapGiveawayWinners','recapFeedbackHighlights','recapEventFlowDoc'];
        for (const id of hostOnlyIds) {
          const el = $(id);
          if (!el) continue;
          const parent = el.closest('div');
          if (parent) parent.classList.toggle('hide', isMedia);
        }

        const recapBtn = $('submitRecapBtn');
        if (recapBtn) {
          recapBtn.toggleAttribute('disabled', !recapEditable);
          recapBtn.classList.toggle('hide', !recapEditable);
        }

        if ($('recapMsg')) {
          if (!recapEditable && !isCoordinatorRole() && ['pending','declined'].includes(myStatus)) {
            $('recapMsg').textContent = (myStatus === 'declined') ? 'You declined this offer.' : 'Accept the offer to submit.';
          } else if (!recapEditable && !isCoordinatorRole() && isMedia) {
            $('recapMsg').textContent = myStatus ? 'Accept the offer to submit.' : 'No media assignment on this event.';
          } else {
            $('recapMsg').textContent = '';
          }
        }
      }

      const canUseOps = ['event_coordinator','manager'].includes(effectiveRole());
      if ($('eventOpsWrap')) $('eventOpsWrap').classList.toggle('hide', !(e && canUseOps));

      if (e && showRecap) loadRecaps(e.id).catch(()=>{});
      if (e && canUseOps) {
        initEventOps().catch(()=>{});
        try{
          requestAnimationFrame(() => {
            const box = $('eventOpsWrap');
            if (box && !box.classList.contains('hide')) box.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        } catch(_e) {}
      }
    }

    function splitCsvList(text, { max = 30, maxLen = 60 } = {}){
      return String(text || '')
        .split(',')
        .map((x) => x.trim())
        .filter(Boolean)
        .map((x) => x.slice(0, maxLen))
        .slice(0, max);
    }

    function joinCsvList(arr){
      return (Array.isArray(arr) ? arr : []).filter(Boolean).join(', ');
    }

    function offerSummaryForEvent(ev){
      const e = (ev && typeof ev === 'object') ? ev : {};
      const meta = (e.meta && typeof e.meta === 'object') ? e.meta : {};
      const assignedUserId = String(e.assigned_user_id || '').trim();
      const eventStatus = String(e.status || '').trim() || 'open';
      const assignedRole = String(e.assigned_role || '').trim();

      const assignments = Array.isArray(meta.assignments) ? meta.assignments : [];
      const scoped = assignedRole
        ? assignments.filter((a) => String(a?.role || '').trim() === assignedRole)
        : assignments;
      const arr = scoped.length ? scoped : assignments;

      const counts = { pending: 0, accepted: 0, declined: 0 };
      for (const a of arr) {
        const s = String(a?.status || 'pending').trim();
        if (s === 'accepted') counts.accepted += 1;
        else if (s === 'declined') counts.declined += 1;
        else counts.pending += 1;
      }

      let offerState = '';
      if (assignedUserId || counts.accepted) offerState = 'accepted';
      else if (counts.pending) offerState = 'pending';
      else if (arr.length && counts.declined === arr.length) offerState = 'declined';
      else if (arr.length) offerState = 'sent';
      else if (eventStatus === 'open') offerState = 'open';
      else offerState = '';

      let offerText = '';
      if (offerState === 'pending') offerText = counts.pending > 1 ? `pending (${counts.pending})` : 'pending';
      else if (offerState === 'accepted') offerText = counts.accepted > 1 ? `accepted (${counts.accepted})` : 'accepted';
      else if (offerState === 'declined') offerText = counts.declined > 1 ? `declined (${counts.declined})` : 'declined';
      else if (offerState === 'sent') offerText = arr.length > 1 ? `sent (${arr.length})` : 'sent';
      else if (offerState) offerText = offerState;
      const offerKind = (offerState === 'accepted') ? 'ok' : ((offerState === 'pending') ? 'warn' : '');
      return { eventStatus, offerText, offerState, offerKind };
    }

    function centsToUsd(cents){
      const n = Number(cents || 0);
      if (!Number.isFinite(n)) return '';
      const dollars = n / 100;
      return dollars.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    }

    function userLabelById(userId){
      const id = String(userId || '').trim();
      if (!id) return '';
      const u = (Array.isArray(state.usersCache) ? state.usersCache : []).find((x) => String(x.userId || '') === id);
      return String(u?.fullName || u?.email || u?.userId || id).trim();
    }

    function findOfferEventById(eventId){
      const id = Number(eventId || 0);
      if (!id) return null;
      const fromOffers = (Array.isArray(state.offers) ? state.offers : []).find((x) => Number(x?.id) === id) || null;
      if (fromOffers) return fromOffers;
      const fromEvents = (Array.isArray(state.events) ? state.events : []).find((x) => Number(x?.id) === id) || null;
      return fromEvents;
    }

    async function openOfferDetail(eventId){
      const id = Number(eventId || 0);
      if (!id) return;
      state.selectedOfferEventId = id;
      await ensureUsersCache();
      renderOfferDetailFromState();
      try{ requestAnimationFrame(() => $('offersDetailWrap')?.scrollIntoView({ behavior: 'smooth', block: 'start' })); } catch(_e) {}
    }

    function closeOfferDetail({ clearSelection = true } = {}){
      if (clearSelection) state.selectedOfferEventId = null;
      const wrap = $('offersDetailWrap');
      if (wrap) wrap.classList.add('hide');
    }

    function renderOfferDetailFromState(){
      const id = Number(state.selectedOfferEventId || 0);
      const wrap = $('offersDetailWrap');
      if (!id) {
        if (wrap) wrap.classList.add('hide');
        return;
      }

      const ev = findOfferEventById(id);
      if (!ev) {
        if (wrap) wrap.classList.add('hide');
        return;
      }

      const meta = (ev.meta && typeof ev.meta === 'object') ? ev.meta : {};
      const asgRole = String(ev.assigned_role || '').trim();
      const sum = offerSummaryForEvent(ev);

      const title = $('offersDetailTitle');
      if (title) title.textContent = `#${ev.id} • ${ev.title || ''}`.trim();

      const metaLine = $('offersDetailMeta');
      if (metaLine) {
        const city = [ev.city, ev.state].filter(Boolean).join(', ');
        metaLine.textContent = [String(ev.event_date || '').trim(), city, asgRole, sum.offerText].filter(Boolean).join(' • ');
      }

      const viewBtn = $('offersDetailViewEventBtn');
      if (viewBtn) viewBtn.classList.toggle('hide', !['event_coordinator','manager'].includes(effectiveRole()));

      const body = $('offersDetailBody');
      if (body) {
        const budget = (meta.budget && typeof meta.budget === 'object') ? meta.budget : {};
        const hostPay = Number(budget.hostPayCents || 0);
        const mediaPay = Number(budget.mediaPayCents || 0);
        const payoutLine = (hostPay || mediaPay)
          ? `Host ${centsToUsd(hostPay)} • Media ${centsToUsd(mediaPay)}`
          : (ev.payout_cents ? centsToUsd(ev.payout_cents) : '');

        const assignments = Array.isArray(meta.assignments) ? meta.assignments : [];
        const scoped = asgRole ? assignments.filter((a) => String(a?.role || '').trim() === asgRole) : assignments;
        const sentTo = scoped
          .map((a) => {
            const uid = String(a?.userId || '').trim();
            if (!uid) return null;
            const st = String(a?.status || 'pending').trim();
            return `${userLabelById(uid)} (${st})`;
          })
          .filter(Boolean);

        const er = effectiveRole();
        const effectiveUserId = (isManagerUser() && String(state.viewAsUserId || '').trim())
          ? String(state.viewAsUserId || '').trim()
          : String(state.me?.user?.id || '');
        const myAsg = myAssignmentForEvent(ev, er, effectiveUserId);
        const myStatus = String(myAsg?.status || '').trim();

        const myLine = myStatus ? `<div class="muted small" style="margin-top:6px;">Your status: <span class="badge ${escapeHtml(myStatus === 'accepted' ? 'ok' : (myStatus === 'declined' ? 'warn' : ''))}">${escapeHtml(myStatus)}</span></div>` : '';

        body.innerHTML = `
          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <div class="badge">event: ${escapeHtml(String(sum.eventStatus || ev.status || ''))}</div>
            ${payoutLine ? `<div class="badge">payouts: ${escapeHtml(payoutLine)}</div>` : ''}
            ${ev.assigned_user_id ? `<div class="badge ok">assigned: ${escapeHtml(userLabelById(ev.assigned_user_id))}</div>` : ''}
          </div>

          ${sentTo.length ? `
            <div style="margin-top:10px;">
              <div class="muted small" style="font-weight:900;">Sent to</div>
              <div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(sentTo.join('\n'))}</div>
            </div>
          ` : ''}

          ${myLine}

          ${String(ev.notes || '').trim() ? `
            <div style="margin-top:10px;">
              <div class="muted small" style="font-weight:900;">Notes</div>
              <div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(String(ev.notes || '').trim())}</div>
            </div>
          ` : ''}
        `;
      }

      if (wrap) wrap.classList.remove('hide');
    }

    function isCollapsed(targetId){
      const body = $(targetId);
      return !!(body && body.classList.contains('hide'));
    }

    function setCollapsed(targetId, collapsed, { persist = true } = {}){
      const body = $(targetId);
      if (body) body.classList.toggle('hide', !!collapsed);
      const btn = document.querySelector(`button[data-collapse-target="${CSS.escape(String(targetId))}"]`);
      if (btn) {
        btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
        const chev = btn.querySelector('[data-collapse-chev]');
        if (chev) chev.textContent = collapsed ? '▼' : '▲';
      }
      if (persist) {
        if (!state.ui || typeof state.ui !== 'object') state.ui = { sidebarCollapsed: false, collapse: {}, _opsCollapseInit: false };
        if (!state.ui.collapse || typeof state.ui.collapse !== 'object') state.ui.collapse = {};
        state.ui.collapse[String(targetId)] = collapsed ? 'closed' : 'open';
      }
    }

    function restoreCollapsedFromState(targetId, fallbackCollapsed){
      const key = String(targetId);
      const v = state?.ui?.collapse && typeof state.ui.collapse === 'object' ? state.ui.collapse[key] : null;
      if (v === 'open') return setCollapsed(targetId, false, { persist: false });
      if (v === 'closed') return setCollapsed(targetId, true, { persist: false });
      return setCollapsed(targetId, !!fallbackCollapsed, { persist: true });
    }

    function toggleCollapsed(targetId){
      const next = !isCollapsed(targetId);
      setCollapsed(targetId, next);
    }

    function ensureEventOpsCollapseDefaults(){
      if (state?.ui?._opsCollapseInit) return;
      restoreCollapsedFromState('opsStaffingBody', false);
      restoreCollapsedFromState('opsChecklistBody', false);
      restoreCollapsedFromState('opsPlanBody', true);
      restoreCollapsedFromState('opsBudgetBody', true);
      restoreCollapsedFromState('opsVendorsBody', true);
      restoreCollapsedFromState('opsFeedbackBody', true);
      restoreCollapsedFromState('opsAiStaffingBody', true);
      restoreCollapsedFromState('opsReportBody', true);
      state.ui._opsCollapseInit = true;
    }

    function talentIsCoordinator(){
      return isCoordinatorRole();
    }

    function effectiveUserIdForView(){
      const v = String(state.viewAsUserId || '').trim();
      if (isManagerUser() && v) return v;
      return String(state.me?.user?.id || '').trim();
    }

    function normalizeTalentRecord(raw, { fallbackUserId = '', defaultRole = '' } = {}){
      const r = (raw && typeof raw === 'object') ? raw : {};
      const userId = String(r.userId || fallbackUserId || '').trim();
      const pubIn = (r.public && typeof r.public === 'object') ? r.public : r;
      const intIn = (r.internal && typeof r.internal === 'object') ? r.internal : r;
      const cleanList = (v) => (Array.isArray(v) ? v : splitCsvList(v || '', { max: 30, maxLen: 80 }));
      const pub = {
        userId,
        displayName: String(pubIn.displayName || r.displayName || '').trim(),
        role: String(pubIn.role || r.role || defaultRole || '').trim(),
        homeBaseCity: String(pubIn.homeBaseCity || r.homeBaseCity || '').trim(),
        homeBaseState: String(pubIn.homeBaseState || r.homeBaseState || '').trim(),
        bio: String(pubIn.bio || r.bio || '').trim(),
        notes: String(pubIn.notes || '').trim(),
        specialties: cleanList(pubIn.specialties),
        tone: cleanList(pubIn.tone || r.tone),
        gear: cleanList(pubIn.gear || r.gear),
        preferredPairings: cleanList(pubIn.preferredPairings),
        avatarDataUrl: String(pubIn.avatarDataUrl || '').trim(),
      };
      const intRel = (intIn.reliability && typeof intIn.reliability === 'object') ? intIn.reliability : (r.reliability && typeof r.reliability === 'object' ? r.reliability : {});
      const internal = {
        userId,
        notes: String(intIn.notes || r.notes || '').trim(),
        specialties: cleanList(intIn.specialties),
        tone: cleanList(intIn.tone),
        gear: cleanList(intIn.gear),
        preferredPairings: cleanList(intIn.preferredPairings),
        reliability: {
          score: (intRel.score == null || intRel.score === '') ? null : Number(intRel.score),
          flags: cleanList(intRel.flags),
        },
      };
      if (!Number.isFinite(internal.reliability.score)) internal.reliability.score = null;
      return {
        userId,
        public: pub,
        internal,
        updatedAt: String(r.updatedAt || '').trim(),
      };
    }

    function avatarInitials(label){
      const s = String(label || '').trim();
      if (!s) return '';
      const parts = s.replace(/[^a-zA-Z0-9\s]/g, ' ').split(/\s+/).filter(Boolean);
      const a = (parts[0] || '').slice(0, 1);
      const b = (parts.length > 1 ? parts[parts.length - 1] : '').slice(0, 1);
      return (a + b).toUpperCase();
    }

    function setAvatarCircle(el, dataUrl, fallbackLabel){
      if (!el) return;
      const url = String(dataUrl || '').trim();
      if (url) {
        el.style.backgroundImage = `url(${url})`;
        el.textContent = '';
      } else {
        el.style.backgroundImage = '';
        el.textContent = avatarInitials(fallbackLabel) || ' '; // keep circle height
      }
    }

    function uniqueList(arr){
      const items = (Array.isArray(arr) ? arr : []).map((x) => String(x || '').trim()).filter(Boolean);
      const out = [];
      const seen = new Set();
      for (const it of items) {
        const k = it.toLowerCase();
        if (seen.has(k)) continue;
        seen.add(k);
        out.push(it);
      }
      return out;
    }

    function reliabilityLabel(score){
      const n = Number(score);
      if (!Number.isFinite(n)) return { text: 'Unrated', kind: '' };
      if (n >= 80) return { text: 'Reliable', kind: 'ok' };
      if (n >= 55) return { text: 'Somewhat reliable', kind: '' };
      return { text: 'Not reliable', kind: 'warn' };
    }

    function availabilitySummaryFrom(availability){
      const a = (availability && typeof availability === 'object') ? availability : {};
      const byDate = (a?.slots?.byDate && typeof a.slots.byDate === 'object') ? a.slots.byDate : null;
      if (!byDate) return '';
      const days = Object.keys(byDate);
      if (!days.length) return '';
      let total = 0;
      for (const d of days) {
        const arr = Array.isArray(byDate[d]) ? byDate[d] : [];
        total += arr.length;
      }
      if (!total) return '';
      return `${days.length} day(s) • ${total} slot(s)`;
    }

    async function ensureAvailabilityCacheForUserIds(userIds, { force = false } = {}){
      const ids = uniqueList(userIds).slice(0, 60);
      if (!ids.length) return 0;
      const ttlMs = 5 * 60 * 1000;
      const now = Date.now();
      const missing = ids.filter((id) => {
        const hit = state._availabilityCache && state._availabilityCache[id];
        if (!hit) return true;
        if (force) return true;
        const loadedAt = Number(hit.loadedAt || 0);
        return (now - loadedAt) > ttlMs;
      });
      if (!missing.length) return 0;

      const tasks = missing.map(async (id) => {
        try {
          const j = await api('/api/portal/availability?userId=' + encodeURIComponent(String(id)));
          state._availabilityCache[id] = { loadedAt: now, availability: j.availability || null };
        } catch {
          state._availabilityCache[id] = { loadedAt: now, availability: null };
        }
      });

      // Keep it simple: modest parallelism.
      const chunkSize = 8;
      for (let i = 0; i < tasks.length; i += chunkSize) {
        // eslint-disable-next-line no-await-in-loop
        await Promise.all(tasks.slice(i, i + chunkSize));
      }

      return missing.length;
    }

    function chipHtml(label, { removable = false, removeKey = '', removeValue = '' } = {}){
      const rm = removable
        ? `<button type="button" aria-label="Remove" data-chip-remove="${escapeHtml(removeKey)}" data-chip-value="${escapeHtml(removeValue)}">×</button>`
        : '';
      return `<span class="chip">${escapeHtml(label)}${rm}</span>`;
    }

    function renderChipList(containerId, items, { removable = false, removeKey = '', labelFor = null } = {}){
      const el = $(containerId);
      if (!el) return;
      const arr = uniqueList(items);
      el.innerHTML = arr.length
        ? arr.map((v) => chipHtml(typeof labelFor === 'function' ? String(labelFor(v) || v) : v, { removable, removeKey, removeValue: v })).join('')
        : '<span class="muted small">—</span>';
    }

    function talentProfileEditContext(){
      const targetUserId = (talentIsCoordinator() && String(state.talent.editUserId || '').trim())
        ? String(state.talent.editUserId || '').trim()
        : effectiveUserIdForView();
      const effectiveUserId = effectiveUserIdForView();
      const isSelf = !!targetUserId && targetUserId === effectiveUserId;
      const canEditInternal = talentIsCoordinator() && coordinatorOpsEditable();
      const canEditPublic = isSelf && !isManagerViewAsPreviewOnly() && !!state.talent.selfEditing;
      const showAvailability = ['event_host', 'media_team'].includes(effectiveRole());
      const canEditAvailability = isSelf && showAvailability && !isManagerViewAsPreviewOnly();
      return { targetUserId, effectiveUserId, isSelf, canEditInternal, canEditPublic, showAvailability, canEditAvailability };
    }

    function setTalentStep(next){
      const step = Number(next || 1);
      const ctx = talentProfileEditContext();
      const showStep4 = talentIsCoordinator() || ctx.showAvailability;
      const max = showStep4 ? 4 : 3;
      const safe = Math.max(1, Math.min(step, max));
      state.talent.step = safe;

      const steps = Array.from(document.querySelectorAll('#viewTalent .talStep'));
      for (const el of steps) {
        const n = Number(el.dataset.step || 0);
        el.classList.toggle('hide', n !== safe);
      }

      const buttons = [
        { n: 1, id: 'talStep1' },
        { n: 2, id: 'talStep2' },
        { n: 3, id: 'talStep3' },
        { n: 4, id: 'talStep4' },
      ];
      for (const b of buttons) {
        const btn = $(b.id);
        if (!btn) continue;
        btn.classList.toggle('active', b.n === safe);
      }

      const step4Btn = $('talStep4');
      if (step4Btn) {
        step4Btn.classList.toggle('hide', !showStep4);
        step4Btn.textContent = talentIsCoordinator() ? 'Reliability' : 'Availability';
      }

      const relBox = $('talReliabilityBox');
      if (relBox) relBox.classList.toggle('hide', !talentIsCoordinator());
      const availBox = $('talAvailabilityBox');
      if (availBox) availBox.classList.toggle('hide', !(ctx.showAvailability));

      const prev = $('talPrevBtn');
      const nextBtn = $('talNextBtn');
      if (prev) prev.disabled = safe <= 1;
      if (nextBtn) nextBtn.disabled = safe >= max;
    }

    function setTalentEditingLine(){
      const line = $('talentEditingLine');
      if (!line) return;
      const editing = String(state.talent?.editUserId || '').trim();
      if (!editing) {
        line.textContent = '';
        return;
      }
      const u = (Array.isArray(state.usersCache) ? state.usersCache : []).find((x) => String(x.userId) === editing);
      const label = u ? String(u.fullName || u.email || u.userId || '').trim() : editing;
      line.textContent = `Editing: ${label}`;
    }

    function readTalentForm(){
      const base = (state.talent.form && typeof state.talent.form === 'object') ? state.talent.form : normalizeTalentRecord(null, { fallbackUserId: talentProfileEditContext().targetUserId, defaultRole: myPortalRole() });
      const pub = Object.assign({}, base.public);
      const internal = Object.assign({}, base.internal);

      pub.displayName = String($('talDisplayName')?.value || '').trim();
      pub.role = String($('talRole')?.value || pub.role || '').trim();
      pub.homeBaseCity = String($('talCity')?.value || '').trim();
      pub.homeBaseState = String($('talState')?.value || '').trim();
      pub.bio = String($('talBio')?.value || '').trim();
      pub.notes = String($('talPublicNotes')?.value || '').trim();

      internal.notes = String($('talInternalNotes')?.value || '').trim();

      // Lists are maintained in state.talent.form via chips.
      pub.specialties = uniqueList(base.public?.specialties);
      pub.tone = uniqueList(base.public?.tone);
      pub.gear = uniqueList(base.public?.gear);
      pub.preferredPairings = uniqueList(base.public?.preferredPairings);
      pub.avatarDataUrl = String(base.public?.avatarDataUrl || '').trim();

      internal.specialties = uniqueList(base.internal?.specialties);
      internal.tone = uniqueList(base.internal?.tone);
      internal.gear = uniqueList(base.internal?.gear);
      internal.preferredPairings = uniqueList(base.internal?.preferredPairings);

      // Reliability (internal)
      const scoreRaw = $('talReliabilityScore')?.value;
      const score = (scoreRaw == null || scoreRaw === '') ? null : Number(scoreRaw);
      const clamped = Number.isFinite(score) ? Math.max(0, Math.min(100, Math.trunc(score))) : null;
      internal.reliability = internal.reliability && typeof internal.reliability === 'object' ? internal.reliability : { score: null, flags: [] };
      internal.reliability.score = clamped;
      internal.reliability.flags = uniqueList(base.internal?.reliability?.flags);

      return { public: pub, internal };
    }

    function applyTalentEditMode(){
      const ctx = talentProfileEditContext();
      const publicEditable = ctx.canEditPublic;
      const internalEditable = ctx.canEditInternal;

      // Self view/edit controls
      const selfEditBtn = $('talSelfEditBtn');
      const selfCancelBtn = $('talSelfCancelBtn');
      if (selfEditBtn) selfEditBtn.classList.toggle('hide', talentIsCoordinator() || ctx.targetUserId !== ctx.effectiveUserId || ctx.canEditPublic);
      if (selfCancelBtn) selfCancelBtn.classList.toggle('hide', !(ctx.targetUserId === ctx.effectiveUserId && state.talent.selfEditing));

      // Avatar controls (public)
      const up = $('talAvatarUploadBtn');
      const rm = $('talAvatarRemoveBtn');
      if (up) up.classList.toggle('hide', !publicEditable);
      if (rm) rm.classList.toggle('hide', !publicEditable);

      // Public fields
      for (const id of ['talDisplayName', 'talCity', 'talState', 'talBio', 'talPublicNotes']) {
        const el = $(id);
        if (el) {
          el.disabled = !publicEditable;
          el.classList.toggle('talAsText', !publicEditable);
        }
      }
      const roleEl = $('talRole');
      if (roleEl) {
        roleEl.disabled = true; // role locked always
        roleEl.classList.add('talAsText');
      }

      // Public chip adders
      for (const id of ['talPublicSpecialtyInput','talPublicSpecialtyAdd','talPublicToneInput','talPublicToneAdd','talPublicGearInput','talPublicGearAdd','talPublicPairingsAdd']) {
        const el = $(id);
        if (el) {
          el.disabled = !publicEditable;
          el.classList.toggle('hide', !publicEditable);
        }
      }

      // Internal fields + chip adders
      const internalBox = $('talInternalProfileBox');
      if (internalBox) internalBox.classList.toggle('hide', !talentIsCoordinator());
      const internalNotesBox = $('talInternalNotesBox');
      if (internalNotesBox) internalNotesBox.classList.toggle('hide', !talentIsCoordinator());

      // For coordinators, keep editable tags visible near the top of Profile step.
      if (talentIsCoordinator() && internalBox && internalBox.parentElement) {
        const firstPublicGroup = $('talPublicSpecialtyInput')?.closest('div');
        if (firstPublicGroup && firstPublicGroup.parentElement === internalBox.parentElement) {
          internalBox.parentElement.insertBefore(internalBox, firstPublicGroup);
        }
      }

      for (const id of ['talInternalNotes','talInternalSpecialtyInput','talInternalSpecialtyAdd','talInternalToneInput','talInternalToneAdd','talInternalGearInput','talInternalGearAdd']) {
        const el = $(id);
        if (el) el.disabled = !internalEditable;
      }

      // Reliability controls
      for (const id of ['talReliabilityScore','talReliabilityFlagInput','talReliabilityFlagAdd']) {
        const el = $(id);
        if (el) el.disabled = !internalEditable;
      }

      // Save button
      const saveBtn = $('talentSaveBtn');
      if (saveBtn) {
        const canSave = internalEditable || publicEditable;
        saveBtn.classList.toggle('hide', !canSave);
        saveBtn.disabled = !canSave;
      }
    }

    function syncReliabilityLabel(){
      const el = $('talReliabilityScoreLabel');
      const slider = $('talReliabilityScore');
      if (!el || !slider) return;
      const raw = slider.value;
      const n = (raw == null || raw === '') ? null : Number(raw);
      const lab = reliabilityLabel(n);
      el.textContent = lab.text;
      el.classList.remove('ok', 'warn');
      if (lab.kind) el.classList.add(lab.kind);
    }

    function renderTalentFormChips(){
      const base = (state.talent.form && typeof state.talent.form === 'object') ? state.talent.form : null;
      if (!base) return;
      const ctx = talentProfileEditContext();
      const pubRemovable = ctx.canEditPublic;
      const intRemovable = ctx.canEditInternal;

      renderChipList('talPublicSpecialties', base.public.specialties, { removable: pubRemovable, removeKey: 'pub.specialties' });
      renderChipList('talPublicTone', base.public.tone, { removable: pubRemovable, removeKey: 'pub.tone' });
      renderChipList('talPublicGear', base.public.gear, { removable: pubRemovable, removeKey: 'pub.gear' });

      // Pairings: public when self-editing, internal when coordinator editing.
      const pairKey = talentIsCoordinator() ? 'int.preferredPairings' : 'pub.preferredPairings';
      const pairItems = talentIsCoordinator() ? base.internal.preferredPairings : base.public.preferredPairings;
      renderChipList('talPublicPairings', pairItems, {
        removable: talentIsCoordinator() ? intRemovable : pubRemovable,
        removeKey: pairKey,
        labelFor: (uid) => userLabelById(uid) || uid,
      });

      renderChipList('talInternalSpecialties', base.internal.specialties, { removable: intRemovable, removeKey: 'int.specialties' });
      renderChipList('talInternalTone', base.internal.tone, { removable: intRemovable, removeKey: 'int.tone' });
      renderChipList('talInternalGear', base.internal.gear, { removable: intRemovable, removeKey: 'int.gear' });

      renderChipList('talReliabilityFlags', base.internal?.reliability?.flags || [], { removable: intRemovable, removeKey: 'int.reliability.flags' });
    }

    function writeTalentForm(profile){
      const ctx = talentProfileEditContext();
      const p0 = normalizeTalentRecord(profile, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      state.talent.form = p0;

      if ($('talDisplayName')) $('talDisplayName').value = String(p0.public.displayName || '');
      if ($('talRole')) $('talRole').value = String(p0.public.role || myPortalRole() || '');
      if ($('talCity')) $('talCity').value = String(p0.public.homeBaseCity || '');
      if ($('talState')) $('talState').value = String(p0.public.homeBaseState || '');
      if ($('talBio')) $('talBio').value = String(p0.public.bio || '');
      if ($('talPublicNotes')) $('talPublicNotes').value = String(p0.public.notes || '');
      if ($('talInternalNotes')) $('talInternalNotes').value = String(p0.internal.notes || '');

      setAvatarCircle($('talAvatarCircle'), p0.public.avatarDataUrl, p0.public.displayName || userLabelById(p0.userId));

      if ($('talReliabilityScore')) $('talReliabilityScore').value = (p0.internal?.reliability?.score == null ? '' : String(p0.internal.reliability.score));
      syncReliabilityLabel();

      renderTalentFormChips();
      applyTalentEditMode();
      setTalentStep(Number(state.talent?.step || 1));
    }

    async function loadTalentProfilesCache({ force = false } = {}){
      if (!talentIsCoordinator()) return new Map();

      const now = Date.now();
      const loadedAt = Number(state._talentProfilesLoadedAt || 0);
      const ttlMs = 5 * 60 * 1000;
      if (!force && state._talentProfilesById instanceof Map && (now - loadedAt) < ttlMs) {
        return state._talentProfilesById;
      }

      try {
        const j = await api('/api/portal/talent_profiles');
        const profiles = Array.isArray(j.profiles) ? j.profiles : [];
        state.talent.profiles = profiles;
        const byId = new Map(profiles.map((p) => [String(p?.userId || ''), p]));
        state._talentProfilesById = byId;
        state._talentProfilesLoadedAt = now;
        return byId;
      } catch {
        state.talent.profiles = [];
        const byId = new Map();
        state._talentProfilesById = byId;
        state._talentProfilesLoadedAt = now;
        return byId;
      }
    }

    async function rerenderTalentDirectoryFromCache(){
      if (!talentIsCoordinator()) return;
      await ensureUsersCache();
      const profilesById = (state._talentProfilesById instanceof Map)
        ? state._talentProfilesById
        : new Map((Array.isArray(state.talent?.profiles) ? state.talent.profiles : []).map((p) => [String(p?.userId || ''), p]));
      renderTalentDirectory(profilesById);
    }

    async function loadTalentTab(){
      $('talentMsg').textContent = '';
      $('talentDirMsg').textContent = '';

      // Clear edit mode automatically for non-coordinators.
      if (!talentIsCoordinator()) {
        state.talent.editUserId = '';
      }

      if (talentIsCoordinator()) {
        await ensureUsersCache();
        $('talentDirectoryWrap')?.classList.remove('hide');
        setCollapsed('talentDirBody', false, { persist: true });
        $('talentStopEditingBtn')?.classList.toggle('hide', !String(state.talent.editUserId || '').trim());
      } else {
        $('talentDirectoryWrap')?.classList.add('hide');
        $('talentStopEditingBtn')?.classList.add('hide');
      }

      setTalentEditingLine();

      const profilesById = await loadTalentProfilesCache();

      // Coordinators shouldn't see the editor until they pick someone to edit.
      const editorCard = $('talentProfileEditorCard');
      if (talentIsCoordinator()) {
        const editing = String(state.talent.editUserId || '').trim();
        if (editorCard) editorCard.classList.toggle('hide', !editing);
        state.talent.selfEditing = false;
      } else {
        if (editorCard) editorCard.classList.remove('hide');
      }

      // Load the active form target.
      const targetUserId = (talentIsCoordinator() && String(state.talent.editUserId || '').trim())
        ? String(state.talent.editUserId || '').trim()
        : effectiveUserIdForView();

      let profile = profilesById.get(targetUserId) || null;
      if (!profile) {
        try {
          const j = await api('/api/portal/talent_profiles?userId=' + encodeURIComponent(targetUserId));
          profile = j.profile || null;
        } catch {
          profile = null;
        }
      }

      // If a coordinator is editing someone without a saved profile yet, prefill a sensible stub
      // so they don't feel like they need to "create" anything just to get started.
      if (talentIsCoordinator() && String(state.talent.editUserId || '').trim() && !profile) {
        const u = (Array.isArray(state.usersCache) ? state.usersCache : []).find((x) => String(x.userId) === String(targetUserId));
        const stub = normalizeTalentRecord(null, { fallbackUserId: String(targetUserId), defaultRole: String(u?.role || '') });
        stub.public.displayName = String(u?.fullName || u?.email || '').trim();
        profile = stub;
      }
      state.talent.my = profile ? normalizeTalentRecord(profile, { fallbackUserId: targetUserId, defaultRole: myPortalRole() }) : null;
      writeTalentForm(state.talent.my || normalizeTalentRecord(null, { fallbackUserId: targetUserId, defaultRole: myPortalRole() }));

      // Embedded availability for host/media
      if (!talentIsCoordinator()) {
        await loadTalentAvailability().catch(() => {});
      }

      if (talentIsCoordinator()) {
        renderTalentDirectory(profilesById);
      }

      if (talentIsCoordinator() && String(state.talent.editUserId || '').trim()) {
        try{ requestAnimationFrame(() => { editorCard?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }); } catch(_e) {}
      }
    }

    function talentDirectoryRows(profilesById){
      const users = Array.isArray(state.usersCache) ? state.usersCache : [];
      const pool = users.filter((u) => ['event_host','media_team'].includes(String(u?.role || '').trim()));
      const q = String($('talentQ')?.value || state.talent.q || '').trim().toLowerCase();
      state.talent.q = q;

      const rows = pool.map((u) => {
        const uid = String(u.userId);
        const p = profilesById.get(uid) ? normalizeTalentRecord(profilesById.get(uid), { fallbackUserId: uid, defaultRole: String(u.role || '') }) : null;
        const display = (p && p.public?.displayName) ? String(p.public.displayName) : String(u.fullName || u.email || uid);
        const loc = p ? [p.public.homeBaseCity, p.public.homeBaseState].filter(Boolean).join(', ') : '';
        const specs = p ? uniqueList([...(p.public.specialties || []), ...(p.internal.specialties || [])]).join(', ') : '';
        const relScore = (p?.internal?.reliability?.score == null) ? null : Number(p.internal.reliability.score);
        const hay = [display, String(u.email || ''), String(u.role || ''), loc, specs].join(' ').toLowerCase();
        if (q && !hay.includes(q)) return null;

        return {
          userId: uid,
          role: String(u.role || ''),
          display,
          email: String(u.email || ''),
          loc,
          specs,
          relScore,
          avatarDataUrl: String(p?.public?.avatarDataUrl || '').trim(),
          hasProfile: !!p,
        };
      }).filter(Boolean);

      rows.sort((a, b) => a.display.localeCompare(b.display));
      return rows;
    }

    function renderTalentDirectory(profilesById){
      const tbody = $('talentUsersTbody');
      if (!tbody) return;
      const rows = talentDirectoryRows(profilesById);
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">No matching talent.</td></tr>';
        return;
      }

      // Availability summaries (cached)
      const avail = state._availabilityCache && typeof state._availabilityCache === 'object' ? state._availabilityCache : {};

      tbody.innerHTML = rows.slice(0, 160).map((r) => {
        const badge = r.hasProfile ? '<span class="badge ok">profile</span>' : '<span class="badge">ready</span>';
        const rel = reliabilityLabel(r.relScore);
        const relHtml = (r.relScore == null)
          ? '<span class="relBadge">Unrated</span>'
          : `<span class="relBadge ${escapeHtml(rel.kind)}">${escapeHtml(rel.text)}</span>`;
        const a = avail[String(r.userId)] ? avail[String(r.userId)].availability : null;
        const aText = availabilitySummaryFrom(a) || '—';

        const avatar = String(r.avatarDataUrl || '').trim();
        const avatarHtml = `<div class="row" style="gap:10px; align-items:center;">
          <div class="avatarCircle" style="width:34px; height:34px; ${avatar ? `background-image:url(${escapeHtml(avatar)});` : ''}">${avatar ? '' : escapeHtml(avatarInitials(r.display || r.email))}</div>
          <div>
            <div style="font-weight:900;">${escapeHtml(r.display)}</div>
            <div class="muted small">${escapeHtml(r.email || '')}</div>
          </div>
        </div>`;

        return `
          <tr class="clickRow" data-talent-open-user="${escapeHtml(r.userId)}">
            <td>${avatarHtml}<div class="muted small" style="margin-top:4px;">${escapeHtml([r.loc, r.specs].filter(Boolean).join(' • '))}</div></td>
            <td><span class="badge">${escapeHtml(viewingLabel(r.role))}</span></td>
            <td>${relHtml} ${badge}</td>
            <td class="muted">${escapeHtml(aText)}</td>
            <td><button class="btn secondary small" type="button" data-talent-open-user="${escapeHtml(r.userId)}">Open</button></td>
          </tr>
        `;
      }).join('');

      // Kick off availability fetch in background and re-render once.
      const ids = rows.map((r) => String(r.userId)).filter(Boolean);
      ensureAvailabilityCacheForUserIds(ids).then((didFetch) => {
        if (!didFetch) return;
        // Only re-render if still on Talent tab.
        if (state.activeTab === 'talent') renderTalentDirectory(profilesById);
      }).catch(() => {});
    }

    async function saveTalentProfile(){
      $('talentMsg').textContent = '';
      try{
        const profile = readTalentForm();
        const body = { profile };
        if (talentIsCoordinator() && String(state.talent.editUserId || '').trim()) {
          body.userId = String(state.talent.editUserId || '').trim();
        }
        const j = await api('/api/portal/talent_profiles', { method: 'POST', body });
        state.talent.my = j.profile ? normalizeTalentRecord(j.profile, { fallbackUserId: String(body.userId || effectiveUserIdForView()), defaultRole: myPortalRole() }) : null;
        if (!talentIsCoordinator()) state.talent.selfEditing = false;
        $('talentMsg').textContent = 'Saved.';

        // Refresh caches + directory and staffing dropdown labels.
        if (talentIsCoordinator()) {
          await loadTalentProfilesCache({ force: true });
          await initEventOps().catch(()=>{});
          await rerenderTalentDirectoryFromCache().catch(()=>{});
        }

        // Refresh form view from server response.
        writeTalentForm(state.talent.my || normalizeTalentRecord(null, { fallbackUserId: String(body.userId || effectiveUserIdForView()), defaultRole: myPortalRole() }));
      } catch(e){
        $('talentMsg').textContent = String(e.message || e);
      }
    }

    function stopTalentEditing(){
      state.talent.editUserId = '';
      state.talent.selfEditing = false;
      $('talentStopEditingBtn')?.classList.add('hide');
      setTalentEditingLine();
      loadTalentTab().catch(()=>{});
    }

    function openPeoplePick({ title = 'Pick person', onPick } = {}){
      const modal = $('peoplePickModal');
      if (!modal) return;
      state.peoplePick.open = true;
      state.peoplePick.q = '';
      state.peoplePick.onPick = (typeof onPick === 'function') ? onPick : null;
      if ($('peoplePickTitle')) $('peoplePickTitle').textContent = String(title || 'Pick person');
      if ($('peoplePickQ')) $('peoplePickQ').value = '';
      renderPeoplePickList();
      modal.classList.add('show');
      try { $('peoplePickQ')?.focus(); } catch(_e) {}
    }

    function closePeoplePick(){
      const modal = $('peoplePickModal');
      if (!modal) return;
      modal.classList.remove('show');
      state.peoplePick.open = false;
      state.peoplePick.onPick = null;
      state.peoplePick.q = '';
      if ($('peoplePickList')) $('peoplePickList').innerHTML = '';
    }

    function renderPeoplePickList(){
      const box = $('peoplePickList');
      if (!box) return;
      const users = Array.isArray(state.usersCache) ? state.usersCache : [];
      const pool = users.filter((u) => ['event_host','media_team'].includes(String(u?.role || '').trim()));
      const q = String($('peoplePickQ')?.value || state.peoplePick.q || '').trim().toLowerCase();
      state.peoplePick.q = q;
      const rows = pool
        .map((u) => {
          const label = String(u.fullName || u.email || u.userId || '').trim();
          const hay = [label, String(u.email || ''), String(u.role || '')].join(' ').toLowerCase();
          if (q && !hay.includes(q)) return null;
          return { userId: String(u.userId), label, email: String(u.email || ''), role: String(u.role || '') };
        })
        .filter(Boolean)
        .slice(0, 120);

      if ($('peoplePickCount')) $('peoplePickCount').textContent = `${rows.length} result(s)`;
      if (!rows.length) {
        box.innerHTML = '<div class="muted small">No matches.</div>';
        return;
      }
      box.innerHTML = rows.map((r) => `
        <button class="modalRow" type="button" data-people-pick-user="${escapeHtml(r.userId)}">
          <div>
            <div style="font-weight:900;">${escapeHtml(r.label)}</div>
            <div class="muted small">${escapeHtml([r.email, viewingLabel(r.role)].filter(Boolean).join(' • '))}</div>
          </div>
        </button>
      `).join('');
    }

    function openAvatarCrop(dataUrl){
      const modal = $('avatarCropModal');
      const img = $('avatarCropImg');
      const box = $('avatarCropBox');
      if (!modal || !img || !box) return;
      state.avatarCrop.open = true;
      state.avatarCrop.dataUrl = String(dataUrl || '');
      state.avatarCrop.dx = 0;
      state.avatarCrop.dy = 0;
      state.avatarCrop.zoom = 1;
      state.avatarCrop._drag = null;
      if ($('avatarCropMsg')) $('avatarCropMsg').textContent = '';
      if ($('avatarCropZoom')) $('avatarCropZoom').value = '1';
      img.src = state.avatarCrop.dataUrl;
      modal.classList.add('show');

      const sync = () => {
        const z = Number(state.avatarCrop.zoom || 1);
        img.style.transform = `translate(calc(-50% + ${state.avatarCrop.dx}px), calc(-50% + ${state.avatarCrop.dy}px)) scale(${z})`;
      };
      sync();

      box.onpointerdown = (ev) => {
        ev.preventDefault();
        state.avatarCrop._drag = { x: ev.clientX, y: ev.clientY, dx: state.avatarCrop.dx, dy: state.avatarCrop.dy, id: ev.pointerId };
        try { box.setPointerCapture(ev.pointerId); } catch(_e) {}
      };
      box.onpointermove = (ev) => {
        if (!state.avatarCrop._drag) return;
        const d = state.avatarCrop._drag;
        state.avatarCrop.dx = d.dx + (ev.clientX - d.x);
        state.avatarCrop.dy = d.dy + (ev.clientY - d.y);
        sync();
      };
      const end = () => { state.avatarCrop._drag = null; };
      box.onpointerup = end;
      box.onpointercancel = end;
    }

    function closeAvatarCrop(){
      const modal = $('avatarCropModal');
      if (!modal) return;
      modal.classList.remove('show');
      state.avatarCrop.open = false;
      state.avatarCrop.dataUrl = '';
      state.avatarCrop._drag = null;
      if ($('avatarCropMsg')) $('avatarCropMsg').textContent = '';
    }

    function saveAvatarCropToForm(){
      const imgEl = $('avatarCropImg');
      const boxEl = $('avatarCropBox');
      if (!imgEl || !boxEl) return;
      const nW = Number(imgEl.naturalWidth || 0);
      const nH = Number(imgEl.naturalHeight || 0);
      if (!nW || !nH) {
        if ($('avatarCropMsg')) $('avatarCropMsg').textContent = 'Image not ready.';
        return;
      }
      const rect = boxEl.getBoundingClientRect();
      const boxW = Math.max(1, rect.width);
      const boxH = Math.max(1, rect.height);
      const baseScale = Math.max(boxW / nW, boxH / nH);
      const zoom = Math.max(1, Math.min(3, Number(state.avatarCrop.zoom || 1)));
      const scale = baseScale * zoom;
      const drawW = nW * scale;
      const drawH = nH * scale;

      const size = 256;
      const cx = document.createElement('canvas');
      cx.width = size;
      cx.height = size;
      const ctx = cx.getContext('2d');
      if (!ctx) return;

      const sx = size / boxW;
      const sy = size / boxH;
      const centerX = (boxW / 2) + Number(state.avatarCrop.dx || 0);
      const centerY = (boxH / 2) + Number(state.avatarCrop.dy || 0);

      const dx = (size / 2) + (centerX - boxW / 2) * sx - (drawW * sx) / 2;
      const dy = (size / 2) + (centerY - boxH / 2) * sy - (drawH * sy) / 2;

      ctx.clearRect(0, 0, size, size);
      ctx.save();
      ctx.beginPath();
      ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();
      ctx.imageSmoothingEnabled = true;
      try { ctx.imageSmoothingQuality = 'high'; } catch(_e) {}
      ctx.drawImage(imgEl, dx, dy, drawW * sx, drawH * sy);
      ctx.restore();
      const out = cx.toDataURL('image/png');

      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: talentProfileEditContext().targetUserId, defaultRole: myPortalRole() });
      state.talent.form.public.avatarDataUrl = out;
      setAvatarCircle($('talAvatarCircle'), out, $('talDisplayName')?.value || '');
      closeAvatarCrop();
    }

    function ensureTalAvailInit(){
      const a = state.talent.avail;
      a.tz = localTz() || '';
      if (typeof a.weekOffset !== 'number') a.weekOffset = Number(a.weekOffset || 0);
      if (!a.byDate || typeof a.byDate !== 'object') a.byDate = {};
      if (!a.drag || typeof a.drag !== 'object') a.drag = { active: false, mode: '' };
    }

    function talWeekDates(){
      ensureTalAvailInit();
      const off = Number(state.talent.avail.weekOffset || 0);
      const base = addDays(new Date(), off * 7);
      const start = startOfWeekMonday(base);
      return Array.from({ length: 7 }, (_, i) => addDays(start, i));
    }

    function talSetAvailSlot(dateYmd, hhmm, on){
      ensureTalAvailInit();
      const d = String(dateYmd || '');
      const t = String(hhmm || '');
      if (!d || !t) return;
      const arr = Array.isArray(state.talent.avail.byDate[d]) ? state.talent.avail.byDate[d].slice() : [];
      const set = new Set(arr.map(String));
      if (on) set.add(t);
      else set.delete(t);
      const next = Array.from(set).sort();
      if (next.length) state.talent.avail.byDate[d] = next;
      else delete state.talent.avail.byDate[d];
    }

    function talHasAvailSlot(dateYmd, hhmm){
      const d = String(dateYmd || '');
      const t = String(hhmm || '');
      const arr = Array.isArray(state.talent.avail.byDate?.[d]) ? state.talent.avail.byDate[d] : [];
      return arr.includes(t);
    }

    function renderTalAvailWeekGrid(){
      ensureTalAvailInit();
      const grid = $('talAvailWeekGrid');
      if (!grid) return;

      const ctx = talentProfileEditContext();
      const editable = !!ctx.canEditAvailability;
      const todayKey = isoToday();

      const tzLabel = $('talAvailTzLabel');
      if (tzLabel) tzLabel.textContent = localTz() || 'local';

      const week = talWeekDates();
      const weekLabel = $('talAvailWeekLabel');
      if (weekLabel) weekLabel.textContent = `${ymd(week[0])} – ${ymd(week[6])}`;

      const saveBtn = $('talAvailSaveBtn');
      if (saveBtn) saveBtn.disabled = !editable;
      const clearBtn = $('talAvailClearWeek');
      if (clearBtn) clearBtn.disabled = !editable;

      const head = [];
      head.push(`<div class="availHeadCell"></div>`);
      for (const d of week) {
        const dateKey = ymd(d);
        const pastDay = (dateKey < todayKey);
        head.push(`<div class="availHeadCell ${pastDay ? 'pastDay' : ''}">${escapeHtml(dayHeadLabel(d))}<div class="muted" style="margin-top:2px; font-weight:700;">${escapeHtml(dateKey)}</div></div>`);
      }

      const rows = [];
      const times = timeSlots();
      for (const t of times) {
        rows.push(`<div class="availTimeCell">${escapeHtml(timeLabel(t))}</div>`);
        for (const d of week) {
          const dateKey = ymd(d);
          const active = talHasAvailSlot(dateKey, t);
          const pastDay = (dateKey < todayKey);
          if (editable) {
            rows.push(`<div class="availSlotCell ${pastDay ? 'pastDay' : ''}"><button type="button" class="availSlotBtn ${active ? 'active' : ''}" data-tal-avail-date="${escapeHtml(dateKey)}" data-tal-avail-time="${escapeHtml(t)}" aria-pressed="${active ? 'true' : 'false'}" ${pastDay ? 'disabled' : ''}></button></div>`);
          } else {
            rows.push(`<div class="availSlotCell ${pastDay ? 'pastDay' : ''}"><div class="availSlotBtn ${active ? 'active' : ''}" aria-hidden="true"></div></div>`);
          }
        }
      }

      grid.innerHTML = head.join('') + rows.join('');

      const drag = state.talent.avail.drag;
      drag.active = false;
      drag.mode = '';
      if (!editable) {
        grid.onpointerdown = null;
        grid.onpointerover = null;
        grid.onpointerup = null;
        grid.onpointercancel = null;
        return;
      }

      const applyCell = (btn) => {
        if (btn.disabled) return;
        const dateKey = String(btn.dataset.talAvailDate || '');
        const t = String(btn.dataset.talAvailTime || '');
        if (!dateKey || !t) return;
        const wantOn = drag.mode === 'add';
        talSetAvailSlot(dateKey, t, wantOn);
        const on = talHasAvailSlot(dateKey, t);
        btn.classList.toggle('active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      };

      grid.onpointerdown = (ev) => {
        const btn = ev.target && ev.target.closest ? ev.target.closest('button.availSlotBtn') : null;
        if (!btn) return;
        ev.preventDefault();
        const dateKey = String(btn.dataset.talAvailDate || '');
        const t = String(btn.dataset.talAvailTime || '');
        const currentlyOn = talHasAvailSlot(dateKey, t);
        drag.active = true;
        drag.mode = currentlyOn ? 'remove' : 'add';
        applyCell(btn);
        try { btn.setPointerCapture(ev.pointerId); } catch(_e) {}
      };
      grid.onpointerover = (ev) => {
        if (!drag.active) return;
        const btn = ev.target && ev.target.closest ? ev.target.closest('button.availSlotBtn') : null;
        if (!btn) return;
        applyCell(btn);
      };
      const endDrag = () => { drag.active = false; drag.mode = ''; };
      grid.onpointerup = endDrag;
      grid.onpointercancel = endDrag;
      document.addEventListener('pointerup', endDrag, { once: true });
    }

    async function loadTalentAvailability(){
      const box = $('talAvailabilityBox');
      if (!box || box.classList.contains('hide')) return;
      if ($('talAvailMsg')) $('talAvailMsg').textContent = '';
      ensureTalAvailInit();
      try {
        const ctx = talentProfileEditContext();
        state.talent.avail.viewUserId = ctx.targetUserId;
        const qs = ctx.targetUserId ? ('?userId=' + encodeURIComponent(String(ctx.targetUserId))) : '';
        const j = await api('/api/portal/availability' + qs);
        const slots = j.availability?.slots && typeof j.availability.slots === 'object' ? j.availability.slots : {};
        const byDate = slots.byDate && typeof slots.byDate === 'object' ? slots.byDate : {};
        state.talent.avail.byDate = byDate;
        renderTalAvailWeekGrid();
      } catch (e) {
        if ($('talAvailMsg')) $('talAvailMsg').textContent = String(e.message || e);
      }
    }

    async function saveTalentAvailability(){
      if ($('talAvailMsg')) $('talAvailMsg').textContent = '';
      ensureTalAvailInit();
      const btn = $('talAvailSaveBtn');
      const wasDisabled = btn ? btn.disabled : false;
      if (btn) btn.disabled = true;
      try {
        const ctx = talentProfileEditContext();
        const body = {
          slots: {
            tz: localTz() || '',
            byDate: state.talent.avail.byDate || {},
          }
        };
        if (ctx.targetUserId) body.userId = String(ctx.targetUserId);
        await api('/api/portal/availability', { method: 'PUT', body });
        if ($('talAvailMsg')) $('talAvailMsg').textContent = `Saved ${new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}`;
      } catch (e) {
        if ($('talAvailMsg')) $('talAvailMsg').textContent = String(e.message || e);
      } finally {
        if (btn) btn.disabled = wasDisabled;
      }
    }

    async function loadRecaps(eventId){
      $('recapMsg').textContent = '';
      $('recapsList').textContent = '';
      try{
        const j = await api('/api/portal/event_recaps?eventId=' + encodeURIComponent(String(eventId)));
        const recaps = j.recaps || [];
        if (!recaps.length) {
          $('recapsList').innerHTML = '<div class="muted small">No recaps yet.</div>';
          return;
        }
        $('recapsList').innerHTML = recaps.map((r) => {
          const p = r.payload || {};
          const media = Array.isArray(r.media_urls) ? r.media_urls : [];
          const meta = [
            p.attendanceEstimate != null ? ('attendance ' + p.attendanceEstimate) : '',
            p.rating ? ('rating ' + p.rating) : '',
            media.length ? (media.length + ' media') : '',
          ].filter(Boolean).join(' • ');
          const mediaHtml = media.length ? (`<div class="small" style="margin-top:8px;">${media.map((u) => `<div><a href="${escapeHtml(u)}" target="_blank" rel="noopener">${escapeHtml(u)}</a></div>`).join('')}</div>`) : '';
          return `
            <div class="card" style="background:#fff; margin-bottom:10px;">
              <div class="bd">
                <div class="muted small">${escapeHtml(r.created_at || '')}</div>
                ${meta ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(meta)}</div>` : ''}
                ${r.recap ? `<div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(r.recap)}</div>` : ''}
                ${mediaHtml}
              </div>
            </div>
          `;
        }).join('');
      } catch(e){
        $('recapMsg').textContent = String(e.message || e);
      }
    }

    async function submitRecap(){
      $('recapMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');

        const er = effectiveRole();
        const effectiveUserId = (isManagerUser() && String(state.viewAsUserId || '').trim())
          ? String(state.viewAsUserId || '').trim()
          : String(state.me?.user?.id || '');
        const myAsg = myAssignmentForEvent(e, er, effectiveUserId);
        const myStatus = String(myAsg?.status || '').trim();
        const isMedia = er === 'media_team';
        const isHost = er === 'event_host';

        const recapEditable = isCoordinatorRole()
          || (isHost && eventIsMineForRole(e, 'event_host', effectiveUserId))
          || (isMedia && myStatus === 'accepted');
        if (!recapEditable) throw new Error('not_allowed');
        if (!isCoordinatorRole() && (myStatus === 'pending' || myStatus === 'declined')) {
          throw new Error(myStatus === 'declined' ? 'declined' : 'accept_first');
        }

        const mediaUrls = String($('recapMedia').value || '')
          .split('\n')
          .map((x) => x.trim())
          .filter(Boolean)
          .slice(0, 30);

        const payload = isMedia ? {
          mediaCount: mediaUrls.length,
          mediaOnly: true,
        } : {
          attendanceEstimate: $('recapAttendance').value ? Number($('recapAttendance').value) : null,
          rating: $('recapRating').value || null,
          issuesReported: $('recapIssues').value || null,
          issuesDetails: $('recapIssuesDetails').value || '',
          mediaCount: mediaUrls.length,
          hostNotes: $('recapNotes').value || '',
          standouts: $('recapStandouts') ? ($('recapStandouts').value || '') : '',
          giveawayWinners: $('recapGiveawayWinners') ? ($('recapGiveawayWinners').value || '') : '',
          feedbackHighlights: $('recapFeedbackHighlights') ? ($('recapFeedbackHighlights').value || '') : '',
          eventFlowDocUrl: $('recapEventFlowDoc') ? ($('recapEventFlowDoc').value || '') : '',
        };

        await api('/api/portal/event_recaps', {
          method: 'POST',
          body: {
            eventId: e.id,
            recap: isMedia ? '' : (payload.hostNotes || payload.issuesDetails || ''),
            mediaUrls,
            payload,
          },
        });

        $('recapMsg').textContent = '';
        await loadRecaps(e.id);
      } catch(e){
        $('recapMsg').textContent = String(e.message || e);
      }
    }

    function myPortalRole(){
      return String(state.me?.profile?.role || '');
    }

    function isCoordinatorRole(){
      const r = effectiveRole();
      return r === 'event_coordinator' || r === 'manager';
    }

    function isManagerViewAsActive(){
      const vRole = String(state.viewAsRole || '').trim();
      const vUser = String(state.viewAsUserId || '').trim();
      return isManagerUser() && (!!vRole || !!vUser);
    }

    function isManagerViewAsPreviewOnly(){
      const vRole = String(state.viewAsRole || '').trim();
      const vUser = String(state.viewAsUserId || '').trim();
      return isManagerUser() && !!vRole && !vUser;
    }

    function coordinatorOpsEditable(){
      // Role-only preview is read-only; user-scoped view-as is editable.
      return isCoordinatorRole() && !isManagerViewAsPreviewOnly();
    }

    function dollarsToCents(v){
      const n = Number(String(v || '').trim());
      if (!Number.isFinite(n) || n < 0) return 0;
      return Math.round(n * 100);
    }

    function centsToDollars(c){
      const n = Number(c || 0);
      if (!Number.isFinite(n)) return '';
      return (n / 100).toFixed(2);
    }

    function mergeMeta(base, patch){
      const a = (base && typeof base === 'object') ? base : {};
      const b = (patch && typeof patch === 'object') ? patch : {};
      return Object.assign({}, a, b);
    }

    function feedbackDefaultForm(){
      return {
        enabled: 'no',
        token: '',
        subtitle: 'Thanks for joining us. Your feedback helps us improve future events.',
        thanksMessage: 'Your feedback was received.',
        questions: [
          { type: 'long_text', label: 'What was your favorite part?' },
          { type: 'long_text', label: 'What should we do differently next time?' },
        ],
      };
    }

    function cleanFeedbackQuestion(q){
      const obj = (q && typeof q === 'object') ? q : {};
      const type = String(obj.type || 'long_text').trim();
      const label = String(obj.label || '').trim();
      const allowed = new Set(['short_text','long_text','yes_no']);
      return {
        type: allowed.has(type) ? type : 'long_text',
        label: label.slice(0, 140) || 'Question',
      };
    }

    function feedbackFormFromMeta(meta){
      const m = (meta && typeof meta === 'object') ? meta : {};
      const base = feedbackDefaultForm();
      const f = (m.feedbackForm && typeof m.feedbackForm === 'object') ? m.feedbackForm : {};
      const out = Object.assign({}, base, f);
      out.enabled = String(out.enabled || '') === 'yes' ? 'yes' : 'no';
      out.token = String(out.token || '').trim().slice(0, 220);
      out.subtitle = String(out.subtitle || base.subtitle).trim().slice(0, 200);
      out.thanksMessage = String(out.thanksMessage || base.thanksMessage).trim().slice(0, 200);
      out.questions = (Array.isArray(out.questions) ? out.questions : base.questions).slice(0, 10).map(cleanFeedbackQuestion);
      return out;
    }

    function feedbackLinkFor(eventId, token){
      const id = String(eventId || '').trim();
      const t = String(token || '').trim();
      if (!id || !t) return '';
      try {
        return `${location.origin}/feedback?eventId=${encodeURIComponent(id)}&t=${encodeURIComponent(t)}`;
      } catch {
        return `/feedback?eventId=${encodeURIComponent(id)}&t=${encodeURIComponent(t)}`;
      }
    }

    function genFeedbackToken(){
      try {
        if (crypto?.randomUUID) return crypto.randomUUID().replace(/-/g, '');
      } catch {
        // ignore
      }
      return 'fb_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function renderFeedbackEditor(meta){
      const e = state.selectedEvent;
      const msg = $('feedbackFormMsg');
      if (msg) msg.textContent = '';

      const editable = coordinatorOpsEditable();
      $('feedbackEnableBtn')?.toggleAttribute('disabled', !editable);
      $('feedbackAddQBtn')?.toggleAttribute('disabled', !editable);
      $('feedbackSaveBtn')?.toggleAttribute('disabled', !editable);

      const f = feedbackFormFromMeta(meta);
      const link = (f.enabled === 'yes' && f.token) ? feedbackLinkFor(e?.id, f.token) : '';
      if ($('feedbackLink')) $('feedbackLink').value = link;
      if ($('feedbackSubtitle')) $('feedbackSubtitle').value = String(f.subtitle || '');
      if ($('feedbackThanks')) $('feedbackThanks').value = String(f.thanksMessage || '');

      const list = $('feedbackQuestionsList');
      if (list) {
        list.innerHTML = '';
        if (!f.questions.length) {
          list.innerHTML = '<div class="muted small">No questions yet.</div>';
        } else {
          for (const q of f.questions) addFeedbackQuestionRow(list, q, { editable });
        }
      }

      // Clear summary display if event changed.
      const sum = state._feedbackSummaryByEventId && e?.id ? state._feedbackSummaryByEventId[String(e.id)] : null;
      renderFeedbackSummary(sum);
    }

    function addFeedbackQuestionRow(listEl, q, { editable } = {}){
      const list = listEl || $('feedbackQuestionsList');
      if (!list) return;

      const question = cleanFeedbackQuestion(q);
      // Remove the empty placeholder.
      if (list.children.length === 1 && list.children[0].classList?.contains('muted')) list.innerHTML = '';

      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.fbqRow = '1';
      row.style.gap = '8px';
      row.style.flexWrap = 'wrap';
      row.style.marginBottom = '8px';

      row.innerHTML = `
        <select data-fbq-type="1" ${editable ? '' : 'disabled'}>
          <option value="long_text" ${question.type === 'long_text' ? 'selected' : ''}>Long text</option>
          <option value="short_text" ${question.type === 'short_text' ? 'selected' : ''}>Short text</option>
          <option value="yes_no" ${question.type === 'yes_no' ? 'selected' : ''}>Yes / No</option>
        </select>
        <input data-fbq-label="1" value="${escapeHtml(question.label)}" placeholder="Question label" style="min-width:280px; flex:1;" ${editable ? '' : 'disabled'} />
        <button class="btn secondary small" type="button" data-fbq-remove="1" ${editable ? '' : 'disabled'}>Remove</button>
      `;

      const rm = row.querySelector('button[data-fbq-remove]');
      if (rm) {
        rm.addEventListener('click', () => {
          if (!editable) return;
          row.remove();
          if (!list.children.length) list.innerHTML = '<div class="muted small">No questions yet.</div>';
        });
      }

      list.appendChild(row);
    }

    function readFeedbackEditor(){
      const subtitle = String($('feedbackSubtitle')?.value || '').trim().slice(0, 200);
      const thanksMessage = String($('feedbackThanks')?.value || '').trim().slice(0, 200);
      const list = $('feedbackQuestionsList');
      const rows = list ? Array.from(list.querySelectorAll('[data-fbq-row]')) : [];
      const questions = rows.map((row) => {
        const type = String(row.querySelector('[data-fbq-type]')?.value || 'long_text').trim();
        const label = String(row.querySelector('[data-fbq-label]')?.value || '').trim();
        return cleanFeedbackQuestion({ type, label });
      }).filter(Boolean).slice(0, 10);
      return { subtitle, thanksMessage, questions };
    }

    async function enableOrRegenerateFeedbackLink(){
      $('feedbackFormMsg').textContent = '';
      try {
        if (!coordinatorOpsEditable()) throw new Error('read_only');
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const current = feedbackFormFromMeta(meta);
        const ed = readFeedbackEditor();
        const next = Object.assign({}, current, ed, {
          enabled: 'yes',
          token: genFeedbackToken(),
          updatedAt: new Date().toISOString(),
        });
        await patchSelectedEventMeta({ feedbackForm: next });
        const updated = state.selectedEvent;
        renderFeedbackEditor(updated?.meta);
        $('feedbackFormMsg').textContent = 'Link generated.';
      } catch(e){
        $('feedbackFormMsg').textContent = String(e.message || e);
      }
    }

    async function saveFeedbackForm(){
      $('feedbackFormMsg').textContent = '';
      try {
        if (!coordinatorOpsEditable()) throw new Error('read_only');
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const current = feedbackFormFromMeta(meta);
        const ed = readFeedbackEditor();
        const next = Object.assign({}, current, ed, {
          updatedAt: new Date().toISOString(),
        });
        await patchSelectedEventMeta({ feedbackForm: next });
        const updated = state.selectedEvent;
        renderFeedbackEditor(updated?.meta);
        $('feedbackFormMsg').textContent = 'Saved.';
      } catch(e){
        $('feedbackFormMsg').textContent = String(e.message || e);
      }
    }

    async function copyFeedbackLink(){
      const v = String($('feedbackLink')?.value || '').trim();
      if (!v) return;
      try {
        await navigator.clipboard.writeText(v);
        $('feedbackFormMsg').textContent = 'Copied.';
      } catch {
        // Fallback
        const el = $('feedbackLink');
        if (el) {
          el.focus();
          el.select();
          document.execCommand('copy');
          $('feedbackFormMsg').textContent = 'Copied.';
        }
      }
    }

    function openFeedbackLink(){
      const v = String($('feedbackLink')?.value || '').trim();
      if (!v) return;
      try { window.open(v, '_blank', 'noopener'); } catch { /* ignore */ }
    }

    function renderFeedbackSummary(summary){
      const line = $('feedbackSummaryLine');
      const list = $('feedbackCommentsList');
      if (!line || !list) return;

      if (!summary) {
        line.textContent = '';
        list.innerHTML = '';
        return;
      }

      const c = Number(summary.count || 0);
      const avg = summary.avgRating == null ? '' : String(summary.avgRating);
      line.textContent = c ? `Submissions: ${c}${avg ? (' • Avg rating: ' + avg) : ''}` : 'No submissions yet.';

      const comments = Array.isArray(summary.comments) ? summary.comments : [];
      if (!comments.length) {
        list.innerHTML = '';
        return;
      }

      list.innerHTML = comments.slice(0, 25).map((x) => {
        const meta = [x.ts ? String(x.ts).slice(0, 19).replace('T', ' ') : '', x.rating ? ('★' + x.rating) : '', x.name || ''].filter(Boolean).join(' • ');
        return `
          <div class="card" style="background:#fff; margin-bottom:10px;">
            <div class="bd">
              <div class="muted small">${escapeHtml(meta)}</div>
              <div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(x.comment || '')}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadFeedbackSummary(){
      $('feedbackFormMsg').textContent = '';
      try {
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const j = await api('/api/portal/event_feedback?eventId=' + encodeURIComponent(String(e.id)));
        const summary = j?.summary || null;
        if (!state._feedbackSummaryByEventId) state._feedbackSummaryByEventId = {};
        state._feedbackSummaryByEventId[String(e.id)] = summary;
        renderFeedbackSummary(summary);
      } catch(e){
        $('feedbackFormMsg').textContent = String(e.message || e);
      }
    }

    function updateEventInState(updated){
      if (!updated || !updated.id) return;
      const id = Number(updated.id);
      state.events = Array.isArray(state.events) ? state.events : [];
      const idx = state.events.findIndex((x) => Number(x?.id) === id);
      if (idx >= 0) state.events[idx] = updated;
      if (state.selectedEvent && Number(state.selectedEvent.id) === id) state.selectedEvent = updated;
    }

    function renderAssignments(assignments, usersById){
      const box = $('assignmentsList');
      if (!box) return;
      const arr = Array.isArray(assignments) ? assignments : [];
      if (!arr.length) {
        box.innerHTML = '<div class="muted small">No assignments yet.</div>';
        return;
      }

      const canManage = isCoordinatorRole();

      box.innerHTML = arr.map((a) => {
        const uid = String(a?.userId || '');
        const role = String(a?.role || '');
        const status = String(a?.status || 'pending');
        const u = usersById && usersById.get ? usersById.get(uid) : null;
        const name = String(u?.fullName || u?.email || uid).trim();
        const badge = `<span class="badge ${status === 'accepted' ? 'ok' : ''}">${escapeHtml(status)}</span>`;
        const removeBtn = canManage
          ? `<button class="btn secondary small" data-remove-asg="1" data-asg-role="${escapeHtml(role)}" data-asg-user="${escapeHtml(uid)}">Remove</button>`
          : '';
        return `
          <div class="card" style="background:#fff; margin-top:8px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; gap:12px;">
                <div>
                  <div style="font-weight:900;">${escapeHtml(role)} — ${escapeHtml(name)}</div>
                  <div class="muted small" style="margin-top:2px;">${escapeHtml(uid)}</div>
                </div>
                <div class="row" style="gap:8px;">${badge} ${removeBtn}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      for (const btn of box.querySelectorAll('button[data-remove-asg]')){
        btn.addEventListener('click', () => {
          const uid = String(btn.dataset.asgUser || '');
          const role = String(btn.dataset.asgRole || '');
          removeAssignment(uid, role).catch(()=>{});
        });
      }
    }

    function renderMyAssignmentActions(assignments){
      const el = $('myAssignmentActions');
      if (!el) return;
      const arr = Array.isArray(assignments) ? assignments : [];
      const uid = String(state.me?.user?.id || '');
      const mine = arr.filter((a) => String(a?.userId || '') === uid && String(a?.status || '') === 'pending');
      if (!mine.length) {
        el.classList.add('hide');
        el.innerHTML = '';
        return;
      }

      el.classList.remove('hide');
      el.innerHTML = `
        <div style="font-weight:900;">Your assignment</div>
        <div class="muted small" style="margin-top:4px;">Accept/decline so Ops can reassign quickly.</div>
        <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap;">
          ${mine.map((a) => {
            const role = String(a?.role || '');
            return `
              <button class="btn" type="button" data-asg-accept="1" data-asg-role="${escapeHtml(role)}">Accept ${escapeHtml(role)}</button>
              <button class="btn secondary" type="button" data-asg-decline="1" data-asg-role="${escapeHtml(role)}">Decline</button>
            `;
          }).join('')}
        </div>
      `;

      for (const btn of el.querySelectorAll('button[data-asg-accept]')) {
        btn.addEventListener('click', () => respondAssignment(String(btn.dataset.asgRole || ''), 'accepted').catch(()=>{}));
      }
      for (const btn of el.querySelectorAll('button[data-asg-decline]')) {
        btn.addEventListener('click', () => respondAssignment(String(btn.dataset.asgRole || ''), 'declined').catch(()=>{}));
      }
    }

    async function loadAssignableUsers(){
      if (!isCoordinatorRole()) return [];
      if (Array.isArray(state._eventOpsUsers) && state._eventOpsUsers.length) return state._eventOpsUsers;
      const j = await api('/api/portal/users');
      const users = Array.isArray(j.users) ? j.users : [];
      state._eventOpsUsers = users;
      return users;
    }

    function fillAssignSelects(users, profilesById){
      const hostSel = $('assignHostUser');
      const mediaSel = $('assignMediaUser');
      if (!hostSel || !mediaSel) return;
      const arr = Array.isArray(users) ? users : [];

      const byId = (profilesById instanceof Map)
        ? profilesById
        : new Map((Array.isArray(state.talent?.profiles) ? state.talent.profiles : []).map((p) => [String(p?.userId || ''), p]));

      function bestName(u, p){
        return String((p && p.displayName) || u.fullName || u.email || u.userId || '').trim();
      }

      function talentMetaBits(p){
        if (!p || typeof p !== 'object') return [];
        const loc = [p.homeBaseCity, p.homeBaseState].filter(Boolean).join(', ');
        const specs = Array.isArray(p.specialties) ? p.specialties.filter(Boolean).slice(0, 3).join(', ') : '';
        const rel = (p.reliability && typeof p.reliability === 'object' && p.reliability.score != null) ? ('rel ' + String(p.reliability.score)) : '';
        return [loc, specs, rel].filter(Boolean);
      }

      function option(u){
        const p = byId.get(String(u.userId)) || null;
        const meta = talentMetaBits(p);
        const label = [bestName(u, p), u.email || '', meta.length ? meta.join(' • ') : ''].filter(Boolean).join(' • ') || u.userId;
        return `<option value="${escapeHtml(u.userId)}">${escapeHtml(label)}</option>`;
      }

      const hosts = arr.filter((u) => String(u.role || '') === 'event_host').slice().sort((a, b) => {
        const pa = byId.get(String(a.userId)) || null;
        const pb = byId.get(String(b.userId)) || null;
        return bestName(a, pa).localeCompare(bestName(b, pb));
      });
      const medias = arr.filter((u) => String(u.role || '') === 'media_team').slice().sort((a, b) => {
        const pa = byId.get(String(a.userId)) || null;
        const pb = byId.get(String(b.userId)) || null;
        return bestName(a, pa).localeCompare(bestName(b, pb));
      });

      hostSel.innerHTML = '<option value="">Assign host…</option>' + hosts.map(option).join('');
      mediaSel.innerHTML = '<option value="">Assign media…</option>' + medias.map(option).join('');
    }

    async function loadAssignmentsForSelected(){
      const e = state.selectedEvent;
      if (!e || !e.id) return { assignments: [], usersById: new Map() };

      const j = await api('/api/portal/event_assignments?eventId=' + encodeURIComponent(String(e.id)));
      const assignments = Array.isArray(j.assignments) ? j.assignments : [];

      let users = [];
      try {
        users = await loadAssignableUsers();
      } catch {
        users = [];
      }
      const byId = new Map((Array.isArray(users) ? users : []).map((u) => [String(u.userId), u]));
      return { assignments, usersById: byId };
    }

    function renderEventOpsFromSelected(meta, assignments, usersById){
      const wrap = $('eventOpsWrap');
      if (!wrap) return;

      const e = state.selectedEvent;
      wrap.classList.toggle('hide', !e);
      if (!e) return;

      ensureEventOpsCollapseDefaults();
      const ro = isCoordinatorRole() && isManagerViewAsPreviewOnly();
      $('eventOpsReadOnlyLine')?.classList.toggle('hide', !ro);

      const canManage = coordinatorOpsEditable();
      $('assignHostUser')?.toggleAttribute('disabled', !canManage);
      $('assignMediaUser')?.toggleAttribute('disabled', !canManage);
      $('addHostBtn')?.toggleAttribute('disabled', !canManage);
      $('addMediaBtn')?.toggleAttribute('disabled', !canManage);
      $('aiRecommendTalentBtn')?.toggleAttribute('disabled', !isCoordinatorRole());
      $('aiAssignTopTalentBtn')?.toggleAttribute('disabled', !canManage);

      const checklist = meta?.checklist && typeof meta.checklist === 'object' ? meta.checklist : {};
      if ($('chkRecapReceived')) $('chkRecapReceived').checked = String(checklist.recapReceived || '') === 'yes';
      if ($('chkMediaReceived')) $('chkMediaReceived').checked = String(checklist.mediaReceived || '') === 'yes';
      if ($('chkFeedbackReceived')) $('chkFeedbackReceived').checked = String(checklist.feedbackReceived || '') === 'yes';
      if ($('chkReportSent')) $('chkReportSent').checked = String(checklist.reportSent || '') === 'yes';

      const reportSentAt = String(meta?.reportSentAt || '').trim();
      if ($('reportSentLine')) {
        $('reportSentLine').textContent = reportSentAt ? (`Last sent: ${reportSentAt}`) : '';
      }

      const draft = meta?.reportDraft && typeof meta.reportDraft === 'object' ? meta.reportDraft : null;
      const draftText = String(draft?.plainText || '').trim() || String(draft?.markdown || '').trim();
      if ($('reportDraftText')) {
        const current = String($('reportDraftText').value || '').trim();
        if (!current || current === String($('reportDraftText').placeholder || '').trim()) {
          $('reportDraftText').value = draftText;
        }
      }

      const canManageReport = coordinatorOpsEditable();
      $('genReportDraftBtn')?.toggleAttribute('disabled', !isCoordinatorRole());
      $('copyReportDraftBtn')?.toggleAttribute('disabled', !draftText);
      $('sendReportDraftBtn')?.toggleAttribute('disabled', !canManageReport || !draftText);

      const plan = meta?.plan && typeof meta.plan === 'object' ? meta.plan : {};
      if ($('planStrategy')) $('planStrategy').value = String(plan.strategy || '');
      if ($('planEventType')) $('planEventType').value = String(plan.eventType || '');
      if ($('planJustification')) $('planJustification').value = String(plan.justification || '');
      renderPlanEventTypeDetails();

      // Plan vendors UI
      try{
        const vendors = Array.isArray(plan.vendors) ? plan.vendors : [];
        state._eventOpsPlanVendors = vendors.slice(0, 25);
        renderPlanVendors();
      } catch(_e) {}

      const budget = meta?.budget && typeof meta.budget === 'object' ? meta.budget : {};
      if ($('budHost')) $('budHost').value = centsToDollars(budget.hostPayCents || 0);
      if ($('budMedia')) $('budMedia').value = centsToDollars(budget.mediaPayCents || 0);
      if ($('budFood')) $('budFood').value = centsToDollars(budget.foodCents || 0);
      if ($('budDecor')) $('budDecor').value = centsToDollars(budget.decorCents || 0);
      if ($('budSupplies')) $('budSupplies').value = centsToDollars(budget.suppliesCents || 0);
      if ($('budContingency')) $('budContingency').value = centsToDollars(budget.contingencyCents || 0);

      renderAssignments(assignments, usersById);
      renderMyAssignmentActions(assignments);

      renderTalentAiFromCache();

      renderFeedbackEditor(meta);
    }

    function planVendorKey(v){
      const name = String(v?.name || v?.['Vendor Name'] || '').trim().toLowerCase();
      const type = String(v?.type || v?.Type || '').trim().toLowerCase();
      const coverage = String(v?.coverage || v?.['City/Coverage Area'] || '').trim().toLowerCase();
      return [name, type, coverage].filter(Boolean).join('|');
    }

    function planVendorShort(v){
      const base = (v && typeof v === 'object') ? v : {};
      return {
        name: String(base.name || base['Vendor Name'] || base.vendorName || '').trim(),
        type: String(base.type || base.Type || '').trim(),
        coverage: String(base.coverage || base['City/Coverage Area'] || '').trim(),
        contact: String(base.contact || base['Phone / Email'] || '').trim(),
        rateInfo: String(base.rateInfo || base['Rate Info'] || '').trim(),
        notes: String(base.notes || base.Notes || '').trim(),
      };
    }

    function renderPlanVendors(){
      const box = $('planVendorSelected');
      if (!box) return;
      const vendors = Array.isArray(state._eventOpsPlanVendors) ? state._eventOpsPlanVendors : [];
      const editable = coordinatorOpsEditable();

      if (!vendors.length) {
        box.innerHTML = '<div class="muted small">None selected yet.</div>';
        return;
      }

      box.innerHTML = vendors.slice(0, 25).map((v, i) => {
        const label = vendorLabel(v);
        const contact = String(v?.contact || v?.['Phone / Email'] || '').trim();
        const notes = String(v?.notes || v?.Notes || '').trim();
        return `
          <div class="card" style="background:#fff; margin-bottom:8px;">
            <div class="bd">
              <div class="row" style="justify-content:space-between; gap:12px; align-items:flex-start;">
                <div>
                  <div style="font-weight:900;">${escapeHtml(label)}</div>
                  ${contact ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(contact)}</div>` : ''}
                  ${notes ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(notes.slice(0, 180))}</div>` : ''}
                </div>
                <div class="row" style="gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                  <button class="btn secondary small" type="button" data-plan-vendor-remove="${i}" ${editable ? '' : 'disabled'}>Remove</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      for (const btn of box.querySelectorAll('button[data-plan-vendor-remove]')){
        btn.addEventListener('click', () => {
          const idx = Number(btn.dataset.planVendorRemove || 0);
          removeVendorFromPlan(idx).catch(()=>{});
        });
      }
    }

    async function addVendorToPlan(v){
      $('planVendorMsg').textContent = '';
      try{
        if (!coordinatorOpsEditable()) throw new Error('read_only');
        const short = planVendorShort(v);
        if (!short.name) throw new Error('invalid_vendor');

        const cur = Array.isArray(state._eventOpsPlanVendors) ? state._eventOpsPlanVendors : [];
        const next = cur.slice();
        const key = planVendorKey(short);
        const exists = next.some((x) => planVendorKey(x) === key || String(x?.name || '').trim().toLowerCase() === String(short.name).trim().toLowerCase());
        if (!exists) next.push(short);

        state._eventOpsPlanVendors = next.slice(0, 25);
        renderPlanVendors();
      } catch (err) {
        $('planVendorMsg').textContent = String(err.message || err);
      }
    }

    async function removeVendorFromPlan(idx){
      $('planVendorMsg').textContent = '';
      try{
        if (!coordinatorOpsEditable()) throw new Error('read_only');
        const cur = Array.isArray(state._eventOpsPlanVendors) ? state._eventOpsPlanVendors : [];
        const next = cur.slice().filter((_v, i) => i !== idx);
        state._eventOpsPlanVendors = next;
        renderPlanVendors();
      } catch (err) {
        $('planVendorMsg').textContent = String(err.message || err);
      }
    }

    async function searchPlanVendors(){
      $('planVendorMsg').textContent = '';
      const out = $('planVendorResults');
      if (out) out.innerHTML = '';
      try{
        const q = String($('planVendorQ')?.value || '').trim();
        if (!q) throw new Error('type a search');
        const j = await api('/api/portal/vendors?q=' + encodeURIComponent(q));
        const vendors = Array.isArray(j.vendors) ? j.vendors : [];
        if (!out) return;

        const editable = coordinatorOpsEditable();
        out.innerHTML = vendors.slice(0, 20).map((v, i) => {
          const label = vendorLabel(v);
          const contact = String(v?.contact || v?.['Phone / Email'] || '').trim();
          const notes = String(v?.notes || v?.Notes || '').trim();
          return `
            <div class="card" style="background:#fff; margin-bottom:8px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; gap:12px; align-items:flex-start;">
                  <div>
                    <div style="font-weight:900;">${escapeHtml(label)}</div>
                    ${contact ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(contact)}</div>` : ''}
                    ${notes ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(notes.slice(0, 160))}</div>` : ''}
                  </div>
                  <div class="row" style="gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                    <button class="btn secondary small" type="button" data-plan-vendor-add="${i}" ${editable ? '' : 'disabled'}>Add</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted small">No vendors found.</div>';

        for (const btn of out.querySelectorAll('button[data-plan-vendor-add]')){
          btn.addEventListener('click', () => {
            const idx = Number(btn.dataset.planVendorAdd || 0);
            addVendorToPlan(vendors[idx]).catch(()=>{});
          });
        }
      } catch (err) {
        $('planVendorMsg').textContent = String(err.message || err);
      }
    }

    function suggestPlanVendorsFromEventType(){
      const et = String($('planEventType')?.value || '').trim().toLowerCase();
      let q = '';
      if (et.includes('dj') || et.includes('disco')) q = 'dj';
      else if (et.includes('photo') || et.includes('headshot')) q = 'photo';
      else if (et.includes('chef') || et.includes('tasting') || et.includes('bbq')) q = 'catering';
      else if (et.includes('market') || et.includes('vendor')) q = 'vendor';
      else if (et.includes('movie')) q = 'outdoor movie';
      else if (et.includes('band') || et.includes('acoustic') || et.includes('jazz')) q = 'band';
      else q = et.split(/\s+/g).slice(0, 3).join(' ');
      if ($('planVendorQ')) $('planVendorQ').value = q;
      searchPlanVendors().catch(()=>{});
    }

    function filterPlanEventTypes(){
      $('planEventTypeMsg').textContent = '';
      try{
        const q = String($('planEventTypeQ')?.value || '').trim();
        const types = Array.isArray(state._eventOpsTypes) ? state._eventOpsTypes : [];
        const sel = $('planEventType');
        if (!sel) return;
        if (!q) throw new Error('type a search');
        const qq = q.toLowerCase();
        const filtered = types.filter((t) => JSON.stringify(t).toLowerCase().includes(qq));
        const current = String(sel.value || '');
        const opts = filtered.slice(0, 200).map((t) => {
          const label = eventTypeLabel(t);
          return `<option value="${escapeHtml(label)}">${escapeHtml(label)}</option>`;
        });
        sel.innerHTML = '<option value="">Select…</option>' + opts.join('');
        if (current) {
          const has = Array.from(sel.options).some((o) => String(o.value) === String(current));
          if (has) sel.value = current;
        }
        if (!filtered.length) $('planEventTypeMsg').textContent = 'No matches.';
      } catch (err) {
        $('planEventTypeMsg').textContent = String(err.message || err);
      }
    }

    function resetPlanEventTypes(){
      $('planEventTypeMsg').textContent = '';
      try{
        const types = Array.isArray(state._eventOpsTypes) ? state._eventOpsTypes : [];
        const sel = $('planEventType');
        if (!sel) return;
        const current = String(sel.value || '');
        const opts = types.map((t) => {
          const label = eventTypeLabel(t);
          return `<option value="${escapeHtml(label)}">${escapeHtml(label)}</option>`;
        });
        sel.innerHTML = '<option value="">Select…</option>' + opts.join('');
        if (current) sel.value = current;
      } catch(_e) {}
    }

    async function generateReportDraftForSelected(){
      if (!$('reportDraftMsg')) return;
      $('reportDraftMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');

        const j = await api('/api/portal/event_report?eventId=' + encodeURIComponent(String(e.id)));
        const text = String(j.plainText || j.markdown || '').trim();
        if ($('reportDraftText')) $('reportDraftText').value = text;

        const baseMeta = (e.meta && typeof e.meta === 'object') ? e.meta : {};
        const nextMeta = Object.assign({}, baseMeta, { reportDraft: { generatedAt: j.generatedAt || new Date().toISOString(), plainText: j.plainText || '', markdown: j.markdown || '' } });
        updateEventInState(Object.assign({}, e, { meta: nextMeta }));

        $('reportDraftMsg').textContent = 'Draft generated.';
        await initEventOps();
      } catch(err){
        $('reportDraftMsg').textContent = String(err.message || err);
      }
    }

    async function copyReportDraft(){
      if (!$('reportDraftMsg')) return;
      $('reportDraftMsg').textContent = '';
      try{
        const text = String($('reportDraftText')?.value || '').trim();
        if (!text) throw new Error('generate_draft_first');
        await navigator.clipboard.writeText(text);
        $('reportDraftMsg').textContent = 'Copied.';
      } catch(err){
        $('reportDraftMsg').textContent = String(err.message || err);
      }
    }

    async function sendReportDraft(){
      if (!$('reportDraftMsg')) return;
      $('reportDraftMsg').textContent = '';
      try{
        if (!coordinatorOpsEditable()) throw new Error('read_only');
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');

        const baseMeta = (e.meta && typeof e.meta === 'object') ? e.meta : {};
        const draft = baseMeta.reportDraft && typeof baseMeta.reportDraft === 'object' ? baseMeta.reportDraft : {};
        const plainText = String($('reportDraftText')?.value || '').trim() || String(draft.plainText || '').trim();
        const markdown = String(draft.markdown || '').trim();
        if (!plainText && !markdown) throw new Error('generate_draft_first');

        const j = await api('/api/portal/event_report', {
          method: 'POST',
          body: {
            eventId: e.id,
            action: 'send',
            plainText,
            markdown,
          }
        });

        if (j && j.event) updateEventInState(j.event);
        if ($('chkReportSent')) $('chkReportSent').checked = true;
        $('reportDraftMsg').textContent = `Sent to ${(Array.isArray(j.to) ? j.to.length : 0)} recipient(s).`;
        await initEventOps();
      } catch(err){
        $('reportDraftMsg').textContent = String(err.message || err);
      }
    }

    async function initEventOps(){
      const e = state.selectedEvent;
      if (!e || !e.id) {
        if ($('eventOpsWrap')) $('eventOpsWrap').classList.add('hide');
        return;
      }

      $('eventOpsMsg').textContent = '';
      $('budgetMsg').textContent = '';

      // Load event types for select.
      try{
        const j = await api('/api/portal/event_types');
        const types = Array.isArray(j.types) ? j.types : [];
        state._eventOpsTypes = types;
        const sel = $('planEventType');
        if (sel) {
          const opts = types.map((t) => {
            const label = eventTypeLabel(t);
            return `<option value="${escapeHtml(label)}">${escapeHtml(label)}</option>`;
          });
          sel.innerHTML = '<option value="">Select…</option>' + opts.join('');
        }
      } catch {
        // ignore
      }

      if (isCoordinatorRole()) {
        try{
          const profilesById = await loadTalentProfilesCache();
          const users = await loadAssignableUsers();
          fillAssignSelects(users, profilesById);
        } catch {
          // ignore
        }
      }

      const { assignments, usersById } = await loadAssignmentsForSelected();
      const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
      renderEventOpsFromSelected(meta, assignments, usersById);
    }

    async function addAssignment(role, userIdOverride){
      $('eventOpsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const userId = String(userIdOverride || (role === 'event_host' ? String($('assignHostUser')?.value || '') : String($('assignMediaUser')?.value || '')) || '');
        if (!userId) throw new Error('select a user');
        const j = await api('/api/portal/event_assignments', { method: 'PATCH', body: { action: 'add', eventId: e.id, role, userId } });
        const next = Array.isArray(j.assignments) ? j.assignments : [];
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const nextMeta = Object.assign({}, meta, { assignments: next });
        const updated = Object.assign({}, e, { meta: nextMeta });
        updateEventInState(updated);
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function removeAssignment(userId, role){
      $('eventOpsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const j = await api('/api/portal/event_assignments', { method: 'PATCH', body: { action: 'remove', eventId: e.id, role, userId } });
        const next = Array.isArray(j.assignments) ? j.assignments : [];
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const nextMeta = Object.assign({}, meta, { assignments: next });
        const updated = Object.assign({}, e, { meta: nextMeta });
        updateEventInState(updated);
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function respondAssignment(role, decision){
      $('eventOpsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const j = await api('/api/portal/event_assignments', { method: 'PATCH', body: { action: 'respond', eventId: e.id, role, decision } });
        const next = Array.isArray(j.assignments) ? j.assignments : [];
        const meta = e.meta && typeof e.meta === 'object' ? e.meta : {};
        const nextMeta = Object.assign({}, meta, { assignments: next });
        const updated = Object.assign({}, e, { meta: nextMeta, status: j.status || e.status });
        updateEventInState(updated);
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function patchSelectedEventMeta(partial){
      const e = state.selectedEvent;
      if (!e || !e.id) throw new Error('select an event');
      const baseMeta = (e.meta && typeof e.meta === 'object') ? e.meta : {};
      const nextMeta = mergeMeta(baseMeta, partial);
      const j = await api('/api/portal/events', { method: 'PATCH', body: { id: e.id, meta: nextMeta } });
      if (j && j.event) updateEventInState(j.event);
      else updateEventInState(Object.assign({}, e, { meta: nextMeta }));
    }

    async function saveChecklist(){
      $('eventOpsMsg').textContent = '';
      try{
        const checklist = {
          recapReceived: $('chkRecapReceived')?.checked ? 'yes' : 'no',
          mediaReceived: $('chkMediaReceived')?.checked ? 'yes' : 'no',
          feedbackReceived: $('chkFeedbackReceived')?.checked ? 'yes' : 'no',
          reportSent: $('chkReportSent')?.checked ? 'yes' : 'no',
          updatedAt: new Date().toISOString(),
        };
        await patchSelectedEventMeta({ checklist });
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function savePlan(){
      $('eventOpsMsg').textContent = '';
      try{
        const strategy = String($('planStrategy')?.value || '');
        const eventType = String($('planEventType')?.value || '');
        const justification = String($('planJustification')?.value || '').trim();
        if (strategy && !justification) throw new Error('justification_required');

        const types = Array.isArray(state._eventOpsTypes) ? state._eventOpsTypes : [];
        const match = eventType ? (types.find((t) => eventTypeLabel(t) === eventType) || null) : null;
        const eventTypeData = match ? {
          name: String(match?.name || match?.['Event Type'] || '').trim(),
          classFit: String(match?.classFit || match?.['Class Fit'] || '').trim(),
          kind: String(match?.kind || match?.Type || '').trim(),
          hook: String(match?.hook || match?.['Psychological Hook'] || '').trim(),
          goal: String(match?.goal || match?.Goal || '').trim(),
          notes: String(match?.notes || match?.Notes || '').trim(),
        } : null;

        const vendors = Array.isArray(state._eventOpsPlanVendors) ? state._eventOpsPlanVendors : [];
        const plan = { strategy, eventType, eventTypeData, vendors: vendors.slice(0, 25), justification, updatedAt: new Date().toISOString() };
        await patchSelectedEventMeta({ plan });
        await initEventOps();
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    async function saveBudget(){
      $('budgetMsg').textContent = '';
      try{
        const hostPayCents = dollarsToCents($('budHost')?.value);
        const mediaPayCents = dollarsToCents($('budMedia')?.value);
        if (mediaPayCents > 0) {
          const minHost = Math.ceil(mediaPayCents * 0.75);
          if (hostPayCents < minHost) throw new Error(`host_pay_must_be_at_least_${(minHost/100).toFixed(2)}`);
        }
        const budget = {
          hostPayCents,
          mediaPayCents,
          foodCents: dollarsToCents($('budFood')?.value),
          decorCents: dollarsToCents($('budDecor')?.value),
          suppliesCents: dollarsToCents($('budSupplies')?.value),
          contingencyCents: dollarsToCents($('budContingency')?.value),
          updatedAt: new Date().toISOString(),
        };
        await patchSelectedEventMeta({ budget });
        await initEventOps();
      } catch (err) {
        $('budgetMsg').textContent = String(err.message || err);
      }
    }

    async function createFollowups(){
      $('eventOpsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const j = await api('/api/portal/event_followups', { method: 'POST', body: { eventId: e.id } });
        const created = Array.isArray(j.created) ? j.created.length : 0;
        const skipped = Array.isArray(j.skipped) ? j.skipped.length : 0;
        $('eventOpsMsg').textContent = `Follow-ups: ${created} created, ${skipped} already existed.`;
      } catch (err) {
        $('eventOpsMsg').textContent = String(err.message || err);
      }
    }

    function vendorLabel(v){
      const name = String(v?.name || v?.['Vendor Name'] || v?.vendorName || v?.Vendor || v?.vendor || v?.Name || '').trim();
      const type = String(v?.type || v?.Type || v?.Category || v?.category || '').trim();
      const coverage = String(v?.coverage || v?.['City/Coverage Area'] || v?.City || v?.city || '').trim();
      const extra = [type, coverage].filter(Boolean).join(' • ');
      return [name, extra].filter(Boolean).join(' — ') || JSON.stringify(v).slice(0, 80);
    }

    async function loadVendors(){
      $('vendorsMsg').textContent = '';
      try{
        const q = String($('vendorQ')?.value || '').trim();
        const j = await api('/api/portal/vendors?q=' + encodeURIComponent(q));
        let vendors = Array.isArray(j.vendors) ? j.vendors : [];

        const e = state.selectedEvent;
        const evCity = String(e?.city || '').trim().toLowerCase();
        const evState = String(e?.state || '').trim().toLowerCase();
        function scoreVendor(v){
          const area = String(v?.['City/Coverage Area'] || v?.coverage || v?.City || v?.city || '').trim().toLowerCase();
          let s = 0;
          if (evState && area && area.includes(evState)) s += 1;
          if (evCity && area && area.includes(evCity)) s += 2;
          return s;
        }

        if (evCity || evState) {
          vendors = vendors.slice().sort((a, b) => {
            const sa = scoreVendor(a);
            const sb = scoreVendor(b);
            if (sb !== sa) return sb - sa;
            return vendorLabel(a).localeCompare(vendorLabel(b));
          });
        }

        $('vendorsList').innerHTML = vendors.slice(0, 30).map((v, i) => {
          const s = (evCity || evState) ? scoreVendor(v) : 0;
          const match = s >= 3 ? '<span class="badge ok">local</span>' : (s >= 1 ? '<span class="badge">state</span>' : '');
          return `
            <div class="card" style="background:#fff; margin-bottom:8px;">
              <div class="bd">
                <div style="font-weight:900;">${escapeHtml(vendorLabel(v))} ${match}</div>
                <div class="row" style="margin-top:8px;">
                  <button class="btn secondary small" type="button" data-add-vendor="${i}">Add to event</button>
                </div>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted small">No vendors found.</div>';

        for (const btn of $('vendorsList').querySelectorAll('button[data-add-vendor]')){
          btn.addEventListener('click', () => {
            const idx = Number(btn.dataset.addVendor || 0);
            addVendorToEvent(vendors[idx]).catch(()=>{});
          });
        }
      } catch (err) {
        $('vendorsMsg').textContent = String(err.message || err);
      }
    }

    function suggestVendorsForSelected(){
      const e = state.selectedEvent;
      const city = String(e?.city || '').trim();
      const st = String(e?.state || '').trim();
      const q = [city, st].filter(Boolean).join(' ');
      if ($('vendorQ')) $('vendorQ').value = q;
      loadVendors().catch(()=>{});
    }

    async function aiSuggestVendorsForSelected(){
      $('vendorsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        $('vendorsMsg').textContent = 'AI thinking…';

        const j = await api('/api/portal/ai/vendor_suggest?eventId=' + encodeURIComponent(String(e.id)));
        const picked = Array.isArray(j.picked) ? j.picked : [];
        const missingInfo = Array.isArray(j.missingInfo) ? j.missingInfo : [];
        const searchQuery = String(j.searchQuery || '').trim();

        // Audit log (only when mutations are allowed).
        if (coordinatorOpsEditable()) {
          try {
            const audit = {
              suggestedAt: new Date().toISOString(),
              searchQuery,
              missingInfo: missingInfo.slice(0, 8),
              picked: picked.slice(0, 10).map((p0) => {
                const v = (p0 && typeof p0 === 'object') ? p0.vendor : null;
                return {
                  vendor: v && typeof v === 'object' ? {
                    name: String(v.name || '').trim(),
                    city: String(v.city || '').trim(),
                    state: String(v.state || '').trim(),
                    type: String(v.type || '').trim(),
                    email: String(v.email || '').trim(),
                    phone: String(v.phone || '').trim(),
                  } : null,
                  reason: String(p0?.reason || '').trim().slice(0, 300),
                };
              }),
            };
            await patchSelectedEventMeta({ aiVendorSuggest: audit });
          } catch {
            // ignore audit failures
          }
        }

        if (!picked.length) {
          $('vendorsMsg').textContent = 'No AI suggestions returned.';
          $('vendorsList').innerHTML = '<div class="muted small">No suggestions.</div>';
          return;
        }

        $('vendorsMsg').textContent = `AI suggested ${picked.length} vendor(s).`;

        const header = [
          searchQuery ? `<div class="muted small">Search query: <span style="font-family:var(--mono);">${escapeHtml(searchQuery)}</span></div>` : '',
          missingInfo.length ? `<div class="muted small" style="margin-top:6px;">Missing info: ${escapeHtml(missingInfo.slice(0, 6).join(' • '))}</div>` : '',
          '<div style="height:8px"></div>',
        ].filter(Boolean).join('');

        $('vendorsList').innerHTML = header + picked.slice(0, 12).map((p, i) => {
          const v = p && typeof p === 'object' ? p.vendor : null;
          const reason = String(p?.reason || '').trim();
          const label = vendorLabel(v || {});
          return `
            <div class="card" style="background:#fff; margin-bottom:8px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between; gap:12px; align-items:flex-start;">
                  <div>
                    <div style="font-weight:900;">${escapeHtml(label)} <span class="badge">ai</span></div>
                    ${reason ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(reason)}</div>` : ''}
                  </div>
                  <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                    <button class="btn secondary small" type="button" data-add-ai-vendor="${i}">Add to event</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        for (const btn of $('vendorsList').querySelectorAll('button[data-add-ai-vendor]')){
          btn.addEventListener('click', () => {
            const idx = Number(btn.dataset.addAiVendor || 0);
            const v = picked[idx]?.vendor;
            if (!v) return;
            addVendorToEvent(v).catch(()=>{});
          });
        }
      } catch (err) {
        $('vendorsMsg').textContent = String(err.message || err);
      }
    }

    function talentDisplayName(userId){
      const uid = String(userId || '').trim();
      if (!uid) return '';

      const profilesById = (state._talentProfilesById instanceof Map)
        ? state._talentProfilesById
        : new Map((Array.isArray(state.talent?.profiles) ? state.talent.profiles : []).map((p) => [String(p?.userId || ''), p]));
      const p = profilesById.get(uid) || null;

      const users = Array.isArray(state._eventOpsUsers) ? state._eventOpsUsers : [];
      const u = users.find((x) => String(x?.userId || '') === uid) || null;

      return String((p && p.displayName) || u?.fullName || u?.email || uid).trim();
    }

    function renderTalentAiRecommendations(payload){
      const list = $('talentAiList');
      if (!list) return;
      const canAssign = coordinatorOpsEditable();
      const p = (payload && typeof payload === 'object') ? payload : {};
      const hosts = Array.isArray(p.hosts) ? p.hosts : [];
      const media = Array.isArray(p.media) ? p.media : [];
      const missingInfo = Array.isArray(p.missingInfo) ? p.missingInfo : [];

      if (!hosts.length && !media.length) {
        list.innerHTML = '<div class="muted small">No recommendations yet.</div>';
        return;
      }

      const row = (roleLabel, arr, role) => {
        if (!arr.length) return '';
        return `
          <div style="font-weight:900; margin-top:8px;">${escapeHtml(roleLabel)}</div>
          <div style="height:6px"></div>
          ${arr.slice(0, 6).map((it) => {
            const uid = String(it?.userId || '').trim();
            const name = talentDisplayName(uid);
            const reason = String(it?.reason || '').trim();
            const action = canAssign
              ? `<button class="btn secondary small" type="button" data-ai-assign="1" data-ai-role="${escapeHtml(role)}" data-ai-user="${escapeHtml(uid)}">Assign</button>`
              : '<span class="badge">read-only</span>';
            return `
              <div class="card" style="background:#fff; margin-bottom:8px;">
                <div class="bd">
                  <div class="row" style="justify-content:space-between; gap:12px; align-items:flex-start;">
                    <div>
                      <div style="font-weight:900;">${escapeHtml(name)}</div>
                      <div class="muted small" style="margin-top:2px; font-family:var(--mono);">${escapeHtml(uid)}</div>
                      ${reason ? `<div class="muted small" style="margin-top:6px;">${escapeHtml(reason)}</div>` : ''}
                    </div>
                    <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                      ${action}
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        `;
      };

      list.innerHTML = [
        missingInfo.length ? `<div class="muted small">Missing info: ${escapeHtml(missingInfo.slice(0, 6).join(' • '))}</div><div style="height:8px"></div>` : '',
        row('Hosts', hosts, 'event_host'),
        row('Media', media, 'media_team'),
      ].filter(Boolean).join('') || '<div class="muted small">No recommendations.</div>';

      if (canAssign) {
        for (const btn of list.querySelectorAll('button[data-ai-assign]')){
          btn.addEventListener('click', () => {
            const role = String(btn.dataset.aiRole || '').trim();
            const uid = String(btn.dataset.aiUser || '').trim();
            if (!role || !uid) return;
            addAssignment(role, uid).catch(()=>{});
          });
        }
      }
    }

    function renderTalentAiFromCache(){
      const e = state.selectedEvent;
      const msg = $('talentAiMsg');
      if (msg) msg.textContent = '';
      const list = $('talentAiList');
      if (!list) return;
      if (!e || !e.id) {
        list.innerHTML = '<div class="muted small">Select an event to get recommendations.</div>';
        return;
      }
      const map = (state._talentAiByEventId && typeof state._talentAiByEventId === 'object') ? state._talentAiByEventId : {};
      const payload = map[String(e.id)] || null;
      renderTalentAiRecommendations(payload);
    }

    async function aiRecommendTalentForSelected(){
      const msg = $('talentAiMsg');
      if (msg) msg.textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        if (!isCoordinatorRole()) throw new Error('forbidden');

        // Ensure we have local name caches so the UI can render nicely.
        await loadTalentProfilesCache().catch(()=>{});
        await loadAssignableUsers().catch(()=>{});

        if (msg) msg.textContent = 'AI thinking…';
        const j = await api('/api/portal/ai/talent_recommend?eventId=' + encodeURIComponent(String(e.id)));

        if (!state._talentAiByEventId) state._talentAiByEventId = {};
        state._talentAiByEventId[String(e.id)] = {
          hosts: Array.isArray(j.hosts) ? j.hosts : [],
          media: Array.isArray(j.media) ? j.media : [],
          missingInfo: Array.isArray(j.missingInfo) ? j.missingInfo : [],
        };

        // Audit log (only when mutations are allowed).
        if (coordinatorOpsEditable()) {
          try {
            const audit = {
              recommendedAt: new Date().toISOString(),
              missingInfo: Array.isArray(j.missingInfo) ? j.missingInfo.slice(0, 8) : [],
              hosts: Array.isArray(j.hosts) ? j.hosts.slice(0, 5).map((x) => ({
                userId: String(x?.userId || '').trim(),
                reason: String(x?.reason || '').trim().slice(0, 300),
              })) : [],
              media: Array.isArray(j.media) ? j.media.slice(0, 5).map((x) => ({
                userId: String(x?.userId || '').trim(),
                reason: String(x?.reason || '').trim().slice(0, 300),
              })) : [],
            };
            await patchSelectedEventMeta({ aiTalentRecommend: audit });
          } catch {
            // ignore audit failures
          }
        }

        if (msg) msg.textContent = '';
        renderTalentAiFromCache();
      } catch (err) {
        if (msg) msg.textContent = String(err.message || err);
      }
    }

    async function aiAssignTopTalentForSelected(){
      const msg = $('talentAiMsg');
      if (msg) msg.textContent = '';
      try{
        if (!coordinatorOpsEditable()) throw new Error('read_only');
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');

        const map = (state._talentAiByEventId && typeof state._talentAiByEventId === 'object') ? state._talentAiByEventId : {};
        const payload = map[String(e.id)] || null;
        const hosts = Array.isArray(payload?.hosts) ? payload.hosts : [];
        const media = Array.isArray(payload?.media) ? payload.media : [];

        const hostId = String(hosts?.[0]?.userId || '').trim();
        const mediaId = String(media?.[0]?.userId || '').trim();
        if (!hostId && !mediaId) throw new Error('no_recommendations');

        if (msg) msg.textContent = 'Assigning…';

        const errs = [];
        if (hostId) {
          try { await addAssignment('event_host', hostId); }
          catch (e0) { errs.push(String(e0?.message || e0)); }
        }
        if (mediaId) {
          try { await addAssignment('media_team', mediaId); }
          catch (e0) { errs.push(String(e0?.message || e0)); }
        }

        if (msg) msg.textContent = errs.length ? ('Assigned with warnings: ' + errs.slice(0, 2).join(' • ')) : 'Assigned top picks.';
      } catch (err) {
        if (msg) msg.textContent = String(err.message || err);
      }
    }

    async function addVendorToEvent(vendor){
      $('vendorsMsg').textContent = '';
      try{
        const e = state.selectedEvent;
        if (!e || !e.id) throw new Error('select an event');
        const baseMeta = (e.meta && typeof e.meta === 'object') ? e.meta : {};
        const chosen = Array.isArray(baseMeta.vendorsChosen) ? baseMeta.vendorsChosen : [];
        const next = chosen.concat([vendor]).slice(0, 20);
        await patchSelectedEventMeta({ vendorsChosen: next });
        $('vendorsMsg').textContent = 'Added.';
      } catch (err) {
        $('vendorsMsg').textContent = String(err.message || err);
      }
    }

    function eventTypeLabel(t){
      return String(t?.name || t?.['Event Type'] || t?.event_type || t?.type || '').trim() || JSON.stringify(t).slice(0, 80);
    }

    function renderPlanEventTypeDetails(){
      const box = $('planEventTypeDetails');
      if (!box) return;
      try{
        const label = String($('planEventType')?.value || '').trim();
        if (!label) { box.textContent = ''; return; }

        const types = Array.isArray(state._eventOpsTypes) ? state._eventOpsTypes : [];
        const t = types.find((x) => eventTypeLabel(x) === label) || null;
        if (!t) { box.textContent = ''; return; }

        const kind = String(t?.kind || t?.Type || '').trim();
        const classFit = String(t?.classFit || t?.['Class Fit'] || '').trim();
        const hook = String(t?.hook || t?.['Psychological Hook'] || '').trim();
        const goal = String(t?.goal || t?.Goal || '').trim();
        const notes = String(t?.notes || t?.Notes || '').trim();

        const bits = [
          kind ? `<span class="badge">${escapeHtml(kind)}</span>` : '',
          classFit ? `<span class="badge">${escapeHtml(classFit)}</span>` : '',
        ].filter(Boolean).join(' ');

        const lines = [
          bits ? `<div class="row" style="gap:6px; flex-wrap:wrap;">${bits}</div>` : '',
          hook ? `<div style="margin-top:6px;"><span style="font-weight:900;">Hook:</span> ${escapeHtml(hook)}</div>` : '',
          goal ? `<div style="margin-top:4px;"><span style="font-weight:900;">Goal:</span> ${escapeHtml(goal)}</div>` : '',
          notes ? `<div style="margin-top:4px;">${escapeHtml(notes)}</div>` : '',
        ].filter(Boolean);

        box.innerHTML = lines.join('');
      } catch(_e) {
        box.textContent = '';
      }
    }

    async function loadEventTypes(){
      $('eventTypesMsg').textContent = '';
      try{
        const q = String($('eventTypeQ')?.value || '').trim();
        const j = await api('/api/portal/event_types?q=' + encodeURIComponent(q));
        const types = Array.isArray(j.types) ? j.types : [];
        $('eventTypesList').innerHTML = types.slice(0, 30).map((t, i) => {
          const label = eventTypeLabel(t);
          const kind = String(t?.kind || t?.Type || '').trim();
          const classFit = String(t?.classFit || t?.['Class Fit'] || '').trim();
          const hook = String(t?.hook || t?.['Psychological Hook'] || '').trim();
          const goal = String(t?.goal || t?.Goal || '').trim();
          const meta = [kind, classFit].filter(Boolean).join(' • ');
          return `
            <div class="card" style="background:#fff; margin-bottom:8px;">
              <div class="bd">
                <div style="font-weight:900;">${escapeHtml(label)}</div>
                ${meta ? `<div class="muted small" style="margin-top:4px;">${escapeHtml(meta)}</div>` : ''}
                ${hook ? `<div class="muted small" style="margin-top:4px;"><span style="font-weight:900;">Hook:</span> ${escapeHtml(hook.slice(0, 180))}</div>` : ''}
                ${goal ? `<div class="muted small" style="margin-top:2px;"><span style="font-weight:900;">Goal:</span> ${escapeHtml(goal.slice(0, 180))}</div>` : ''}
                <div class="row" style="margin-top:8px;">
                  <button class="btn secondary small" type="button" data-use-type="${i}">Use as event type</button>
                </div>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted small">No event types found.</div>';

        for (const btn of $('eventTypesList').querySelectorAll('button[data-use-type]')){
          btn.addEventListener('click', () => {
            const idx = Number(btn.dataset.useType || 0);
            const label = eventTypeLabel(types[idx]);
            const sel = $('planEventType');
            if (!sel) return;
            const has = Array.from(sel.options || []).some((o) => String(o.value) === String(label));
            if (!has) {
              const opt = document.createElement('option');
              opt.value = label;
              opt.textContent = label;
              sel.appendChild(opt);
            }
            sel.value = label;
            renderPlanEventTypeDetails();
          });
        }
      } catch (err) {
        $('eventTypesMsg').textContent = String(err.message || err);
      }
    }

    function fmtMoney(cents){
      const n = Number(cents || 0) / 100;
      return n.toLocaleString(undefined, { style:'currency', currency:'USD' });
    }

    function pipelineStages(){
      // Order matters: this is the visual timeline.
      return [
        { key: 'new', label: 'New' },
        { key: 'working', label: 'Working' },
        { key: 'booked', label: 'Booked' },
        { key: 'won', label: 'Won' },
        { key: 'lost', label: 'Lost' },
      ];
    }

    function countByStatus(leads){
      const out = {};
      const arr = Array.isArray(leads) ? leads : [];
      for (const l of arr) {
        const st = String(l?.status || '').trim();
        if (!st) continue;
        out[st] = Number(out[st] || 0) + 1;
      }
      return out;
    }

    function leadsForStage(leads, stageKey){
      const st = String(stageKey || '').trim();
      return (Array.isArray(leads) ? leads : []).filter((l) => String(l?.status || '').trim() === st);
    }

    function leadLabelLine(l){
      const name = [l?.first_name, l?.last_name].filter(Boolean).join(' ').trim() || '(no name)';
      const prop = String(l?.property_name || l?.company || '').trim();
      return [name, prop].filter(Boolean).join(' • ');
    }

    function renderPipelineTimeline(containerId, leads, { context = 'leads' } = {}){
      const el = $(containerId);
      if (!el) return;
      const defs = pipelineStages();
      const counts = countByStatus(leads);
      el.innerHTML = defs.map((d, idx) => {
        const c = Number(counts[d.key] || 0);
        const line = (idx < defs.length - 1) ? `<span class="pipeLine" aria-hidden="true"></span>` : '';
        return `
          <div class="pipeStage">
            <button type="button" class="pipeNode" data-pipe-stage="${escapeHtml(d.key)}" data-pipe-context="${escapeHtml(context)}">
              <span>${escapeHtml(d.label)}</span>
              <span class="pipeCount">${c}</span>
            </button>
            ${line}
          </div>
        `;
      }).join('');

      for (const btn of el.querySelectorAll('button[data-pipe-stage]')){
        btn.addEventListener('click', () => {
          const stage = String(btn.dataset.pipeStage || '');
          const ctx = String(btn.dataset.pipeContext || 'leads');
          openPipelineModal({ stage, context: ctx });
        });
      }
    }

    const pipelineModalState = {
      stage: '',
      context: 'leads',
      leads: [],
      idx: 0,
    };

    function openPipelineModal({ stage, context } = {}){
      const modal = $('pipelineModal');
      if (!modal) return;

      const st = String(stage || '').trim();
      if (!st) return;
      const ctx = String(context || 'leads');

      const pool = (ctx === 'closer') ? (state.closerQueue || []) : (state.leads || []);
      const items = leadsForStage(pool, st);
      items.sort((a, b) => {
        const an = leadLabelLine(a);
        const bn = leadLabelLine(b);
        return an.localeCompare(bn);
      });

      pipelineModalState.stage = st;
      pipelineModalState.context = ctx;
      pipelineModalState.leads = items;
      pipelineModalState.idx = 0;

      const title = $('pipelineModalTitle');
      const sub = $('pipelineModalSub');
      if (title) title.textContent = (ctx === 'closer' ? 'Sales pipeline' : 'Pipeline') + ` — ${st}`;
      if (sub) sub.textContent = `${items.length} lead${items.length === 1 ? '' : 's'}`;

      renderPipelineModal();
      modal.classList.add('show');
    }

    function closePipelineModal(){
      const modal = $('pipelineModal');
      if (!modal) return;
      modal.classList.remove('show');
    }

    function selectPipelineIdx(nextIdx){
      const n = pipelineModalState.leads.length;
      if (!n) { pipelineModalState.idx = 0; return; }
      let i = Number(nextIdx || 0);
      if (i < 0) i = 0;
      if (i >= n) i = n - 1;
      pipelineModalState.idx = i;
      renderPipelineModal();
    }

    function renderPipelineModal(){
      const list = $('pipelineModalList');
      const detail = $('pipelineModalDetail');
      if (!list || !detail) return;

      const items = pipelineModalState.leads || [];
      if (!items.length) {
        list.innerHTML = '<div class="muted small" style="padding:12px;">No leads in this stage.</div>';
        detail.innerHTML = '<div class="muted small">—</div>';
        return;
      }

      const idx = Number(pipelineModalState.idx || 0);
      const safeIdx = Math.max(0, Math.min(idx, items.length - 1));
      pipelineModalState.idx = safeIdx;

      list.innerHTML = items.map((l, i) => {
        const active = i === safeIdx ? 'active' : '';
        const line = leadLabelLine(l);
        const phone = String(l?.phone || '').trim();
        const followup = (l?.meta && typeof l.meta === 'object') ? String(l.meta.followup || '').trim() : '';
        const extra = [phone ? ('☎ ' + phone) : '', followup ? ('FU ' + followup) : ''].filter(Boolean).join(' • ');
        return `<button type="button" class="${active}" data-pm-pick="${i}">
          <div style="font-weight:900;">${escapeHtml(line)}</div>
          ${extra ? `<div class="muted small" style="margin-top:2px;">${escapeHtml(extra)}</div>` : ''}
        </button>`;
      }).join('');

      for (const btn of list.querySelectorAll('button[data-pm-pick]')){
        btn.addEventListener('click', () => selectPipelineIdx(Number(btn.dataset.pmPick || 0)));
      }

      const l = items[safeIdx];
      const meta = (l?.meta && typeof l.meta === 'object') ? l.meta : {};
      const website = String(meta?.website || '').trim();
      const mapsUrl = String(meta?.maps_url || '').trim();

      detail.innerHTML = `
        <div class="kv">
          <div>ID</div><div>${escapeHtml(String(l?.id || ''))}</div>
          <div>Name</div><div>${escapeHtml([l?.first_name, l?.last_name].filter(Boolean).join(' ') || '')}</div>
          <div>Property</div><div>${escapeHtml(String(l?.property_name || l?.company || ''))}</div>
          <div>Phone</div><div>${escapeHtml(String(l?.phone || ''))}</div>
          <div>Email</div><div>${escapeHtml(String(l?.email || ''))}</div>
          <div>City</div><div>${escapeHtml([l?.city, l?.state].filter(Boolean).join(', '))}</div>
          <div>Status</div><div><span class="badge">${escapeHtml(String(l?.status || ''))}</span></div>
          <div>Follow up</div><div>${escapeHtml(String(meta?.followup || ''))}</div>
          <div>Website</div><div>${website ? `<a href="${escapeHtml(website)}" target="_blank" rel="noopener">${escapeHtml(website)}</a>` : '<span class="muted">—</span>'}</div>
          <div>Maps</div><div>${mapsUrl ? `<a href="${escapeHtml(mapsUrl)}" target="_blank" rel="noopener">Open</a>` : '<span class="muted">—</span>'}</div>
        </div>
      `;
    }

    function renderLeadsTable(){
      const tb = $('leadsTbody');
      if (!tb) return;
      const status = String($('leadStatus')?.value || '').trim();
      const items = (Array.isArray(state.leads) ? state.leads : []).filter((l) => !status || String(l?.status || '') === status);

      renderPipelineTimeline('leadsPipeline', state.leads || [], { context: 'leads' });

      if ($('leadsEmpty')) $('leadsEmpty').textContent = items.length ? '' : 'No leads yet.';
      if (!items.length) {
        tb.innerHTML = '<tr><td colspan="7" class="muted">No leads yet.</td></tr>';
        return;
      }

      tb.innerHTML = items.map((l) => {
        const name = [l.first_name, l.last_name].filter(Boolean).join(' ') || '(no name)';
        const prop = l.property_name || l.company || '';
        const city = [l.city, l.state].filter(Boolean).join(', ');
        const asg = l.assigned_role || '';
        return `
          <tr>
            <td><span class="badge">${l.id}</span></td>
            <td>${name}</td>
            <td>${prop}</td>
            <td class="muted">${city}</td>
            <td><span class="badge">${l.status}</span></td>
            <td class="muted">${asg}</td>
            <td><button class="btn secondary small" data-pick="${l.id}">Select</button></td>
          </tr>
        `;
      }).join('');

      for (const btn of tb.querySelectorAll('button[data-pick]')){
        btn.addEventListener('click', () => {
          const id = Number(btn.dataset.pick);
          state.selectedLead = (state.leads || []).find((x) => Number(x.id) === id) || null;
          setSelectedLeadLine();
          loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
          loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
          setTab(state.pickLeadReturnTab || 'calls');
        });
      }
    }

    async function loadLeads(){
      setBadge('warn', 'loading');
      $('leadsMsg').textContent = '';
      if ($('leadsEmpty')) $('leadsEmpty').textContent = '';

      const q = $('leadQ').value.trim();
      const qs = new URLSearchParams();
      if (q) qs.set('q', q);
      // Always fetch without status so the stage bar can show counts.
      qs.set('limit', '120');

      try{
        const j = await api('/api/portal/leads?' + qs.toString());
        state.leads = j.leads || [];
        renderLeadsTable();
        setBadge('ok', 'loaded');
      } catch(e){
        $('leadsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function pullLeads(){
      const msg = $('pullLeadsMsg');
      if (msg) msg.textContent = '';

      const cityState = String($('plCityState')?.value || '').trim();
      if (!cityState) {
        if (msg) msg.textContent = 'Enter City, State.';
        return;
      }
      const keyword = String($('plKeyword')?.value || '').trim() || 'apartment leasing office';
      const limit = Number($('plLimit')?.value || 10) || 10;
      const notes = String($('plNotes')?.value || '').trim();

      setBadge('warn', 'loading');
      try {
        const j = await api('/api/portal/pull_leads', {
          method: 'POST',
          body: { cityState, keyword, limit, notes },
        });
        const inserted = Number(j.inserted || 0);
        const skipped = Number(j.skipped || 0);
        if (msg) msg.textContent = inserted
          ? `Pulled ${inserted} leads. ${skipped ? (skipped + ' skipped (missing phone).') : ''}`.trim()
          : `No leads pulled. ${skipped ? (skipped + ' skipped (missing phone).') : ''}`.trim();
        $('pullLeadsBox').hidden = true;
        await loadLeads();
        setBadge('ok', 'loaded');
      } catch (e) {
        if (msg) msg.textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createLead(){
      $('createLeadMsg').textContent = '';
      const cityState = $('nlCityState').value.trim();
      let city = cityState, st = '';
      if (cityState.includes(',')){
        const parts = cityState.split(',');
        city = (parts[0] || '').trim();
        st = (parts[1] || '').trim();
      }

      try{
        await api('/api/portal/leads', {
          method: 'POST',
          body: {
            firstName: $('nlFirst').value,
            lastName: $('nlLast').value,
            phone: $('nlPhone').value,
            email: $('nlEmail').value,
            propertyName: $('nlProp').value,
            city,
            state: st,
            notes: $('nlNotes').value,
            status: 'new',
          }
        });
        $('newLeadBox').hidden = true;
        await loadLeads();
      } catch(e){
        $('createLeadMsg').textContent = String(e.message || e);
      }
    }

    async function logCall(){
      $('callMsg').textContent = '';
      if (!state.selectedLead) return $('callMsg').textContent = 'Select a lead first (from Leads tab).';

      const outcome = $('callOutcome').value;
      if (!outcome) return $('callMsg').textContent = 'Pick an outcome.';

      try{
        const followup = String($('callFollowup').value || '').trim();
        await api('/api/portal/calls', {
          method: 'POST',
          body: {
            leadId: state.selectedLead.id,
            outcome,
            notes: $('callNotes').value,
            payload: followup ? { followup } : {},
          }
        });

        const nextStatus = $('callLeadStatus').value;
        if (nextStatus){
          await api('/api/portal/leads', { method:'PATCH', body: { id: state.selectedLead.id, status: nextStatus } });
        }

        if (followup) {
          const nextMeta = Object.assign({}, (state.selectedLead.meta && typeof state.selectedLead.meta === 'object') ? state.selectedLead.meta : {});
          nextMeta.followup = followup;
          await api('/api/portal/leads', { method:'PATCH', body: { id: state.selectedLead.id, meta: nextMeta } });
        }

        $('callMsg').textContent = '';
        setBadge('ok', 'saved');
        loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
      } catch(e){
        $('callMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function aiFollowup(){
      $('callMsg').textContent = '';
      $('followupBox').classList.add('hide');

      if (!state.selectedLead) return $('callMsg').textContent = 'Select a lead first (from Leads tab).';
      const outcome = $('callOutcome').value;

      setBadge('warn', 'thinking');
      try{
        const j = await api('/api/portal/ai/followup', {
          method: 'POST',
          body: {
            leadId: state.selectedLead.id,
            outcome,
            notes: $('callNotes').value,
          }
        });

        const fu = j.followup || {};
        $('fuSubject').value = fu.emailSubject || '';
        $('fuEmail').value = fu.emailBody || '';
        $('fuSms').value = fu.sms || '';
        $('fuNext').value = fu.nextStep || '';
        $('followupBox').classList.remove('hide');

        setBadge('ok', 'ready');
      } catch(e){
        $('callMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadOffers(){
      setBadge('warn', 'loading');
      if ($('offersMsg')) $('offersMsg').textContent = '';
      const tb = $('offersTbody');
      if (tb) tb.innerHTML = '';

      const qs = new URLSearchParams();
      qs.set('limit', '160');

      try{
        const j = await api('/api/portal/events?' + qs.toString());
        const allEvents = Array.isArray(j.events) ? j.events : [];

        const er = effectiveRole();
        const effectiveUserId = (isManagerUser() && String(state.viewAsUserId || '').trim())
          ? String(state.viewAsUserId || '').trim()
          : String(state.me?.user?.id || '');

        const isHostOrMedia = ['event_host','media_team'].includes(er);
        const isMgrOrCoord = (er === 'manager' || er === 'event_coordinator');

        let offers = [];
        if (isHostOrMedia) {
          offers = allEvents.filter((ev) => {
            const a = myAssignmentForEvent(ev, er, effectiveUserId);
            const s = String(a?.status || '').trim();
            return s === 'pending' || s === 'declined' || s === 'accepted';
          });
        } else if (isMgrOrCoord) {
          offers = allEvents.filter((ev) => {
            const asg = String(ev.assigned_role || '').trim();
            if (!['event_host','media_team'].includes(asg)) return false;
            const hasAssignments = !!(ev.meta && typeof ev.meta === 'object' && Array.isArray(ev.meta.assignments) && ev.meta.assignments.length);
            const isOpenUnassigned = String(ev.status || 'open') === 'open' && !ev.assigned_user_id;
            return hasAssignments || isOpenUnassigned;
          });
        }

        const wantState = String($('offersStatePick')?.value || '').trim();
        if (wantState) {
          offers = offers.filter((ev) => {
            if (isHostOrMedia) {
              const a = myAssignmentForEvent(ev, er, effectiveUserId);
              const s = String(a?.status || '').trim();
              return s === wantState;
            }
            const sum = offerSummaryForEvent(ev);
            return String(sum.offerState || '').trim() === wantState;
          });
        }

        if (!tb) {
          setBadge('ok', 'loaded');
          return;
        }

        if (!offers.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No offers to show.</td></tr>';
          state.offers = [];
          closeOfferDetail({ clearSelection: true });
          setBadge('ok', 'loaded');
          return;
        }

        state.offers = offers;

        tb.innerHTML = offers.map((ev) => {
          const date = ev.event_date || '';
          const city = [ev.city, ev.state].filter(Boolean).join(', ');
          const asg = ev.assigned_role || '';

          const sum = offerSummaryForEvent(ev);
          const badgeKind = sum.offerKind || '';

          let offerText = sum.offerText || '';
          let offerBadge = offerText ? `<span class="badge ${escapeHtml(badgeKind)}">${escapeHtml(offerText)}</span>` : `<span class="badge">${escapeHtml(String(ev.status || ''))}</span>`;

          let actions = `<button class="btn secondary small" data-offer-open="${ev.id}">Open</button>`;

          if (isHostOrMedia) {
            const myAsg = myAssignmentForEvent(ev, er, effectiveUserId);
            const myStatus = String(myAsg?.status || '').trim();
            offerBadge = myStatus
              ? `<span class="badge ${myStatus === 'accepted' ? 'ok' : (myStatus === 'declined' ? 'warn' : '')}">${escapeHtml(myStatus)}</span>`
              : offerBadge;
            if (myStatus === 'pending' && !isManagerViewAsPreviewOnly()) {
              actions = `<button class="btn small" data-offer-respond="accept" data-offer-event="${ev.id}" data-offer-role="${escapeHtml(er)}">Accept</button> <button class="btn secondary small" data-offer-respond="decline" data-offer-event="${ev.id}" data-offer-role="${escapeHtml(er)}">Decline</button> <button class="btn secondary small" data-offer-open="${ev.id}">Open</button>`;
            }
          }

          if (!isHostOrMedia && !isMgrOrCoord) {
            actions = '<span class="muted">—</span>';
          }

          return `
            <tr>
              <td><span class="badge">${ev.id}</span></td>
              <td class="muted">${escapeHtml(date)}</td>
              <td>${escapeHtml(ev.title || '')}</td>
              <td class="muted">${escapeHtml(city)}</td>
              <td>${offerBadge}</td>
              <td class="muted">${escapeHtml(asg)}</td>
              <td>${actions}</td>
            </tr>
          `;
        }).join('');

        tb.onclick = async (ev) => {
          const target = ev.target instanceof Element ? ev.target : null;
          if (!target) return;
          const openBtn = target.closest('button[data-offer-open]');
          if (openBtn) {
            const id = Number(openBtn.getAttribute('data-offer-open') || 0);
            if (!id) return;
            openOfferDetail(id).catch(() => {});
            return;
          }

          const respondBtn = target.closest('button[data-offer-respond]');
          if (respondBtn) {
            if ($('offersMsg')) $('offersMsg').textContent = '';
            try{
              const action = String(respondBtn.getAttribute('data-offer-respond') || '');
              const decision = action === 'accept' ? 'accepted' : (action === 'decline' ? 'declined' : '');
              const eventId = Number(respondBtn.getAttribute('data-offer-event') || 0);
              const role = String(respondBtn.getAttribute('data-offer-role') || '').trim();
              if (!decision || !eventId || !role) throw new Error('invalid_action');
              await respondAssignmentForEvent(eventId, role, decision);
              await loadOffers();

              // Keep the details panel fresh if it's open.
              renderOfferDetailFromState();
            } catch(e){
              if ($('offersMsg')) $('offersMsg').textContent = String(e.message || e);
            }
          }
        };

        // If something was already open, keep it open.
        renderOfferDetailFromState();

        setBadge('ok', 'loaded');
      } catch(e){
        if ($('offersMsg')) $('offersMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadEvents(){
      setBadge('warn', 'loading');
      $('eventsMsg').textContent = '';

      const prevSelectedId = state.selectedEvent ? Number(state.selectedEvent.id) : null;

      const status = $('eventStatus').value;
      const qs = new URLSearchParams();
      if (status) qs.set('status', status);
      qs.set('limit', '120');

      try{
        const j = await api('/api/portal/events?' + qs.toString());
        const allEvents = j.events || [];

        const er = effectiveRole();
        const effectiveUserId = (isManagerUser() && String(state.viewAsUserId || '').trim()) ? String(state.viewAsUserId || '').trim() : String(state.me?.user?.id || '');

        let desired = (state.activeTab === 'offers') ? 'offers' : String(state.eventsSubtab || 'all');

        // Filtering
        let nextEvents = allEvents;
        const isHostOrMedia = ['event_host','media_team'].includes(er);
        const isMgrOrCoord = (er === 'manager' || er === 'event_coordinator');

        const canAll = canSeeAllEventsForRole();
        if (isHostOrMedia && desired === 'all' && !canAll) desired = 'my';

        if (isHostOrMedia) {
          if (desired === 'my') {
            nextEvents = allEvents.filter((ev) => eventIsMineForRole(ev, er, effectiveUserId));
          } else if (desired === 'offers') {
            nextEvents = allEvents.filter((ev) => {
              const a = myAssignmentForEvent(ev, er, effectiveUserId);
              const s = String(a?.status || '').trim();
              return s === 'pending' || s === 'declined' || s === 'accepted';
            });
          } else {
            // 'all'
            nextEvents = allEvents;
          }
        }

        // Offers oversight for managers/coordinators: show open offers + offers already sent.
        if (isMgrOrCoord && desired === 'offers') {
          nextEvents = allEvents.filter((ev) => {
            const asg = String(ev.assigned_role || '').trim();
            if (!['event_host','media_team'].includes(asg)) return false;
            const hasAssignments = !!(ev.meta && typeof ev.meta === 'object' && Array.isArray(ev.meta.assignments) && ev.meta.assignments.length);
            const isOpenUnassigned = String(ev.status || 'open') === 'open' && !ev.assigned_user_id;
            return hasAssignments || isOpenUnassigned;
          });
        }

        state.events = nextEvents;

        const tb = $('eventsTbody');
        if (!state.events.length) {
          tb.innerHTML = '<tr><td colspan="7" class="muted">No events yet.</td></tr>';
          if (prevSelectedId != null) setSelectedEvent(null);
          setBadge('ok', 'loaded');
          return;
        }

        tb.innerHTML = state.events.map((ev) => {
          const date = ev.event_date || '';
          const city = [ev.city, ev.state].filter(Boolean).join(', ');
          const asg = ev.assigned_role || '';
          const isSelected = prevSelectedId != null && Number(ev.id) === Number(prevSelectedId);

          const myAsg = myAssignmentForEvent(ev, er, effectiveUserId);
          const myStatus = String(myAsg?.status || '').trim();
          const showOfferActions = (desired === 'offers') && (myStatus === 'pending') && !isManagerViewAsPreviewOnly();
          const offerActions = showOfferActions
            ? `<button class="btn small" data-asg-respond="accept" data-asg-event="${ev.id}" data-asg-role="${escapeHtml(er)}">Accept</button> <button class="btn secondary small" data-asg-respond="decline" data-asg-event="${ev.id}" data-asg-role="${escapeHtml(er)}">Decline</button>`
            : '';
          const myStatusBadge = (desired === 'offers' && myStatus)
            ? `<div style="margin-top:6px;"><span class="badge ${myStatus === 'accepted' ? 'ok' : (myStatus === 'declined' ? 'warn' : '')}">${escapeHtml(myStatus)}</span></div>`
            : '';

          const sum = offerSummaryForEvent(ev);
          const isOffersTab = (state.activeTab === 'offers');
          const offerBadge = (isOffersTab && sum.offerText)
            ? `<div style="margin-top:6px;"><span class="badge ${sum.offerKind}">${escapeHtml(sum.offerText)}</span></div>`
            : '';

          // In offers contexts, show ONE status label (offer/assignment state) to avoid
          // confusing combinations like "open" + "pending".
          const inOffersContext = (desired === 'offers') || isOffersTab;
          const primaryOfferText = myStatus || sum.offerText || '';
          const statusCell = inOffersContext
            ? `<span class="badge">${escapeHtml(primaryOfferText || String(ev.status || ''))}</span>`
            : `<span class="badge">${escapeHtml(ev.status || '')}</span>${offerBadge}${myStatusBadge}`;

          const acceptBtn = '';

          return `
            <tr class="clickRow ${isSelected ? 'selected' : ''}" data-event-row="${ev.id}">
              <td><span class="badge">${ev.id}</span></td>
              <td class="muted">${date}</td>
              <td>${escapeHtml(ev.title || '')}</td>
              <td class="muted">${escapeHtml(city)}</td>
              <td>${statusCell}</td>
              <td class="muted">${asg}</td>
              <td>${offerActions} ${acceptBtn}</td>
            </tr>
          `;
        }).join('');

        tb.onclick = (ev) => {
          const target = ev.target instanceof Element ? ev.target : null;
          if (!target) return;
          if (target.closest('button')) return;
          const tr = target.closest('tr[data-event-row]');
          if (!tr) return;
          const id = Number(tr.getAttribute('data-event-row') || 0);
          const found = state.events.find((x) => Number(x.id) === id) || null;
          setSelectedEvent(found);
          for (const row of tb.querySelectorAll('tr[data-event-row]')) row.classList.remove('selected');
          tr.classList.add('selected');
        };

        for (const btn of tb.querySelectorAll('button[data-asg-respond]')){
          btn.addEventListener('click', async () => {
            $('eventsMsg').textContent = '';
            try{
              const action = String(btn.dataset.asgRespond || '');
              const decision = action === 'accept' ? 'accepted' : (action === 'decline' ? 'declined' : '');
              const eventId = Number(btn.dataset.asgEvent || 0);
              const role = String(btn.dataset.asgRole || '').trim();
              if (!decision || !eventId || !role) throw new Error('invalid_action');
              await respondAssignmentForEvent(eventId, role, decision);
              await loadEvents();
            } catch(e){
              $('eventsMsg').textContent = String(e.message || e);
            }
          });
        }

        // Restore / apply selection.
        const pendingId = Number(state.pendingSelectEventId || 0);
        if (pendingId) {
          state.pendingSelectEventId = null;
          const found = state.events.find((x) => Number(x.id) === pendingId) || null;
          setSelectedEvent(found);
        } else if (prevSelectedId != null) {
          const found = state.events.find((x) => Number(x.id) === prevSelectedId) || null;
          setSelectedEvent(found);
        }

        setBadge('ok', 'loaded');
      } catch(e){
        $('eventsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createEvent(){
      $('createEventMsg').textContent = '';
      try{
        if ($('neAccountMsg')) $('neAccountMsg').textContent = '';
        const accountId = String($('neAccountPick')?.value || '').trim();
        if (!accountId) throw new Error('property_required');

        const accounts = Array.isArray(state._newEventAccounts) ? state._newEventAccounts : [];
        const account = accounts.find((a) => String(a?.id || '') === accountId) || null;
        const propertyName = String(account?.propertyName || account?.name || '').trim();
        if (!propertyName) throw new Error('invalid_property');

        const address = String($('neAddress')?.value || '').trim() || String(account?.address || '').trim();
        const city = String($('neCity')?.value || '').trim() || String(account?.city || '').trim();
        const st = String($('neState')?.value || '').trim() || String(account?.state || '').trim();
        const title = String($('neTitle')?.value || '').trim() || propertyName;
        await api('/api/portal/events', {
          method: 'POST',
          body: {
            title,
            eventDate: $('neDate').value,
            address,
            city,
            state: st,
            notes: $('neNotes').value,
            status: 'open',
            assignedRole: 'event_host',
            meta: {
              accountId,
              propertyName,
              propertyAddress: address,
              createdFrom: 'portal_new_event',
            }
          }
        });
        $('newEventBox').hidden = true;
        if ($('neAccountPick')) $('neAccountPick').value = '';
        if ($('neAddress')) $('neAddress').value = '';
        if ($('neTitle')) $('neTitle').value = '';
        if ($('neDate')) $('neDate').value = '';
        if ($('neCity')) $('neCity').value = '';
        if ($('neState')) $('neState').value = '';
        if ($('neNotes')) $('neNotes').value = '';
        await loadEvents();
      } catch(e){
        $('createEventMsg').textContent = String(e.message || e);
      }
    }

    async function ensureNewEventAccountsLoaded({ force = false } = {}){
      if (!$('neAccountPick')) return [];
      if (!force && Array.isArray(state._newEventAccounts) && state._newEventAccounts.length && $('neAccountPick').options.length > 1) {
        return state._newEventAccounts;
      }
      if ($('neAccountMsg')) $('neAccountMsg').textContent = '';
      try{
        const j = await api('/api/portal/accounts');
        const accounts = Array.isArray(j.accounts) ? j.accounts : [];
        state._newEventAccounts = accounts;
        $('neAccountPick').innerHTML = ['<option value="">Select…</option>']
          .concat(accounts.map((a) => {
            const id = escapeHtml(String(a?.id || ''));
            const label = escapeHtml(String(a?.propertyName || a?.name || '').trim());
            return `<option value="${id}">${label}</option>`;
          }))
          .join('');
        return accounts;
      } catch (e) {
        if ($('neAccountMsg')) $('neAccountMsg').textContent = String(e.message || e);
        state._newEventAccounts = [];
        return [];
      }
    }

    function applyNewEventAccountFill(){
      if (!$('neAccountPick')) return;
      const accountId = String($('neAccountPick').value || '').trim();
      const accounts = Array.isArray(state._newEventAccounts) ? state._newEventAccounts : [];
      const account = accounts.find((a) => String(a?.id || '') === accountId) || null;
      if (!account) return;
      if ($('neAddress') && !$('neAddress').value) $('neAddress').value = String(account.address || '');
      if ($('neCity') && !$('neCity').value) $('neCity').value = String(account.city || '');
      if ($('neState') && !$('neState').value) $('neState').value = String(account.state || '');
      if ($('neTitle') && !$('neTitle').value) $('neTitle').value = String(account.propertyName || account.name || '');
    }

    async function loadPayouts(){
      setBadge('warn', 'loading');
      $('payoutsMsg').textContent = '';
      if ($('payoutsTotals')) $('payoutsTotals').textContent = '';
      if ($('payoutsTotalsSub')) $('payoutsTotalsSub').textContent = '';
      if ($('payoutsTotalBig')) $('payoutsTotalBig').textContent = '$0.00';
      if ($('payoutsEmpty')) $('payoutsEmpty').textContent = '';
      try{
        const days = Number(state.payoutsPeriodDays || 0);
        let qs = 'limit=200';
        if (days && Number.isFinite(days)) {
          const d = new Date();
          d.setUTCDate(d.getUTCDate() - Math.max(1, Math.trunc(days)));
          const ymd = d.toISOString().slice(0, 10);
          qs += '&since=' + encodeURIComponent(ymd);
        }

        const j = await api('/api/portal/payouts?' + qs);
        const payoutsAll = j.payouts || [];

        const norm = (v) => String(v || '').trim().toLowerCase();
        const q = norm(state.payoutsQ || '');
        const wantStatus = norm(state.payoutsStatus || '');
        const matchesStatus = (p) => {
          const s = norm(p?.status || '');
          if (!wantStatus) return true;
          if (wantStatus === 'pending') return s !== 'paid';
          return s === wantStatus;
        };

        let payouts = Array.isArray(payoutsAll) ? payoutsAll.slice() : [];
        payouts = payouts.filter((p) => matchesStatus(p));
        if (q) {
          payouts = payouts.filter((p) => {
            const date = String(p?.created_at || '').slice(0, 10);
            const desc = norm(p?.description || '');
            const status = norm(p?.status || '');
            const amt = norm(fmtMoney(p?.amount_cents || 0));
            return desc.includes(q) || status.includes(q) || date.includes(q) || amt.includes(q);
          });
        }

        try{
          const sumCents = (rows) => (Array.isArray(rows) ? rows : []).reduce((a, p) => a + Number(p.amount_cents || 0), 0);
          const paid = payouts.filter((p) => norm(p.status) === 'paid');
          const pending = payouts.filter((p) => norm(p.status) !== 'paid');
          const totalCents = sumCents(payouts);
          const paidCents = sumCents(paid);
          const pendingCents = sumCents(pending);
          const label = days ? `Last ${Math.trunc(days)} days` : 'All time';
          const fBits = [
            wantStatus ? `Status: ${wantStatus}` : '',
            q ? `Search: “${q}”` : '',
          ].filter(Boolean);
          if ($('payoutsTotals')) $('payoutsTotals').textContent = fBits.length ? `${label} • ${fBits.join(' • ')}` : label;
          if ($('payoutsTotalBig')) $('payoutsTotalBig').textContent = fmtMoney(totalCents);
          if ($('payoutsTotalsSub')) {
            const shown = payouts.length;
            const total = Array.isArray(payoutsAll) ? payoutsAll.length : 0;
            const suffix = (shown !== total) ? ` • Showing ${shown} of ${total}` : ` • ${shown} payout(s)`;
            $('payoutsTotalsSub').textContent = `Paid ${fmtMoney(paidCents)} • Pending ${fmtMoney(pendingCents)}${suffix}`;
          }
        } catch(_e) {
          if ($('payoutsTotals')) $('payoutsTotals').textContent = '';
          if ($('payoutsTotalsSub')) $('payoutsTotalsSub').textContent = '';
        }

        if ($('payoutsEmpty')) {
          if (!payoutsAll.length) $('payoutsEmpty').textContent = 'No payouts yet.';
          else if (!payouts.length) $('payoutsEmpty').textContent = 'No payouts match your filters.';
          else $('payoutsEmpty').textContent = '';
        }

        if (!payouts.length) {
          $('payoutsTbody').innerHTML = '<tr><td colspan="4" class="muted">No payouts to show.</td></tr>';
          setBadge('ok', 'loaded');
          return;
        }
        $('payoutsTbody').innerHTML = payouts.map((p) => `
          <tr>
            <td class="muted">${(p.created_at || '').slice(0,10)}</td>
            <td>${fmtMoney(p.amount_cents)}</td>
            <td><span class="badge">${p.status}</span></td>
            <td class="muted">${p.description || ''}</td>
          </tr>
        `).join('');
        setBadge('ok', 'loaded');
      } catch(e){
        $('payoutsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function loadDocs(){
      setBadge('warn', 'loading');
      $('docsMsg').textContent = '';
      try{
        const j = await api('/api/portal/docs?limit=80');
        const docs = j.docs || [];
        $('docsList').innerHTML = docs.map((d) => {
          const role = d.audience_role
            ? `<span class="badge">${escapeHtml(viewingLabel(d.audience_role))}</span>`
            : `<span class="badge ok">all</span>`;
          const content = (d.content || '').slice(0, 2000);
          return `
            <div class="card" style="background: #fff; margin-bottom:12px;">
              <div class="bd">
                <div class="row" style="justify-content:space-between;">
                  <div style="font-weight:800;">${d.title}</div>
                  ${role}
                </div>
                <div style="height:10px"></div>
                <pre style="white-space:pre-wrap; margin:0; font-family: var(--mono); font-size:12px; color: var(--text);">${escapeHtml(content)}</pre>
              </div>
            </div>
          `;
        }).join('') || '<div class="muted">No docs yet.</div>';
        setBadge('ok', 'loaded');
      } catch(e){
        $('docsMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    async function createDoc(){
      $('createDocMsg').textContent = '';
      try{
        await api('/api/portal/docs', {
          method: 'POST',
          body: {
            title: $('docTitle').value,
            audienceRole: $('docAudience').value,
            content: $('docContent').value,
            source: 'manual_paste',
            meta: { format: 'csv_or_text' }
          }
        });
        $('docTitle').value = '';
        $('docAudience').value = '';
        $('docContent').value = '';
        await loadDocs();
      } catch(e){
        $('createDocMsg').textContent = String(e.message || e);
      }
    }

    async function loadUsers(){
      $('usersMsg').textContent = '';
      setBadge('warn', 'loading');
      try{
        const j = await api('/api/portal/users');
        const users = (j.users || []);
        state.usersCache = users;
        const er = effectiveRole();
        const canManageUsers = (myRole() === 'manager') && !isManagerViewAsActive();
        const canEditProfiles = ['event_coordinator','manager'].includes(er);

        // Availability summaries for hosts/media.
        const hostMediaIds = users
          .filter((u) => ['event_host','media_team'].includes(String(u?.role || '').trim()))
          .map((u) => String(u.userId || '').trim())
          .filter(Boolean);
        await ensureAvailabilityCacheForUserIds(hostMediaIds).catch(() => {});

        $('usersTbody').innerHTML = users.map((u) => {
          const uid = String(u.userId || '').trim();
          const isHostMedia = ['event_host','media_team'].includes(String(u?.role || '').trim());
          const a = (state._availabilityCache && state._availabilityCache[uid]) ? state._availabilityCache[uid].availability : null;
          const aText = isHostMedia ? (availabilitySummaryFrom(a) || '—') : '—';

          const actionBtn = canManageUsers
            ? `<button class="btn secondary small" type="button" data-edit-user="${escapeHtml(u.userId)}">Edit user</button>`
            : (canEditProfiles
              ? `<button class="btn secondary small" type="button" data-edit-profile="${escapeHtml(u.userId)}">Edit profile</button>`
              : '<span class="muted">—</span>');

          return `
          <tr>
            <td>${escapeHtml(u.fullName || '')}</td>
            <td class="muted">${escapeHtml(u.email || '')}</td>
            <td><span class="badge">${escapeHtml(viewingLabel(u.role))}</span></td>
            <td class="muted">${escapeHtml(aText)}</td>
            <td>${actionBtn}</td>
          </tr>
          `;
        }).join('');

        for (const btn of $('usersTbody').querySelectorAll('button[data-edit-user]')){
          btn.addEventListener('click', async () => {
            $('usersMsg').textContent = '';
            try{
              if (!canManageUsers) throw new Error('forbidden');
              const userId = String(btn.dataset.editUser || '').trim();
              const current = users.find((x) => String(x.userId) === userId);
              const nextRole = prompt('Role:', current?.role || '');
              if (nextRole == null) return;
              const nextName = prompt('Full name:', current?.fullName || '');
              if (nextName == null) return;
              await api('/api/portal/users', { method:'PATCH', body: { userId, role: nextRole, fullName: nextName } });
              await loadUsers();
              setBadge('ok', 'updated');
            } catch(e){
              $('usersMsg').textContent = String(e.message || e);
            }
          });
        }

        for (const btn of $('usersTbody').querySelectorAll('button[data-edit-profile]')){
          btn.addEventListener('click', () => {
            $('usersMsg').textContent = '';
            try{
              const userId = String(btn.dataset.editProfile || '').trim();
              if (!userId) return;
              // Open the Talent editor for this person.
              state.talent.editUserId = userId;
              state.talent.step = 1;
              setTab('talent');
            } catch(e){
              $('usersMsg').textContent = String(e.message || e);
            }
          });
        }
        setBadge('ok', 'loaded');
      } catch(e){
        $('usersMsg').textContent = String(e.message || e);
        setBadge('warn', 'error');
      }
    }

    function escapeHtml(s){
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function on(id, eventName, handler){
      const el = $(id);
      if (el) el.addEventListener(eventName, handler);
    }

    let __pickersInited = false;
    function initPickersOnce(){
      if (__pickersInited) return;
      if (typeof window.flatpickr !== 'function') return;
      __pickersInited = true;

      for (const el of Array.from(document.querySelectorAll('input[data-picker="date"]'))) {
        window.flatpickr(el, {
          dateFormat: 'Y-m-d',
          allowInput: true,
        });
      }
      for (const el of Array.from(document.querySelectorAll('input[data-picker="time"]'))) {
        window.flatpickr(el, {
          enableTime: true,
          noCalendar: true,
          dateFormat: 'H:i',
          time_24hr: true,
          allowInput: true,
        });
      }
    }

    async function boot(){
      $('authMsg').textContent = '';
      $('authOk').textContent = '';

      initPickersOnce();

      restoreUiPrefs();

      // Restore prior session token if present.
      state.token = localStorage.getItem('portal_access_token') || '';
      state.refreshToken = localStorage.getItem('portal_refresh_token') || '';
      state.expiresAt = localStorage.getItem('portal_expires_at') || '';
      await refreshMe();
      renderDialerSubtab();
      renderCloserSubtab();
      renderMeetingsSubtab();
      renderManagerSubtab();
      enhanceAllSelects();
    }

    on('loginBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      setAuthLoading(true, 'Signing in…');
      try{
        const email = $('email').value.trim();
        const password = $('password').value;

        const r = await withTimeout(fetch('/api/portal/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        }), 15000, 'login_timeout');

        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          throw new Error(det ? (msg + ': ' + det) : msg);
        }

        const token = String(j?.session?.access_token || '').trim();
        if (!token) throw new Error('login_failed');

        setSessionTokens(j.session || {});

        setAuthLoading(false);
        $('authOk').textContent = 'Signed in.';
        await refreshMe();
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      } finally {
        setAuthLoading(false);
      }
    });

    on('signupBtn', 'click', async () => {
      $('authMsg').textContent = '';
      $('authOk').textContent = '';
      setAuthLoading(true, 'Creating account…');
      try{
        const email = $('email').value.trim();
        const password = $('password').value;

        const r = await withTimeout(fetch('/api/portal/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        }), 15000, 'signup_timeout');

        const j = await r.json().catch(() => null);
        if (!j || !j.ok) {
          const msg = String(j?.error || ('http_' + r.status));
          const det = String(j?.detail || '').trim();
          throw new Error(det ? (msg + ': ' + det) : msg);
        }

        const token = String(j?.session?.access_token || '').trim();
        if (!token) throw new Error('signup_failed');

        setSessionTokens(j.session || {});

        setAuthLoading(false);
        $('authOk').textContent = 'Account created.';
        await refreshMe();
      } catch(e){
        $('authMsg').textContent = String(e.message || e);
      } finally {
        setAuthLoading(false);
      }
    });


    on('logoutBtn', 'click', async () => {
      clearSession();
      await refreshMe();
    });

    on('refreshBtn', 'click', () => refreshMe().catch(() => {}));

    on('loadLeadsBtn', 'click', () => loadLeads().catch(() => {}));
    on('leadStatus', 'change', () => renderLeadsTable());
    on('newLeadToggle', 'click', () => { $('newLeadBox').hidden = !$('newLeadBox').hidden; });
    on('createLeadBtn', 'click', () => createLead().catch(() => {}));
    on('pullLeadsToggle', 'click', () => { $('pullLeadsBox').hidden = !$('pullLeadsBox').hidden; });
    on('pullLeadsBtn', 'click', () => pullLeads().catch(() => {}));

    on('closerPickLead', 'click', () => { state.pickLeadReturnTab = 'closer'; setTab('leads'); });
    on('pickFromLeads', 'click', () => { state.pickLeadReturnTab = 'calls'; setTab('leads'); });
    on('openScheduleBtn', 'click', () => openScheduleModal({ after: () => loadAppointmentsInto('meetingsTbody', 'meetingsMsg') }));
    on('logCallBtn', 'click', () => logCall().catch(() => {}));
    on('aiFollowupBtn', 'click', () => aiFollowup().catch(() => {}));

    on('loadQueueBtn', 'click', () => loadQueue().catch(() => {}));
    on('loadDialerTimelineBtn', 'click', () => loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(() => {}));

    on('dialerSegCall', 'click', () => setDialerSubtab('call'));
    on('dialerSegActivity', 'click', () => setDialerSubtab('activity'));
    on('dialerSegBooked', 'click', () => setDialerSubtab('booked'));
    on('dialerSegTasks', 'click', () => setDialerSubtab('tasks'));
    on('dialerBookedRefreshBtn', 'click', () => loadDialerBooked().catch(() => {}));
    on('dialerBookedOpenSchedule', 'click', () => scheduleDialerBooked().catch(() => {}));

    on('loadOffersBtn', 'click', () => loadOffers().catch(() => {}));
    on('offersStatePick', 'change', () => loadOffers().catch(() => {}));

    on('offersDetailCloseBtn', 'click', () => closeOfferDetail({ clearSelection: true }));
    on('offersDetailViewEventBtn', 'click', () => {
      const id = Number(state.selectedOfferEventId || 0);
      if (!id) return;
      if (!['event_coordinator','manager'].includes(effectiveRole())) return;
      state.pendingSelectEventId = id;
      setTab('events');
    });

    on('loadEventsBtn', 'click', () => loadEvents().catch(() => {}));
    on('eventsSegMy', 'click', () => setEventsSubtab('my'));
    on('eventsSegAll', 'click', () => setEventsSubtab('all'));
    on('newEventToggle', 'click', async () => {
      const box = $('newEventBox');
      if (!box) return;
      box.hidden = !box.hidden;
      if (!box.hidden) await ensureNewEventAccountsLoaded().catch(() => {});
    });
    on('newEventCloseBtn', 'click', () => { const b = $('newEventBox'); if (b) b.hidden = true; });
    on('neAccountPick', 'change', () => applyNewEventAccountFill());
    on('createEventBtn', 'click', () => createEvent().catch(() => {}));
    on('createFollowupsBtn', 'click', () => createFollowups().catch(() => {}));
    on('addHostBtn', 'click', () => addAssignment('event_host').catch(() => {}));
    on('addMediaBtn', 'click', () => addAssignment('media_team').catch(() => {}));
    on('saveChecklistBtn', 'click', () => saveChecklist().catch(() => {}));
    on('savePlanBtn', 'click', () => savePlan().catch(() => {}));
    on('saveBudgetBtn', 'click', () => saveBudget().catch(() => {}));
    on('planVendorSearchBtn', 'click', () => searchPlanVendors().catch(() => {}));
    on('planVendorSuggestBtn', 'click', () => suggestPlanVendorsFromEventType());
    on('planEventTypeSearchBtn', 'click', () => filterPlanEventTypes());
    on('planEventTypeResetBtn', 'click', () => resetPlanEventTypes());
    on('planEventType', 'change', () => renderPlanEventTypeDetails());

    on('closeOpsEventBtn', 'click', () => setSelectedEvent(null));

    // Enter-to-search convenience
    try{
      const pv = $('planVendorQ');
      if (pv) pv.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); searchPlanVendors().catch(()=>{}); } });
      const pt = $('planEventTypeQ');
      if (pt) pt.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); filterPlanEventTypes(); } });
    } catch(_e) {}
    on('loadVendorsBtn', 'click', () => loadVendors().catch(() => {}));
    on('suggestVendorsBtn', 'click', () => suggestVendorsForSelected());
    on('aiSuggestVendorsBtn', 'click', () => aiSuggestVendorsForSelected().catch(() => {}));
    on('loadEventTypesBtn', 'click', () => loadEventTypes().catch(() => {}));

    on('feedbackEnableBtn', 'click', () => enableOrRegenerateFeedbackLink().catch(() => {}));
    on('feedbackCopyBtn', 'click', () => copyFeedbackLink().catch(() => {}));
    on('feedbackOpenBtn', 'click', () => openFeedbackLink());
    on('feedbackAddQBtn', 'click', () => {
      if (!coordinatorOpsEditable()) return;
      addFeedbackQuestionRow(null, { type: 'long_text', label: '' }, { editable: true });
    });
    on('feedbackSaveBtn', 'click', () => saveFeedbackForm().catch(() => {}));
    on('feedbackLoadSummaryBtn', 'click', () => loadFeedbackSummary().catch(() => {}));

    on('aiRecommendTalentBtn', 'click', () => aiRecommendTalentForSelected().catch(() => {}));
    on('aiAssignTopTalentBtn', 'click', () => aiAssignTopTalentForSelected().catch(() => {}));

    on('genReportDraftBtn', 'click', () => generateReportDraftForSelected().catch(() => {}));
    on('copyReportDraftBtn', 'click', () => copyReportDraft().catch(() => {}));
    on('sendReportDraftBtn', 'click', () => sendReportDraft().catch(() => {}));

    document.addEventListener('click', (ev) => {
      if (!(ev.target instanceof Element)) return;

      const collapseBtn = ev.target.closest('button[data-collapse-target]');
      if (collapseBtn) {
        const targetId = String(collapseBtn.getAttribute('data-collapse-target') || '').trim();
        if (!targetId) return;
        ev.preventDefault();
        toggleCollapsed(targetId);
        return;
      }

      const chipBtn = ev.target.closest('button[data-chip-remove]');
      if (chipBtn) {
        const key = String(chipBtn.getAttribute('data-chip-remove') || '').trim();
        const value = String(chipBtn.getAttribute('data-chip-value') || '').trim();
        if (!key || !value) return;
        const form = (state.talent.form && typeof state.talent.form === 'object') ? state.talent.form : null;
        if (!form) return;
        const rm = (arr) => uniqueList((Array.isArray(arr) ? arr : []).filter((x) => String(x) !== value));
        if (key === 'pub.specialties') form.public.specialties = rm(form.public.specialties);
        else if (key === 'pub.tone') form.public.tone = rm(form.public.tone);
        else if (key === 'pub.gear') form.public.gear = rm(form.public.gear);
        else if (key === 'pub.preferredPairings') form.public.preferredPairings = rm(form.public.preferredPairings);
        else if (key === 'int.specialties') form.internal.specialties = rm(form.internal.specialties);
        else if (key === 'int.tone') form.internal.tone = rm(form.internal.tone);
        else if (key === 'int.gear') form.internal.gear = rm(form.internal.gear);
        else if (key === 'int.preferredPairings') form.internal.preferredPairings = rm(form.internal.preferredPairings);
        else if (key === 'int.reliability.flags') {
          if (!form.internal.reliability || typeof form.internal.reliability !== 'object') form.internal.reliability = { score: null, flags: [] };
          form.internal.reliability.flags = rm(form.internal.reliability.flags);
        }
        renderTalentFormChips();
        return;
      }

      const openTalentBtn = ev.target.closest('button[data-talent-open-user]');
      if (openTalentBtn) {
        const userId = String(openTalentBtn.getAttribute('data-talent-open-user') || '').trim();
        if (!userId) return;
        state.talent.editUserId = userId;
        state.talent.step = 1;
        $('talentStopEditingBtn')?.classList.remove('hide');
        loadTalentTab().catch(() => {});
        return;
      }

      const openTalentRow = ev.target.closest('tr[data-talent-open-user]');
      if (openTalentRow && !ev.target.closest('button')) {
        const userId = String(openTalentRow.getAttribute('data-talent-open-user') || '').trim();
        if (!userId) return;
        state.talent.editUserId = userId;
        state.talent.step = 1;
        $('talentStopEditingBtn')?.classList.remove('hide');
        loadTalentTab().catch(() => {});
        return;
      }

      const pickBtn = ev.target.closest('button[data-people-pick-user]');
      if (pickBtn) {
        const userId = String(pickBtn.getAttribute('data-people-pick-user') || '').trim();
        if (!userId) return;
        const fn = state.peoplePick && typeof state.peoplePick.onPick === 'function' ? state.peoplePick.onPick : null;
        closePeoplePick();
        if (fn) fn(userId);
      }
    });

    on('talentSaveBtn', 'click', () => saveTalentProfile().catch(() => {}));
    on('talentRefreshBtn', 'click', async () => {
      await loadTalentProfilesCache({ force: true }).catch(() => {});
      await loadTalentTab().catch(() => {});
    });
    on('talentStopEditingBtn', 'click', () => stopTalentEditing());

    // Talent: self edit mode
    on('talSelfEditBtn', 'click', () => {
      state.talent.selfEditing = true;
      applyTalentEditMode();
    });
    on('talSelfCancelBtn', 'click', () => {
      state.talent.selfEditing = false;
      // Reload from last known profile
      writeTalentForm(state.talent.my || state.talent.form);
    });

    // Talent: avatar upload/crop
    on('talAvatarUploadBtn', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditPublic) return;
      $('talAvatarFile')?.click();
    });
    on('talAvatarFile', 'change', async () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditPublic) return;
      const input = $('talAvatarFile');
      const f = input && input.files && input.files[0] ? input.files[0] : null;
      if (!f) return;
      if (f.size > 6 * 1024 * 1024) {
        $('talentMsg').textContent = 'That file is too large (max 6MB).';
        return;
      }
      const dataUrl = await new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result || ''));
        fr.onerror = () => resolve('');
        fr.readAsDataURL(f);
      });
      if (!dataUrl) return;
      openAvatarCrop(dataUrl);
      try { input.value = ''; } catch(_e) {}
    });
    on('talAvatarRemoveBtn', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditPublic) return;
      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      state.talent.form.public.avatarDataUrl = '';
      setAvatarCircle($('talAvatarCircle'), '', $('talDisplayName')?.value || '');
    });

    // Avatar crop modal
    on('avatarCropCancel', 'click', () => closeAvatarCrop());
    on('avatarCropSave', 'click', () => saveAvatarCropToForm());
    on('avatarCropZoom', 'input', () => {
      const z = Number($('avatarCropZoom')?.value || 1);
      state.avatarCrop.zoom = Math.max(1, Math.min(3, z));
      const img = $('avatarCropImg');
      if (img) img.style.transform = `translate(calc(-50% + ${state.avatarCrop.dx}px), calc(-50% + ${state.avatarCrop.dy}px)) scale(${state.avatarCrop.zoom})`;
    });

    // People picker modal
    on('peoplePickClose', 'click', () => closePeoplePick());
    on('peoplePickQ', 'input', () => renderPeoplePickList());

    // Talent: chip adders (public)
    on('talPublicSpecialtyAdd', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditPublic) return;
      const v = String($('talPublicSpecialtyInput')?.value || '').trim();
      if (!v) return;
      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      state.talent.form.public.specialties = uniqueList([...(state.talent.form.public.specialties || []), v]);
      if ($('talPublicSpecialtyInput')) $('talPublicSpecialtyInput').value = '';
      renderTalentFormChips();
    });
    on('talPublicToneAdd', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditPublic) return;
      const v = String($('talPublicToneInput')?.value || '').trim();
      if (!v) return;
      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      state.talent.form.public.tone = uniqueList([...(state.talent.form.public.tone || []), v]);
      if ($('talPublicToneInput')) $('talPublicToneInput').value = '';
      renderTalentFormChips();
    });
    on('talPublicGearAdd', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditPublic) return;
      const v = String($('talPublicGearInput')?.value || '').trim();
      if (!v) return;
      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      state.talent.form.public.gear = uniqueList([...(state.talent.form.public.gear || []), v]);
      if ($('talPublicGearInput')) $('talPublicGearInput').value = '';
      renderTalentFormChips();
    });

    // Talent: pairings picker (public for self, internal for coordinator)
    on('talPublicPairingsAdd', 'click', async () => {
      const ctx = talentProfileEditContext();
      const canAdd = talentIsCoordinator() ? ctx.canEditInternal : ctx.canEditPublic;
      if (!canAdd) return;
      await ensureUsersCache();
      openPeoplePick({
        title: 'Add pairing',
        onPick: (uid) => {
          if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
          if (talentIsCoordinator()) {
            state.talent.form.internal.preferredPairings = uniqueList([...(state.talent.form.internal.preferredPairings || []), uid]);
          } else {
            state.talent.form.public.preferredPairings = uniqueList([...(state.talent.form.public.preferredPairings || []), uid]);
          }
          renderTalentFormChips();
        }
      });
    });

    // Talent: chip adders (internal)
    on('talInternalSpecialtyAdd', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditInternal) return;
      const v = String($('talInternalSpecialtyInput')?.value || '').trim();
      if (!v) return;
      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      state.talent.form.internal.specialties = uniqueList([...(state.talent.form.internal.specialties || []), v]);
      if ($('talInternalSpecialtyInput')) $('talInternalSpecialtyInput').value = '';
      renderTalentFormChips();
    });
    on('talInternalToneAdd', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditInternal) return;
      const v = String($('talInternalToneInput')?.value || '').trim();
      if (!v) return;
      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      state.talent.form.internal.tone = uniqueList([...(state.talent.form.internal.tone || []), v]);
      if ($('talInternalToneInput')) $('talInternalToneInput').value = '';
      renderTalentFormChips();
    });
    on('talInternalGearAdd', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditInternal) return;
      const v = String($('talInternalGearInput')?.value || '').trim();
      if (!v) return;
      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      state.talent.form.internal.gear = uniqueList([...(state.talent.form.internal.gear || []), v]);
      if ($('talInternalGearInput')) $('talInternalGearInput').value = '';
      renderTalentFormChips();
    });

    // Talent: reliability
    on('talReliabilityScore', 'input', () => syncReliabilityLabel());
    on('talReliabilityFlagAdd', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditInternal) return;
      const v = String($('talReliabilityFlagInput')?.value || '').trim();
      if (!v) return;
      if (!state.talent.form) state.talent.form = normalizeTalentRecord(null, { fallbackUserId: ctx.targetUserId, defaultRole: myPortalRole() });
      if (!state.talent.form.internal.reliability || typeof state.talent.form.internal.reliability !== 'object') state.talent.form.internal.reliability = { score: null, flags: [] };
      state.talent.form.internal.reliability.flags = uniqueList([...(state.talent.form.internal.reliability.flags || []), v]);
      if ($('talReliabilityFlagInput')) $('talReliabilityFlagInput').value = '';
      renderTalentFormChips();
    });

    // Talent: embedded availability
    on('talAvailSaveBtn', 'click', () => saveTalentAvailability().catch(() => {}));
    on('talAvailPrevWeek', 'click', () => { ensureTalAvailInit(); state.talent.avail.weekOffset -= 1; renderTalAvailWeekGrid(); });
    on('talAvailNextWeek', 'click', () => { ensureTalAvailInit(); state.talent.avail.weekOffset += 1; renderTalAvailWeekGrid(); });
    on('talAvailToday', 'click', () => { ensureTalAvailInit(); state.talent.avail.weekOffset = 0; renderTalAvailWeekGrid(); });
    on('talAvailClearWeek', 'click', () => {
      const ctx = talentProfileEditContext();
      if (!ctx.canEditAvailability) return;
      ensureTalAvailInit();
      const todayKey = isoToday();
      const week = talWeekDates().map(ymd);
      for (const d of week) {
        if (String(d) < todayKey) continue;
        if (state.talent.avail.byDate && typeof state.talent.avail.byDate === 'object') delete state.talent.avail.byDate[d];
      }
      renderTalAvailWeekGrid();
    });

    on('talStep1', 'click', () => setTalentStep(1));
    on('talStep2', 'click', () => setTalentStep(2));
    on('talStep3', 'click', () => setTalentStep(3));
    on('talStep4', 'click', () => setTalentStep(4));
    on('talPrevBtn', 'click', () => setTalentStep(Number(state.talent?.step || 1) - 1));
    on('talNextBtn', 'click', () => setTalentStep(Number(state.talent?.step || 1) + 1));
    on('talentQ', 'input', () => {
      if (!talentIsCoordinator()) return;
      if (state.talent.qTimer) clearTimeout(state.talent.qTimer);
      state.talent.qTimer = setTimeout(() => {
        rerenderTalentDirectoryFromCache().catch(() => {});
      }, 120);
    });

    on('closeSubmitBtn', 'click', () => submitClose().catch(() => {}));
    // closeQuoteBtn removed (package pricing is custom)

    on('clearSelectedLeadBtn', 'click', () => clearSelectedLead());
    on('closerClearLeadBtn', 'click', () => clearSelectedLead());

    on('loadApptsBtn', 'click', () => loadAppointments().catch(() => {}));
    on('scheduleApptBtn', 'click', () => scheduleAppointment().catch(() => {}));
    on('meetingsRefreshBtn', 'click', () => loadAppointmentsInto('meetingsTbody', 'meetingsMsg').catch(() => {}));
    on('meetingsOpenSchedule', 'click', () => scheduleMeeting().catch(() => {}));

    on('meetingsSegList', 'click', () => setMeetingsSubtab('list'));
    on('meetingsSegAvailability', 'click', () => setMeetingsSubtab('availability'));

    on('mgrSegStats', 'click', () => setManagerSubtab('stats'));
    on('mgrSegTasks', 'click', () => setManagerSubtab('tasks'));
    on('mgrSegUsers', 'click', () => setManagerSubtab('users'));

    on('scheduleClose', 'click', () => closeScheduleModal());
    on('scheduleSaveBtn', 'click', () => scheduleFromModal().catch(() => {}));
    on('scheduleClearLead', 'click', () => {
      clearSelectedLead();
      const line = $('scheduleLeadLine');
      if (line) line.textContent = 'None';
    });
    on('schedulePickLead', 'click', () => {
      state.pickLeadReturnTab = state.activeTab || 'calls';
      closeScheduleModal();
      setTab('leads');
    });

    on('availSaveBtn', 'click', () => saveAvailability().catch(() => {}));
    on('availPrevWeek', 'click', () => { ensureAvailInit(); state.availability.weekOffset -= 1; renderAvailWeekGrid(); });
    on('availNextWeek', 'click', () => { ensureAvailInit(); state.availability.weekOffset += 1; renderAvailWeekGrid(); });
    on('availToday', 'click', () => { ensureAvailInit(); state.availability.weekOffset = 0; renderAvailWeekGrid(); });
    on('availClearWeek', 'click', () => {
      if (!availabilityEditable()) return;
      ensureAvailInit();
      const todayKey = isoToday();
      const week = weekDates().map(ymd);
      for (const d of week) {
        if (String(d) < todayKey) continue;
        if (state.availability.byDate && typeof state.availability.byDate === 'object') delete state.availability.byDate[d];
      }
      renderAvailWeekGrid();
    });

    on('accountsRefreshBtn', 'click', () => loadAccounts().catch(() => {}));
    on('accountsNewToggle', 'click', () => { const b = $('accountsNewBox'); if (b) b.hidden = !b.hidden; });
    on('accountsCreateBtn', 'click', () => createAccount().catch(() => {}));
    on('acctSaveBtn', 'click', () => saveAccount().catch(() => {}));
    on('acctDeleteBtn', 'click', () => deleteAccount().catch(() => {}));
    on('sentimentAddBtn', 'click', () => addSentiment().catch(() => {}));
    on('issueAddBtn', 'click', () => addIssue().catch(() => {}));
    on('tplSaveBtn', 'click', () => saveTemplate().catch(() => {}));
    on('accountsExpiring', 'change', () => loadAccounts().catch(() => {}));
    on('accountsQ', 'input', () => {
      ensureAccountsInit();
      if (state.accounts.qTimer) clearTimeout(state.accounts.qTimer);
      state.accounts.qTimer = setTimeout(() => {
        // Filter locally and refresh server list occasionally.
        renderAccounts();
      }, 120);
    });

    on('acctStart', 'change', () => syncNewAccountDerived());
    on('acctTermMonths', 'input', () => syncNewAccountDerived());
    on('acctEnd', 'change', () => syncNewAccountDerived());

    on('acctEditStart', 'change', () => syncEditAccountDerived());
    on('acctEditTermMonths', 'input', () => syncEditAccountDerived());
    on('acctEditEnd', 'change', () => syncEditAccountDerived());
    on('acctEditReminderDays', 'input', () => syncEditAccountDerived());

    on('closerSegDisposition', 'click', () => setCloserSubtab('disposition'));


    on('submitRecapBtn', 'click', () => submitRecap().catch(() => {}));

    on('leadClearBtn', 'click', () => clearSelectedLead());
    on('closeRecapBtn', 'click', () => setSelectedEvent(null));

    on('pipelineClose', 'click', () => closePipelineModal());
    on('pipelinePrev', 'click', () => selectPipelineIdx(Number(pipelineModalState.idx || 0) - 1));
    on('pipelineNext', 'click', () => selectPipelineIdx(Number(pipelineModalState.idx || 0) + 1));
    on('pipelineOpenLead', 'click', async () => {
      const items = pipelineModalState.leads || [];
      const idx = Number(pipelineModalState.idx || 0);
      const l = items[idx];
      if (!l || !l.id) return;
      state.selectedLead = l;
      setSelectedLeadLine();
      closePipelineModal();
      if (pipelineModalState.context === 'closer') {
        setTab('closer');
        setCloserSubtab('disposition');
      } else {
        setTab('leads');
      }
      await loadTimelineInto('timelineList', 'timelineMsg').catch(()=>{});
      await loadTimelineInto('dialerTimelineList', 'dialerTimelineMsg').catch(()=>{});
    });

    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape') {
        const m = $('pipelineModal');
        if (m && m.classList.contains('show')) closePipelineModal();
        const s = $('scheduleModal');
        if (s && s.classList.contains('show')) closeScheduleModal();
        const p = $('peoplePickModal');
        if (p && p.classList.contains('show')) closePeoplePick();
        const a = $('avatarCropModal');
        if (a && a.classList.contains('show')) closeAvatarCrop();
      }
    });

    on('pipelineModal', 'click', (ev) => {
      const m = $('pipelineModal');
      if (!m) return;
      if (ev.target === m) closePipelineModal();
    });

    on('scheduleModal', 'click', (ev) => {
      const m = $('scheduleModal');
      if (!m) return;
      if (ev.target === m) closeScheduleModal();
    });

    on('peoplePickModal', 'click', (ev) => {
      const m = $('peoplePickModal');
      if (!m) return;
      if (ev.target === m) closePeoplePick();
    });

    on('avatarCropModal', 'click', (ev) => {
      const m = $('avatarCropModal');
      if (!m) return;
      if (ev.target === m) closeAvatarCrop();
    });

    on('loadPayoutsBtn', 'click', () => loadPayouts().catch(() => {}));
    on('payoutsPeriodPick', 'change', () => setPayoutsPeriodDays(Number($('payoutsPeriodPick')?.value || 0)));
    on('payoutsStatusPick', 'change', () => {
      state.payoutsStatus = String($('payoutsStatusPick')?.value || '').trim();
      if (state.activeTab === 'payments') loadPayouts().catch(() => {});
    });
    on('payoutsSearchBtn', 'click', () => {
      state.payoutsQ = String($('payoutsQ')?.value || '');
      if (state.activeTab === 'payments') loadPayouts().catch(() => {});
    });
    on('payoutsQ', 'keydown', (ev) => {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        state.payoutsQ = String($('payoutsQ')?.value || '');
        if (state.activeTab === 'payments') loadPayouts().catch(() => {});
      }
    });

    on('leadDetailRefreshBtn', 'click', () => loadTimelineInto('timelineList', 'timelineMsg').catch(() => {}));
    on('leadSaveBtn', 'click', () => saveLeadEdits().catch(() => {}));
    on('timelineAddBtn', 'click', () => addTimelineNote('timelineNote', 'timelineAddMsg', 'timelineList').catch(() => {}));

    on('loadDispatchBtn', 'click', () => loadDispatchManager().catch(() => {}));
    on('scanDispatchBtn', 'click', () => scanDispatchOverdue().catch(() => {}));
    on('dispatchCreateBtn', 'click', () => createDispatchTask().catch(() => {}));
    on('dispatchPickLead', 'click', () => {
      state.pickLeadReturnTab = 'manager';
      state.managerSubtab = 'tasks';
      setTab('leads');
    });
    on('dispatchUseSelectedLead', 'click', () => {
      const id = state.selectedLead ? String(state.selectedLead.id || '').trim() : '';
      if ($('dispatchLeadId')) $('dispatchLeadId').value = id;
    });

    on('loadDialerTasksBtn', 'click', () => loadDispatchInto('dialerTasksTbody', 'dialerTasksMsg', { overdueOnly: !!$('dialerTasksOverdue')?.checked, scope: String($('dialerTasksScope')?.value || 'role') }).catch(() => {}));
    // Closer Dispatch removed from Sales.

    boot().catch((e) => {
      $('authMsg').textContent = String(e.message || e);
    });
  </script>
</body>
</html>
